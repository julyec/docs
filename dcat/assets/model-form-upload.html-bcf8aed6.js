import{_ as i}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o as l,c,a as s,d as a,w as u,b as n,e as t}from"./app-c17653d8.js";const r={},d=s("h1",{id:"图片-文件上传",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#图片-文件上传","aria-hidden":"true"},"#"),n(" 图片/文件上传")],-1),k={href:"https://fex.baidu.com/webuploader/",target:"_blank",rel:"noopener noreferrer"},v={href:"https://fex.baidu.com/webuploader/document.html",target:"_blank",rel:"noopener noreferrer"},g=t(`<blockquote><p>{tip} 文件或图片上传表单字段请不要在模型中设置<strong>访问器</strong>和<strong>修改器</strong>拼接域名，如有相关需求可参考<a href="#withhost">文件/图片域名拼接</a>。</p></blockquote><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file_column&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;image_column&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="本地上传" tabindex="-1"><a class="header-anchor" href="#本地上传" aria-hidden="true">#</a> 本地上传</h2><p>先添加存储配置，<code>config/filesystems.php</code> 添加一项<code>disk</code>:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>
<span class="token string single-quoted-string">&#39;disks&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span> <span class="token punctuation">,</span>

    <span class="token string single-quoted-string">&#39;admin&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;driver&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;local&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;root&#39;</span> <span class="token operator">=&gt;</span> <span class="token function">public_path</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;uploads&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;visibility&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;public&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;url&#39;</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;APP_URL&#39;</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;/uploads&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置上传的路径为<code>public/uploads</code>(public_path(&#39;uploads&#39;))。</p><p>然后选择上传的<code>disk</code>，打开<code>config/admin.php</code>找到：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>    
<span class="token string single-quoted-string">&#39;upload&#39;</span>  <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>

    <span class="token string single-quoted-string">&#39;disk&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;admin&#39;</span><span class="token punctuation">,</span>

    <span class="token string single-quoted-string">&#39;directory&#39;</span>  <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;image&#39;</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;images&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;file&#39;</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;files&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将<code>disk</code>设置为上面添加的<code>admin</code>，<code>directory.image</code>和<code>directory.file</code>分别为用<code>$form-&gt;image($column)</code>和<code>$form-&gt;file($column)</code>上传的图片和文件的上传目录。</p><p>当然你也可以在代码中指定<code>disk</code>：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;your disk name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="云盘上传" tabindex="-1"><a class="header-anchor" href="#云盘上传" aria-hidden="true">#</a> 云盘上传</h2><p>如果需要上传到云存储，需要安装对应<code>laravel storage</code>的适配器，拿七牛云存储举例</p>`,13),m={href:"https://github.com/zgldh/qiniu-laravel-storage",target:"_blank",rel:"noopener noreferrer"},b=t(`<p>同样配置好disk，在<code>config/filesystems.php</code> 添加一项:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token string single-quoted-string">&#39;disks&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span> <span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;qiniu&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;driver&#39;</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;qiniu&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;domains&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">&#39;default&#39;</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;xxxxx.com1.z0.glb.clouddn.com&#39;</span><span class="token punctuation">,</span> <span class="token comment">//你的七牛域名</span>
            <span class="token string single-quoted-string">&#39;https&#39;</span>     <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;dn-yourdomain.qbox.me&#39;</span><span class="token punctuation">,</span>         <span class="token comment">//你的HTTPS域名</span>
            <span class="token string single-quoted-string">&#39;custom&#39;</span>    <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;static.abc.com&#39;</span><span class="token punctuation">,</span>                <span class="token comment">//你的自定义域名</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;access_key&#39;</span><span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;&#39;</span><span class="token punctuation">,</span>  <span class="token comment">//AccessKey</span>
        <span class="token string single-quoted-string">&#39;secret_key&#39;</span><span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;&#39;</span><span class="token punctuation">,</span>  <span class="token comment">//SecretKey</span>
        <span class="token string single-quoted-string">&#39;bucket&#39;</span>    <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;&#39;</span><span class="token punctuation">,</span>  <span class="token comment">//Bucket名字</span>
        <span class="token string single-quoted-string">&#39;notify_url&#39;</span><span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;&#39;</span><span class="token punctuation">,</span>  <span class="token comment">//持久化处理回调地址</span>
        <span class="token string single-quoted-string">&#39;url&#39;</span>       <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;http://of8kfibjo.bkt.clouddn.com/&#39;</span><span class="token punctuation">,</span>  <span class="token comment">// 填写文件访问根url</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后修改<code>dcat-admin</code>的上传配置，打开<code>config/admin.php</code>找到：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>
<span class="token string single-quoted-string">&#39;upload&#39;</span>  <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>

    <span class="token string single-quoted-string">&#39;disk&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;qiniu&#39;</span><span class="token punctuation">,</span>

    <span class="token string single-quoted-string">&#39;directory&#39;</span>  <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;image&#39;</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;image&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;file&#39;</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>disk</code>选择上面配置的<code>qiniu</code>，或：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;qiniu&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="公共方法" tabindex="-1"><a class="header-anchor" href="#公共方法" aria-hidden="true">#</a> 公共方法</h2><h3 id="缩略图-thumbnail" tabindex="-1"><a class="header-anchor" href="#缩略图-thumbnail" aria-hidden="true">#</a> 缩略图 (thumbnail)</h3><p>上传图片的同时生成缩略图</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token variable">$column</span><span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">$label</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">thumbnail</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;small&#39;</span><span class="token punctuation">,</span> <span class="token variable">$width</span> <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token variable">$height</span> <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 生成多张缩略图</span>
<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token variable">$column</span><span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">$label</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">thumbnail</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string single-quoted-string">&#39;small1&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;small2&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;small3&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">Dcat<span class="token punctuation">\\</span>Admin<span class="token punctuation">\\</span>Traits<span class="token punctuation">\\</span>Resizable</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Photo</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">Resizable</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// To access thumbnail</span>
<span class="token variable">$photo</span><span class="token operator">-&gt;</span><span class="token function">thumbnail</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;small&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;photo_column&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="存储驱动-disk" tabindex="-1"><a class="header-anchor" href="#存储驱动-disk" aria-hidden="true">#</a> 存储驱动 (disk)</h3><p>修改文件上传源</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;your disk name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="上传路径-move" tabindex="-1"><a class="header-anchor" href="#上传路径-move" aria-hidden="true">#</a> 上传路径 (move)</h3><p>修改上传路径</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;public/upload/image1/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="文件名称-name" tabindex="-1"><a class="header-anchor" href="#文件名称-name" aria-hidden="true">#</a> 文件名称 (name)</h3><p>修改上传文件名称</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;test.text&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;picture&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string single-quoted-string">&#39;test.&#39;</span><span class="token operator">.</span><span class="token variable">$file</span><span class="token operator">-&gt;</span><span class="token function">guessExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="随机名称-uniquename" tabindex="-1"><a class="header-anchor" href="#随机名称-uniquename" aria-hidden="true">#</a> 随机名称 (uniqueName)</h3><p>使用随机生成文件名 (md5(uniqid()).extension)</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;picture&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">uniqueName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="禁止页面删除文件-替换上传" tabindex="-1"><a class="header-anchor" href="#禁止页面删除文件-替换上传" aria-hidden="true">#</a> 禁止页面删除文件 (替换上传)</h3><p>通过<code>removable</code>方法可以禁止用户从页面点击删除服务器上的文件，可以实现图片覆盖上传效果。</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token variable">$column</span><span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">$label</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">removable</span><span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="自动上传-autoupload" tabindex="-1"><a class="header-anchor" href="#自动上传-autoupload" aria-hidden="true">#</a> 自动上传 (autoUpload)</h3><p>开启这个功能之后选择完文件之后会立即自动上传，页面将不再显示<code>上传</code>按钮，使用方法如下</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">autoUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;img&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">autoUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="禁止删除-retainable" tabindex="-1"><a class="header-anchor" href="#禁止删除-retainable" aria-hidden="true">#</a> 禁止删除 (retainable)</h3><p>开启这个功能之后文件将不会从服务器删除</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">retainable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;img&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">retainable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="storagepermission" tabindex="-1"><a class="header-anchor" href="#storagepermission" aria-hidden="true">#</a> storagePermission</h3><p>设置上传文件的权限</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;picture&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">storagePermission</span><span class="token punctuation">(</span><span class="token number">777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="限制上传文件类型" tabindex="-1"><a class="header-anchor" href="#限制上传文件类型" aria-hidden="true">#</a> 限制上传文件类型</h3><p>限制上传文件的类型</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;jpg,png,gif,jpeg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 可以指定 mimeTypes， 多个用逗号分割</span>
<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;jpg,png,gif,jpeg&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;image/*&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分块上传-chunked" tabindex="-1"><a class="header-anchor" href="#分块上传-chunked" aria-hidden="true">#</a> 分块上传 (chunked)</h3><p>启用分块上传</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">chunked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="分块大小-chunksize" tabindex="-1"><a class="header-anchor" href="#分块大小-chunksize" aria-hidden="true">#</a> 分块大小(chunkSize)</h3><p>设置分块大小，单位为<code>KB</code>，默认<code>5MB</code></p><blockquote><p>{tip} 调用这个方法会自动启用分块上传</p></blockquote><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token comment">// 设置为 1MB</span>
<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">chunkSize</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="文件大小-maxsize" tabindex="-1"><a class="header-anchor" href="#文件大小-maxsize" aria-hidden="true">#</a> 文件大小(maxSize)</h3><p>设置单个文件最大大小，单位为<code>Kb</code>，默认大小为<code>10M</code>。</p><blockquote><p>{tip} 同时应该保证<code>php.ini</code>配置文件的<code>upload_max_filesize</code>参数值必须大于这个方法设置的值。</p></blockquote><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token comment">// 设置单个文件最大为1Mb</span>
<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">maxSize</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="并发上传线程数-threads" tabindex="-1"><a class="header-anchor" href="#并发上传线程数-threads" aria-hidden="true">#</a> 并发上传线程数 (threads)</h3><p>设置并发上传线程数，默认<code>3</code></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">threads</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="自定义上传接口-url" tabindex="-1"><a class="header-anchor" href="#自定义上传接口-url" aria-hidden="true">#</a> 自定义上传接口 (url)</h3><p>通过<code>url</code>可以设置自定义上传接口</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;users/files&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>系统提供了<code>Dcat\\Admin\\Traits\\HasUploadedFile</code>这个<code>trait</code>来帮助开发者更轻松地处理上传文件，用法如下</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\\</span>Admin<span class="token punctuation">\\</span>Controllers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Dcat<span class="token punctuation">\\</span>Admin<span class="token punctuation">\\</span>Traits<span class="token punctuation">\\</span>HasUploadedFile</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">FileController</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">HasUploadedFile</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$disk</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;local&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 判断是否是删除文件请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">isDeleteRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除文件并响应</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">deleteFileAndResponse</span><span class="token punctuation">(</span><span class="token variable">$disk</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 获取上传的文件</span>
        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取上传的字段名称</span>
        <span class="token variable">$column</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">uploader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">upload_column</span><span class="token punctuation">;</span>

        <span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;my-images&#39;</span><span class="token punctuation">;</span>
        <span class="token variable">$newName</span> <span class="token operator">=</span> <span class="token variable">$column</span><span class="token operator">.</span><span class="token string single-quoted-string">&#39;-我的文件名称.&#39;</span><span class="token operator">.</span><span class="token variable">$file</span><span class="token operator">-&gt;</span><span class="token function">getClientOriginalExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$disk</span><span class="token operator">-&gt;</span><span class="token function">putFileAs</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token variable">$newName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$dir</span><span class="token punctuation">}</span></span>/<span class="token interpolation"><span class="token variable">$newName</span></span>&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$result</span>
            <span class="token operator">?</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">responseUploaded</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">,</span> <span class="token variable">$disk</span><span class="token operator">-&gt;</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">responseErrorMessage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;文件上传失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在你的路由文件<code>app\\Admin\\routes.php</code>中加上</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$router</span><span class="token operator">-&gt;</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;users/files&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;FileController@handle&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="deleteurl" tabindex="-1"><a class="header-anchor" href="#deleteurl" aria-hidden="true">#</a> deleteUrl</h3><p>修改删除已上传文件路径，此方法一般不需要修改</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">deleteUrl</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file/delete&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="自动保存字段值-autosave" tabindex="-1"><a class="header-anchor" href="#自动保存字段值-autosave" aria-hidden="true">#</a> 自动保存字段值 (autoSave)</h3><p>设置上传文件后是否自动保存文件路径到数据库，此方法默认启用，一般不需要修改</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">autoSave</span><span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="配置-options" tabindex="-1"><a class="header-anchor" href="#配置-options" aria-hidden="true">#</a> 配置 (options)</h3>`,66),h={href:"https://fex.baidu.com/webuploader/document.html",target:"_blank",rel:"noopener noreferrer"},f=t(`<div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;disableGlobalDnd&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">true</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="可排序-sortable" tabindex="-1"><a class="header-anchor" href="#可排序-sortable" aria-hidden="true">#</a> 可排序 (sortable)</h3><p>此方法仅针对多图/文件上传表单有效</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">multipleImage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;images&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">sortable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="压缩图片-compress" tabindex="-1"><a class="header-anchor" href="#压缩图片-compress" aria-hidden="true">#</a> 压缩图片 (compress)</h3><p>默认不启用</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token comment">// 启用图片压缩功能</span>

<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">multipleImage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;images&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">compress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;avatar&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">compress</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
	<span class="token string single-quoted-string">&#39;width&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">1600</span><span class="token punctuation">,</span>
	<span class="token string single-quoted-string">&#39;height&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">1600</span><span class="token punctuation">,</span>

	<span class="token comment">// 图片质量，只有type为\`image/jpeg\`的时候才有效。</span>
	<span class="token string single-quoted-string">&#39;quality&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">90</span><span class="token punctuation">,</span>

	<span class="token comment">// 是否允许放大，如果想要生成小图的时候不失真，此选项应该设置为false.</span>
	<span class="token string single-quoted-string">&#39;allowMagnify&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>

	<span class="token comment">// 是否允许裁剪。</span>
	<span class="token string single-quoted-string">&#39;crop&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>

	<span class="token comment">// 是否保留头部meta信息。</span>
	<span class="token string single-quoted-string">&#39;preserveHeaders&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>

	<span class="token comment">// 如果发现压缩后文件大小比原来还大，则使用原来图片</span>
	<span class="token comment">// 此属性可能会影响图片自动纠正功能</span>
	<span class="token string single-quoted-string">&#39;noCompressIfLarger&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>

	<span class="token comment">// 单位字节，如果图片大小小于此值，不会采用压缩。</span>
	<span class="token string single-quoted-string">&#39;compressSize&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">0</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="监听webuploader文件上传事件-on" tabindex="-1"><a class="header-anchor" href="#监听webuploader文件上传事件-on" aria-hidden="true">#</a> 监听WebUploader文件上传事件 (on)</h3>`,8),q=s("code",null,"on",-1),$={href:"http://fex.baidu.com/webuploader/doc/index.html#WebUploader_Uploader_events",target:"_blank",rel:"noopener noreferrer"},x=t(`<div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;...&#39;</span><span class="token punctuation">)</span>
	<span class="token operator">-&gt;</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;startUpload&#39;</span><span class="token punctuation">,</span> <span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token constant">JS</span>
		<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			console<span class="token operator">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;文件开始上传...&#39;</span><span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token comment">// 上传文件前附加自定义参数到文件上传接口</span>
			this<span class="token operator">.</span>uploader<span class="token operator">.</span>options<span class="token operator">.</span>formData<span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;custom_field&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;...&#39;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token constant">JS</span>
    <span class="token punctuation">)</span>
	<span class="token operator">-&gt;</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;uploadFinished&#39;</span><span class="token punctuation">,</span> <span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token constant">JS</span>
    	<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    		console<span class="token operator">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;文件上传完毕&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token constant">JS</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="文件-图片域名拼接" tabindex="-1"><a class="header-anchor" href="#文件-图片域名拼接" aria-hidden="true">#</a> 文件/图片域名拼接</h3><p>文件或图片上传表单字段请不要在模型中设置<strong>访问器</strong>和<strong>修改器</strong>拼接域名，如果你需要在访问的时候拼接完整域名，可以在模型中定义一个<code>public</code>方法</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\\</span>Support<span class="token punctuation">\\</span>Str</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\\</span>Support<span class="token punctuation">\\</span>Facades<span class="token punctuation">\\</span>Storage</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">YourModel</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 定义一个public方法访问图片或文件</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name static-context">Str</span><span class="token operator">::</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">image</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;//&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">image</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">return</span> <span class="token class-name static-context">Storage</span><span class="token operator">::</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;admin&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">image</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="保存域名" tabindex="-1"><a class="header-anchor" href="#保存域名" aria-hidden="true">#</a> 保存域名</h3><p>如果你需要保存文件域名到数据表，可以使用<code>saveFullUrl</code>方法</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;avatar&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">saveFullUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;...&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">saveFullUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="监听文件上传变动-change" tabindex="-1"><a class="header-anchor" href="#监听文件上传变动-change" aria-hidden="true">#</a> 监听文件上传变动 (change)</h3><p>通过以下方法可以监听文件<strong>上传成功</strong>或文件<strong>被删除</strong>时产生的变动</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;...&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name static-context">Admin</span><span class="token operator">::</span><span class="token function">script</span><span class="token punctuation">(</span>
	<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token class-name type-declaration">JS</span>
$<span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;{$file-&gt;getElementClassSelector()} .file-input&#39;</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;change&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token operator">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;文件发生变动&#39;</span><span class="token punctuation">,</span> this<span class="token operator">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">JS</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="覆盖上传-override" tabindex="-1"><a class="header-anchor" href="#覆盖上传-override" aria-hidden="true">#</a> 覆盖上传 (override)</h3><p>通过 <code>override</code> 方法可以实现文件覆盖上传。</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">override</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;img&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">override</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="图片上传内置方法" tabindex="-1"><a class="header-anchor" href="#图片上传内置方法" aria-hidden="true">#</a> 图片上传内置方法</h2><h3 id="压缩、裁切、添加水印等" tabindex="-1"><a class="header-anchor" href="#压缩、裁切、添加水印等" aria-hidden="true">#</a> 压缩、裁切、添加水印等</h3>`,15),y={href:"http://image.intervention.io/getting_started/installation",target:"_blank",rel:"noopener noreferrer"},_={href:"http://image.intervention.io/getting_started/introduction",target:"_blank",rel:"noopener noreferrer"},w=t(`<div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token variable">$column</span><span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">$label</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 修改图片上传路径和文件名</span>
<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token variable">$column</span><span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">$label</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 剪裁图片</span>
<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token variable">$column</span><span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">$label</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">crop</span><span class="token punctuation">(</span><span class="token keyword type-hint">int</span> <span class="token variable">$width</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$height</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword type-declaration">int</span> <span class="token variable">$x</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$y</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加水印</span>
<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token variable">$column</span><span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">$label</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token variable">$watermark</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;center&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="限制上传图片的尺寸" tabindex="-1"><a class="header-anchor" href="#限制上传图片的尺寸" aria-hidden="true">#</a> 限制上传图片的尺寸</h3><p>设置文件上传尺寸限制</p><p>参数： <code>array</code> 单位为像素</p><ul><li><code>width</code> 指定宽度</li><li><code>height</code> 指定高度</li><li><code>min_width</code> 最小宽度</li><li><code>min_height</code> 最小高度</li><li><code>max_width</code> 最大宽度</li><li><code>max_height</code> 最大高度</li><li><code>ratio</code> 宽高比 (width/height)</li></ul><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token comment">// 上传宽度为100-300像素之间的图片</span>
<span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;img&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">dimensions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;min_width&#39;</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;max_width&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="把图片-文件路径保存在其他数据表" tabindex="-1"><a class="header-anchor" href="#把图片-文件路径保存在其他数据表" aria-hidden="true">#</a> 把图片/文件路径保存在其他数据表</h2><p>通过下面的方法可以把图片或文件的路径保存在单独的附件表，而当前的图片/文件字段只保存ID</p><blockquote><p>{tip} 这里的示例用的是单图上传表单，如果是多图的话可以按这个思路自行调整。</p></blockquote><p>图片/文件表结构</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>images<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>path<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">191</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>created_at<span class="token punctuation">\`</span></span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>updated_at<span class="token punctuation">\`</span></span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>MyISAM <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">4</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;image1&#39;</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">saving</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$form</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">isEditing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 编辑页面，删除图片逻辑</span>
            <span class="token class-name static-context">Image</span><span class="token operator">::</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">image1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 新增或编辑页面上传图片</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$model</span> <span class="token operator">=</span> <span class="token class-name static-context">Image</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;path&#39;</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$model</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$model</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token property">path</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>

        <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">customFormat</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token class-name static-context">Image</span><span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">array</span><span class="token punctuation">)</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">pluck</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="文件上传失败或无法访问" tabindex="-1"><a class="header-anchor" href="#文件上传失败或无法访问" aria-hidden="true">#</a> 文件上传失败或无法访问？</h2><p>如果你发现无法上传文件，那么通常有几下几点原因：</p>`,15),U=s("code",null,"Laravel",-1),L=s("code",null,"admin.upload.disk",-1),A=s("code",null,"laravel",-1),E={href:"https://learnku.com/docs/laravel/7.x/filesystem/7485",target:"_blank",rel:"noopener noreferrer"},S=s("li",null,[n("文件过大，需要调整"),s("code",null,"php.ini"),n("的"),s("code",null,"upload_max_filesize"),n("参数")],-1),N=s("li",null,"文件上传目录没有写权限",-1),T=s("li",null,[s("code",null,"php"),n("没有安装或没有开启"),s("code",null,"fileinfo"),n("扩展")],-1),I=s("p",null,[n("如果你的文件上传成功了，却无法正常访问，那么可能是"),s("code",null,".env"),n("配置文件中的"),s("code",null,"APP_URL"),n("参数没有设置正确。")],-1);function F(z,C){const o=p("RouterLink"),e=p("ExternalLinkIcon");return l(),c("div",null,[d,s("p",null,[a(o,{to:"/zh/guide/model-form.html"},{default:u(()=>[n("数据表单")]),_:1}),n("通过以下的调用来生成图片/文件上传表单，支持本地和云存储的文件上传。上传组件是基于"),s("a",k,[n("webuploader"),a(e)]),n("实现的，具体的使用配置可参考"),s("a",v,[n("webuploader官方文档"),a(e)]),n("。")]),g,s("p",null,[n("首先安装 "),s("a",m,[n("zgldh/qiniu-laravel-storage"),a(e)])]),b,s("p",null,[n("自定义"),s("a",h,[n("webuploader"),a(e)]),n("配置")]),f,s("p",null,[n("通过 "),q,n(" 方法可以监听 "),s("a",$,[n("WebUploader文件上传相关事件"),a(e)])]),x,s("p",null,[n("可以使用压缩、裁切、添加水印等各种方法,需要先安装"),s("a",y,[n("intervention/image"),a(e)]),n(".")]),s("p",null,[n("更多使用方法请参考["),s("a",_,[n("Intervention"),a(e)]),n("]：")]),w,s("ol",null,[s("li",null,[U,n("文件上传配置不正确，请检查"),L,n("参数。如果你不了解"),A,n("文件上传功能，请阅读文档"),s("a",E,[n("Laravel - 文件存储"),a(e)])]),S,N,T]),I])}const D=i(r,[["render",F],["__file","model-form-upload.html.vue"]]);export{D as default};
