<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>等待或返回 fork 的子进程状态</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.pcntl-unshare.html">? pcntl_unshare</a></li>
      <li style="float: right;"><a href="function.pcntl-waitpid.html">pcntl_waitpid ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.pcntl.html">PCNTL 函数</a></li>
    <li>等待或返回 fork 的子进程状态</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.pcntl-wait" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">pcntl_wait</h1>
  <p class="verinfo">(PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">pcntl_wait</span> &mdash; <span class="dc-title">等待或返回 fork 的子进程状态</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.pcntl-wait-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>pcntl_wait</strong></span>(<span class="methodparam"><span class="type">int</span> <code class="parameter reference">&$status</code></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code><span class="initializer"> = 0</span></span>, <span class="methodparam"><span class="type">array</span> <code class="parameter reference">&$resource_usage</code><span class="initializer"> = []</span></span>): <span class="type">int</span></div>

  <p class="para rdfs-comment">
   wait 函数挂起当前进程的执行直到一个子进程退出或接收到一个信号要求中断当前进程或调用一个信号处理函数。如果一个子进程在调用此函数时已经退出（俗称僵尸进程），此函数立刻返回。子进程使用的所有系统资源将被释放。关于 wait 在您系统上工作的详细规范请查看您系统的 wait（2）手册。
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    这个函数等同于以 <code class="literal">-1</code> 作为参数 <code class="parameter">process_id</code>
    的值并且没有 <code class="parameter">flags</code> 参数来调用 <span class="function"><a href="function.pcntl-waitpid.html" class="function">pcntl_waitpid()</a></span>
    函数。
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.pcntl-wait-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">status</code></dt>

     <dd>

      <p class="para">
       <span class="function"><strong>pcntl_wait()</strong></span> 将会存储状态信息到 <code class="parameter">status</code>
       参数上，这个通过 <code class="parameter">status</code> 参数返回的状态信息可以用以下函数
       <span class="function"><a href="function.pcntl-wifexited.html" class="function">pcntl_wifexited()</a></span>、
       <span class="function"><a href="function.pcntl-wifstopped.html" class="function">pcntl_wifstopped()</a></span>、
       <span class="function"><a href="function.pcntl-wifsignaled.html" class="function">pcntl_wifsignaled()</a></span>、
       <span class="function"><a href="function.pcntl-wexitstatus.html" class="function">pcntl_wexitstatus()</a></span>、
       <span class="function"><a href="function.pcntl-wtermsig.html" class="function">pcntl_wtermsig()</a></span> 以及
       <span class="function"><a href="function.pcntl-wstopsig.html" class="function">pcntl_wstopsig()</a></span> 获取其具体的值。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">flags</code></dt>

     <dd>

      <p class="para">
      如果操作系统（多数 BSD 类系统）允许使用 wait3，可以提供可选的 <code class="parameter">flags</code>
      参数。如果这个参数没有提供，wait 将会被用作系统调用。如果 wait3 不可用，提供参数
      <code class="parameter">flags</code> 不会有任何效果。<code class="parameter">flags</code> 的值可以是以下两个常量中
      0 个或多个 <code class="literal">OR</code> 运算的结果：
       <table class="doctable table">
        <caption><strong><code class="parameter">flags</code> 可用值</strong></caption>
        
         <tbody class="tbody">
          <tr>
           <td><code class="literal">WNOHANG</code></td>
           <td>
            如果没有子进程退出立刻返回。
           </td>
          </tr>

          <tr>
           <td><code class="literal">WUNTRACED</code></td>
           <td>
           子进程已经退出并且其状态未报告时返回。
           </td>
          </tr>

         </tbody>
        
       </table>

      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.pcntl-wait-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   <span class="function"><strong>pcntl_wait()</strong></span> 返回退出的子进程进程号，发生错误时返回 -1，如果提供了 WNOHANG 作为 option（wait3 可用的系统）并且没有可用子进程时返回 0。
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.pcntl-wait-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.pcntl-fork.html" class="function" rel="rdfs-seeAlso">pcntl_fork()</a> - 在当前进程当前位置产生分叉（fork）</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-signal.html" class="function" rel="rdfs-seeAlso">pcntl_signal()</a> - 安装信号处理程序</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wifexited.html" class="function" rel="rdfs-seeAlso">pcntl_wifexited()</a> - 检查状态代码是否代表一个正常的退出</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wifstopped.html" class="function" rel="rdfs-seeAlso">pcntl_wifstopped()</a> - 检查子进程当前是否已经停止</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wifsignaled.html" class="function" rel="rdfs-seeAlso">pcntl_wifsignaled()</a> - 检查子进程状态码是否代表由于某个信号而中断</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wexitstatus.html" class="function" rel="rdfs-seeAlso">pcntl_wexitstatus()</a> - 返回一个中断的子进程的返回代码</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wtermsig.html" class="function" rel="rdfs-seeAlso">pcntl_wtermsig()</a> - 返回导致子进程中断的信号</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wstopsig.html" class="function" rel="rdfs-seeAlso">pcntl_wstopsig()</a> - 返回导致子进程停止的信号</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-waitpid.html" class="function" rel="rdfs-seeAlso">pcntl_waitpid()</a> - 等待或返回 fork 的子进程状态</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="98712""></a>
  <div class="note">
   <strong class="user">duerra at yahoo dot com</strong>
   <a href="#98712" class="date">01-Jul-2010 07:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Oops, I stripped just a little much from the job daemon code in the previous comment.&nbsp; You'll want to add a little line before the -&gt;launchJob() method is called:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">while(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">) &gt;= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">maxProcesses</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Maximum children allowed, waiting...\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">); <br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98710""></a>
  <div class="note">
   <strong class="user">duerra at yahoo dot com</strong>
   <a href="#98710" class="date">01-Jul-2010 06:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Using pcntl_fork() can be a little tricky in some situations.&nbsp; For fast jobs, a child can finish processing before the parent process has executed some code related to the launching of the process.&nbsp; The parent can receive a signal before it's ready to handle the child process' status.&nbsp; To handle this scenario, I add an id to a "queue" of processes in the signal handler that need to be cleaned up if the parent process is not yet ready to handle them.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">declare(</span><span class="default">ticks</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">);<br />
</span><span class="comment">//A very basic job daemon that you can extend to your needs.&nbsp; <br />
</span><span class="keyword">class </span><span class="default">JobDaemon</span><span class="keyword">{<br />
<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$maxProcesses </span><span class="keyword">= </span><span class="default">25</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$jobsStarted </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; <br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$currentJobs </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$signalQueue</span><span class="keyword">=array();&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$parentPID</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"constructed \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">parentPID </span><span class="keyword">= </span><span class="default">getmypid</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGCHLD</span><span class="keyword">, array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"childSignalHandler"</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/** <br />
&nbsp;&nbsp;&nbsp; * Run the Daemon<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">run</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Running \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">10000</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$jobID </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">10000000000000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$launched </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">launchJob</span><span class="keyword">(</span><span class="default">$jobID</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Wait for child processes to finish before exiting here<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Waiting for current jobs to finish... \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/** <br />
&nbsp;&nbsp;&nbsp; * Launch a job from the job queue<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">protected function </span><span class="default">launchJob</span><span class="keyword">(</span><span class="default">$jobID</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$pid </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Problem launching the job<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">error_log</span><span class="keyword">(</span><span class="string">'Could not launch new job, exiting'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else if (</span><span class="default">$pid</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Parent process<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // Sometimes you can receive a signal to the childSignalHandler function before this code executes if <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // the child script executes quickly enough!<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">] = </span><span class="default">$jobID</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// In the event that a signal for this pid was caught before we get here, it will be in our signalQueue array<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // So let's go ahead and process it now as if we'd just received the signal<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(isset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">])){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"found </span><span class="default">$pid</span><span class="string"> in the signal queue, processing it now \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">childSignalHandler</span><span class="keyword">(</span><span class="default">SIGCHLD</span><span class="keyword">, </span><span class="default">$pid</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Forked child, do your deeds.... <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$exitStatus </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">//Error code if you need to or whatever<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"Doing something fun in pid "</span><span class="keyword">.</span><span class="default">getmypid</span><span class="keyword">().</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; exit(</span><span class="default">$exitStatus</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">childSignalHandler</span><span class="keyword">(</span><span class="default">$signo</span><span class="keyword">, </span><span class="default">$pid</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//If no pid is provided, that means we're getting the signal from the system.&nbsp; Let's figure out<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; //which child process ended<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(!</span><span class="default">$pid</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_waitpid</span><span class="keyword">(-</span><span class="default">1</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">, </span><span class="default">WNOHANG</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Make sure we get all of the exited children<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while(</span><span class="default">$pid </span><span class="keyword">&gt; </span><span class="default">0</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$pid </span><span class="keyword">&amp;&amp; isset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">])){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$exitCode </span><span class="keyword">= </span><span class="default">pcntl_wexitstatus</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$exitCode </span><span class="keyword">!= </span><span class="default">0</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"</span><span class="default">$pid</span><span class="string"> exited with status "</span><span class="keyword">.</span><span class="default">$exitCode</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else if(</span><span class="default">$pid</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Oh no, our job has finished before this parent process could even note that it had been launched!<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //Let's make note of it and handle it when the parent process is ready for it<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"..... Adding </span><span class="default">$pid</span><span class="string"> to the signal queue ..... \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">] = </span><span class="default">$status</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_waitpid</span><span class="keyword">(-</span><span class="default">1</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">, </span><span class="default">WNOHANG</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98534""></a>
  <div class="note">
   <strong class="user">digitalaudiorock at gmail dot com</strong>
   <a href="#98534" class="date">21-Jun-2010 02:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was unable to get pcntl_wait or pcntl_waitpid to terminate when I had an active signal handler.&nbsp; I then noticed the post below from gaylord at 100days dot de, however I'm a little confused by that post as I found the exact opposite to be true.&nbsp; The default value of the third parameter of pcntl_signal (the restart_syscalls parameter) is true and this seems to cause the wait to continue when the signal arrives.&nbsp; In order to prevent this I had to expressly set it to false.&nbsp; That is:<br />
<br />
pcntl_signal(SIGTERM, 'my_handler_function', false);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98450""></a>
  <div class="note">
   <strong class="user">gaylord at 100days dot de</strong>
   <a href="#98450" class="date">16-Jun-2010 05:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
pcntl_wait will not terminate on signals if you have a PHP signal handler activated (pcntl_signal).<br />
This is unless the signal handler was activated with 3rd parameter=true.<br />
<br />
Example:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">declare(</span><span class="default">ticks</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">);<br />
</span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGTERM</span><span class="keyword">, </span><span class="string">"myHandler"</span><span class="keyword">);<br />
</span><span class="default">$pid</span><span class="keyword">=</span><span class="default">pcntl_wait</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
This will not terminate on SIGTERM sent to the process, because "wait" will be restarted after php recieves the signal. The signal handler "myHandler" will not be called unless pcntl_wait terminates for some other reason.<br />
<br />
Change to:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">declare(</span><span class="default">ticks</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">);<br />
</span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGTERM</span><span class="keyword">, </span><span class="string">"myHandler"</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
</span><span class="default">$pid</span><span class="keyword">=</span><span class="default">pcntl_wait</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Now the pcntl_wait terminates when a signal comes in and "myHandler" will be called on SIGTERM. (Make sure to put the wait in a loop though, because it will now not only terminate when a child exits but also when a signal arrives. Test for $pid&gt;0 to detect a exit message from a child)<br />
(thanks to Andrey for helping me debugging this)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="63594""></a>
  <div class="note">
   <strong class="user">thomas dot nicolai at unisg dot ch</strong>
   <a href="#63594" class="date">24-Mar-2006 11:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The code before isnt working for me cause the children are correctly started but not refreshed after they died. So keep in mind to use this instead and use the signal handler to know when a child exits to know when you have to start a new one. I added a few lines to the posting from {andy at cbeyond dot net} cause his post wasnt working for me as well (PHP5.1). Same effect like the one below.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">declare(</span><span class="default">ticks </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">);<br />
<br />
</span><span class="default">$max</span><span class="keyword">=</span><span class="default">5</span><span class="keyword">;<br />
</span><span class="default">$child</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
<br />
</span><span class="comment">// function for signal handler<br />
</span><span class="keyword">function </span><span class="default">sig_handler</span><span class="keyword">(</span><span class="default">$signo</span><span class="keyword">) {<br />
&nbsp; global </span><span class="default">$child</span><span class="keyword">;<br />
&nbsp; switch (</span><span class="default">$signo</span><span class="keyword">) {<br />
&nbsp;&nbsp; case </span><span class="default">SIGCHLD</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; echo </span><span class="string">"SIGCHLD received\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$child</span><span class="keyword">--;<br />
&nbsp; }<br />
}<br />
<br />
</span><span class="comment">// install signal handler for dead kids<br />
</span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGCHLD</span><span class="keyword">, </span><span class="string">"sig_handler"</span><span class="keyword">);<br />
<br />
while (</span><span class="default">1</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$child</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$pid</span><span class="keyword">=</span><span class="default">pcntl_fork</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; if (</span><span class="default">$pid </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; die(</span><span class="string">"could not fork"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; } else if (</span><span class="default">$pid</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// we are the parent<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if ( </span><span class="default">$child </span><span class="keyword">&gt;= </span><span class="default">$max </span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">pcntl_wait</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$child</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// we are the child<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">echo </span><span class="string">"\t Starting new child | now we de have </span><span class="default">$child</span><span class="string"> child processes\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// presumably doing something interesting<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">,</span><span class="default">5</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit;<br />
&nbsp;&nbsp; &nbsp; &nbsp; }<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62099""></a>
  <div class="note">
   <strong class="user">federico at nextware dot it</strong>
   <a href="#62099" class="date">19-Feb-2006 04:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This a simple multi process application where you can choose 
<br />
the maximun process that can run at the same time.
<br />
This is useful when you need to limit the fork of process.
<br />
When the MAXPROCESS is reached the program wait on pcntl_wait()
<br />

<br />
<span class="default">&lt;?php
<br />

<br />
DEFINE</span><span class="keyword">(</span><span class="default">MAXPROCESS</span><span class="keyword">,</span><span class="default">25</span><span class="keyword">);
<br />

<br />
for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">100</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++){
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$pid </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; die(</span><span class="string">"could not fork"</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; } elseif (</span><span class="default">$pid</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"I'm the Parent </span><span class="default">$i</span><span class="string">\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$execute</span><span class="keyword">++;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$execute</span><span class="keyword">&gt;=</span><span class="default">MAXPROCESS</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_wait</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$execute</span><span class="keyword">--;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; } else {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; echo </span><span class="string">"I am the child, </span><span class="default">$i</span><span class="string"> pid = </span><span class="default">$pid</span><span class="string"> \n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">,</span><span class="default">3</span><span class="keyword">));
<br />
&nbsp;&nbsp; &nbsp; &nbsp; echo </span><span class="string">"Bye Bye from </span><span class="default">$i</span><span class="string">\n"</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; exit;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57932""></a>
  <div class="note">
   <strong class="user">thisisroot at gmail dot com</strong>
   <a href="#57932" class="date">19-Oct-2005 07:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Below is a simple example of forking some children and timing the total duration (useful for stress tests).<br />
<br />
<span class="default">&lt;?php<br />
<br />
$isParent&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
</span><span class="default">$children&nbsp; &nbsp; </span><span class="keyword">= array();<br />
</span><span class="default">$start&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">( </span><span class="default">true</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* Fork you!<br />
&nbsp;* (Sorry, I had to)<br />
&nbsp;*/<br />
</span><span class="default">$ceiling </span><span class="keyword">= </span><span class="default">$CONCURRENCY </span><span class="keyword">- </span><span class="default">1</span><span class="keyword">;<br />
<br />
for ( </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; (( </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$ceiling</span><span class="keyword">) &amp;&amp; ( </span><span class="default">$isParent</span><span class="keyword">)); </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; if ( </span><span class="default">$pid </span><span class="keyword">=== </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$isParent </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; } elseif ( </span><span class="default">$pid </span><span class="keyword">!= -</span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$children</span><span class="keyword">[] = </span><span class="default">$pid</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
}<br />
<br />
</span><span class="comment">/* Process body */<br />
</span><span class="keyword">echo </span><span class="string">"Do stuff here\n"</span><span class="keyword">;<br />
<br />
</span><span class="comment">/* Cleanup */<br />
</span><span class="keyword">if ( </span><span class="default">$isParent</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$status </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; while ( </span><span class="default">count</span><span class="keyword">( </span><span class="default">$children</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_wait</span><span class="keyword">( </span><span class="default">$status</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">array_pop</span><span class="keyword">( </span><span class="default">$children</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Completed in " </span><span class="keyword">. ( </span><span class="default">microtime</span><span class="keyword">( </span><span class="default">true</span><span class="keyword">) - </span><span class="default">$start</span><span class="keyword">) . </span><span class="string">" seconds.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
