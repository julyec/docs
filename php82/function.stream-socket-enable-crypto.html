<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>Turns encryption on/off on an already connected socket</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.stream-socket-client.html">? stream_socket_client</a></li>
      <li style="float: right;"><a href="function.stream-socket-get-name.html">stream_socket_get_name ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.stream.html">Stream 函数</a></li>
    <li>Turns encryption on/off on an already connected socket</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.stream-socket-enable-crypto" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">stream_socket_enable_crypto</h1>
  <p class="verinfo">(PHP 5 &gt;= 5.1.0, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">stream_socket_enable_crypto</span> &mdash; <span class="dc-title">Turns encryption on/off on an already connected socket</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.stream-socket-enable-crypto-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>stream_socket_enable_crypto</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">resource</span> <code class="parameter">$stream</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">bool</span> <code class="parameter">$enable</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">int</span><span class="type"></span></span> <code class="parameter">$crypto_method</code><span class="initializer"> = <strong><code>null</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">resource</span><span class="type"></span></span> <code class="parameter">$session_stream</code><span class="initializer"> = <strong><code>null</code></strong></span></span><br>): <span class="type"><span class="type">int</span>|<span class="type">bool</span></span></div>


  <p class="simpara">
   Enable or disable encryption on the stream.
  </p>

  <p class="simpara">
   Once the crypto settings are established, cryptography can be turned
   on and off dynamically by passing <strong><code>true</code></strong> or <strong><code>false</code></strong> in the
   <code class="parameter">enable</code> parameter.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.stream-socket-enable-crypto-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">stream</code></dt>

     <dd>

      <p class="para">
       The stream resource.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">enable</code></dt>

     <dd>

      <p class="para">
       Enable/disable cryptography on the stream.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">crypto_method</code></dt>

     <dd>

      <p class="para">
       Setup encryption on the stream.
       Valid methods are
       <ul class="itemizedlist">
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_SSLv2_CLIENT</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_SSLv3_CLIENT</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_SSLv23_CLIENT</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_ANY_CLIENT</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLS_CLIENT</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLSv1_0_CLIENT</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLSv1_1_CLIENT</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLSv1_2_CLIENT</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLSv1_3_CLIENT</code></strong> (as of PHP 7.4.0)</span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_SSLv2_SERVER</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_SSLv3_SERVER</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_SSLv23_SERVER</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_ANY_SERVER</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLS_SERVER</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLSv1_0_SERVER</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLSv1_1_SERVER</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLSv1_2_SERVER</code></strong></span></li>
        <li class="listitem"><span class="simpara"><strong><code>STREAM_CRYPTO_METHOD_TLSv1_3_SERVER</code></strong> (as of PHP 7.4.0)</span></li>
       </ul>
      </p>
      <p class="para">
       If omitted, the <code class="literal">crypto_method</code> context option on
       the stream&#039;s SSL context will be used instead.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">session_stream</code></dt>

     <dd>

      <p class="para">
       Seed the stream with settings from <code class="parameter">session_stream</code>.
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.stream-socket-enable-crypto-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   Returns <strong><code>true</code></strong> on success, <strong><code>false</code></strong> if negotiation has failed or
   <code class="literal">0</code> if there isn&#039;t enough data and you should try again
   (only for non-blocking sockets).
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.stream-socket-enable-crypto-changelog">
  <h3 class="title">更新日志</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>版本</th>
      <th>说明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>8.0.0</td>
      <td>
       <code class="parameter">session_stream</code> is now nullable.
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>

 
 <div class="refsect1 examples" id="refsect1-function.stream-socket-enable-crypto-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="">
    <p><strong>Example #1 <span class="function"><strong>stream_socket_enable_crypto()</strong></span> example</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$fp </span><span style="color: #007700">= </span><span style="color: #0000BB">stream_socket_client</span><span style="color: #007700">(</span><span style="color: #DD0000">"tcp://myproto.example.com:31337"</span><span style="color: #007700">, </span><span style="color: #0000BB">$errno</span><span style="color: #007700">, </span><span style="color: #0000BB">$errstr</span><span style="color: #007700">, </span><span style="color: #0000BB">30</span><span style="color: #007700">);<br />if (!</span><span style="color: #0000BB">$fp</span><span style="color: #007700">) {<br />    die(</span><span style="color: #DD0000">"Unable to connect: </span><span style="color: #0000BB">$errstr</span><span style="color: #DD0000"> (</span><span style="color: #0000BB">$errno</span><span style="color: #DD0000">)"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/* Turn on encryption for login phase */<br /></span><span style="color: #0000BB">stream_socket_enable_crypto</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">true</span><span style="color: #007700">, </span><span style="color: #0000BB">STREAM_CRYPTO_METHOD_SSLv23_CLIENT</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #DD0000">"USER god\r\n"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #DD0000">"PASS secret\r\n"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/* Turn off encryption for the rest */<br /></span><span style="color: #0000BB">stream_socket_enable_crypto</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">false</span><span style="color: #007700">);<br /><br />while (</span><span style="color: #0000BB">$motd </span><span style="color: #007700">= </span><span style="color: #0000BB">fgets</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">)) {<br />    echo </span><span style="color: #0000BB">$motd</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上示例的输出类似于：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
</pre></div>
    </div>
   </div>
  </p>
 </div>

 
 <div class="refsect1 seealso" id="refsect1-function.stream-socket-enable-crypto-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><a href="ref.openssl.html" class="xref">OpenSSL 函数</a></li>
    <li class="member"><a href="transports.html" class="xref">所支持的套接字传输器列表</a></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="126761""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#126761" class="date">13-Jan-2022 05:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you need to change a stream from unencrypted to crypted after unencrypted traffic has been processed, you use the stream-socket-recvfrom function to read instead of fread when reading the unencrypted traffic. Using fread will cause some of the buffer of the initial CLIENT HELLO message to be read into it's buffers causing the SSL handshake to fail in some situations.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="122958""></a>
  <div class="note">
   <strong class="user">cgy at anymacro dot com</strong>
   <a href="#122958" class="date">19-Jul-2018 09:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
$context = stream_context_create();<br />
stream_context_set_option($context, 'ssl', 'allow_self_signed', false);<br />
stream_context_set_option($context, 'ssl', 'verify_peer', false);<br />
stream_context_set_option($context, 'ssl', 'verify_peer_name', false);<br />
$fp = stream_socket_client("unix:///tmp/ssl.sock", $errno, $errstr, 30,STREAM_CLIENT_ASYNC_CONNECT | STREAM_CLIENT_CONNECT,$context);<br />
<br />
stream_socket_enable_crypto($fp, true, STREAM_CRYPTO_METHOD_TLS_CLIENT);<br />
<br />
错误提示：<br />
PHP Warning:&nbsp; stream_socket_enable_crypto(): this stream does not support SSL/crypto</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119122""></a>
  <div class="note">
   <strong class="user">bobe at webnaute dot net</strong>
   <a href="#119122" class="date">05-Apr-2016 06:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Constants added in PHP 5.6 :<br />
<br />
STREAM_CRYPTO_METHOD_ANY_CLIENT<br />
STREAM_CRYPTO_METHOD_TLSv1_0_CLIENT<br />
STREAM_CRYPTO_METHOD_TLSv1_1_CLIENT<br />
STREAM_CRYPTO_METHOD_TLSv1_2_CLIENT<br />
STREAM_CRYPTO_METHOD_ANY_SERVER<br />
STREAM_CRYPTO_METHOD_TLSv1_0_SERVER<br />
STREAM_CRYPTO_METHOD_TLSv1_1_SERVER<br />
STREAM_CRYPTO_METHOD_TLSv1_2_SERVER<br />
<br />
Now, be careful because since PHP 5.6.7, STREAM_CRYPTO_METHOD_TLS_CLIENT (same for _SERVER) no longer means any tls version but tls 1.0 only (for "backward compatibility"...).<br />
<br />
Before PHP 5.6.7 :<br />
STREAM_CRYPTO_METHOD_SSLv23_CLIENT = STREAM_CRYPTO_METHOD_SSLv2_CLIENT|STREAM_CRYPTO_METHOD_SSLv3_CLIENT<br />
STREAM_CRYPTO_METHOD_TLS_CLIENT = STREAM_CRYPTO_METHOD_TLSv1_0_CLIENT|STREAM_CRYPTO_METHOD_TLSv1_1_CLIENT|STREAM_CRYPTO_METHOD_TLSv1_2_CLIENT<br />
<br />
PHP &gt;= 5.6.7<br />
STREAM_CRYPTO_METHOD_SSLv23_CLIENT = STREAM_CRYPTO_METHOD_TLSv1_0_CLIENT|STREAM_CRYPTO_METHOD_TLSv1_1_CLIENT|STREAM_CRYPTO_METHOD_TLSv1_2_CLIENT<br />
STREAM_CRYPTO_METHOD_TLS_CLIENT = STREAM_CRYPTO_METHOD_TLSv1_0_CLIENT<br />
<br />
PHP bug : https://bugs.php.net/bug.php?id=69195<br />
Commit : https://github.com/php/php-src/commit/10bc5fd4c4c8e1dd57bd911b086e9872a56300a0<br />
<br />
STREAM_CRYPTO_METHOD_SSLv23_CLIENT is not safe to use because before php 5.6.7, it means sslv2 or sslv3. So, you should do this :<br />
<span class="default">&lt;?php<br />
$crypto_method </span><span class="keyword">= </span><span class="default">STREAM_CRYPTO_METHOD_TLS_CLIENT</span><span class="keyword">;<br />
<br />
if (</span><span class="default">defined</span><span class="keyword">(</span><span class="string">'STREAM_CRYPTO_METHOD_TLSv1_2_CLIENT'</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$crypto_method </span><span class="keyword">|= </span><span class="default">STREAM_CRYPTO_METHOD_TLSv1_2_CLIENT</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$crypto_method </span><span class="keyword">|= </span><span class="default">STREAM_CRYPTO_METHOD_TLSv1_1_CLIENT</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">stream_socket_enable_crypto</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">, </span><span class="default">$crypto_method</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116915""></a>
  <div class="note">
   <strong class="user">bobe at webnaute dot net</strong>
   <a href="#116915" class="date">20-Mar-2015 04:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There is an error in the description of the third argument:<br />
"If omitted, the crypto_type context option on the stream's SSL context will be used instead."<br />
<br />
The name of the context option is "crypto_method", NOT "crypto_type" which is just the name of the argument.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79001""></a>
  <div class="note">
   <strong class="user">mark at kinoko dot fr</strong>
   <a href="#79001" class="date">06-Nov-2007 11:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just to avoid letting you search everywhere why your code doesn't work when using this function to enable crypto as a server, and when using TLS, you have to put the certificate in the "ssl" context, even if you start a TLS, SSLv3, etc.. server.<br />
<br />
I had some troubles because of that...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75442""></a>
  <div class="note">
   <strong class="user">tigger (AT) tiggerswelt d0t net</strong>
   <a href="#75442" class="date">30-May-2007 03:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As already mentioned above:<br />
<br />
stream_socket_enable_crypto is likely to fail/return zero if the socket is in non-blocking mode.<br />
<br />
You may either wait some seconds until all neccessary data has arrived or switch temporary to blocking mode:<br />
<br />
<span class="default">&lt;?PHP<br />
<br />
&nbsp; stream_set_blocking </span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
&nbsp; </span><span class="default">stream_socket_enable_crypto </span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">, </span><span class="default">STREAM_CRYPTO_METHOD_TLS_CLIENT</span><span class="keyword">);<br />
&nbsp; </span><span class="default">stream_set_blocking </span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
This works very fine for me ;-)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
