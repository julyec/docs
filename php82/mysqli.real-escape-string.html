<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>根据当前连接的字符集，对于 SQL 语句中的特殊字符进行转义</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqli.real-connect.html">? mysqli::real_connect</a></li>
      <li style="float: right;"><a href="mysqli.real-query.html">mysqli::real_query ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="class.mysqli.html">mysqli</a></li>
    <li>根据当前连接的字符集，对于 SQL 语句中的特殊字符进行转义</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqli.real-escape-string" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mysqli::real_escape_string</h1>
  <h1 class="refname">mysqli_real_escape_string</h1>
  <p class="verinfo">(PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">mysqli::real_escape_string</span> -- <span class="refname">mysqli_real_escape_string</span> &mdash; <span class="dc-title">根据当前连接的字符集，对于 SQL 语句中的特殊字符进行转义</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-mysqli.real-escape-string-description">
  <h3 class="title">说明</h3>
  <p class="para">面向对象风格</p>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="methodname"><strong>mysqli::real_escape_string</strong></span>(<span class="methodparam"><span class="type">string</span> <code class="parameter">$string</code></span>): <span class="type">string</span></div>

  <p class="para rdfs-comment">过程化风格</p>
  <div class="methodsynopsis dc-description"><span class="methodname"><strong>mysqli_real_escape_string</strong></span>(<span class="methodparam"><span class="type"><a href="class.mysqli.html" class="type mysqli">mysqli</a></span> <code class="parameter">$mysql</code></span>, <span class="methodparam"><span class="type">string</span> <code class="parameter">$string</code></span>): <span class="type">string</span></div>

  <p class="para rdfs-comment">
   此函数用于创建可在 SQL 语句中使用的合法 SQL 字符串。考虑到连接的当前字符集，对指定的字符串进行编码以生成转义的 SQL 字符串。
  </p>
  <div class="caution"><strong class="caution">Caution</strong>
   <h1 class="title">安全：默认字符集</h1>
   <p class="para">
    字符集必须在服务器级别设置，或者使用 API 函数 <span class="function"><a href="mysqli.set-charset.html" class="function">mysqli_set_charset()</a></span>
    影响 <span class="function"><strong>mysqli_real_escape_string()</strong></span>。参阅<a href="mysqlinfo.concepts.charset.html" class="link">字符集</a>的概念（concepts）部分。
   </p>
  </div>
 </div>


 <div class="refsect1 parameters" id="refsect1-mysqli.real-escape-string-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    <dt>

<code class="parameter">mysql</code></dt>
<dd>
<p class="para">仅以过程化样式：由<span class="function"><a href="function.mysqli-connect.html" class="function">mysqli_connect()</a></span> 或 <span class="function"><a href="mysqli.init.html" class="function">mysqli_init()</a></span>
返回的 <span class="classname"><a href="class.mysqli.html" class="classname">mysqli</a></span> 对象。</p></dd>

    
     <dt>
<code class="parameter">string</code></dt>

     <dd>

      <p class="para">
       需要进行转义的字符串。
      </p>
      <p class="para">
       会被进行转义的字符包括：<code class="literal">NUL（ASCII 0）、\n、\r、\、&#039;、&quot; 和
       Control-Z</code>。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-mysqli.real-escape-string-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   返回转义后的字符串。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-mysqli.real-escape-string-examples">
  <h3 class="title">示例</h3>
  <div class="example" id="example-2968">
   <p><strong>Example #1 <span class="methodname"><strong>mysqli::real_escape_string()</strong></span> 示例</strong></p>
   <div class="example-contents"><p>面向对象风格</p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />mysqli_report</span><span style="color: #007700">(</span><span style="color: #0000BB">MYSQLI_REPORT_ERROR </span><span style="color: #007700">| </span><span style="color: #0000BB">MYSQLI_REPORT_STRICT</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli </span><span style="color: #007700">= new </span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">, </span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">, </span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">, </span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$city </span><span style="color: #007700">= </span><span style="color: #DD0000">"'s-Hertogenbosch"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/* 对 $city 转义，此查询运行正常 */<br /></span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT CountryCode FROM City WHERE name='%s'"</span><span style="color: #007700">,<br />    </span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">real_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$city</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Select returned %d rows.\n"</span><span style="color: #007700">, </span><span style="color: #0000BB">$result</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">num_rows</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/* 未转义 $city，此查询运行失败 */<br /></span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT CountryCode FROM City WHERE name='%s'"</span><span style="color: #007700">, </span><span style="color: #0000BB">$city</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">);</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>过程化风格</p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />mysqli_report</span><span style="color: #007700">(</span><span style="color: #0000BB">MYSQLI_REPORT_ERROR </span><span style="color: #007700">| </span><span style="color: #0000BB">MYSQLI_REPORT_STRICT</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli </span><span style="color: #007700">= </span><span style="color: #0000BB">mysqli_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">, </span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">, </span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">, </span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$city </span><span style="color: #007700">= </span><span style="color: #DD0000">"'s-Hertogenbosch"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/* 对 $city 转义，此查询运行正常 */<br /></span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT CountryCode FROM City WHERE name='%s'"</span><span style="color: #007700">,<br />    </span><span style="color: #0000BB">mysqli_real_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">, </span><span style="color: #0000BB">$city</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">mysqli_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">, </span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Select returned %d rows.\n"</span><span style="color: #007700">, </span><span style="color: #0000BB">mysqli_num_rows</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">/* 未转义 $city，此查询运行失败 */<br /></span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT CountryCode FROM City WHERE name='%s'"</span><span style="color: #007700">, </span><span style="color: #0000BB">$city</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">mysqli_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">, </span><span style="color: #0000BB">$query</span><span style="color: #007700">);</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>以上示例的输出类似于：</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
Select returned 1 rows.

Fatal error: Uncaught mysqli_sql_exception: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#039;s-Hertogenbosch&#039;&#039; at line 1 in...
</pre></div>
   </div>
  </div>
 </div>


 <div class="refsect1 seealso" id="refsect1-mysqli.real-escape-string-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="mysqli.set-charset.html" class="function" rel="rdfs-seeAlso">mysqli_set_charset()</a> - 设置客户端字符集</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="125972""></a>
  <div class="note">
   <strong class="user">ASchmidt at Anamera dot net</strong>
   <a href="#125972" class="date">30-Mar-2021 04:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Caution when escaping the % and _ wildcard characters. According to an often overlooked note at the bottom of:<br />
&nbsp;<br />
https://dev.mysql.com/doc/refman/5.7/en/string-literals.html#character-escape-sequences<br />
<br />
the escape sequences \% and \_ will ONLY be interpreted as % and _, *if* they occur in a LIKE! (Same for MySQL 8.0)<br />
<br />
In regular string literals, the escape sequences \% and \_ are treated as those two character pairs. So if those escape sequences appear in a WHERE "=" instead of a WHERE LIKE, they would NOT match a single % or _ character!<br />
<br />
Consequently, one MUST use two "escape" functions: The real-escape-string (or equivalent) for regular string literals, and an amended escape function JUST for string literals that are intended to be used in LIKE.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="122016""></a>
  <div class="note">
   <strong class="user">Lawrence DOliveiro</strong>
   <a href="#122016" class="date">13-Dec-2017 03:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that the "like" operator requires an *additional* level of escaping for its special characters, *on top of* that performed by mysql_escape_string. But there is no built-in function for performing this escaping. Here is a function that does it:<br />
<br />
function escape_sql_wild($s)<br />
&nbsp; /* escapes SQL pattern wildcards in s. */<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; $result = array();<br />
&nbsp;&nbsp;&nbsp; foreach(str_split($s) as $ch)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ($ch == "\\" || $ch == "%" || $ch == "_")<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $result[] = "\\";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } /*if*/<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $result[] = $ch;<br />
&nbsp;&nbsp; &nbsp;&nbsp; } /*foreach*/<br />
&nbsp;&nbsp;&nbsp; return<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; implode("", $result);<br />
&nbsp; } /*escape_sql_wild*/</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121402""></a>
  <div class="note">
   <strong class="user">therselman at gmail dot com</strong>
   <a href="#121402" class="date">19-Jul-2017 08:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Presenting several UTF-8 / Multibyte-aware escape functions.<br />
<br />
These functions represent alternatives to mysqli::real_escape_string, as long as your DB connection and Multibyte extension are using the same character set (UTF-8), they will produce the same results by escaping the same characters as mysqli::real_escape_string.<br />
<br />
This is based on research I did for my SQL Query Builder class:<br />
https://github.com/twister-php/sql<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/**<br />
&nbsp;* Returns a string with backslashes before characters that need to be escaped.<br />
&nbsp;* As required by MySQL and suitable for multi-byte character sets<br />
&nbsp;* Characters encoded are NUL (ASCII 0), \n, \r, \, ', ", and ctrl-Z.<br />
&nbsp;*<br />
&nbsp;* @param string $string String to add slashes to<br />
&nbsp;* @return $string with `\` prepended to reserved characters <br />
&nbsp;*<br />
&nbsp;* @author Trevor Herselman<br />
&nbsp;*/<br />
</span><span class="keyword">if (</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'mb_ereg_replace'</span><span class="keyword">))<br />
{<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">mb_escape</span><span class="keyword">(</span><span class="default">string $string</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mb_ereg_replace</span><span class="keyword">(</span><span class="string">'[\x00\x0A\x0D\x1A\x22\x27\x5C]'</span><span class="keyword">, </span><span class="string">'\\\0'</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
} else {<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">mb_escape</span><span class="keyword">(</span><span class="default">string $string</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'~[\x00\x0A\x0D\x1A\x22\x27\x5C]~u'</span><span class="keyword">, </span><span class="string">'\\\$0'</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Characters escaped are (the same as mysqli::real_escape_string):<br />
<br />
00 = \0 (NUL)<br />
0A = \n<br />
0D = \r<br />
1A = ctl-Z<br />
22 = "<br />
27 = '<br />
5C = \<br />
<br />
Note: preg_replace() is in PCRE_UTF8 (UTF-8) mode (`u`).<br />
<br />
Enhanced version:<br />
<br />
When escaping strings for `LIKE` syntax, remember that you also need to escape the special characters _ and %<br />
<br />
So this is a more fail-safe version (even when compared to mysqli::real_escape_string, because % characters in user input can cause unexpected results and even security violations via SQL injection in LIKE statements):<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/**<br />
&nbsp;* Returns a string with backslashes before characters that need to be escaped.<br />
&nbsp;* As required by MySQL and suitable for multi-byte character sets<br />
&nbsp;* Characters encoded are NUL (ASCII 0), \n, \r, \, ', ", and ctrl-Z.<br />
&nbsp;* In addition, the special control characters % and _ are also escaped,<br />
&nbsp;* suitable for all statements, but especially suitable for `LIKE`.<br />
&nbsp;*<br />
&nbsp;* @param string $string String to add slashes to<br />
&nbsp;* @return $string with `\` prepended to reserved characters <br />
&nbsp;*<br />
&nbsp;* @author Trevor Herselman<br />
&nbsp;*/<br />
</span><span class="keyword">if (</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'mb_ereg_replace'</span><span class="keyword">))<br />
{<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">mb_escape</span><span class="keyword">(</span><span class="default">string $string</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mb_ereg_replace</span><span class="keyword">(</span><span class="string">'[\x00\x0A\x0D\x1A\x22\x25\x27\x5C\x5F]'</span><span class="keyword">, </span><span class="string">'\\\0'</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
} else {<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">mb_escape</span><span class="keyword">(</span><span class="default">string $string</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'~[\x00\x0A\x0D\x1A\x22\x25\x27\x5C\x5F]~u'</span><span class="keyword">, </span><span class="string">'\\\$0'</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Additional characters escaped:<br />
<br />
25 = %<br />
5F = _<br />
<br />
Bonus function:<br />
<br />
The original MySQL `utf8` character-set (for tables and fields) only supports 3-byte sequences.<br />
4-byte characters are not common, but I've had queries fail to execute on 4-byte UTF-8 characters, so you should be using `utf8mb4` wherever possible.<br />
<br />
However, if you still want to use `utf8`, you can use the following function to replace all 4-byte sequences.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Modified from: https://stackoverflow.com/a/24672780/2726557<br />
</span><span class="keyword">function </span><span class="default">mysql_utf8_sanitizer</span><span class="keyword">(</span><span class="default">string $str</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'/[\x{10000}-\x{10FFFF}]/u'</span><span class="keyword">, </span><span class="string">"\xEF\xBF\xBD"</span><span class="keyword">, </span><span class="default">$str</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Pick your poison and use at your own risk!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116946""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#116946" class="date">25-Mar-2015 09:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you wonder why (besides \, ' and ")&nbsp; NUL (ASCII 0), \n, \r, and Control-Z are escaped: it is not to prevent sql injection, but to prevent your sql logfile to get unreadable.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102639""></a>
  <div class="note">
   <strong class="user">dave at mausner.us</strong>
   <a href="#102639" class="date">25-Feb-2011 07:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can avoid all character escaping issues (on the PHP side) if you use prepare() and bind_param(), as an alternative to placing arbitrary string values in SQL statements.&nbsp; This works because bound parameter values are NOT passed via the SQL statement syntax.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96429""></a>
  <div class="note">
   <strong class="user">Josef Toman</strong>
   <a href="#96429" class="date">26-Feb-2010 06:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For percent sign and underscore I use this:<br />
<span class="default">&lt;?php<br />
$more_escaped </span><span class="keyword">= </span><span class="default">addcslashes</span><span class="keyword">(</span><span class="default">$escaped</span><span class="keyword">, </span><span class="string">'%_'</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="46339""></a>
  <div class="note">
   <strong class="user">arnoud at procurios dot nl</strong>
   <a href="#46339" class="date">07-Oct-2004 09:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that this function will NOT escape _ (underscore) and % (percent) signs, which have special meanings in LIKE clauses. <br />
<br />
As far as I know there is no function to do this, so you have to escape them yourself by adding a backslash in front of them.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
