<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>LDAP 函数</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="ldap.examples-controls.html">? LDAP Controls</a></li>
      <li style="float: right;"><a href="function.ldap-8859-to-t61.html">ldap_8859_to_t61 ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="book.ldap.html">LDAP</a></li>
    <li>LDAP 函数</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="ref.ldap" class="reference">
 <h1 class="title">LDAP 函数</h1>
 











































 





 






































































































































































































































































<h2>Table of Contents</h2><ul class="chunklist chunklist_reference"><li><a href="function.ldap-8859-to-t61.html">ldap_8859_to_t61</a> &mdash; Translate 8859 characters to t61 characters</li><li><a href="function.ldap-add-ext.html">ldap_add_ext</a> &mdash; Add entries to LDAP directory</li><li><a href="function.ldap-add.html">ldap_add</a> &mdash; Add entries to LDAP directory</li><li><a href="function.ldap-bind-ext.html">ldap_bind_ext</a> &mdash; Bind to LDAP directory</li><li><a href="function.ldap-bind.html">ldap_bind</a> &mdash; 绑定 LDAP 目录</li><li><a href="function.ldap-close.html">ldap_close</a> &mdash; 别名 ldap_unbind</li><li><a href="function.ldap-compare.html">ldap_compare</a> &mdash; Compare value of attribute found in entry specified with DN</li><li><a href="function.ldap-connect.html">ldap_connect</a> &mdash; Connect to an LDAP server</li><li><a href="function.ldap-control-paged-result-response.html">ldap_control_paged_result_response</a> &mdash; Retrieve the LDAP pagination cookie</li><li><a href="function.ldap-control-paged-result.html">ldap_control_paged_result</a> &mdash; Send LDAP pagination control</li><li><a href="function.ldap-count-entries.html">ldap_count_entries</a> &mdash; Count the number of entries in a search</li><li><a href="function.ldap-count-references.html">ldap_count_references</a> &mdash; Counts the number of references in a search result</li><li><a href="function.ldap-delete-ext.html">ldap_delete_ext</a> &mdash; Delete an entry from a directory</li><li><a href="function.ldap-delete.html">ldap_delete</a> &mdash; Delete an entry from a directory</li><li><a href="function.ldap-dn2ufn.html">ldap_dn2ufn</a> &mdash; Convert DN to User Friendly Naming format</li><li><a href="function.ldap-err2str.html">ldap_err2str</a> &mdash; Convert LDAP error number into string error message</li><li><a href="function.ldap-errno.html">ldap_errno</a> &mdash; Return the LDAP error number of the last LDAP command</li><li><a href="function.ldap-error.html">ldap_error</a> &mdash; Return the LDAP error message of the last LDAP command</li><li><a href="function.ldap-escape.html">ldap_escape</a> &mdash; Escape a string for use in an LDAP filter or DN</li><li><a href="function.ldap-exop-passwd.html">ldap_exop_passwd</a> &mdash; PASSWD extended operation helper</li><li><a href="function.ldap-exop-refresh.html">ldap_exop_refresh</a> &mdash; Refresh extended operation helper</li><li><a href="function.ldap-exop-whoami.html">ldap_exop_whoami</a> &mdash; WHOAMI extended operation helper</li><li><a href="function.ldap-exop.html">ldap_exop</a> &mdash; Performs an extended operation</li><li><a href="function.ldap-explode-dn.html">ldap_explode_dn</a> &mdash; Splits DN into its component parts</li><li><a href="function.ldap-first-attribute.html">ldap_first_attribute</a> &mdash; Return first attribute</li><li><a href="function.ldap-first-entry.html">ldap_first_entry</a> &mdash; Return first result id</li><li><a href="function.ldap-first-reference.html">ldap_first_reference</a> &mdash; Return first reference</li><li><a href="function.ldap-free-result.html">ldap_free_result</a> &mdash; Free result memory</li><li><a href="function.ldap-get-attributes.html">ldap_get_attributes</a> &mdash; Get attributes from a search result entry</li><li><a href="function.ldap-get-dn.html">ldap_get_dn</a> &mdash; Get the DN of a result entry</li><li><a href="function.ldap-get-entries.html">ldap_get_entries</a> &mdash; Get all result entries</li><li><a href="function.ldap-get-option.html">ldap_get_option</a> &mdash; Get the current value for given option</li><li><a href="function.ldap-get-values-len.html">ldap_get_values_len</a> &mdash; Get all binary values from a result entry</li><li><a href="function.ldap-get-values.html">ldap_get_values</a> &mdash; Get all values from a result entry</li><li><a href="function.ldap-list.html">ldap_list</a> &mdash; Single-level search</li><li><a href="function.ldap-mod_add-ext.html">ldap_mod_add_ext</a> &mdash; Add attribute values to current attributes</li><li><a href="function.ldap-mod-add.html">ldap_mod_add</a> &mdash; Add attribute values to current attributes</li><li><a href="function.ldap-mod_del-ext.html">ldap_mod_del_ext</a> &mdash; Delete attribute values from current attributes</li><li><a href="function.ldap-mod-del.html">ldap_mod_del</a> &mdash; Delete attribute values from current attributes</li><li><a href="function.ldap-mod_replace-ext.html">ldap_mod_replace_ext</a> &mdash; Replace attribute values with new ones</li><li><a href="function.ldap-mod-replace.html">ldap_mod_replace</a> &mdash; Replace attribute values with new ones</li><li><a href="function.ldap-modify-batch.html">ldap_modify_batch</a> &mdash; Batch and execute modifications on an LDAP entry</li><li><a href="function.ldap-modify.html">ldap_modify</a> &mdash; 别名 ldap_mod_replace</li><li><a href="function.ldap-next-attribute.html">ldap_next_attribute</a> &mdash; Get the next attribute in result</li><li><a href="function.ldap-next-entry.html">ldap_next_entry</a> &mdash; Get next result entry</li><li><a href="function.ldap-next-reference.html">ldap_next_reference</a> &mdash; Get next reference</li><li><a href="function.ldap-parse-exop.html">ldap_parse_exop</a> &mdash; Parse result object from an LDAP extended operation</li><li><a href="function.ldap-parse-reference.html">ldap_parse_reference</a> &mdash; Extract information from reference entry</li><li><a href="function.ldap-parse-result.html">ldap_parse_result</a> &mdash; Extract information from result</li><li><a href="function.ldap-read.html">ldap_read</a> &mdash; Read an entry</li><li><a href="function.ldap-rename-ext.html">ldap_rename_ext</a> &mdash; Modify the name of an entry</li><li><a href="function.ldap-rename.html">ldap_rename</a> &mdash; Modify the name of an entry</li><li><a href="function.ldap-sasl-bind.html">ldap_sasl_bind</a> &mdash; Bind to LDAP directory using SASL</li><li><a href="function.ldap-search.html">ldap_search</a> &mdash; Search LDAP tree</li><li><a href="function.ldap-set-option.html">ldap_set_option</a> &mdash; Set the value of the given option</li><li><a href="function.ldap-set-rebind-proc.html">ldap_set_rebind_proc</a> &mdash; Set a callback function to do re-binds on referral chasing</li><li><a href="function.ldap-sort.html">ldap_sort</a> &mdash; Sort LDAP result entries on the client side</li><li><a href="function.ldap-start-tls.html">ldap_start_tls</a> &mdash; Start TLS</li><li><a href="function.ldap-t61-to-8859.html">ldap_t61_to_8859</a> &mdash; Translate t61 characters to 8859 characters</li><li><a href="function.ldap-unbind.html">ldap_unbind</a> &mdash; Unbind from LDAP directory</li></ul>
</div>
<div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="120020""></a>
  <div class="note">
   <strong class="user">llurovi at gmail dot com</strong>
   <a href="#120020" class="date">11-Oct-2016 10:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those of you that are having trouble when user's password has special characters, make sure you decode the string to an appropiate codification. For instance, I had an issue where some users could not logging properly into our web app.<br />
<br />
Example of a simple connection:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$ldap_ip </span><span class="keyword">= </span><span class="string">'LDAP-SERVER-IP'</span><span class="keyword">;<br />
</span><span class="default">$ldap </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$ldap_ip</span><span class="keyword">);<br />
<br />
</span><span class="default">$user </span><span class="keyword">= </span><span class="string">'Test'</span><span class="keyword">;<br />
</span><span class="default">$password </span><span class="keyword">= </span><span class="string">'oto?o'</span><span class="keyword">; </span><span class="comment">//This password is correct but binding it with this format will give us an error<br />
<br />
</span><span class="default">$password </span><span class="keyword">= </span><span class="default">utf8_decode</span><span class="keyword">(</span><span class="default">$password</span><span class="keyword">); </span><span class="comment">//$password = otoxF1o<br />
<br />
</span><span class="default">$ldap_bind </span><span class="keyword">= </span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">$user</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">); </span><span class="comment">//Now the binding is successfull and $ldap_bind = true<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116606""></a>
  <div class="note">
   <strong class="user">oscar dot php at linaresdigital dot com</strong>
   <a href="#116606" class="date">28-Jan-2015 11:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There is a lot of confusion about accountExpires, pwdLastSet, lastLogon and badPasswordTime active directory fields.<br />
<br />
All of them are using "Interval" date/time format with a value that represents the number of 100-nanosecond intervals since January 1, 1601 (UTC, and a value of 0 or 0x7FFFFFFFFFFFFFFF, 9223372036854775807, indicates that the account never expires): https://msdn.microsoft.com/en-us/library/ms675098(v=vs.85).aspx<br />
<br />
So if you need to translate it from/to UNIX timestamp you can easily calculate the difference with:<br />
<br />
<span class="default">&lt;?php<br />
$datetime1 </span><span class="keyword">= new </span><span class="default">DateTime</span><span class="keyword">(</span><span class="string">'1601-01-01'</span><span class="keyword">);<br />
</span><span class="default">$datetime2 </span><span class="keyword">= new </span><span class="default">DateTime</span><span class="keyword">(</span><span class="string">'1970-01-01'</span><span class="keyword">);<br />
</span><span class="default">$interval </span><span class="keyword">= </span><span class="default">$datetime1</span><span class="keyword">-&gt;</span><span class="default">diff</span><span class="keyword">(</span><span class="default">$datetime2</span><span class="keyword">);<br />
echo (</span><span class="default">$interval</span><span class="keyword">-&gt;</span><span class="default">days </span><span class="keyword">* </span><span class="default">24 </span><span class="keyword">* </span><span class="default">60 </span><span class="keyword">* </span><span class="default">60</span><span class="keyword">) . </span><span class="string">" seconds\n"</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
The difference between both dates is 11644473600 seconds. Don't rely on floating point calculations nor other numbers that probably were calculated badly (including time zone or something similar).<br />
<br />
Now you can convert from LDAP field:<br />
<br />
<span class="default">&lt;?php<br />
$lastlogon </span><span class="keyword">= </span><span class="default">$info</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">'lastlogon'</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">];<br />
</span><span class="comment">// divide by 10.000.000 to get seconds from 100-nanosecond intervals<br />
</span><span class="default">$winInterval </span><span class="keyword">= </span><span class="default">round</span><span class="keyword">(</span><span class="default">$lastlogon </span><span class="keyword">/ </span><span class="default">10000000</span><span class="keyword">);<br />
</span><span class="comment">// substract seconds from 1601-01-01 -&gt; 1970-01-01<br />
</span><span class="default">$unixTimestamp </span><span class="keyword">= (</span><span class="default">$winInterval </span><span class="keyword">- </span><span class="default">11644473600</span><span class="keyword">);<br />
</span><span class="comment">// show date/time in local time zone<br />
</span><span class="keyword">echo </span><span class="default">date</span><span class="keyword">(</span><span class="string">"Y-m-d H:i:s"</span><span class="keyword">, </span><span class="default">$unixTimestamp</span><span class="keyword">) .</span><span class="string">"\n"</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
Hope it helps.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108395""></a>
  <div class="note">
   <strong class="user">Andrew Sharpe</strong>
   <a href="#108395" class="date">23-Apr-2012 06:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To compile PHP 5.1.6 on RHEL 6.2 x86_64, add the following to your configure command:<br />
<br />
--with-libdir=lib64<br />
--with-ldap=/usr</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99347""></a>
  <div class="note">
   <strong class="user">idbobby at rambler dot ru</strong>
   <a href="#99347" class="date">12-Aug-2010 02:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
First of all, sorry for my English.<br />
Here are two functions to check group membership and some others which can be useful for work with LDAP (Active Directory in this example).<br />
<br />
index.php<br />
---------<br />
<br />
<span class="default">&lt;?php<br />
<br />
$user </span><span class="keyword">= </span><span class="string">'bob'</span><span class="keyword">;<br />
</span><span class="default">$password </span><span class="keyword">= </span><span class="string">'zhlob'</span><span class="keyword">;<br />
</span><span class="default">$host </span><span class="keyword">= </span><span class="string">'myldap'</span><span class="keyword">;<br />
</span><span class="default">$domain </span><span class="keyword">= </span><span class="string">'mydomain.ex'</span><span class="keyword">;<br />
</span><span class="default">$basedn </span><span class="keyword">= </span><span class="string">'dc=mydomain,dc=ex'</span><span class="keyword">;<br />
</span><span class="default">$group </span><span class="keyword">= </span><span class="string">'SomeGroup'</span><span class="keyword">;<br />
<br />
</span><span class="default">$ad </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="string">"ldap://</span><span class="keyword">{</span><span class="default">$host</span><span class="keyword">}</span><span class="string">.</span><span class="keyword">{</span><span class="default">$domain</span><span class="keyword">}</span><span class="string">"</span><span class="keyword">) or die(</span><span class="string">'Could not connect to LDAP server.'</span><span class="keyword">);<br />
</span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);<br />
</span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
@</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="string">"</span><span class="keyword">{</span><span class="default">$user</span><span class="keyword">}</span><span class="string">@</span><span class="keyword">{</span><span class="default">$domain</span><span class="keyword">}</span><span class="string">"</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">) or die(</span><span class="string">'Could not bind to AD.'</span><span class="keyword">);<br />
</span><span class="default">$userdn </span><span class="keyword">= </span><span class="default">getDN</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$user</span><span class="keyword">, </span><span class="default">$basedn</span><span class="keyword">);<br />
if (</span><span class="default">checkGroupEx</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="default">getDN</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$group</span><span class="keyword">, </span><span class="default">$basedn</span><span class="keyword">))) {<br />
</span><span class="comment">//if (checkGroup($ad, $userdn, getDN($ad, $group, $basedn))) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"You're authorized as "</span><span class="keyword">.</span><span class="default">getCN</span><span class="keyword">(</span><span class="default">$userdn</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">'Authorization failed'</span><span class="keyword">;<br />
}<br />
</span><span class="default">ldap_unbind</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">);<br />
<br />
</span><span class="comment">/*<br />
* This function searchs in LDAP tree ($ad -LDAP link identifier)<br />
* entry specified by samaccountname and returns its DN or epmty<br />
* string on failure.<br />
*/<br />
</span><span class="keyword">function </span><span class="default">getDN</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$samaccountname</span><span class="keyword">, </span><span class="default">$basedn</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$attributes </span><span class="keyword">= array(</span><span class="string">'dn'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">ldap_search</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$basedn</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"(samaccountname=</span><span class="keyword">{</span><span class="default">$samaccountname</span><span class="keyword">}</span><span class="string">)"</span><span class="keyword">, </span><span class="default">$attributes</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$result </span><span class="keyword">=== </span><span class="default">FALSE</span><span class="keyword">) { return </span><span class="string">''</span><span class="keyword">; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$entries </span><span class="keyword">= </span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$result</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$entries</span><span class="keyword">[</span><span class="string">'count'</span><span class="keyword">]&gt;</span><span class="default">0</span><span class="keyword">) { return </span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">'dn'</span><span class="keyword">]; }<br />
&nbsp;&nbsp;&nbsp; else { return </span><span class="string">''</span><span class="keyword">; };<br />
}<br />
<br />
</span><span class="comment">/*<br />
* This function retrieves and returns CN from given DN<br />
*/<br />
</span><span class="keyword">function </span><span class="default">getCN</span><span class="keyword">(</span><span class="default">$dn</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">'/[^,]*/'</span><span class="keyword">, </span><span class="default">$dn</span><span class="keyword">, </span><span class="default">$matchs</span><span class="keyword">, </span><span class="default">PREG_OFFSET_CAPTURE</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$matchs</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">];<br />
}<br />
<br />
</span><span class="comment">/*<br />
* This function checks group membership of the user, searching only<br />
* in specified group (not recursively).<br />
*/<br />
</span><span class="keyword">function </span><span class="default">checkGroup</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="default">$groupdn</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$attributes </span><span class="keyword">= array(</span><span class="string">'members'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">ldap_read</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="string">"(memberof=</span><span class="keyword">{</span><span class="default">$groupdn</span><span class="keyword">}</span><span class="string">)"</span><span class="keyword">, </span><span class="default">$attributes</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$result </span><span class="keyword">=== </span><span class="default">FALSE</span><span class="keyword">) { return </span><span class="default">FALSE</span><span class="keyword">; };<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$entries </span><span class="keyword">= </span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$result</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return (</span><span class="default">$entries</span><span class="keyword">[</span><span class="string">'count'</span><span class="keyword">] &gt; </span><span class="default">0</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">/*<br />
* This function checks group membership of the user, searching<br />
* in specified group and groups which is its members (recursively).<br />
*/<br />
</span><span class="keyword">function </span><span class="default">checkGroupEx</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="default">$groupdn</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$attributes </span><span class="keyword">= array(</span><span class="string">'memberof'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">ldap_read</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="string">'(objectclass=*)'</span><span class="keyword">, </span><span class="default">$attributes</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$result </span><span class="keyword">=== </span><span class="default">FALSE</span><span class="keyword">) { return </span><span class="default">FALSE</span><span class="keyword">; };<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$entries </span><span class="keyword">= </span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$result</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$entries</span><span class="keyword">[</span><span class="string">'count'</span><span class="keyword">] &lt;= </span><span class="default">0</span><span class="keyword">) { return </span><span class="default">FALSE</span><span class="keyword">; };<br />
&nbsp;&nbsp;&nbsp; if (empty(</span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">'memberof'</span><span class="keyword">])) { return </span><span class="default">FALSE</span><span class="keyword">; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">'memberof'</span><span class="keyword">][</span><span class="string">'count'</span><span class="keyword">]; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">'memberof'</span><span class="keyword">][</span><span class="default">$i</span><span class="keyword">] == </span><span class="default">$groupdn</span><span class="keyword">) { return </span><span class="default">TRUE</span><span class="keyword">; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; elseif (</span><span class="default">checkGroupEx</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">'memberof'</span><span class="keyword">][</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$groupdn</span><span class="keyword">)) { return </span><span class="default">TRUE</span><span class="keyword">; };<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp;&nbsp; };<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">FALSE</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82216""></a>
  <div class="note">
   <strong class="user">ben_demott at hotmail dot com</strong>
   <a href="#82216" class="date">01-Apr-2008 06:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For anyone that is a programmer and not extremely familiar with naming conventions in Microsoft Active Directory or how to find objects within the directory, or more importantly how to reference the objects.<br />
Running "adsiedit.msc" from the command line will display all of your objects in the directory in an easy to read and copyable naming format.<br />
Hope this is helpful!<br />
<br />
Note:<br />
You must Run this command from an AD Domain Controller<br />
You Must have the Windows Resource Kit Tools installed<br />
(wouldn't let me make a link that long so I had to make a link break - Sorry!)<br />
a <a href="http://www.microsoft.com/downloads/details.aspx" rel="nofollow" target="_blank">http://www.microsoft.com/downloads/details.aspx</a><br />
?FamilyID=9d467a69-57ff-4ae7-96ee-b18c4790cffd&amp;displaylang=en<br />
<br />
Installing this tool should modify your system path so you can just type the command from the run dialogue, otherwise the absolute path is:<br />
C:\Program Files\Windows Resource Kits\Tools\adsiedit.msc</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77553""></a>
  <div class="note">
   <strong class="user">alex at netflex dot nl</strong>
   <a href="#77553" class="date">03-Sep-2007 06:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to use ldaps on windows but you don't want to validate the tls certificate try the following line before the ldap_connect call:<br />
<br />
putenv('LDAPTLS_REQCERT=never') or die('Failed to setup the env');</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76155""></a>
  <div class="note">
   <strong class="user">Tod</strong>
   <a href="#76155" class="date">03-Jul-2007 05:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Notes for people running PHP 4 with Apache 2.2 on Win2k3.<br />
The Apache Service needs to be running under the local administrators account in order for the ldap_connect to return a result. As apposed to the Domain Administrators account as may happen on servers in an Active Directory Domain.<br />
<br />
It will 'appear' to work ok but will return no results otherwise.<br />
<br />
so use (server name)\administrator for the username in the service logon properties.<br />
<br />
Tod</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73971""></a>
  <div class="note">
   <strong class="user">jector at inbox dot ru</strong>
   <a href="#73971" class="date">18-Mar-2007 09:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Spent some time on fixing "Unable to load dynamic library 'php_ldap.dll'. Copied libeay32.dll and ssleay32.dll&nbsp; everywhere, but error still stands.<br />
<br />
After digging all this dlls I found, that both libeay32.dll and ssleay32.dll need msvcr70.dll (or msvcr71.dll, it depends on the compiler version). Then just copy that dll to system32\ dir and it works perfectly.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73191""></a>
  <div class="note">
   <strong class="user">maykelsb at yahoo dot com dot br</strong>
   <a href="#73191" class="date">12-Feb-2007 11:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Problems with ldap_search in W2k3, can be solved adding <br />
<br />
// -- $conn is a valid ldap connection.<br />
<br />
ldap_set_option($conn, LDAP_OPT_PROTOCOL_VERSION,3);<br />
ldap_set_option($conn, LDAP_OPT_REFERRALS,0);<br />
<br />
before ldap_bind, as sad in <a href="http://bugs.php.net/bug.php?id=30670." rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=30670.</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="71687""></a>
  <div class="note">
   <strong class="user">unroar at gmail dot com</strong>
   <a href="#71687" class="date">11-Dec-2006 05:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In Solaris 9 the libnet library is a prerequisite for building&nbsp; PHP with LDAP, SASL and SSL (libnet is available on Sunfreeware).&nbsp; <br />
<br />
I didn't see this mentioned anywhere and I'm not sure if it is required by ldap or sasl or ssl.&nbsp; I just spent an hour on Google with no luck before I figured it out, maybe this comment will help the next googler.<br />
<br />
The error is,<br />
ld: fatal: library -lnet: not found<br />
ld: fatal: File processing errors. No output written to sapi/cli/php<br />
collect2: ld returned 1 exit status<br />
make: *** [sapi/cli/php] Error 1</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="71206""></a>
  <div class="note">
   <strong class="user">nigelf at esp dot co dot uk</strong>
   <a href="#71206" class="date">16-Nov-2006 06:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Chasing referrals in Active Directory (ie: searching across domains), can be slow.&nbsp; You can look up the object instead in the GC (Global Catalog) as follows:<br />
<br />
Remove any reference to ldap:// when you use ldap_connect, ie: use "serv1.mydom.com" NOT "ldap://serv1.mydom.com"<br />
<br />
Connect to port 3268 (not 389, the default)<br />
<br />
Set the Base DN for the search to null ie: "" (empty quotes).&nbsp; <br />
<br />
AD will then run the search against the GC which holds a copy of all objects in the Forest.&nbsp; You can also retrieve a subset of attributes (including group membership, except local groups).<br />
<br />
You will still need to follow referals for a full set of attributes.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="67955""></a>
  <div class="note">
   <strong class="user">gcathell at thetdgroup dot com</strong>
   <a href="#67955" class="date">07-Jul-2006 09:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I recently had to access a Microsoft Active Directory server as an LDAP service over SSL using PHP.&nbsp; It took me a long time to get all the information I needed to get it to work.<br />
<br />
I attempted to post a note here with the details but it ended it being too long.&nbsp; I've placed the details at the following URL in hopes that someone else will benefit and will be able to solve the problem much more quickly than I did.<br />
<br />
<a href="http://greg.cathell.net/php_ldap_ssl.html" rel="nofollow" target="_blank">http://greg.cathell.net/php_ldap_ssl.html</a><br />
<br />
Good luck!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="59902""></a>
  <div class="note">
   <strong class="user">nacenroe at remove dot this dot nystec dot com</strong>
   <a href="#59902" class="date">19-Dec-2005 12:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you're looking to use PHP to integrate LDAP with AD (I'm working with Win2K3), you may want to tinker with the LDP.exe tool included (no resource kit needed!!) with Win2k and Win2K3.&nbsp; You can run this app right from the command line.<br />
<br />
The Win2K3 Help function was a good start point, and then pointed me to an article in the M$ KB: <a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;255602 (XADM: Browsing and Querying Using the LDP Utility" rel="nofollow" target="_blank">http://support.microsoft.com/default.aspx?scid=kb;en-us;255602 (XADM: Browsing and Querying Using the LDP Utility</a>).<br />
<br />
So ... if your connect/bindings are working but your queries are not, you may want to start here.&nbsp; I'm finding it very useful when I run it on the local AD to see the attributes, etc.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57860""></a>
  <div class="note">
   <strong class="user">christopherbyrne at hotmail dot com</strong>
   <a href="#57860" class="date">16-Oct-2005 08:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just an ammendment to my previous post: my calculations were using east coast Australian time (GMT+10) whereas the Unix timestamp is in GMT. Therefore Active Directoy's "accountexpires" integer value does start from 1-Jan-1601 00:00:00 GMT and the number of seconds between this date and 1-Jan-1970 00:00:00 GMT is 11644524000. <br />
<br />
The increments are still definately in 100 nanoseconds though!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57855""></a>
  <div class="note">
   <strong class="user">christopherbyrne at hotmail dot com</strong>
   <a href="#57855" class="date">16-Oct-2005 04:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For anyone who's been having trouble working with the "accountexpires" attribute in Active Directory after having read the following article <br />
<br />
www.microsoft.com/technet/scriptcenter/<br />
resources/qanda/sept05/hey0902.mspx <br />
<br />
or something similar, this may save you some frustration. In the article is is mentioned that this attribute is an integer representing the number of nanoseconds since 01-Jan-1601 00:00:00.<br />
<br />
However the "accountexpires" attribute actually seems to be the number of 100 nanosecond increments since 31-Dec-1600 14:00:00. As a result if you divide the integer by 10,000,000 and subtract 11644560000 you will get a Unix timestamp that will match the dates in AD. <br />
<br />
To set the "accountexpires" date just reverse the procedure, that is, get the timestamp for the new date you want, add 11644560000 and multiply by 10,000,000. You will also need to format the resultant number to make sure it is not outputted in scientific notation for AD to be happy with it. <br />
<br />
Hope this helps!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55262""></a>
  <div class="note">
   <strong class="user">hijinio at comcast dot net</strong>
   <a href="#55262" class="date">28-Jul-2005 11:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In case anybody has trouble configuring PHP with LDAP support on a Solaris 10 box, here is the configure line I used:<br />
<br />
./configure --with-nsapi=/opt/SUNWwbsvr --enable-libgcc --disable-libxml --with-ldap=/usr/local --prefix=/opt/php/php-5.0.4<br />
<br />
The important part to note is the location used for --with-ldap= ; which for most S10 people, will be "--with-ldap=/usr/local".</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="50840""></a>
  <div class="note">
   <strong class="user">jpmens at gmail dot com</strong>
   <a href="#50840" class="date">11-Mar-2005 02:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Further to jabba at zeelandnet dot nl's note. If you are trying to connect to an LDAPS URI with OpenLDAP, you can either create the configuration file as described by jabba, or alternatively, use the environment settings to set LDAPTLS_REQCERT=never as described in ldap.conf(5).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="48343""></a>
  <div class="note">
   <strong class="user">Richie Bartlett(at)ITsystems-Online com</strong>
   <a href="#48343" class="date">20-Dec-2004 12:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is an update to &lt;i&gt;wtfo at technocraft dot com&lt;/i&gt; (23-May-2002 03:40)... This function allows additional (optional) parameters. The prev function listed, failed to close the ldap connection after successful authenication.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">checkNTuser</span><span class="keyword">(</span><span class="default">$username</span><span class="keyword">,</span><span class="default">$password</span><span class="keyword">,</span><span class="default">$DomainName</span><span class="keyword">=</span><span class="string">"myDomain"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ldap_server</span><span class="keyword">=</span><span class="string">"ldap://PDC.example.net"</span><span class="keyword">){</span><span class="comment">//v0.9<br />
// returns true when user/pass enable bind to LDAP (Windows 2k).<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$auth_user</span><span class="keyword">=</span><span class="default">$username</span><span class="keyword">.</span><span class="string">"@"</span><span class="keyword">.</span><span class="default">$DomainName</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">#echo $auth_user."-&gt;";<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$connect</span><span class="keyword">=@</span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$ldap_server</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">#echo "connection ($ldap_server): ";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$bind</span><span class="keyword">=@</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$connect</span><span class="keyword">, </span><span class="default">$auth_user</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">#echo "true &lt;BR&gt;";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">@</span><span class="default">ldap_close</span><span class="keyword">(</span><span class="default">$connect</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return(</span><span class="default">true</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }</span><span class="comment">//if bound to ldap<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}</span><span class="comment">//if connected to ldap<br />
&nbsp;&nbsp;&nbsp; #echo "failed &lt;BR&gt;";<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">@</span><span class="default">ldap_close</span><span class="keyword">(</span><span class="default">$connect</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return(</span><span class="default">false</span><span class="keyword">);<br />
}</span><span class="comment">//end function checkNTuser<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47427""></a>
  <div class="note">
   <strong class="user">jabba at zeelandnet dot nl</strong>
   <a href="#47427" class="date">15-Nov-2004 11:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using PHP on windows, and you are trying to connect (bind) to a Netware (6) LDAP server that requires secure connections (LDAPS), PHP will return a message stating that the server cannot be found.<br />
&nbsp;<br />
A network traffic capture of the traffic taking place on connection attempt reveals that the server supplies a certificate for use in the SSL connection, but this is rejected (***bad certificate SSLv3 packet) by the client.<br />
<br />
The reason for this is probably that the PHP LDAP implementation tries to verify the received certificate with the CA that issued the certificate. There may be a way to make it possible that this verification succeeds, but it is also possible to disable this verification by the client (which is, in this case, PHP) by creating an openldap (surprise!!) configuration file. <br />
<br />
The location of this configuration file seems to be hardcoded in the LDAP support module for windows, and you may need to manually create the following directory structure:<br />
<br />
C:\openldap\sysconf\<br />
<br />
In the sysconf folder, create a text file named 'ldap.conf' (you can use notepad for this) and, to disable certificate verification, place the following line in the ldap.conf file:<br />
<br />
TLS_REQCERT never<br />
<br />
After this, all the normal ldap_bind calls will work, provided your supplied user id and password are correct.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="46984""></a>
  <div class="note">
   <strong class="user">spam2004 at turniton dot dk</strong>
   <a href="#46984" class="date">29-Oct-2004 05:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here are two small functions that enables you to convert a binary objectSID from Microsoft AD into a more usefull text version (formatted (S-1-5.....)).<br />
<br />
// Converts a little-endian hex-number to one, that 'hexdec' can convert<br />
function littleEndian($hex) {<br />
&nbsp;&nbsp;&nbsp; for ($x=strlen($hex)-2; $x &gt;= 0; $x=$x-2) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $result .= substr($hex,$x,2);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return $result;<br />
}<br />
<br />
// Returns the textual SID<br />
function binSIDtoText($binsid) {<br />
&nbsp;&nbsp;&nbsp; $hex_sid=bin2hex($binsid);<br />
&nbsp;&nbsp;&nbsp; $rev = hexdec(substr($hex_sid,0,2));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Get revision-part of SID<br />
&nbsp;&nbsp;&nbsp; $subcount = hexdec(substr($hex_sid,2,2));&nbsp; &nbsp; // Get count of sub-auth entries<br />
&nbsp;&nbsp;&nbsp; $auth = hexdec(substr($hex_sid,4,12));&nbsp; &nbsp; &nbsp; // SECURITY_NT_AUTHORITY<br />
&nbsp;&nbsp;&nbsp; $result = "$rev-$auth";<br />
&nbsp;&nbsp;&nbsp; for ($x=0;$x &lt; $subcount; $x++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $subauth[$x] = hexdec(littleEndian(substr($hex_sid,16+($x*8),8)));&nbsp; // get all SECURITY_NT_AUTHORITY<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $result .= "-".$subauth[$x];<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return $result;<br />
}<br />
<br />
echo binSIDtoText($bin_sid);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="45929""></a>
  <div class="note">
   <strong class="user">Jimmy Wimenta Oei</strong>
   <a href="#45929" class="date">23-Sep-2004 12:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to disable/enable chase referral option, you need to first set the protocol version to version 3, otherwise the LDAP_OPT_REFERRALS option will not have any effect. This is especially true for querying MS Active Directory.<br />
<br />
<span class="default">&lt;?php<br />
ldap_set_option</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);<br />
</span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
And as always, these should be called after connect but before binding.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="42435""></a>
  <div class="note">
   <strong class="user">Sami Oksanen</strong>
   <a href="#42435" class="date">16-May-2004 06:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I edited Jon Caplinger's code which is located below (date: 09-Nov-2002 05:44).<br />
<br />
&nbsp;- I corrected line<br />
&nbsp;&nbsp; "if (!($connect=@ldap_connect($ldap))) {" with<br />
&nbsp;&nbsp; "if (!($connect=@ldap_connect($ldap_server))) {"<br />
<br />
&nbsp;- Removed $name-attribute<br />
<br />
&nbsp;- "Name is:"-field was always an Array, so I changed printing line to:<br />
&nbsp;&nbsp; " echo "Name is: ". $info[$i]["name"][0]."&lt;br&gt;";"<br />
<br />
I also added some alternative search filters to try out.<br />
<br />
Here is the code:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$ldap_server </span><span class="keyword">= </span><span class="string">"ldap://foo.bar.net"</span><span class="keyword">;<br />
</span><span class="default">$auth_user </span><span class="keyword">= </span><span class="string">"user@bar.net"</span><span class="keyword">;<br />
</span><span class="default">$auth_pass </span><span class="keyword">= </span><span class="string">"mypassword"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// Set the base dn to search the entire directory.<br />
<br />
</span><span class="default">$base_dn </span><span class="keyword">= </span><span class="string">"DC=bar, DC=net"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// Show only user persons<br />
</span><span class="default">$filter </span><span class="keyword">= </span><span class="string">"(&amp;(objectClass=user)(objectCategory=person)(cn=*))"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// Enable to show only users<br />
// $filter = "(&amp;(objectClass=user)(cn=$*))";<br />
<br />
// Enable to show everything<br />
// $filter = "(cn=*)";<br />
<br />
// connect to server<br />
<br />
</span><span class="keyword">if (!(</span><span class="default">$connect</span><span class="keyword">=@</span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$ldap_server</span><span class="keyword">))) {<br />
&nbsp;&nbsp; &nbsp; die(</span><span class="string">"Could not connect to ldap server"</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">// bind to server<br />
<br />
</span><span class="keyword">if (!(</span><span class="default">$bind</span><span class="keyword">=@</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$connect</span><span class="keyword">, </span><span class="default">$auth_user</span><span class="keyword">, </span><span class="default">$auth_pass</span><span class="keyword">))) {<br />
&nbsp;&nbsp; &nbsp; die(</span><span class="string">"Unable to bind to server"</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">//if (!($bind=@ldap_bind($connect))) {<br />
//&nbsp; &nbsp;&nbsp; die("Unable to bind to server");<br />
//}<br />
<br />
// search active directory<br />
<br />
</span><span class="keyword">if (!(</span><span class="default">$search</span><span class="keyword">=@</span><span class="default">ldap_search</span><span class="keyword">(</span><span class="default">$connect</span><span class="keyword">, </span><span class="default">$base_dn</span><span class="keyword">, </span><span class="default">$filter</span><span class="keyword">))) {<br />
&nbsp;&nbsp; &nbsp; die(</span><span class="string">"Unable to search ldap server"</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">$number_returned </span><span class="keyword">= </span><span class="default">ldap_count_entries</span><span class="keyword">(</span><span class="default">$connect</span><span class="keyword">,</span><span class="default">$search</span><span class="keyword">);<br />
</span><span class="default">$info </span><span class="keyword">= </span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$connect</span><span class="keyword">, </span><span class="default">$search</span><span class="keyword">);<br />
<br />
echo </span><span class="string">"The number of entries returned is "</span><span class="keyword">. </span><span class="default">$number_returned</span><span class="keyword">.</span><span class="string">"&lt;p&gt;"</span><span class="keyword">;<br />
<br />
for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">$info</span><span class="keyword">[</span><span class="string">"count"</span><span class="keyword">]; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; echo </span><span class="string">"Name is: "</span><span class="keyword">. </span><span class="default">$info</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"name"</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">].</span><span class="string">"&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; echo </span><span class="string">"Display name is: "</span><span class="keyword">. </span><span class="default">$info</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"displayname"</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">].</span><span class="string">"&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; echo </span><span class="string">"Email is: "</span><span class="keyword">. </span><span class="default">$info</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"mail"</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">].</span><span class="string">"&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; echo </span><span class="string">"Telephone number is: "</span><span class="keyword">. </span><span class="default">$info</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"telephonenumber"</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">].</span><span class="string">"&lt;p&gt;"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="40245""></a>
  <div class="note">
   <strong class="user">ant at solace dot mh dot se</strong>
   <a href="#40245" class="date">26-Feb-2004 08:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When working with LDAP, its worth remembering that the majority<br />
of LDAP servers encode their strings as UTF-8. What this means<br />
for non ascii strings is that you will need to use the utf8_encode and<br />
utf8_decode functions when creating filters for the LDAP server.<br />
<br />
Of course, if you can its simpler to just avoid using non-ascii characters<br />
but for most sites the users like to see their strange native character<br />
sets including umlauts etc..<br />
<br />
If you just get ? characters where you are expecting non-ascii, then<br />
you might just need to upgrade your PHP version.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36367""></a>
  <div class="note">
   <strong class="user">pookey at pookey dot co dot uk</strong>
   <a href="#36367" class="date">07-Oct-2003 01:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is an example of how to query an LDAP server, and print all entries out.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$ldapServer </span><span class="keyword">= </span><span class="string">'127.0.0.1'</span><span class="keyword">;<br />
</span><span class="default">$ldapBase </span><span class="keyword">= </span><span class="string">'DC=anlx,DC=net'</span><span class="keyword">;<br />
<br />
</span><span class="comment">/*<br />
&nbsp;* try to connect to the server<br />
&nbsp;*/<br />
</span><span class="default">$ldapConn </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$ldapServer</span><span class="keyword">);<br />
if (!</span><span class="default">$ldapConn</span><span class="keyword">)<br />
{<br />
&nbsp; die(</span><span class="string">'Cannot Connect to LDAP server'</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">/*<br />
&nbsp;* bind anonymously<br />
&nbsp;*/<br />
</span><span class="default">$ldapBind </span><span class="keyword">= </span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ldapConn</span><span class="keyword">);<br />
if (!</span><span class="default">$ldapBind</span><span class="keyword">)<br />
{<br />
&nbsp; die(</span><span class="string">'Cannot Bind to LDAP server'</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">/*<br />
&nbsp;* set the ldap options<br />
&nbsp;*/<br />
</span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ldapConn</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);<br />
<br />
</span><span class="comment">/*<br />
&nbsp;* search the LDAP server<br />
&nbsp;*/<br />
</span><span class="default">$ldapSearch </span><span class="keyword">= </span><span class="default">ldap_search</span><span class="keyword">(</span><span class="default">$ldapConn</span><span class="keyword">, </span><span class="default">$ldapBase</span><span class="keyword">, </span><span class="string">"(cn=*)"</span><span class="keyword">);<br />
</span><span class="default">$ldapResults </span><span class="keyword">= </span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$ldapConn</span><span class="keyword">, </span><span class="default">$ldapSearch</span><span class="keyword">);<br />
<br />
for (</span><span class="default">$item </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$item </span><span class="keyword">&lt; </span><span class="default">$ldapResults</span><span class="keyword">[</span><span class="string">'count'</span><span class="keyword">]; </span><span class="default">$item</span><span class="keyword">++)<br />
{<br />
&nbsp; for (</span><span class="default">$attribute </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$attribute </span><span class="keyword">&lt; </span><span class="default">$ldapResults</span><span class="keyword">[</span><span class="default">$item</span><span class="keyword">][</span><span class="string">'count'</span><span class="keyword">]; </span><span class="default">$attribute</span><span class="keyword">++)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">$ldapResults</span><span class="keyword">[</span><span class="default">$item</span><span class="keyword">][</span><span class="default">$attribute</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">$data</span><span class="keyword">.</span><span class="string">":&amp;nbsp;&amp;nbsp;"</span><span class="keyword">.</span><span class="default">$ldapResults</span><span class="keyword">[</span><span class="default">$item</span><span class="keyword">][</span><span class="default">$data</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">].</span><span class="string">"&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp; }<br />
&nbsp; echo </span><span class="string">'&lt;hr /&gt;'</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="34145""></a>
  <div class="note">
   <strong class="user">hkemale at hkem dot com</strong>
   <a href="#34145" class="date">16-Jul-2003 10:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For IIS+PHP+NTFS file system user<br />
After copied &lt;php_dir&gt;/dlls/*.dll to &lt;windows&gt;/systems32/ remember to add read and exexcute premission to "everyone" and the extensions *.dll. this can prevent warning of Access is denied of php_ldap.dll</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="32405""></a>
  <div class="note">
   <strong class="user">greatsafari at hotmail dot com</strong>
   <a href="#32405" class="date">26-May-2003 11:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Having seen so many variations of methods for connecting and query the Active Directory server, it really makes me suspect that the whole thing is dependent of the Active Directory configurations. Looking at this post at:<br />
<br />
<a href="http://www.phpbuilder.com/mail/php-general/2003022/1459.php" rel="nofollow" target="_blank">http://www.phpbuilder.com/mail/php-general/2003022/1459.php</a><br />
<br />
Some methods proven to be working in one instance failed at another instance.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31664""></a>
  <div class="note">
   <strong class="user">nliu99 at nospam dot yahoo dot com</strong>
   <a href="#31664" class="date">29-Apr-2003 03:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
libsasl.dll is NOT required for ldap functionalities. Go check out the posting at: <a href="http://bugs.php.net/bug.php?id=9485 " rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=9485 </a><br />
<br />
On win2k I followed these easy steps and got ldap to work:<br />
1. copy php_ldap.dll from the extension folder to winnt/system32<br />
2. edit winnt/php.ini so that ldap is enabled (uncomment the line). <br />
3. restart IIS. <br />
That's it and have fun with ldap. <br />
<br />
A note for Microsoft Active Directory<br />
1. You can login with the user email, i.e. user@company.com<br />
2. It's easiest to search for user info with ldap_search by filtering: (userprincipalname=[user])</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="30863""></a>
  <div class="note">
   <strong class="user">egeczi at nospamplease dot dist113 dot org</strong>
   <a href="#30863" class="date">01-Apr-2003 09:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On Win2k Server running IIS, it is not enough to just restart IIS after enabling the php_ldap extension. You have to restart the server itself.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="29994""></a>
  <div class="note">
   <strong class="user">yorch at correo dot ath dot cx</strong>
   <a href="#29994" class="date">03-Mar-2003 09:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Some notes about running LDAP extension on a Win2k box:<br />
<br />
After copying php_ldap.php and libsasl.dll in every single directory possible (c:\WinNT\System32, c:\php ...) I decided to read the installation.txt file.<br />
The instructions to install php extensions say: "Some extra DLLs are required for some PHP extensions. Please copy the bundled dlls from the 'dlls/' directory in distribution package to your windows/system (Win9.x) or winnt/system32 (WinNT, Win2000, XP) directory. If you already have these DLLs installed on your system, overwrite them only if something is not working correctly."<br />
<br />
So I did exactly that: copy ALL the dll files from "c:\php\dlls" to "c:\WinNT\System32".<br />
Now they load beautifully ;-)<br />
<br />
I hope this helps someone.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25894""></a>
  <div class="note">
   <strong class="user">gerbille at free dot fr</strong>
   <a href="#25894" class="date">10-Oct-2002 06:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The MD5 of PHP returns a result encoded in base16. But the LDAP MD5 returns a string encoded in base64. <br />
$pwd="toto";<br />
$pwd_md5=base64_encode(mhash(MHASH_MD5,$pwd));<br />
Just add "{MD5}" front $pwd_md5 to obtain the same format as LDAP directory.<br />
<br />
Bye<br />
Aur?lia</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25055""></a>
  <div class="note">
   <strong class="user">mike at whisperedlies dot org</strong>
   <a href="#25055" class="date">09-Sep-2002 09:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In addition to the netBIOS suggestion above, when binding to a Windows2k AD server, you can use the UPN of the intended user. For instance, if your SAM account name is firstname.lastname and your domain is domainname.com, your UPN might be firstname.lastname@domainname.com<br />
<br />
This can be used to bind to AD. I've not seen any difference in any of the methods.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="23159""></a>
  <div class="note">
   <strong class="user">rusko dot marton at gibzone dot hu</strong>
   <a href="#23159" class="date">10-Jul-2002 05:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can authenticate to a Windows 2000 domain's ldap server easily by using the simplified netbios form of the username.<br />
<br />
Somebody written:<br />
When authenticating to a Win2k LDAP server, the name of the person must be<br />
the FULL NAME in the dn <br />
<br />
NO. You can use this form:<br />
<br />
$user = "DOMAINNAME\\username"<br />
$password = "Password_of_user"; <br />
<br />
if (!$connect = ldap_connect("&lt;server&gt;", &lt;port&gt;)) { <br />
&nbsp; //error<br />
&nbsp; exit;<br />
} <br />
if (!$res = @ldap_bind($ldap, $user, $password)) { <br />
&nbsp; //error<br />
&nbsp; exit;<br />
} <br />
<br />
It works fine with Active Directory, we use it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="22486""></a>
  <div class="note">
   <strong class="user">knitterb at blandsite dot org</strong>
   <a href="#22486" class="date">19-Jun-2002 08:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using PHP 4.2.1 with OpenLDAP 2.1.2 I was having problems with binding to the ldap server.&nbsp; I found that php was using an older protocol and added the following to the slapd.conf:<br />
<br />
allow bind_v2<br />
<br />
See ``man slapd.conf'' for more info about the allow item in the slapd.conf file, this is all I know! :)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="17882""></a>
  <div class="note">
   <strong class="user">webmaster at autourdupc dot com</strong>
   <a href="#17882" class="date">31-Dec-2001 04:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When authenticating to a Win2k LDAP server, the name of the person must be the FULL NAME in the dn 
<br />

<br />
NB : nothing is case sensitive !
<br />

<br />
$dn="cn=DUPOND John, cn=Users, dc=autourdupc, dc=com"
<br />
$password = "Password_of_DUPOND"; 
<br />

<br />
Then when you bind to the LDAP database you use: 
<br />

<br />
if (!($ldap = ldap_connect("&lt;server&gt;", &lt;port&gt;))) { 
<br />
die ("Could not connect to LDAP server"); 
<br />
} 
<br />
if (!($res = @ldap_bind($ldap, $dn, $password))) { 
<br />
die ("Could not bind to $dn"); 
<br />
} 
<br />

<br />
Hope this will usefull for everyone !</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
