<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>使用给定参数解密密文</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.mcrypt-create-iv.html">? mcrypt_create_iv</a></li>
      <li style="float: right;"><a href="function.mcrypt-enc-get-algorithms-name.html">mcrypt_enc_get_algorithms_name ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.mcrypt.html">Mcrypt 函数</a></li>
    <li>使用给定参数解密密文</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.mcrypt-decrypt" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mcrypt_decrypt</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.0.2, PHP 5, PHP 7 &lt; 7.2.0, PECL mcrypt &gt;= 1.0.0)</p><p class="refpurpose"><span class="refname">mcrypt_decrypt</span> &mdash; <span class="dc-title">使用给定参数解密密文</span></p>

 </div>
 <div id="function.mcrypt-decrypt-refsynopsisdiv">
  <div class="warning"><strong class="warning">Warning</strong><p class="simpara">本函数已自 PHP 7.1.0 起<em class="emphasis">废弃</em>并将自
PHP 7.2.0 起<em class="emphasis">移除</em>。强烈建议不要使用本函数。</p></div>
 </div>
 <div class="refsect1 description" id="refsect1-function.mcrypt-decrypt-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>mcrypt_decrypt</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$cipher</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$key</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$mode</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$iv</code><span class="initializer"> = ?</span></span><br>): <span class="type"><span class="type">string</span>|<span class="type"><span class="type false">false</span></span></span></div>

  <p class="para rdfs-comment">
   解密 <code class="parameter">data</code> 并返回明文。
  </p>
 </div>

 <div class="refsect1 parameters" id="refsect1-function.mcrypt-decrypt-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">cipher</code></dt>

     <dd>

      <p class="para"><strong><code>MCRYPT_ciphername</code></strong> 常量中的一个，或者是字符串值的算法名称。</p>
     </dd>

    
    
     <dt>
<code class="parameter">key</code></dt>

     <dd>

      <p class="para">
       数据加密密钥。
       如果密钥长度不是加解密算法能够支持的有效长度，
       那么会产生警告并且返回 <strong><code>false</code></strong>
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">data</code></dt>

     <dd>

      <p class="para">
       要使用给定的 <code class="parameter">cipher</code> 和
       <code class="parameter">mode</code> 解密的数据。
       如果数据大小不是 n * 分组大小，则在其后追加 &#039;<code class="literal">\0</code>&#039; 来补齐。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">mode</code></dt>

     <dd>

      <p class="para"><strong><code>MCRYPT_MODE_modename</code></strong> 常量中的一个，或以下字符串中的一个：&quot;ecb&quot;，&quot;cbc&quot;，&quot;cfb&quot;，&quot;ofb&quot;，&quot;nofb&quot; 和 &quot;stream&quot;。</p>
     </dd>

    
    
     <dt>
<code class="parameter">iv</code></dt>

     <dd>

      <p class="para">Used for the initialization in CBC, CFB, OFB modes, and in some algorithms in STREAM mode. If the provided IV size is not supported by the chaining mode or no IV was provided, but the chaining mode requires one, the function will emit a warning and return <strong><code>false</code></strong>.</p>
     </dd>

    
   </dl>

  </p>
 </div>

 <div class="refsect1 returnvalues" id="refsect1-function.mcrypt-decrypt-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   以字符串格式返回解密后的数据，  或者在失败时返回 <strong><code>false</code></strong>。
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.mcrypt-decrypt-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.mcrypt-encrypt.html" class="function" rel="rdfs-seeAlso">mcrypt_encrypt()</a> - 使用给定参数加密明文</span></li>
   </ul>
  </p>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="121926""></a>
  <div class="note">
   <strong class="user">gmmarco at outlook dot my</strong>
   <a href="#121926" class="date">28-Nov-2017 05:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Look at <a href="http://php.net/manual/en/function.openssl-decrypt.php for a replacement. " rel="nofollow" target="_blank">http://php.net/manual/en/function.openssl-decrypt.php for a replacement. </a><br />
<br />
Supports PHP 5 &gt;= 5.3.0, PHP 7</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118924""></a>
  <div class="note">
   <strong class="user">pnz dot r00t at yandex dot ru</strong>
   <a href="#118924" class="date">29-Feb-2016 11:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When i using this function i find some problem, with adding additional binary symbols in decode message. <br />
$sDecrypt - ?2433091?<br />
$sDecrypt strlen - 16 (before trim) <br />
$sDecrypt - ?2433091?<br />
$sDecrypt strlen - 7 (after trim)<br />
At local PC this problem solved by using trim/trim, but if I send my encrypt message to sever, and try encrypt them, I see that my message is not 16 symbols, as it was in my local pc, it is 32 sybmols, after encode. And trim function not working. I look at symbols code and what I see <br />
&nbsp;&nbsp;&nbsp; 50<br />
&nbsp;&nbsp;&nbsp; 52<br />
&nbsp;&nbsp;&nbsp; 51<br />
&nbsp;&nbsp;&nbsp; 51<br />
&nbsp;&nbsp;&nbsp; 48<br />
&nbsp;&nbsp;&nbsp; 57<br />
&nbsp;&nbsp;&nbsp; 49<br />
&nbsp;&nbsp;&nbsp; 0<br />
&nbsp;&nbsp;&nbsp; 0<br />
&nbsp;&nbsp;&nbsp; 0<br />
&nbsp;&nbsp;&nbsp; 0<br />
&nbsp;&nbsp;&nbsp; 0<br />
&nbsp;&nbsp;&nbsp; 0<br />
&nbsp;&nbsp;&nbsp; 0<br />
&nbsp;&nbsp;&nbsp; 0<br />
&nbsp;&nbsp;&nbsp; 0<br />
&nbsp;&nbsp;&nbsp; 10<br />
&nbsp;&nbsp;&nbsp; 158<br />
&nbsp;&nbsp;&nbsp; 112<br />
&nbsp;&nbsp;&nbsp; 183<br />
&nbsp;&nbsp;&nbsp; 154<br />
&nbsp;&nbsp;&nbsp; 27<br />
&nbsp;&nbsp;&nbsp; 95<br />
&nbsp;&nbsp;&nbsp; 85<br />
&nbsp;&nbsp;&nbsp; 42<br />
&nbsp;&nbsp;&nbsp; 35<br />
&nbsp;&nbsp;&nbsp; 95<br />
&nbsp;&nbsp;&nbsp; 54<br />
&nbsp;&nbsp;&nbsp; 227<br />
&nbsp;&nbsp;&nbsp; 41<br />
&nbsp;&nbsp;&nbsp; 179<br />
&nbsp;&nbsp;&nbsp; 77<br />
After "tabulation symbols" I get some junk symbols, and&nbsp; I solve this problems like this.<br />
After mcrypt_decrypt I use this code <br />
$plaintext_dec = substr($plaintext_dec, 0, strpos($plaintext_dec, "\0"));<br />
I think it is not best resolution for this problem, but I solve my problem :)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112242""></a>
  <div class="note">
   <strong class="user">artaxerxes2 at iname dot com</strong>
   <a href="#112242" class="date">21-May-2013 04:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To decrypt data coming from MySQL's AES_ENCRYPT function:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">mysql_aes_key</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$new_key </span><span class="keyword">= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">), </span><span class="default">16</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">,</span><span class="default">$len</span><span class="keyword">=</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">);</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">$len</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$new_key</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">%</span><span class="default">16</span><span class="keyword">] = </span><span class="default">$new_key</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">%</span><span class="default">16</span><span class="keyword">] ^ </span><span class="default">$key</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$new_key</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">aes_decrypt</span><span class="keyword">(</span><span class="default">$encrypted</span><span class="keyword">,</span><span class="default">$key</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// if $encrypted is HEXed, then return it to binary<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$encrypted </span><span class="keyword">= </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'H*'</span><span class="keyword">,</span><span class="default">$encrypted</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">mysql_aes_key</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">rtrim</span><span class="keyword">(</span><span class="default">mcrypt_decrypt</span><span class="keyword">(</span><span class="default">MCRYPT_RIJNDAEL_128</span><span class="keyword">,</span><span class="default">$key</span><span class="keyword">,</span><span class="default">$encrypted</span><span class="keyword">,</span><span class="default">MCRYPT_MODE_ECB</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">),</span><span class="string">"\x00..\x1F"</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
adapted from the article "Replicating MySQL AES Encryption Methods With PHP" (dated 2012-05-20) found somewhere online.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105985""></a>
  <div class="note">
   <strong class="user">beltrachi</strong>
   <a href="#105985" class="date">30-Sep-2011 12:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Caution, MCRYPT_RIJNDAEL_256 is not equivalent to AES_256.
<br />

<br />
The way to make RIJNDAEL be decrypted from AES with openssl is to use MCRYPT_RIJNDAEL_128 and padd the string to encrypt before encrypting with the follwing function:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">pkcs5_pad </span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">, </span><span class="default">$blocksize</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pad </span><span class="keyword">= </span><span class="default">$blocksize </span><span class="keyword">- (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">) % </span><span class="default">$blocksize</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$text </span><span class="keyword">. </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">$pad</span><span class="keyword">), </span><span class="default">$pad</span><span class="keyword">);
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
On the decryption, the choosing of AES_256 or AES_128, etc. is based on the keysize used in the crypting. In my case it was a 128bit key so I used AES_128.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103511""></a>
  <div class="note">
   <strong class="user">evangelion207 at hotmail dot com</strong>
   <a href="#103511" class="date">17-Apr-2011 08:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be careful, sometimes mcrypt_decrypt return additional white spaces to the uncrypted string; use trim() for deleting them. I was like 2 hours searching the error and it was that..</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101069""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#101069" class="date">24-Nov-2010 03:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To remove PKCS7 padding:
<br />

<br />
<span class="default">&lt;?php
<br />
&nbsp;&nbsp;&nbsp; $decrypted </span><span class="keyword">= </span><span class="default">mdecrypt_generic</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$enc_auth_token</span><span class="keyword">));
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dec_s </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$decrypted</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$padding </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$decrypted</span><span class="keyword">[</span><span class="default">$dec_s</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">]);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$decrypted </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$decrypted</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, -</span><span class="default">$padding</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="86089""></a>
  <div class="note">
   <strong class="user">david at sickmiller dot com</strong>
   <a href="#86089" class="date">02-Oct-2008 10:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you happen to be decrypting something encrypted in ColdFusion, you'll discover that its encrypt function apparently pads the plaintext with ASCII 4, the "end of transmission" character.<br />
<br />
Building on eddiec's code, you can remove both nulls and EOTs with this:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; $retval </span><span class="keyword">= </span><span class="default">mcrypt_decrypt</span><span class="keyword">( ...</span><span class="default">etc </span><span class="keyword">...);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$retval </span><span class="keyword">= </span><span class="default">rtrim</span><span class="keyword">(</span><span class="default">$retval</span><span class="keyword">, </span><span class="string">"\0\4"</span><span class="keyword">);&nbsp; &nbsp;&nbsp; </span><span class="comment">// trim ONLY the nulls and EOTs at the END<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54734""></a>
  <div class="note">
   <strong class="user">eddiec at stararcher dot com</strong>
   <a href="#54734" class="date">13-Jul-2005 06:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It appears that mcrypt_decrypt pads the *RETURN STRING* with nulls ('\0') to fill out to n * blocksize.&nbsp; For old C-programmers, like myself, it is easy to believe the string ends at the first null.&nbsp; In PHP it does not:
<br />

<br />
&nbsp;&nbsp;&nbsp; strlen("abc\0\0") returns 5 and *NOT* 3
<br />
&nbsp;&nbsp;&nbsp; strcmp("abc", "abc\0\0") returns -2 and *NOT* 0
<br />

<br />
I learned this lesson painfully when I passed a string returned from mycrypt_decrypt into a NuSoap message, which happily passed the nulls along to the receiver, who couldn't figure out what I was talking about.
<br />

<br />
My solution was:
<br />
<span class="default">&lt;?php
<br />
&nbsp;&nbsp;&nbsp; $retval </span><span class="keyword">= </span><span class="default">mcrypt_decrypt</span><span class="keyword">( ...</span><span class="default">etc </span><span class="keyword">...);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$retval </span><span class="keyword">= </span><span class="default">rtrim</span><span class="keyword">(</span><span class="default">$retval</span><span class="keyword">, </span><span class="string">"\0"</span><span class="keyword">);&nbsp; &nbsp;&nbsp; </span><span class="comment">// trim ONLY the nulls at the END
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
