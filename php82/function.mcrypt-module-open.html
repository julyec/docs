<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>打开算法和模式对应的模块</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.mcrypt-module-is-block-mode.html">? mcrypt_module_is_block_mode</a></li>
      <li style="float: right;"><a href="function.mcrypt-module-self-test.html">mcrypt_module_self_test ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.mcrypt.html">Mcrypt 函数</a></li>
    <li>打开算法和模式对应的模块</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.mcrypt-module-open" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mcrypt_module_open</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.0.2, PHP 5, PHP 7 &lt; 7.2.0, PECL mcrypt &gt;= 1.0.0)</p><p class="refpurpose"><span class="refname">mcrypt_module_open</span> &mdash; <span class="dc-title">打开算法和模式对应的模块</span></p>

 </div>
 <div id="function.mcrypt-module-open-refsynopsisdiv">
  <div class="warning"><strong class="warning">Warning</strong><p class="simpara">本函数已自 PHP 7.1.0 起<em class="emphasis">废弃</em>并将自
PHP 7.2.0 起<em class="emphasis">移除</em>。强烈建议不要使用本函数。</p></div>
 </div>
 <div class="refsect1 description" id="refsect1-function.mcrypt-module-open-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>mcrypt_module_open</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$algorithm</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$algorithm_directory</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$mode</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$mode_directory</code></span><br>): <span class="type">resource</span></div>

  <p class="para rdfs-comment">
   本函数打开指定算法和模式对应的模块。
   算法名称可以是字符串，例如 <code class="literal">&quot;twofish&quot;</code>，
   也可以是 <strong><code>MCRYPT_ciphername</code></strong> 常量。
   调用 <span class="function"><a href="function.mcrypt-module-close.html" class="function">mcrypt_module_close()</a></span> 函数可以关闭模块。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.mcrypt-module-open-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">algorithm</code></dt>

     <dd>

      <p class="para"><strong><code>MCRYPT_ciphername</code></strong> 常量中的一个，或者是字符串值的算法名称。</p>
     </dd>

    
    
     <dt>
<code class="parameter">algorithm_directory</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">algorithm_directory</code> 参数指示加密模块的位置。
       如果你提供此参数，则使用你指定的值。
       如果将此参数设置为空字符串（<code class="literal">&quot;&quot;</code>），将使用
       <var class="filename">php.ini</var> 中的 <code class="literal">mcrypt.algorithms_dir</code> 。
       如果不指定此参数，则使用 libmcrypt 的编译路径
       （通常是 <var class="filename">/usr/local/lib/libmcrypt</var>）。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">mode</code></dt>

     <dd>

      <p class="para"><strong><code>MCRYPT_MODE_modename</code></strong> 常量中的一个，或以下字符串中的一个：&quot;ecb&quot;，&quot;cbc&quot;，&quot;cfb&quot;，&quot;ofb&quot;，&quot;nofb&quot; 和 &quot;stream&quot;。</p>
     </dd>

    
    
     <dt>
<code class="parameter">mode_directory</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">algorithm_directory</code> 参数指示加密模式的位置。
       如果你提供此参数，则使用你指定的值。
       如果将此参数设置为空字符串（<code class="literal">&quot;&quot;</code>），将使用
       <var class="filename">php.ini</var> 中的 <code class="literal">mcrypt.modes_dir</code> 。
       如果不指定此参数，则使用 libmcrypt 的编译路径
       （通常是 <var class="filename">/usr/local/lib/libmcrypt</var>）。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.mcrypt-module-open-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功则返回加密描述符，如果发生错误则返回 <strong><code>false</code></strong>。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.mcrypt-module-open-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="example-1838">
    <p><strong>Example #1 <span class="function"><strong>mcrypt_module_open()</strong></span> 示例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />    $td </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_module_open</span><span style="color: #007700">(</span><span style="color: #0000BB">MCRYPT_DES</span><span style="color: #007700">, </span><span style="color: #DD0000">''</span><span style="color: #007700">,<br />        </span><span style="color: #0000BB">MCRYPT_MODE_ECB</span><span style="color: #007700">, </span><span style="color: #DD0000">'/usr/lib/mcrypt-modes'</span><span style="color: #007700">);<br /><br />    </span><span style="color: #0000BB">$td </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_module_open</span><span style="color: #007700">(</span><span style="color: #DD0000">'rijndael-256'</span><span style="color: #007700">, </span><span style="color: #DD0000">''</span><span style="color: #007700">, </span><span style="color: #DD0000">'ofb'</span><span style="color: #007700">, </span><span style="color: #DD0000">''</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   示例中的第一行从默认目录打开 <code class="literal">DES</code> 加密算法，
   从 <var class="filename">/usr/lib/mcrypt-modes</var> 目录打开
   <code class="literal">ECB</code> 模式。
   第二个示例中，使用字符串形式表示算法和模式，
   这种形式仅适用于 libmcrypt 2.4.x 或 2.5.x 版本。
  </p>

  <p class="para">
   <div class="example" id="example-1840">
    <p><strong>Example #2 在加密中使用 <span class="function"><strong>mcrypt_module_open()</strong></span></strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />    </span><span style="color: #FF8000">/* 打开加密算法和模式 */<br />    </span><span style="color: #0000BB">$td </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_module_open</span><span style="color: #007700">(</span><span style="color: #DD0000">'rijndael-256'</span><span style="color: #007700">, </span><span style="color: #DD0000">''</span><span style="color: #007700">, </span><span style="color: #DD0000">'ofb'</span><span style="color: #007700">, </span><span style="color: #DD0000">''</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">/* 创建初始向量，并且检测密钥长度。 <br />     * Windows 平台请使用 MCRYPT_RAND。 */<br />    </span><span style="color: #0000BB">$iv </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_create_iv</span><span style="color: #007700">(</span><span style="color: #0000BB">mcrypt_enc_get_iv_size</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">), </span><span style="color: #0000BB">MCRYPT_DEV_RANDOM</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">$ks </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_enc_get_key_size</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">/* 创建密钥 */<br />    </span><span style="color: #0000BB">$key </span><span style="color: #007700">= </span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">md5</span><span style="color: #007700">(</span><span style="color: #DD0000">'very secret key'</span><span style="color: #007700">), </span><span style="color: #0000BB">0</span><span style="color: #007700">, </span><span style="color: #0000BB">$ks</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">/* 初始化加密 */<br />    </span><span style="color: #0000BB">mcrypt_generic_init</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">, </span><span style="color: #0000BB">$key</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">/* 加密数据 */<br />    </span><span style="color: #0000BB">$encrypted </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_generic</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">, </span><span style="color: #DD0000">'This is very important data'</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">/* 结束加密，执行清理工作 */<br />    </span><span style="color: #0000BB">mcrypt_generic_deinit</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">/* 初始化解密模块 */<br />    </span><span style="color: #0000BB">mcrypt_generic_init</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">, </span><span style="color: #0000BB">$key</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">/* 解密数据 */<br />    </span><span style="color: #0000BB">$decrypted </span><span style="color: #007700">= </span><span style="color: #0000BB">mdecrypt_generic</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">, </span><span style="color: #0000BB">$encrypted</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">/* 结束解密，执行清理工作，并且关闭模块 */<br />    </span><span style="color: #0000BB">mcrypt_generic_deinit</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">mcrypt_module_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">/* 显示文本 */<br />    </span><span style="color: #007700">echo </span><span style="color: #0000BB">trim</span><span style="color: #007700">(</span><span style="color: #0000BB">$decrypted</span><span style="color: #007700">) . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.mcrypt-module-open-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.mcrypt-module-close.html" class="function" rel="rdfs-seeAlso">mcrypt_module_close()</a> - 关闭加密模块</span></li>
    <li class="member"><span class="function"><a href="function.mcrypt-generic.html" class="function" rel="rdfs-seeAlso">mcrypt_generic()</a> - 加密数据</span></li>
    <li class="member"><span class="function"><a href="function.mdecrypt-generic.html" class="function" rel="rdfs-seeAlso">mdecrypt_generic()</a> - 解密数据</span></li>
    <li class="member"><span class="function"><a href="function.mcrypt-generic-init.html" class="function" rel="rdfs-seeAlso">mcrypt_generic_init()</a> - 初始化加密所需的缓冲区</span></li>
    <li class="member"><span class="function"><a href="function.mcrypt-generic-deinit.html" class="function" rel="rdfs-seeAlso">mcrypt_generic_deinit()</a> - 对加密模块进行清理工作</span></li>
   </ul>
  </p>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="118861""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#118861" class="date">18-Feb-2016 10:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Follow up to anonymous with Windows' mcrypt_module_open() errors:<br />
<br />
<span class="default">&lt;?php<br />
$M </span><span class="keyword">= </span><span class="default">mcrypt_list_modes</span><span class="keyword">();<br />
</span><span class="default">$A </span><span class="keyword">= </span><span class="default">mcrypt_list_algorithms</span><span class="keyword">();<br />
foreach (</span><span class="default">$M </span><span class="keyword">as </span><span class="default">$m</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$A </span><span class="keyword">as </span><span class="default">$a</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$t </span><span class="keyword">= @</span><span class="default">mcrypt_module_open</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">,</span><span class="default">$m</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print </span><span class="string">"</span><span class="default">$m</span><span class="string">, </span><span class="default">$a</span><span class="string"> = "</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print (</span><span class="default">$t</span><span class="keyword">)?</span><span class="string">"ok"</span><span class="keyword">:</span><span class="string">"nope"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print </span><span class="string">"&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span><br />
This will show that not all modes work with all algorithmns. Cygwin also has no 'libmcrypt.dll' and it too will work with only some combinations.<br />
<br />
(First tries just happened to be one of the ones that did not work!)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="110495""></a>
  <div class="note">
   <strong class="user">Mark</strong>
   <a href="#110495" class="date">29-Oct-2012 02:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
for errors like<br />
' mcrypt_module_open(): Could not open encryption module in '<br />
<br />
Make sure you're using the right name. The page giving the list of ciphers is NOT the right way to say each cipher (shown here <a href="http://www.php.net/manual/en/mcrypt.ciphers.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/mcrypt.ciphers.php</a>).<br />
<br />
In order to see what ones are supported, try phpinfo(); and look under mcrypt to find something like this<br />
<br />
mcrypt support =&gt; enabled<br />
mcrypt_filter support =&gt; enabled<br />
Version =&gt; 2.5.8<br />
Api No =&gt; 20021217<br />
Supported ciphers =&gt; cast-128 gost rijndael-128 twofish arcfour cast-256 loki97 rijndael-192 saferplus wake blowfish-compat des rijndael-256<br />
&nbsp;serpent xtea blowfish enigma rc2 tripledes <br />
Supported modes =&gt; cbc cfb ctr ecb ncfb nofb ofb stream</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92339""></a>
  <div class="note">
   <strong class="user">lehmann*at*arcor-so.net</strong>
   <a href="#92339" class="date">20-Jul-2009 08:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Keep in mind that the mcrypt functions do not implement padding like e.g. pkcs#5. This causes the problem with zero bytes at the end and the sting cannot be correctly decoded in other environments.<br />
<br />
For an example how to add pkcs 5 padding, see ref.mcrypt.php</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89937""></a>
  <div class="note">
   <strong class="user">royconejo</strong>
   <a href="#89937" class="date">29-Mar-2009 09:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
about the previous comments on hex formatting and capitalization as a way to improve the key:<br />
<br />
this would seem pretty obvious, but it is a choice to be limited to only hex characters ([0-9a-z]); you can get the original RAW output from md5() or sha1() and not the default readable hex formatting.<br />
<br />
the result of a raw output will be 16 o 20 (depending on the hash function being used) series of chars in the range 0-255. way better than [0-9a-z] and even [0-9a-zA-Z].<br />
<br />
16 or 20 is generally lower than the maximum key lenght ($ks in the example), but you can append two or more keys together:<br />
<br />
<span class="default">&lt;?php<br />
$human_key1 </span><span class="keyword">= </span><span class="string">'something very secret'</span><span class="keyword">;<br />
</span><span class="default">$human_key2 </span><span class="keyword">= </span><span class="string">'something else very secret'</span><span class="keyword">;<br />
<br />
</span><span class="comment">// 40 bytes binary key using two "human readable" keys and sha1.<br />
</span><span class="default">$bigger_binary_key </span><span class="keyword">= </span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$human_key1</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">) . </span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$human_key2</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
<br />
</span><span class="comment">// then just use it as you would (extract taken from the example)<br />
</span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$bigger_binary_key</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$ks</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
... or you can automatically split one large "human key" into two or more parts, hash those parts with sha1 (raw output!) and merge them together again (in original order or rearrange, salt, transform them as you like) to get a binary key of 40, 60, 80 or more chars depending on the number of parts the secret key has been splitted =)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84517""></a>
  <div class="note">
   <strong class="user">ash</strong>
   <a href="#84517" class="date">17-Jul-2008 03:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A slight improvement of dinamic's function to create a key:<br />
<br />
I think the weak point is that capitals are always used in the same part of the string. The following code capitalizes random characters of the string, making the key less predictable:<br />
<br />
<span class="default">&lt;?php<br />
$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key1</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$ks</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">) . </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">, (</span><span class="default">round</span><span class="keyword">(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">) / </span><span class="default">2</span><span class="keyword">)), </span><span class="default">$ks</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">);<br />
</span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">.</span><span class="default">$key1</span><span class="keyword">.</span><span class="default">$key2</span><span class="keyword">.</span><span class="default">$key1</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$ks</span><span class="keyword">);<br />
<br />
</span><span class="default">$buffer </span><span class="keyword">= </span><span class="default">str_split</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">);<br />
<br />
</span><span class="default">$limit </span><span class="keyword">= </span><span class="default">count</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">;<br />
</span><span class="default">srand</span><span class="keyword">((float)</span><span class="default">microtime</span><span class="keyword">() * </span><span class="default">1000000</span><span class="keyword">);<br />
<br />
</span><span class="default">$end </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">$limit</span><span class="keyword">);<br />
</span><span class="default">$a </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
<br />
</span><span class="comment">// replace random chars with capitals<br />
</span><span class="keyword">while (</span><span class="default">$a </span><span class="keyword">&lt; </span><span class="default">$end</span><span class="keyword">) {&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; list(</span><span class="default">$usec</span><span class="keyword">, </span><span class="default">$sec</span><span class="keyword">) = </span><span class="default">explode</span><span class="keyword">(</span><span class="string">' '</span><span class="keyword">, </span><span class="default">microtime</span><span class="keyword">());<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$seed </span><span class="keyword">= ((float)</span><span class="default">$sec</span><span class="keyword">) + ((float) </span><span class="default">$usec </span><span class="keyword">* </span><span class="default">100000</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mt_srand</span><span class="keyword">(</span><span class="default">$seed</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$index </span><span class="keyword">= </span><span class="default">mt_rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">$limit</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$buffer</span><span class="keyword">[</span><span class="default">$index</span><span class="keyword">] = </span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">[</span><span class="default">$index</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$a</span><span class="keyword">++;<br />
}<br />
<br />
</span><span class="default">$key </span><span class="keyword">= </span><span class="default">join</span><span class="keyword">(</span><span class="string">''</span><span class="keyword">, </span><span class="default">$buffer</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79135""></a>
  <div class="note">
   <strong class="user">dinamic at gmail dot com</strong>
   <a href="#79135" class="date">13-Nov-2007 03:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Also it should be pointed that md5() and/or sha1() should not be used while forming your key for the mcrypt. This is so because hex encoding uses a set of only 16 characters [0-9a-f], which is equivalent to 4 bits, and thus halve the strength of your encryption: 4 x 32 = 128-bit.<br />
<br />
I have re-wrote the example shown, so here is my suggestion to get real 256-bit encryption:<br />
<br />
<span class="default">&lt;?php<br />
$key1 </span><span class="keyword">= </span><span class="string">"this is a secret key"</span><span class="keyword">;<br />
</span><span class="default">$key2 </span><span class="keyword">= </span><span class="string">"this is the second secret key"</span><span class="keyword">;<br />
</span><span class="default">$input </span><span class="keyword">= </span><span class="string">"Let us meet at 9 o'clock at the secret place."</span><span class="keyword">;<br />
</span><span class="default">$length </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$input</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Open the cipher */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$td </span><span class="keyword">= </span><span class="default">mcrypt_module_open</span><span class="keyword">(</span><span class="string">'rijndael-256'</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">, </span><span class="string">'cbc'</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Create the IV and determine the keysize length, use MCRYPT_RAND<br />
&nbsp;&nbsp; &nbsp; * on Windows instead */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">mcrypt_create_iv</span><span class="keyword">(</span><span class="default">mcrypt_enc_get_iv_size</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">), </span><span class="default">MCRYPT_RAND</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ks </span><span class="keyword">= </span><span class="default">mcrypt_enc_get_key_size</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Create key */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key1 </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$key1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key2 </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key1</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$ks</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">) . </span><span class="default">substr</span><span class="keyword">(</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">), (</span><span class="default">round</span><span class="keyword">(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">) / </span><span class="default">2</span><span class="keyword">)), </span><span class="default">$ks</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">.</span><span class="default">$key1</span><span class="keyword">.</span><span class="default">$key2</span><span class="keyword">.</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$key1</span><span class="keyword">),</span><span class="default">0</span><span class="keyword">,</span><span class="default">$ks</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Intialize encryption */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_init</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Encrypt data */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$encrypted </span><span class="keyword">= </span><span class="default">mcrypt_generic</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$input</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Terminate encryption handler */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_deinit</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Initialize encryption module for decryption */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_init</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Decrypt encrypted string */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$decrypted </span><span class="keyword">= </span><span class="default">mdecrypt_generic</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$encrypted</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Terminate decryption handle and close module */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_deinit</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_module_close</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Show string */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"Text: "</span><span class="keyword">.</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$decrypted</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$length</span><span class="keyword">) . </span><span class="string">"&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Encoded: "</span><span class="keyword">.</span><span class="default">$encrypted </span><span class="keyword">.</span><span class="string">"&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"&lt;br&gt;key1: </span><span class="default">$key1</span><span class="string"> &lt;br&gt;key2: </span><span class="default">$key2</span><span class="string">&lt;br&gt;created key: </span><span class="default">$key</span><span class="string">"</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="34611""></a>
  <div class="note">
   
   <a href="#34611" class="date">31-Jul-2003 08:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Doing a trim($decrypted) will remove the null padding that may occur as a result of decryption.<br />
<br />
The problem is if you're encrypting something like a MSWord document which can commonly end with nulls. The result $decrypted will be smaller than the original cleartext - which will then fail to open in MSOffice.<br />
<br />
To get around this, make sure you store the length of the original cleartext, and when you decrypt it, do:<br />
<br />
$decrypted = substr(mdecrypt_generic($td, $encrypted), 0, $originalLength);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
