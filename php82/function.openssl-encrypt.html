<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>加密数据</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.openssl-digest.html">? openssl_digest</a></li>
      <li style="float: right;"><a href="function.openssl-error-string.html">openssl_error_string ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.openssl.html">OpenSSL 函数</a></li>
    <li>加密数据</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.openssl-encrypt" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">openssl_encrypt</h1>
  <p class="verinfo">(PHP 5 &gt;= 5.3.0, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">openssl_encrypt</span> &mdash; <span class="dc-title">加密数据</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.openssl-encrypt-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>openssl_encrypt</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$cipher_algo</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$passphrase</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$options</code><span class="initializer"> = 0</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$iv</code><span class="initializer"> = &quot;&quot;</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter reference">&$tag</code><span class="initializer"> = <strong><code>null</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$aad</code><span class="initializer"> = &quot;&quot;</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$tag_length</code><span class="initializer"> = 16</span></span><br>): <span class="type"><span class="type">string</span>|<span class="type"><span class="type false">false</span></span></span></div>

  <p class="para rdfs-comment">
   以指定的方式和 key 加密数据，返回原始或 base64 编码后的字符串。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.openssl-encrypt-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">data</code></dt>

     <dd>

      <p class="para">
       待加密的明文信息数据。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">cipher_algo</code></dt>

     <dd>

      <p class="para">
       密码学方式。<span class="function"><a href="function.openssl-get-cipher-methods.html" class="function">openssl_get_cipher_methods()</a></span> 可获取有效密码方式列表。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">passphrase</code></dt>

     <dd>

      <p class="para">
       口令（passphrase）。
       若 passphrase 比预期长度短，将静默用 <code class="literal">NUL</code> 填充；
       若比预期长度更长，将静默截断。
      </p>
     </dd>

    
    
      <dt>
<code class="parameter">options</code></dt>

      <dd>

        <p class="para">
          <code class="parameter">options</code> 是以下标记的按位或：
          <strong><code>OPENSSL_RAW_DATA</code></strong> 、
          <strong><code>OPENSSL_ZERO_PADDING</code></strong>。
        </p>
      </dd>

    
    
     <dt>
<code class="parameter">iv</code></dt>

     <dd>

      <p class="para">
       非 NULL 的初始化向量。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">tag</code></dt>

     <dd>

      <p class="para">
       使用 AEAD 密码模式（GCM 或 CCM）时传引用的验证标签。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">aad</code></dt>

     <dd>

      <p class="para">
       附加的验证数据。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">tag_length</code></dt>

     <dd>

      <p class="para">
       验证 <code class="parameter">tag</code> 的长度。GCM 模式时，它的范围是 4 到 16。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.openssl-encrypt-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功时返回加密后的字符串， 或者在失败时返回 <strong><code>false</code></strong>。
  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-function.openssl-encrypt-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
   <code class="parameter">cipher_algo</code> 传入未知算法时，产生 <strong><code>E_WARNING</code></strong> 级别的错误。
  </p>
  <p class="para">
   <code class="parameter">iv</code> 传入空字符串时产生 <strong><code>E_WARNING</code></strong> 级别的错误。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.openssl-encrypt-changelog">
  <h3 class="title">更新日志</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>版本</th>
      <th>说明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>7.1.0</td>
      <td>增加了 <code class="parameter">tag</code>、<code class="parameter">aad</code>、<code class="parameter">tag_length</code> 参数</td>
     </tr>

    </tbody>
   
  </table>

 </div>



 <div class="refsect1 examples" id="refsect1-function.openssl-encrypt-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="example-1878">
    <p><strong>Example #1 PHP 7.1 之前的 GCM 模式的 AES 认证加密示例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//$key should have been previously generated in a cryptographically safe way, like openssl_random_pseudo_bytes<br /></span><span style="color: #0000BB">$plaintext </span><span style="color: #007700">= </span><span style="color: #DD0000">"message to be encrypted"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$cipher </span><span style="color: #007700">= </span><span style="color: #DD0000">"aes-128-gcm"</span><span style="color: #007700">;<br />if (</span><span style="color: #0000BB">in_array</span><span style="color: #007700">(</span><span style="color: #0000BB">$cipher</span><span style="color: #007700">, </span><span style="color: #0000BB">openssl_get_cipher_methods</span><span style="color: #007700">()))<br />{<br />    </span><span style="color: #0000BB">$ivlen </span><span style="color: #007700">= </span><span style="color: #0000BB">openssl_cipher_iv_length</span><span style="color: #007700">(</span><span style="color: #0000BB">$cipher</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">$iv </span><span style="color: #007700">= </span><span style="color: #0000BB">openssl_random_pseudo_bytes</span><span style="color: #007700">(</span><span style="color: #0000BB">$ivlen</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">$ciphertext </span><span style="color: #007700">= </span><span style="color: #0000BB">openssl_encrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$plaintext</span><span style="color: #007700">, </span><span style="color: #0000BB">$cipher</span><span style="color: #007700">, </span><span style="color: #0000BB">$key</span><span style="color: #007700">, </span><span style="color: #0000BB">$options</span><span style="color: #007700">=</span><span style="color: #0000BB">0</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv</span><span style="color: #007700">, </span><span style="color: #0000BB">$tag</span><span style="color: #007700">);<br />    </span><span style="color: #FF8000">//store $cipher, $iv, and $tag for decryption later<br />    </span><span style="color: #0000BB">$original_plaintext </span><span style="color: #007700">= </span><span style="color: #0000BB">openssl_decrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$ciphertext</span><span style="color: #007700">, </span><span style="color: #0000BB">$cipher</span><span style="color: #007700">, </span><span style="color: #0000BB">$key</span><span style="color: #007700">, </span><span style="color: #0000BB">$options</span><span style="color: #007700">=</span><span style="color: #0000BB">0</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv</span><span style="color: #007700">, </span><span style="color: #0000BB">$tag</span><span style="color: #007700">);<br />    echo </span><span style="color: #0000BB">$original_plaintext</span><span style="color: #007700">.</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>

   <div class="example" id="example-1880">
    <p><strong>Example #2 PHP 5.6+ 的 AES 认证加密例子</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//$key previously generated safely, ie: openssl_random_pseudo_bytes<br /></span><span style="color: #0000BB">$plaintext </span><span style="color: #007700">= </span><span style="color: #DD0000">"message to be encrypted"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$ivlen </span><span style="color: #007700">= </span><span style="color: #0000BB">openssl_cipher_iv_length</span><span style="color: #007700">(</span><span style="color: #0000BB">$cipher</span><span style="color: #007700">=</span><span style="color: #DD0000">"AES-128-CBC"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$iv </span><span style="color: #007700">= </span><span style="color: #0000BB">openssl_random_pseudo_bytes</span><span style="color: #007700">(</span><span style="color: #0000BB">$ivlen</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$ciphertext_raw </span><span style="color: #007700">= </span><span style="color: #0000BB">openssl_encrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$plaintext</span><span style="color: #007700">, </span><span style="color: #0000BB">$cipher</span><span style="color: #007700">, </span><span style="color: #0000BB">$key</span><span style="color: #007700">, </span><span style="color: #0000BB">$options</span><span style="color: #007700">=</span><span style="color: #0000BB">OPENSSL_RAW_DATA</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$hmac </span><span style="color: #007700">= </span><span style="color: #0000BB">hash_hmac</span><span style="color: #007700">(</span><span style="color: #DD0000">'sha256'</span><span style="color: #007700">, </span><span style="color: #0000BB">$ciphertext_raw</span><span style="color: #007700">, </span><span style="color: #0000BB">$key</span><span style="color: #007700">, </span><span style="color: #0000BB">$as_binary</span><span style="color: #007700">=</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$ciphertext </span><span style="color: #007700">= </span><span style="color: #0000BB">base64_encode</span><span style="color: #007700">( </span><span style="color: #0000BB">$iv</span><span style="color: #007700">.</span><span style="color: #0000BB">$hmac</span><span style="color: #007700">.</span><span style="color: #0000BB">$ciphertext_raw </span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//decrypt later....<br /></span><span style="color: #0000BB">$c </span><span style="color: #007700">= </span><span style="color: #0000BB">base64_decode</span><span style="color: #007700">(</span><span style="color: #0000BB">$ciphertext</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$ivlen </span><span style="color: #007700">= </span><span style="color: #0000BB">openssl_cipher_iv_length</span><span style="color: #007700">(</span><span style="color: #0000BB">$cipher</span><span style="color: #007700">=</span><span style="color: #DD0000">"AES-128-CBC"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$iv </span><span style="color: #007700">= </span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$c</span><span style="color: #007700">, </span><span style="color: #0000BB">0</span><span style="color: #007700">, </span><span style="color: #0000BB">$ivlen</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$hmac </span><span style="color: #007700">= </span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$c</span><span style="color: #007700">, </span><span style="color: #0000BB">$ivlen</span><span style="color: #007700">, </span><span style="color: #0000BB">$sha2len</span><span style="color: #007700">=</span><span style="color: #0000BB">32</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$ciphertext_raw </span><span style="color: #007700">= </span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$c</span><span style="color: #007700">, </span><span style="color: #0000BB">$ivlen</span><span style="color: #007700">+</span><span style="color: #0000BB">$sha2len</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$original_plaintext </span><span style="color: #007700">= </span><span style="color: #0000BB">openssl_decrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$ciphertext_raw</span><span style="color: #007700">, </span><span style="color: #0000BB">$cipher</span><span style="color: #007700">, </span><span style="color: #0000BB">$key</span><span style="color: #007700">, </span><span style="color: #0000BB">$options</span><span style="color: #007700">=</span><span style="color: #0000BB">OPENSSL_RAW_DATA</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$calcmac </span><span style="color: #007700">= </span><span style="color: #0000BB">hash_hmac</span><span style="color: #007700">(</span><span style="color: #DD0000">'sha256'</span><span style="color: #007700">, </span><span style="color: #0000BB">$ciphertext_raw</span><span style="color: #007700">, </span><span style="color: #0000BB">$key</span><span style="color: #007700">, </span><span style="color: #0000BB">$as_binary</span><span style="color: #007700">=</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />if (</span><span style="color: #0000BB">hash_equals</span><span style="color: #007700">(</span><span style="color: #0000BB">$hmac</span><span style="color: #007700">, </span><span style="color: #0000BB">$calcmac</span><span style="color: #007700">))</span><span style="color: #FF8000">// timing attack safe comparison<br /></span><span style="color: #007700">{<br />    echo </span><span style="color: #0000BB">$original_plaintext</span><span style="color: #007700">.</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>

  </p>
 </div>



 <div class="refsect1 seealso" id="refsect1-function.openssl-encrypt-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.openssl-decrypt.html" class="function" rel="rdfs-seeAlso">openssl_decrypt()</a> - 解密数据</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="126966""></a>
  <div class="note">
   <strong class="user">ralf at exphpert dot de</strong>
   <a href="#126966" class="date">30-Mar-2022 01:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I'd like to point out that the command description doesn't very well point out, how the command really works for the less experienced user.<br />
<br />
One important point is, that you do NOT pass a tag to openssl_encrypt. Any value in the tag variable will be overwritten by openssl_encrypt. It by itself will create a tag which you will need to store.<br />
<br />
To be able to decrypt the encrypted secret with openssl_decrypt, you need to provide (at least) the secret, the cipher, the initialization vector, and the tag.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="126546""></a>
  <div class="note">
   <strong class="user">desmatic at gmail dot com</strong>
   <a href="#126546" class="date">30-Oct-2021 12:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Upgraded php and needed something to replace insecure legacy mcrypt libs, but still supported classic user, password interface.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">encrypt</span><span class="keyword">(</span><span class="default">$plaintext</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$cipher </span><span class="keyword">= </span><span class="string">"aes-256-gcm"</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; if (!</span><span class="default">in_array</span><span class="keyword">(</span><span class="default">$cipher</span><span class="keyword">, </span><span class="default">openssl_get_cipher_methods</span><span class="keyword">())) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">openssl_random_pseudo_bytes</span><span class="keyword">(</span><span class="default">openssl_cipher_iv_length</span><span class="keyword">(</span><span class="default">$cipher</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tag </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ciphertext </span><span class="keyword">= </span><span class="default">openssl_encrypt</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">gzcompress</span><span class="keyword">(</span><span class="default">$plaintext</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cipher</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$options</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$iv</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tag</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; );<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">json_encode</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"ciphertext" </span><span class="keyword">=&gt; </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$ciphertext</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"cipher" </span><span class="keyword">=&gt; </span><span class="default">$cipher</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"iv" </span><span class="keyword">=&gt; </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$iv</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"tag" </span><span class="keyword">=&gt; </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$tag</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; )<br />
&nbsp;&nbsp;&nbsp; );<br />
}<br />
<br />
function </span><span class="default">decrypt</span><span class="keyword">(</span><span class="default">$cipherjson</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; try {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$json </span><span class="keyword">= </span><span class="default">json_decode</span><span class="keyword">(</span><span class="default">$cipherjson</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">,&nbsp; </span><span class="default">JSON_THROW_ON_ERROR</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } catch (</span><span class="default">Exception $e</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">gzuncompress</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_decrypt</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$json</span><span class="keyword">[</span><span class="string">'ciphertext'</span><span class="keyword">]),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$json</span><span class="keyword">[</span><span class="string">'cipher'</span><span class="keyword">],<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$options</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$json</span><span class="keyword">[</span><span class="string">'iv'</span><span class="keyword">]),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$json</span><span class="keyword">[</span><span class="string">'tag'</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; )<br />
&nbsp;&nbsp;&nbsp; );<br />
}<br />
<br />
</span><span class="default">$secret </span><span class="keyword">= </span><span class="string">"MySecRet@123"</span><span class="keyword">;<br />
</span><span class="default">$cipherjson </span><span class="keyword">= </span><span class="default">encrypt</span><span class="keyword">(</span><span class="string">"Hello world!\n"</span><span class="keyword">, </span><span class="default">$secret</span><span class="keyword">);<br />
echo </span><span class="default">decrypt</span><span class="keyword">(</span><span class="default">$cipherjson</span><span class="keyword">, </span><span class="default">$secret</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="126296""></a>
  <div class="note">
   <strong class="user">TheNorthMemory</strong>
   <a href="#126296" class="date">31-Jul-2021 07:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I saw that a doc bug(#80236) were there mentioned that $tag usage. Here is an examples, Hopes those may help someone.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/**<br />
* Encrypts given data with given key, iv and aad, returns a base64 encoded string.<br />
*<br />
* @param string $plaintext - Text to encode.<br />
* @param string $key - The secret key, 32 bytes string.<br />
* @param string $iv - The initialization vector, 16 bytes string.<br />
* @param string $aad - The additional authenticated data, maybe empty string.<br />
*<br />
* @return string - The base64-encoded ciphertext.<br />
*/<br />
</span><span class="keyword">function </span><span class="default">encrypt</span><span class="keyword">(</span><span class="default">string $plaintext</span><span class="keyword">, </span><span class="default">string $key</span><span class="keyword">, </span><span class="default">string $iv </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">, </span><span class="default">string $aad </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">): </span><span class="default">string<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ciphertext </span><span class="keyword">= </span><span class="default">openssl_encrypt</span><span class="keyword">(</span><span class="default">$plaintext</span><span class="keyword">, </span><span class="string">'aes-256-gcm'</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">, </span><span class="default">$tag</span><span class="keyword">, </span><span class="default">$aad</span><span class="keyword">, </span><span class="default">16</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$ciphertext</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">UnexpectedValueException</span><span class="keyword">(</span><span class="string">'Encrypting the input $plaintext failed, please checking your $key and $iv whether or nor correct.'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$ciphertext </span><span class="keyword">. </span><span class="default">$tag</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">/**<br />
* Takes a base64 encoded string and decrypts it using a given key, iv and aad.<br />
*<br />
* @param string $ciphertext - The base64-encoded ciphertext.<br />
* @param string $key - The secret key, 32 bytes string.<br />
* @param string $iv - The initialization vector, 16 bytes string.<br />
* @param string $aad - The additional authenticated data, maybe empty string.<br />
*<br />
* @return string - The utf-8 plaintext.<br />
*/<br />
</span><span class="keyword">function </span><span class="default">decrypt</span><span class="keyword">(</span><span class="default">string $ciphertext</span><span class="keyword">, </span><span class="default">string $key</span><span class="keyword">, </span><span class="default">string $iv </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">, </span><span class="default">string $aad </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">): </span><span class="default">string<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ciphertext </span><span class="keyword">= </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$ciphertext</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$authTag </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$ciphertext</span><span class="keyword">, -</span><span class="default">16</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tagLength </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$authTag</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Manually checking the length of the tag, because the `openssl_decrypt` was mentioned there, it's the caller's responsibility. */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$tagLength </span><span class="keyword">&gt; </span><span class="default">16 </span><span class="keyword">|| (</span><span class="default">$tagLength </span><span class="keyword">&lt; </span><span class="default">12 </span><span class="keyword">&amp;&amp; </span><span class="default">$tagLength </span><span class="keyword">!== </span><span class="default">8 </span><span class="keyword">&amp;&amp; </span><span class="default">$tagLength </span><span class="keyword">!== </span><span class="default">4</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">RuntimeException</span><span class="keyword">(</span><span class="string">'The inputs `$ciphertext` incomplete, the bytes length must be one of 16, 15, 14, 13, 12, 8 or 4.'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$plaintext </span><span class="keyword">= </span><span class="default">openssl_decrypt</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$ciphertext</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, -</span><span class="default">16</span><span class="keyword">), </span><span class="string">'aes-256-gcm'</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">, </span><span class="default">$authTag</span><span class="keyword">, </span><span class="default">$aad</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$plaintext</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">UnexpectedValueException</span><span class="keyword">(</span><span class="string">'Decrypting the input $ciphertext failed, please checking your $key and $iv whether or nor correct.'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$plaintext</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">// usage samples<br />
</span><span class="default">$aesKey </span><span class="keyword">= </span><span class="default">random_bytes</span><span class="keyword">(</span><span class="default">32</span><span class="keyword">);<br />
</span><span class="default">$aesIv </span><span class="keyword">= </span><span class="default">random_bytes</span><span class="keyword">(</span><span class="default">16</span><span class="keyword">);<br />
</span><span class="default">$ciphertext </span><span class="keyword">= </span><span class="default">encrypt</span><span class="keyword">(</span><span class="string">'thing'</span><span class="keyword">, </span><span class="default">$aesKey</span><span class="keyword">, </span><span class="default">$aesIv</span><span class="keyword">);<br />
</span><span class="default">$plaintext </span><span class="keyword">= </span><span class="default">decrypt</span><span class="keyword">(</span><span class="default">$ciphertext</span><span class="keyword">, </span><span class="default">$aesKey</span><span class="keyword">, </span><span class="default">$aesIv</span><span class="keyword">);<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$ciphertext</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$plaintext</span><span class="keyword">);</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="126267""></a>
  <div class="note">
   <strong class="user">Shin</strong>
   <a href="#126267" class="date">22-Jul-2021 10:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Concise description about "options" parameter!<br />
<br />
<a href="http://phpcoderweb.com/manual/function-openssl-encrypt_5698.html" rel="nofollow" target="_blank">http://phpcoderweb.com/manual/function-openssl-encrypt_5698.html</a><br />
<br />
&gt; OPENSSL_ZERO_PADDING has a direct impact on the OpenSSL context.&nbsp; EVP_CIPHER_CTX_set_padding() enables or disables padding (enabled by default).&nbsp; So, OPENSSL_ZERO_PADDING disables padding for the context, which means that you will have to manually apply your own padding out to the block size.&nbsp; Without using OPENSSL_ZERO_PADDING, you will automatically get PKCS#7 padding.<br />
<br />
&gt; OPENSSL_RAW_DATA does not affect the OpenSSL context but has an impact on the format of the data returned to the caller.&nbsp; When OPENSSL_RAW_DATA is specified, the returned data is returned as-is.&nbsp; When it is not specified, Base64 encoded data is returned to the caller.<br />
<br />
Where<br />
- OPENSSL_RAW_DATA=1<br />
- OPENSSL_ZERO_PADDING=2<br />
<br />
Hence<br />
options = 0<br />
-&gt; PKCS#7 padding, Base64 Encode<br />
options = 1<br />
-&gt; PKCS#7 padding, No Base64 Encode (RAW DATA)<br />
options = 2<br />
-&gt; No padding, Base64 Encode<br />
options = 3&nbsp; ( 1 OR 2 )<br />
-&gt; No padding, No Base64 Encode (RAW DATA)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="124246""></a>
  <div class="note">
   <strong class="user">handsomedmm at 126 dot com</strong>
   <a href="#124246" class="date">29-Sep-2019 09:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if encrypt data by openssl enc command with pass and salt, it can aslo decrypt by openssl_decrypt.<br />
<br />
eg.<br />
<br />
encrypt command:<br />
<br />
# echo -n test123 | openssl enc -aes-128-cbc -pass pass:"pass123" -a -md md5<br />
<br />
decrypt command:<br />
# echo -n U2FsdGVkX19349P4LpeP5Sbi4lpCx6lLwFQ2t9xs2AQ= | base64 -d| openssl&nbsp; enc -aes-128-cbc -pass pass:"pass123" -md md5 -d -p<br />
salt=77E3D3F82E978FE5<br />
key=9CA70521F78B9909BF73BAE9233D6258<br />
iv =04BCCB509EC9E6F5AF7E822CA58EA557<br />
test123<br />
<br />
use php code<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// encode data<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$encodeData </span><span class="keyword">= </span><span class="string">"U2FsdGVkX19349P4LpeP5Sbi4lpCx6lLwFQ2t9xs2AQ="</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// base64 decode<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$encodeData</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">16</span><span class="keyword">); </span><span class="comment">// if salted , remove Salted__ prefix<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // salt and pass config<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$salt&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">hex2bin</span><span class="keyword">(</span><span class="string">"77E3D3F82E978FE5"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pass&nbsp;&nbsp; </span><span class="keyword">= </span><span class="string">"pass123"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$method </span><span class="keyword">= </span><span class="string">"AES-128-CBC"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// generate iv and key<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$hash1 </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$pass </span><span class="keyword">. </span><span class="default">$salt</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$hash2 </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">hex2bin</span><span class="keyword">(</span><span class="default">$hash1</span><span class="keyword">) . </span><span class="default">$pass </span><span class="keyword">. </span><span class="default">$salt</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">hex2bin</span><span class="keyword">(</span><span class="default">$hash1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$iv&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">hex2bin</span><span class="keyword">(</span><span class="default">$hash2</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$decodeData </span><span class="keyword">= </span><span class="default">openssl_decrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">$method</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$decodeData</span><span class="keyword">);</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="124244""></a>
  <div class="note">
   <strong class="user">gcleaves at gmail dot com</strong>
   <a href="#124244" class="date">29-Sep-2019 07:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note that at the time of writing this, there is an important and naive security vulnerability in "Example #2 AES Authenticated Encryption example for PHP 5.6+".<br />
<br />
You MUST include the IV when calculating the HMAC. Otherwise, somebody could alter the IV during transport, thereby changing the decrypted message while maintaining HMAC integrity. An absolute disaster.<br />
<br />
To fix the example, the HMAC should be calculated like this:<br />
<br />
<span class="default">&lt;?php<br />
$hmac </span><span class="keyword">= </span><span class="default">hash_hmac</span><span class="keyword">(</span><span class="string">'sha256'</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">.</span><span class="default">$ciphertext_raw</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$as_binary</span><span class="keyword">=</span><span class="default">true</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123586""></a>
  <div class="note">
   <strong class="user">waltzie</strong>
   <a href="#123586" class="date">06-Feb-2019 09:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There are some troubles implementing a 1:1 encryprion/decription between mcrypt and openssl using MCRYPT_RIJNDAEL_128 CBC because the AES-256 is different from RIJNDAEL-256.<br />
The 256 in AES refers to the key size, where the 256 in RIJNDAEL refers to block size.<br />
&nbsp;AES-256 is RIJNDAEL-128 when used with a 256 bit key<br />
(https://stackoverflow.com/questions/6770370/aes-256-encryption-in-php&nbsp; ircmaxell Jun 22 '13 at 11:50)<br />
<br />
Example <br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">encrypt_openssl</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$encryptedMessage </span><span class="keyword">= </span><span class="default">openssl_encrypt</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">, </span><span class="string">'AES-256-CBC'</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">|</span><span class="default">OPENSSL_ZERO_PADDING&nbsp; </span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$iv </span><span class="keyword">. </span><span class="default">$encryptedMessage</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">decrypt_openssl</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$iv_size </span><span class="keyword">= </span><span class="default">openssl_cipher_iv_length</span><span class="keyword">(</span><span class="string">'AES-256-CBC'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$iv_size</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">$iv_size</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">openssl_decrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="string">'AES-256-CBC'</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">,</span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">|</span><span class="default">OPENSSL_ZERO_PADDING&nbsp; </span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
<br />
}<br />
<br />
function </span><span class="default">decrypt_data</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">,</span><span class="default">$key</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$iv_size </span><span class="keyword">= </span><span class="default">mcrypt_get_iv_size</span><span class="keyword">(</span><span class="default">MCRYPT_RIJNDAEL_128</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_CBC</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$iv_size</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">$iv_size</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$decrypted </span><span class="keyword">= </span><span class="default">mcrypt_decrypt</span><span class="keyword">(</span><span class="default">MCRYPT_RIJNDAEL_128</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_CBC</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$decrypted </span><span class="keyword">= </span><span class="default">rtrim</span><span class="keyword">(</span><span class="default">$decrypted</span><span class="keyword">, </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return(</span><span class="default">$decrypted</span><span class="keyword">);<br />
}<br />
<br />
function </span><span class="default">encrypt_data</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">,</span><span class="default">$key</span><span class="keyword">,</span><span class="default">$iv</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$encrypted </span><span class="keyword">= </span><span class="default">$iv </span><span class="keyword">.&nbsp; </span><span class="default">mcrypt_encrypt</span><span class="keyword">(</span><span class="default">MCRYPT_RIJNDAEL_128</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_CBC</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$encrypted</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">// ZERO Padding ISO/IEC 9797-1, ISO/IEC 10118-1<br />
</span><span class="keyword">function </span><span class="default">pad_zero</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$len </span><span class="keyword">= </span><span class="default">mcrypt_get_block_size </span><span class="keyword">(</span><span class="default">MCRYPT_RIJNDAEL_128</span><span class="keyword">,</span><span class="default">MCRYPT_MODE_CBC</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) % </span><span class="default">$len</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$padLength </span><span class="keyword">=&nbsp; </span><span class="default">$len </span><span class="keyword">- </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) %&nbsp; </span><span class="default">$len</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">.= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="string">"\0"</span><span class="keyword">, </span><span class="default">$padLength</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$data</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">$iv_size </span><span class="keyword">= </span><span class="default">mcrypt_get_iv_size</span><span class="keyword">(</span><span class="default">MCRYPT_RIJNDAEL_128</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_CBC</span><span class="keyword">);<br />
</span><span class="default">$iv </span><span class="keyword">= </span><span class="default">mcrypt_create_iv</span><span class="keyword">(</span><span class="default">$iv_size</span><span class="keyword">, </span><span class="default">MCRYPT_RAND</span><span class="keyword">);<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="string">"Hello World!"</span><span class="keyword">;<br />
</span><span class="default">$key </span><span class="keyword">= </span><span class="default">hash</span><span class="keyword">(</span><span class="string">'sha256'</span><span class="keyword">,</span><span class="string">"secret"</span><span class="keyword">,</span><span class="default">true</span><span class="keyword">);<br />
<br />
echo </span><span class="string">"\n\n</span><span class="default">$data</span><span class="string">\n\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">$enc </span><span class="keyword">= </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">encrypt_data</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">,</span><span class="default">$key</span><span class="keyword">,</span><span class="default">$iv</span><span class="keyword">));<br />
echo </span><span class="string">"\nEnc: </span><span class="default">$enc</span><span class="string">"</span><span class="keyword">;<br />
</span><span class="default">$dec </span><span class="keyword">= </span><span class="default">decrypt_data</span><span class="keyword">(</span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">),</span><span class="default">$key</span><span class="keyword">);<br />
echo </span><span class="string">"\nDec: </span><span class="default">$dec</span><span class="string">"</span><span class="keyword">;<br />
</span><span class="default">$dec2</span><span class="keyword">=</span><span class="default">decrypt_openssl</span><span class="keyword">(</span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">),</span><span class="default">$key</span><span class="keyword">);<br />
echo </span><span class="string">"\nDec: </span><span class="default">$dec2</span><span class="string">"</span><span class="keyword">;<br />
<br />
echo </span><span class="string">"\n\nreverse\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">$enc2 </span><span class="keyword">= </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">encrypt_openssl</span><span class="keyword">(</span><span class="default">pad_zero</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">),</span><span class="default">$key</span><span class="keyword">,</span><span class="default">$iv</span><span class="keyword">));<br />
echo </span><span class="string">"\nEnc: </span><span class="default">$enc2</span><span class="string">"</span><span class="keyword">;<br />
</span><span class="default">$dec </span><span class="keyword">= </span><span class="default">decrypt_data</span><span class="keyword">(</span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$enc2</span><span class="keyword">),</span><span class="default">$key</span><span class="keyword">);<br />
echo </span><span class="string">"\nDec: </span><span class="default">$dec</span><span class="string">"</span><span class="keyword">;<br />
</span><span class="default">$dec2</span><span class="keyword">=</span><span class="default">decrypt_openssl</span><span class="keyword">(</span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$enc2</span><span class="keyword">),</span><span class="default">$key</span><span class="keyword">);<br />
echo </span><span class="string">"\nDec: </span><span class="default">$dec2</span><span class="string">"</span><span class="keyword">;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="122502""></a>
  <div class="note">
   <strong class="user">Jess Portnoy</strong>
   <a href="#122502" class="date">13-Mar-2018 11:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that OPENSSL_RAW_DATA and OPENSSL_ZERO_PADDING were introduced by this commit:<br />
https://github.com/php/php-src/commit/9e7ae3b2d0e942b816e3836025456544d6288ac3<br />
<br />
Before that, the options arg was called raw_output and was a Boolean so if you're considering this method as a replacement for mcrypt_encrypt(), this will only work with PHP 5.5 and above.<br />
<br />
A good guide on replacing Mcrypt encryption/decryption methods with the OpenSSL parallels can be found here:<br />
<a href="http://thefsb.tumblr.com/post/110749271235/using-opensslendecrypt-in-php-instead-of" rel="nofollow" target="_blank">http://thefsb.tumblr.com/post/110749271235/using-opensslendecrypt-in-php-instead-of</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121982""></a>
  <div class="note">
   <strong class="user">omidbahrami1990 at gmail dot com</strong>
   <a href="#121982" class="date">05-Dec-2017 11:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This Is The Most Secure Way To Encrypt And Decrypt Your Data, <br />
It Is Almost Impossible To Crack Your Encryption.<br />
--------------------------------------------------------<br />
&nbsp;--- Create Two Random Keys And Save Them In Your Configuration File ---<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Create The First Key<br />
</span><span class="keyword">echo </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">openssl_random_pseudo_bytes</span><span class="keyword">(</span><span class="default">32</span><span class="keyword">));<br />
<br />
</span><span class="comment">// Create The Second Key<br />
</span><span class="keyword">echo </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">openssl_random_pseudo_bytes</span><span class="keyword">(</span><span class="default">64</span><span class="keyword">));<br />
</span><span class="default">?&gt;<br />
</span>--------------------------------------------------------<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Save The Keys In Your Configuration File<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="string">'FIRSTKEY'</span><span class="keyword">,</span><span class="string">'Lk5Uz3slx3BrAghS1aaW5AYgWZRV0tIX5eI0yPchFz4='</span><span class="keyword">);<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="string">'SECONDKEY'</span><span class="keyword">,</span><span class="string">'EZ44mFi3TlAey1b2w4Y7lVDuqO+SRxGXsa7nctnr/JmMrA2vN6EJhrvdVZbxaQs5jpSe34X3ejFK/o9+Y5c83w=='</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span>--------------------------------------------------------<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">secured_encrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">)<br />
{<br />
</span><span class="default">$first_key </span><span class="keyword">= </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">FIRSTKEY</span><span class="keyword">);<br />
</span><span class="default">$second_key </span><span class="keyword">= </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">SECONDKEY</span><span class="keyword">);&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; <br />
</span><span class="default">$method </span><span class="keyword">= </span><span class="string">"aes-256-cbc"</span><span class="keyword">;&nbsp; &nbsp; <br />
</span><span class="default">$iv_length </span><span class="keyword">= </span><span class="default">openssl_cipher_iv_length</span><span class="keyword">(</span><span class="default">$method</span><span class="keyword">);<br />
</span><span class="default">$iv </span><span class="keyword">= </span><span class="default">openssl_random_pseudo_bytes</span><span class="keyword">(</span><span class="default">$iv_length</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">$first_encrypted </span><span class="keyword">= </span><span class="default">openssl_encrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">,</span><span class="default">$method</span><span class="keyword">,</span><span class="default">$first_key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA </span><span class="keyword">,</span><span class="default">$iv</span><span class="keyword">);&nbsp; &nbsp; <br />
</span><span class="default">$second_encrypted </span><span class="keyword">= </span><span class="default">hash_hmac</span><span class="keyword">(</span><span class="string">'sha3-512'</span><span class="keyword">, </span><span class="default">$first_encrypted</span><span class="keyword">, </span><span class="default">$second_key</span><span class="keyword">, </span><span class="default">TRUE</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">$output </span><span class="keyword">= </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$iv</span><span class="keyword">.</span><span class="default">$second_encrypted</span><span class="keyword">.</span><span class="default">$first_encrypted</span><span class="keyword">);&nbsp; &nbsp; <br />
return </span><span class="default">$output</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; <br />
}<br />
</span><span class="default">?&gt;<br />
</span>--------------------------------------------------------<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">secured_decrypt</span><span class="keyword">(</span><span class="default">$input</span><span class="keyword">)<br />
{<br />
</span><span class="default">$first_key </span><span class="keyword">= </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">FIRSTKEY</span><span class="keyword">);<br />
</span><span class="default">$second_key </span><span class="keyword">= </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">SECONDKEY</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
</span><span class="default">$mix </span><span class="keyword">= </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$input</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">$method </span><span class="keyword">= </span><span class="string">"aes-256-cbc"</span><span class="keyword">;&nbsp; &nbsp; <br />
</span><span class="default">$iv_length </span><span class="keyword">= </span><span class="default">openssl_cipher_iv_length</span><span class="keyword">(</span><span class="default">$method</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">$iv </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$mix</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$iv_length</span><span class="keyword">);<br />
</span><span class="default">$second_encrypted </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$mix</span><span class="keyword">,</span><span class="default">$iv_length</span><span class="keyword">,</span><span class="default">64</span><span class="keyword">);<br />
</span><span class="default">$first_encrypted </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$mix</span><span class="keyword">,</span><span class="default">$iv_length</span><span class="keyword">+</span><span class="default">64</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">openssl_decrypt</span><span class="keyword">(</span><span class="default">$first_encrypted</span><span class="keyword">,</span><span class="default">$method</span><span class="keyword">,</span><span class="default">$first_key</span><span class="keyword">,</span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">,</span><span class="default">$iv</span><span class="keyword">);<br />
</span><span class="default">$second_encrypted_new </span><span class="keyword">= </span><span class="default">hash_hmac</span><span class="keyword">(</span><span class="string">'sha3-512'</span><span class="keyword">, </span><span class="default">$first_encrypted</span><span class="keyword">, </span><span class="default">$second_key</span><span class="keyword">, </span><span class="default">TRUE</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
if (</span><span class="default">hash_equals</span><span class="keyword">(</span><span class="default">$second_encrypted</span><span class="keyword">,</span><span class="default">$second_encrypted_new</span><span class="keyword">))<br />
return </span><span class="default">$data</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
return </span><span class="default">false</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121857""></a>
  <div class="note">
   <strong class="user">me at bobste dot in</strong>
   <a href="#121857" class="date">10-Nov-2017 07:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
string openssl_encrypt </span><span class="keyword">( <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">string $data </span><span class="keyword">, <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">string $method </span><span class="keyword">, <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">string $key</span><span class="keyword">, <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">int $options </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">,&nbsp; &nbsp; &nbsp; </span><span class="comment">// optional<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">string $iv </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">,&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// optional<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">string </span><span class="keyword">&amp;</span><span class="default">$tag </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">,&nbsp;&nbsp; </span><span class="comment">// optional<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">string $aad </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">,&nbsp; &nbsp; &nbsp; </span><span class="comment">// optional<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">int $tag_length </span><span class="keyword">= </span><span class="default">16&nbsp;&nbsp; </span><span class="comment">// optional<br />
</span><span class="keyword">)<br />
</span><span class="comment">// (a kinder, gentler function header)<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121818""></a>
  <div class="note">
   <strong class="user">Jean-Luc</strong>
   <a href="#121818" class="date">02-Nov-2017 09:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Important: The key should have exactly the same length as the cipher you are using. For example, if you use AES-256 then you should provide a $key that is 32 bytes long (256 bits == 32 bytes). Any additional bytes in $key will be truncated and not used at all.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121545""></a>
  <div class="note">
   <strong class="user">denis at bitrix dot ru</strong>
   <a href="#121545" class="date">21-Aug-2017 06:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
How to migrate from mcrypt to openssl with backward compatibility.<br />
<br />
In my case I used Blowfish in ECB mode. The task was to decrypt data with openssl_decrypt, encrypted by mcrypt_encrypt and vice versa. It was obvious for a first sight. But in fact openssl_encrypt and mcrypt_encript give different results in most cases.<br />
<br />
Investigating the web I found out that the reason is in different padding methods. And for some reasons openssl_encrypt behave the same strange way with OPENSSL_ZERO_PADDING and OPENSSL_NO_PADDING options: it returns FALSE if encrypted string doesn't divide to the block size. To solve the problem you have to pad your string with NULs by yourself.<br />
<br />
The second question was the key length. Both functions give the same result if the key length is between 16 and 56 bytes. And I managed to find that if your key is shorter than 16 bytes, you just have to repeat it appropriate number of times.<br />
<br />
And finally the code follows which works the same way on openssl and mcrypt libraries.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">encrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$l </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$l </span><span class="keyword">&lt; </span><span class="default">16</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">ceil</span><span class="keyword">(</span><span class="default">16</span><span class="keyword">/</span><span class="default">$l</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$m </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">)%</span><span class="default">8</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">.= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="string">"\x00"</span><span class="keyword">,&nbsp; </span><span class="default">8 </span><span class="keyword">- </span><span class="default">$m</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'mcrypt_encrypt'</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val </span><span class="keyword">= </span><span class="default">mcrypt_encrypt</span><span class="keyword">(</span><span class="default">MCRYPT_BLOWFISH</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_ECB</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val </span><span class="keyword">= </span><span class="default">openssl_encrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="string">'BF-ECB'</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA </span><span class="keyword">| </span><span class="default">OPENSSL_NO_PADDING</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$val</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">decrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$l </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$l </span><span class="keyword">&lt; </span><span class="default">16</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">ceil</span><span class="keyword">(</span><span class="default">16</span><span class="keyword">/</span><span class="default">$l</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'mcrypt_encrypt'</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val </span><span class="keyword">= </span><span class="default">mcrypt_decrypt</span><span class="keyword">(</span><span class="default">MCRYPT_BLOWFISH</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_ECB</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val </span><span class="keyword">= </span><span class="default">openssl_decrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="string">'BF-ECB'</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA </span><span class="keyword">| </span><span class="default">OPENSSL_NO_PADDING</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$val</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="string">'my secret message'</span><span class="keyword">;<br />
</span><span class="default">$key </span><span class="keyword">= </span><span class="string">'dontsay'</span><span class="keyword">;<br />
<br />
</span><span class="default">$c </span><span class="keyword">= </span><span class="default">encrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">);<br />
</span><span class="default">$d </span><span class="keyword">= </span><span class="default">decrypt</span><span class="keyword">(</span><span class="default">$c</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$c</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$d</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span>Gives:<br />
<br />
string(32) "SWBMedXJIxuA9FcMOqCqomk0E5nFq6wv"<br />
string(24) "my secret message\000\000\000\000\000\000\000"</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120858""></a>
  <div class="note">
   <strong class="user">darek334 at gazeta dot pl</strong>
   <a href="#120858" class="date">23-Mar-2017 12:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To check if cipher uses IV use openssl_cipher_iv_length it returns length if exist, 0 if not, false if cipher is unknown.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120141""></a>
  <div class="note">
   <strong class="user">naitsirch at e dot mail dot de</strong>
   <a href="#120141" class="date">10-Nov-2016 11:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PHP lacks a build-in function to encrypt and decrypt large files. `openssl_encrypt()` can be used to encrypt strings, but loading a huge file into memory is a bad idea.<br />
<br />
So we have to write a userland function doing that. This example uses the symmetric AES-128-CBC algorithm to encrypt smaller chunks of a large file and writes them into another file.<br />
<br />
# Encrypt Files<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/**<br />
&nbsp;* Define the number of blocks that should be read from the source file for each chunk.<br />
&nbsp;* For 'AES-128-CBC' each block consist of 16 bytes.<br />
&nbsp;* So if we read 10,000 blocks we load 160kb into memory. You may adjust this value<br />
&nbsp;* to read/write shorter or longer chunks.<br />
&nbsp;*/<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="string">'FILE_ENCRYPTION_BLOCKS'</span><span class="keyword">, </span><span class="default">10000</span><span class="keyword">);<br />
<br />
</span><span class="comment">/**<br />
&nbsp;* Encrypt the passed file and saves the result in a new file with ".enc" as suffix.<br />
&nbsp;* <br />
&nbsp;* @param string $source Path to file that should be encrypted<br />
&nbsp;* @param string $key&nbsp; &nbsp; The key used for the encryption<br />
&nbsp;* @param string $dest&nbsp;&nbsp; File name where the encryped file should be written to.<br />
&nbsp;* @return string|false&nbsp; Returns the file name that has been created or FALSE if an error occured<br />
&nbsp;*/<br />
</span><span class="keyword">function </span><span class="default">encryptFile</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$dest</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">, </span><span class="default">16</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">openssl_random_pseudo_bytes</span><span class="keyword">(</span><span class="default">16</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$fpOut </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$dest</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Put the initialzation vector to the beginning of the file<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fpOut</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$fpIn </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">, </span><span class="string">'rb'</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while (!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$fpIn</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$plaintext </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fpIn</span><span class="keyword">, </span><span class="default">16 </span><span class="keyword">* </span><span class="default">FILE_ENCRYPTION_BLOCKS</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ciphertext </span><span class="keyword">= </span><span class="default">openssl_encrypt</span><span class="keyword">(</span><span class="default">$plaintext</span><span class="keyword">, </span><span class="string">'AES-128-CBC'</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Use the first 16 bytes of the ciphertext as the next initialization vector<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$ciphertext</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">16</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fpOut</span><span class="keyword">, </span><span class="default">$ciphertext</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fpIn</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fpOut</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$error </span><span class="keyword">? </span><span class="default">false </span><span class="keyword">: </span><span class="default">$dest</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
# Decrypt Files<br />
<br />
To decrypt files that have been encrypted with the above function you can use this function.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/**<br />
&nbsp;* Dencrypt the passed file and saves the result in a new file, removing the<br />
&nbsp;* last 4 characters from file name.<br />
&nbsp;* <br />
&nbsp;* @param string $source Path to file that should be decrypted<br />
&nbsp;* @param string $key&nbsp; &nbsp; The key used for the decryption (must be the same as for encryption)<br />
&nbsp;* @param string $dest&nbsp;&nbsp; File name where the decryped file should be written to.<br />
&nbsp;* @return string|false&nbsp; Returns the file name that has been created or FALSE if an error occured<br />
&nbsp;*/<br />
</span><span class="keyword">function </span><span class="default">decryptFile</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$dest</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">, </span><span class="default">16</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$fpOut </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$dest</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$fpIn </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">, </span><span class="string">'rb'</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Get the initialzation vector from the beginning of the file<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fpIn</span><span class="keyword">, </span><span class="default">16</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while (!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$fpIn</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// we have to read one block more for decrypting than for encrypting<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ciphertext </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fpIn</span><span class="keyword">, </span><span class="default">16 </span><span class="keyword">* (</span><span class="default">FILE_ENCRYPTION_BLOCKS </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">)); <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$plaintext </span><span class="keyword">= </span><span class="default">openssl_decrypt</span><span class="keyword">(</span><span class="default">$ciphertext</span><span class="keyword">, </span><span class="string">'AES-128-CBC'</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Use the first 16 bytes of the ciphertext as the next initialization vector<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$ciphertext</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">16</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fpOut</span><span class="keyword">, </span><span class="default">$plaintext</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fpIn</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fpOut</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$error </span><span class="keyword">? </span><span class="default">false </span><span class="keyword">: </span><span class="default">$dest</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Source: <a href="http://stackoverflow.com/documentation/php/5794/cryptography/25499/" rel="nofollow" target="_blank">http://stackoverflow.com/documentation/php/5794/cryptography/25499/</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119986""></a>
  <div class="note">
   <strong class="user">Kruthers</strong>
   <a href="#119986" class="date">04-Oct-2016 07:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There still seems to be some confusion about the "password" argument to this function.&nbsp; It accepts a binary string for the key (ie. NOT encoded), at least for the cipher methods I tried (AES-128-CTR and AES-256-CTR).&nbsp; One of the posts says you should hex encode the key (which is wrong), and some say you should hash the key but don't make it clear how to properly pass the hashed key.<br />
<br />
Instead of the post made by anonymous, this should be more accurate info about the parameters:<br />
<br />
data - BINARY string<br />
method - regular string, from openssl_get_cipher_methods()<br />
password - BINARY string (ie. the encryption key in binary)<br />
options - integer (use the constants provided)<br />
iv - BINARY string<br />
<br />
This is not only from my testing, but backed up by the usage of this function by https://github.com/defuse/php-encryption</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119346""></a>
  <div class="note">
   <strong class="user">Nick</strong>
   <a href="#119346" class="date">17-May-2016 09:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There's a lot of confusion plus some false guidance here on the openssl library. <br />
<br />
The basic tips are:<br />
<br />
aes-256-ctr is arguably the best choice for cipher algorithm as of 2016. This avoids potential security issues (so-called padding oracle attacks) and bloat from algorithms that pad data to a certain block size. aes-256-gcm is preferable, but not usable until the openssl library is enhanced, which is due in PHP 7.1<br />
<br />
Use different random data for the initialisation vector each time encryption is made with the same key. mcrypt_create_iv() is one choice for random data. AES uses 16 byte blocks, so you need 16 bytes for the iv.<br />
<br />
Join the iv data to the encrypted result and extract the iv data again when decrypting.<br />
<br />
Pass OPENSSL_RAW_DATA for the flags and encode the result if necessary after adding in the iv data.<br />
<br />
Hash the chosen encryption key (the password parameter) using openssl_digest() with a hash function such as sha256, and use the hashed value for the password parameter.<br />
<br />
There's a simple Cryptor class on GitHub called php-openssl-cryptor that demonstrates encryption/decryption and hashing with openssl, along with how to produce and consume the data in base64 and hex as well as binary. It should lay the foundations for better understanding and making effective use of openssl with PHP.<br />
<br />
Hopefully it will help anyone looking to get started with this powerful library.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118832""></a>
  <div class="note">
   <strong class="user">Geoff</strong>
   <a href="#118832" class="date">12-Feb-2016 10:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Contrary to some of the other comments here, I'm not certain that Password is indeed being improperly treated as the direct key.&nbsp; I say this because I've been passing random text values into this parameter which would be invalid as hex input.&nbsp; It seems to be hashing the password I provide, using what algorithm I do not know, because otherwise I'd expect it to throw an exception instead of working as expected.<br />
<br />
That said, I'm using openssl_decrypt() to decrypt data that was only encrypted with openssl_encrypt().&nbsp; I've not had to try to decrypt data where I do know for certain what the direct key is to know if I have an issue with bad pad blocks or any other exceptions which would indicate a key mismatch.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118325""></a>
  <div class="note">
   <strong class="user">David</strong>
   <a href="#118325" class="date">17-Nov-2015 09:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note, that if you don't specify the ...RAW_DATA&nbsp; option, then you get a base64 encoded result.&nbsp; I lost a few hours because my PHP didn't have the OPENSSL_RAW_DATA constant, and after I'd carefully base64 encoded the result, it just wasn't decoding...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117499""></a>
  <div class="note">
   <strong class="user">Raphael</strong>
   <a href="#117499" class="date">18-Jun-2015 07:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Beware of the padding this method adds !<br />
<br />
<span class="default">&lt;?php<br />
$encryption_key </span><span class="keyword">= </span><span class="default">openssl_random_pseudo_bytes</span><span class="keyword">(</span><span class="default">32</span><span class="keyword">);<br />
</span><span class="default">$iv </span><span class="keyword">= </span><span class="default">openssl_random_pseudo_bytes</span><span class="keyword">(</span><span class="default">16</span><span class="keyword">);<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">openssl_random_pseudo_bytes</span><span class="keyword">(</span><span class="default">32</span><span class="keyword">);<br />
<br />
for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">5</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;</span><span class="default">$data </span><span class="keyword">= </span><span class="default">openssl_encrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="string">'aes-256-cbc'</span><span class="keyword">, </span><span class="default">$encryption_key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp;echo </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) . </span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
With this sample the output will be:<br />
48<br />
64<br />
80<br />
96<br />
112<br />
<br />
This is because our $data is already taking all the block size, so the method is adding a new block which will contain only padded bytes.<br />
<br />
The only solution that come to my mind to avoid this situation is to add the option OPENSSL_ZERO_PADDING along with the first one:<br />
<span class="default">&lt;?php<br />
$data </span><span class="keyword">= </span><span class="default">openssl_encrypt</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="string">'aes-256-cbc'</span><span class="keyword">, </span><span class="default">$encryption_key</span><span class="keyword">, </span><span class="default">OPENSSL_RAW_DATA</span><span class="keyword">|</span><span class="default">OPENSSL_ZERO_PADDING</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
/!\ Be careful when using this option, be sure that you provide data that have already been padded or that takes already all the block size.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117208""></a>
  <div class="note">
   <strong class="user">openssl at mailismagic dot com</strong>
   <a href="#117208" class="date">02-May-2015 02:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Since the $options are not documented, I'm going to clarify what they mean here in the comments.&nbsp; Behind the scenes, in the source code for /ext/openssl/openssl.c:<br />
<br />
&nbsp;&nbsp;&nbsp; EVP_EncryptInit_ex(&amp;cipher_ctx, NULL, NULL, key, (unsigned char *)iv);<br />
&nbsp;&nbsp;&nbsp; if (options &amp; OPENSSL_ZERO_PADDING) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; EVP_CIPHER_CTX_set_padding(&amp;cipher_ctx, 0);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
And later:<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (options &amp; OPENSSL_RAW_DATA) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; outbuf[outlen] = '\0';<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RETVAL_STRINGL((char *)outbuf, outlen, 0);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; int base64_str_len;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; char *base64_str;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; base64_str = (char*)php_base64_encode(outbuf, outlen, &amp;base64_str_len);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; efree(outbuf);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RETVAL_STRINGL(base64_str, base64_str_len, 0);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
So as we can see here, OPENSSL_ZERO_PADDING has a direct impact on the OpenSSL context.&nbsp; EVP_CIPHER_CTX_set_padding() enables or disables padding (enabled by default).&nbsp; So, OPENSSL_ZERO_PADDING disables padding for the context, which means that you will have to manually apply your own padding out to the block size.&nbsp; Without using OPENSSL_ZERO_PADDING, you will automatically get PKCS#7 padding.<br />
<br />
OPENSSL_RAW_DATA does not affect the OpenSSL context but has an impact on the format of the data returned to the caller.&nbsp; When OPENSSL_RAW_DATA is specified, the returned data is returned as-is.&nbsp; When it is not specified, Base64 encoded data is returned to the caller.<br />
<br />
Hope this saves someone a trip to the PHP source code to figure out what the $options do.&nbsp; Pro developer tip:&nbsp; Download and have a copy of the PHP source code locally so that, when the PHP documentation fails to live up to quality expectations, you can see what is actually happening behind the scenes.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116788""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#116788" class="date">28-Feb-2015 02:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a couple of notes about the parameters:<br />
<br />
data - It is interpreted as a binary string<br />
method - Regular string, make sure you check openssl_get_cipher_methods() for a list of the ciphers available in your server*<br />
password - As biohazard mentioned before, this is actually THE KEY! It should be in hex format.<br />
options - As explained in the Parameters section<br />
iv - Initialization Vector. Different than biohazard mentioned before, this should be a BINARY string. You should check for your particular implementation.<br />
<br />
To verify the length/format of your IV, you can provide strings of different lengths and check the error log. For example, in PHP 5.5.9 (Ubuntu 14.04 LTS), providing a 32 byte hex string (which would represent a 16 byte binary IV) throws an error.<br />
"IV passed is 32 bytes long which is longer than the 16 expected by the selected cipher" (cipher chosen was 'aes-256-cbc' which uses an IV of 128 bits, its block size). <br />
Alternatively, you can use openssl_cipher_iv_length().<br />
<br />
From the security standpoint, make sure you understand whether your IV needs to be random, secret or encrypted. Many times the IV can be non-secret but it has to be a cryptographically secure random number. Make sure you generate it with an appropriate function like openssl_random_pseudo_bytes(), not mt_rand().<br />
<br />
*Note that the available cipher methods can differ between your dev server and your production server! They will depend on the installation and compilation options used for OpenSSL in your machine(s).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109598""></a>
  <div class="note">
   <strong class="user">max</strong>
   <a href="#109598" class="date">01-Aug-2012 02:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Might be useful to people trying to use 'aes-256-cbc' cipher (and probably other cbc ciphers) in collaboration with other implementations of AES (C libs for example) that the openssl extension has a strict implementation regarding padding bytes. I found the solution only by manually going through the openssl source.<br />
<br />
In C, you would want to pad plaintexts the following way (assuming all mem allocations are proper):<br />
<br />
nPadding = ( 16 - ( bufferSize % 16 ) ) ? ( 16 - ( bufferSize % 16 ) ) : 16;<br />
for( index = bufferSize; index &lt; bufferSize + nPadding; index++ )<br />
{<br />
&nbsp;&nbsp;&nbsp; plaintext[ index ] = (char)nPadding;<br />
}<br />
<br />
while decryptions are validated like:<br />
<br />
isSuccess = TRUE;<br />
for( index = bufferSize - 1; index &gt; ( bufferSize - nPadding ); index-- )<br />
{<br />
&nbsp;&nbsp;&nbsp; if( plaintext[ index ] != nPadding )<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; isSuccess = FALSE;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
decryptedSize = bufferSize - nPadding;<br />
<br />
In plain english, the buffer must be padded up to blockSize. If the buffer is already a multiple of blockSize, you add an entire new blockSize bytes as padding.<br />
<br />
The value of the padding bytes MUST be the number of padding bytes as a byte...<br />
<br />
So 5 bytes of padding will result in the following bytes added at the end of the ciphertext:<br />
[ 0x05 ][ 0x05 ][ 0x05 ][ 0x05 ][ 0x05 ]<br />
<br />
Hope this saves someone else a few hours of their life.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109364""></a>
  <div class="note">
   <strong class="user">kazaaknet at yahoo dot com</strong>
   <a href="#109364" class="date">10-Jul-2012 05:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be advised there was a memory leak in this function: https://bugs.php.net/bug.php?id=54060.&nbsp; I believe this got fixed in 5.3.6, but on production webservers running 5.3.5 with modest traffic, this became&nbsp; a memory hemorrhage that brought my site down.&nbsp; Look at mcrypt_encrypt instead.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108733""></a>
  <div class="note">
   <strong class="user">Kukulkan</strong>
   <a href="#108733" class="date">21-May-2012 03:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PHP OpenSSL functions openssl_encrypt() and openssl_decrypt() seem to use PKCS5/7 style padding for all symmetric ciphers. Upon this, you can't use them to encrypt using null byte padding or to decrypt null byte padded data.<br />
<br />
The developers of the wrapper forgot the padding scheme flags... :(</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104438""></a>
  <div class="note">
   <strong class="user">biohazard dot ge at gmail dot com</strong>
   <a href="#104438" class="date">15-Jun-2011 06:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Many users give up with handilng problem when openssl command line tool cant decrypt php openssl encrypted file which is encrypted with openssl_encrypt function.<br />
<br />
For example how beginner is encrypting data:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$string </span><span class="keyword">= </span><span class="string">'It works ? Or not it works ?'</span><span class="keyword">;<br />
</span><span class="default">$pass </span><span class="keyword">= </span><span class="string">'1234'</span><span class="keyword">;<br />
</span><span class="default">$method </span><span class="keyword">= </span><span class="string">'aes128'</span><span class="keyword">;<br />
<br />
</span><span class="default">file_put_contents </span><span class="keyword">(</span><span class="string">'./file.encrypted'</span><span class="keyword">, </span><span class="default">openssl_encrypt </span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$method</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">));<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
And then how beginner is trying to decrypt data from command line:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -pass pass:123<br />
<br />
Or even if he/she determinates that openssl_encrypt output was base64 and tries:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -base64 -pass pass:123<br />
<br />
Or even if he determinates that base64 encoded file is represented in one line and tries:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -base64 -A -pass pass:123<br />
<br />
Or even if he determinates that IV is needed and adds some string iv as encryption function`s fourth parameter and than adds hex representation of iv as parameter in openssl command line :<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -base64 -pass pass:123 -iv -iv 31323334353637383132333435363738<br />
<br />
Or even if he determinates that aes-128 password must be 128 bits there fore 16 bytes and sets $pass = '1234567812345678' and tries:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -base64 -pass pass:1234567812345678 -iv -iv 31323334353637383132333435363738<br />
<br />
All these troubles will have no result in any case.<br />
<br />
BECAUSE THE PASSWORD PARAMETER DOCUMENTED HERE IS NOT THE PASSWORD.<br />
<br />
It means that the password parameter of the function is not the same string used as [-pass pass:] parameter with openssl cmd tool for file encryption decryption.<br />
<br />
IT IS THE KEY !<br />
<br />
And now how to correctly encrypt data with php openssl_encrypt and how to correctly decrypt it from openssl command line tool.<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">strtohex</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">) <br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$s</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">str_split</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">) as </span><span class="default">$c</span><span class="keyword">) </span><span class="default">$s</span><span class="keyword">.=</span><span class="default">sprintf</span><span class="keyword">(</span><span class="string">"%02X"</span><span class="keyword">,</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$c</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return(</span><span class="default">$s</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$source </span><span class="keyword">= </span><span class="string">'It works !'</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="string">"1234567812345678"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pass </span><span class="keyword">= </span><span class="string">'1234567812345678'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$method </span><span class="keyword">= </span><span class="string">'aes-128-cbc'</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"\niv in hex to use: "</span><span class="keyword">.</span><span class="default">strtohex </span><span class="keyword">(</span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"\nkey in hex to use: "</span><span class="keyword">.</span><span class="default">strtohex </span><span class="keyword">(</span><span class="default">$pass</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"\n"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents </span><span class="keyword">(</span><span class="string">'./file.encrypted'</span><span class="keyword">,</span><span class="default">openssl_encrypt </span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">, </span><span class="default">$method</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$exec </span><span class="keyword">= </span><span class="string">"openssl enc -"</span><span class="keyword">.</span><span class="default">$method</span><span class="keyword">.</span><span class="string">" -d -in file.encrypted -nosalt -nopad -K "</span><span class="keyword">.</span><span class="default">strtohex</span><span class="keyword">(</span><span class="default">$pass</span><span class="keyword">).</span><span class="string">" -iv "</span><span class="keyword">.</span><span class="default">strtohex</span><span class="keyword">(</span><span class="default">$iv</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">'executing: '</span><span class="keyword">.</span><span class="default">$exec</span><span class="keyword">.</span><span class="string">"\n\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">exec </span><span class="keyword">(</span><span class="default">$exec</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
IV and Key parameteres passed to openssl command line must be in hex representation of string.<br />
<br />
The correct command for decrypting is:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -nosalt -nopad -K 31323334353637383132333435363738 -iv 31323334353637383132333435363738<br />
<br />
As it has no salt has no padding and by setting functions third parameter we have no more base64 encoded file to decode. The command will echo that it works...<br />
<br />
: /</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95306""></a>
  <div class="note">
   <strong class="user">public at grik dot net</strong>
   <a href="#95306" class="date">25-Dec-2009 09:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The list of methods for this function can be obtained with openssl_get_cipher_methods();<br />
The password can be encrypted with the openssl_private/public_encrypt()</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
