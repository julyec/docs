<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>从已连接的 socket 接收数据</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.socket-read.html">? socket_read</a></li>
      <li style="float: right;"><a href="function.socket-recvfrom.html">socket_recvfrom ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.sockets.html">Socket 函数</a></li>
    <li>从已连接的 socket 接收数据</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.socket-recv" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">socket_recv</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.1.0, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">socket_recv</span> &mdash; <span class="dc-title">从已连接的 socket 接收数据</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.socket-recv-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>socket_recv</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type"><a href="class.socket.html" class="type Socket">Socket</a></span> <code class="parameter">$socket</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">string</span><span class="type"></span></span> <code class="parameter reference">&$data</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$length</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code></span><br>): <span class="type"><span class="type">int</span>|<span class="type"><span class="type false">false</span></span></span></div>

  <p class="para rdfs-comment">
   函数 <span class="function"><strong>socket_recv()</strong></span> 从 <code class="parameter">socket</code> 中接收长度为
   <code class="parameter">length</code> 字节的数据，并保存在 <code class="parameter">data</code> 中。
   <span class="function"><strong>socket_recv()</strong></span> 用于从已连接的 socket 中接收数据。除此之外，可以设定一个或多个 flags
   来控制函数的具体行为。
  </p>
  <p class="para">
   <code class="parameter">data</code> 是传引用的，因此必须以变量的形式，指定到参数列表。从
   <code class="parameter">socket</code> 中接收到的数据将会保存在 <code class="parameter">data</code> 中。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.socket-recv-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">socket</code></dt>

     <dd>

      <p class="para">
       参数 <code class="parameter">socket</code> 必须是一个由 <span class="function"><a href="function.socket-create.html" class="function">socket_create()</a></span>
       创建的 <span class="classname"><a href="class.socket.html" class="classname">Socket</a></span> 实例。
      </p>
     </dd>

    

    
     <dt>
<code class="parameter">data</code></dt>

     <dd>

      <p class="para">
       从 socket 中获取的数据将被保存在由 <code class="parameter">data</code> 指定的变量中。
       如果有错误发生，如链接被重置，数据不可用等等， <code class="parameter">data</code> 将被设为 <strong><code>null</code></strong>。
      </p>
     </dd>

    

    
     <dt>
<code class="parameter">length</code></dt>

     <dd>

      <p class="para">
       从远程主机接收长度最多为 <code class="parameter">length</code> 字节的数据。
      </p>
     </dd>

    

    
     <dt>
<code class="parameter">flags</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">flags</code> 的值可以为下列任意 flag 的组合。使用按位或运算符(<code class="literal">|</code>)来
       组合不同的 flag。
      </p>
      
      <table class="doctable table">
       <caption><strong>可用的 <code class="parameter">flags</code> 值</strong></caption>
       
        <thead>
         <tr>
          <th>Flag</th>
          <th>描述</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td><strong><code>MSG_OOB</code></strong></td>
          <td>
           处理超出边界的数据
          </td>
         </tr>

         <tr>
          <td><strong><code>MSG_PEEK</code></strong></td>
          <td>
           从接收队列的起始位置接收数据，但不将他们从接收队列中移除。
          </td>
         </tr>

         <tr>
          <td><strong><code>MSG_WAITALL</code></strong></td>
          <td>
           在接收到至少 <code class="parameter">length</code> 字节的数据之前，造成一个阻塞，并暂停脚本运行（block）。但是，
           如果接收到中断信号，或远程服务器断开连接，该函数将返回少于 <code class="parameter">length</code> 字节的数据。
          </td>
         </tr>

         <tr>
          <td><strong><code>MSG_DONTWAIT</code></strong></td>
          <td>
           如果指定了该 flag，函数将不会造成阻塞，即使在全局设置中指定了阻塞设置。
          </td>
         </tr>

        </tbody>
       
      </table>

     </dd>

        
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.socket-recv-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   <span class="function"><strong>socket_recv()</strong></span> 返回一个数字，表示接收到的字节数。如果发生了错误，则返回 <strong><code>false</code></strong>
   错误码可使用 <span class="function"><a href="function.socket-last-error.html" class="function">socket_last_error()</a></span> 接收。也可使用函数 <span class="function"><a href="function.socket-strerror.html" class="function">socket_strerror()</a></span> 
   来取得关于错误的文字描述。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.socket-recv-changelog">
  <h3 class="title">更新日志</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>版本</th>
      <th>说明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
  <td>8.0.0</td>
  <td>
   现在 <code class="parameter">socket</code> 是 <span class="classname"><a href="class.socket.html" class="classname">Socket</a></span> 实例，
   之前是 <span class="type">resource</span>。
  </td>
 </tr>

    </tbody>
   
  </table>

 </div>


 <div class="refsect1 examples" id="refsect1-function.socket-recv-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="">
    <p><strong>Example #1 <span class="function"><strong>socket_recv()</strong></span> 范例</strong></p>
    <div class="example-contents"><p>
     该范例简单地使用 <span class="function"><strong>socket_recv()</strong></span> 重写了 <a href="sockets.examples.html" class="xref">示例</a> 中的
     第一个例子。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />error_reporting</span><span style="color: #007700">(</span><span style="color: #0000BB">E_ALL</span><span style="color: #007700">);<br /><br />echo </span><span style="color: #DD0000">"&lt;h2&gt;TCP/IP Connection&lt;/h2&gt;\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/* 获取 WWW 服务的端口。 */<br /></span><span style="color: #0000BB">$service_port </span><span style="color: #007700">= </span><span style="color: #0000BB">getservbyname</span><span style="color: #007700">(</span><span style="color: #DD0000">'www'</span><span style="color: #007700">, </span><span style="color: #DD0000">'tcp'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/* 获取目标主机的 IP 地址。 */<br /></span><span style="color: #0000BB">$address </span><span style="color: #007700">= </span><span style="color: #0000BB">gethostbyname</span><span style="color: #007700">(</span><span style="color: #DD0000">'www.example.com'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/* 创建 TCP/IP 套接字。 */<br /></span><span style="color: #0000BB">$socket </span><span style="color: #007700">= </span><span style="color: #0000BB">socket_create</span><span style="color: #007700">(</span><span style="color: #0000BB">AF_INET</span><span style="color: #007700">, </span><span style="color: #0000BB">SOCK_STREAM</span><span style="color: #007700">, </span><span style="color: #0000BB">SOL_TCP</span><span style="color: #007700">);<br />if (</span><span style="color: #0000BB">$socket </span><span style="color: #007700">=== </span><span style="color: #0000BB">false</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"socket_create() failed: reason: " </span><span style="color: #007700">. </span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">()) . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />} else {<br />    echo </span><span style="color: #DD0000">"OK.\n"</span><span style="color: #007700">;<br />}<br /><br />echo </span><span style="color: #DD0000">"Attempting to connect to '</span><span style="color: #0000BB">$address</span><span style="color: #DD0000">' on port '</span><span style="color: #0000BB">$service_port</span><span style="color: #DD0000">'..."</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">socket_connect</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">, </span><span style="color: #0000BB">$address</span><span style="color: #007700">, </span><span style="color: #0000BB">$service_port</span><span style="color: #007700">);<br />if (</span><span style="color: #0000BB">$result </span><span style="color: #007700">=== </span><span style="color: #0000BB">false</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"socket_connect() failed.\nReason: (</span><span style="color: #0000BB">$result</span><span style="color: #DD0000">) " </span><span style="color: #007700">. </span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">)) . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />} else {<br />    echo </span><span style="color: #DD0000">"OK.\n"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$in </span><span style="color: #007700">= </span><span style="color: #DD0000">"HEAD / HTTP/1.1\r\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$in </span><span style="color: #007700">.= </span><span style="color: #DD0000">"Host: www.example.com\r\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$in </span><span style="color: #007700">.= </span><span style="color: #DD0000">"Connection: Close\r\n\r\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$out </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">;<br /><br />echo </span><span style="color: #DD0000">"Sending HTTP HEAD request..."</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">socket_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">, </span><span style="color: #0000BB">$in</span><span style="color: #007700">, </span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$in</span><span style="color: #007700">));<br />echo </span><span style="color: #DD0000">"OK.\n"</span><span style="color: #007700">;<br /><br />echo </span><span style="color: #DD0000">"Reading response:\n\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$buf </span><span style="color: #007700">= </span><span style="color: #DD0000">'This is my buffer.'</span><span style="color: #007700">;<br />if (</span><span style="color: #0000BB">false </span><span style="color: #007700">!== (</span><span style="color: #0000BB">$bytes </span><span style="color: #007700">= </span><span style="color: #0000BB">socket_recv</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">, </span><span style="color: #0000BB">$buf</span><span style="color: #007700">, </span><span style="color: #0000BB">2048</span><span style="color: #007700">, </span><span style="color: #0000BB">MSG_WAITALL</span><span style="color: #007700">))) {<br />    echo </span><span style="color: #DD0000">"Read </span><span style="color: #0000BB">$bytes</span><span style="color: #DD0000"> bytes from socket_recv(). Closing socket..."</span><span style="color: #007700">;<br />} else {<br />    echo </span><span style="color: #DD0000">"socket_recv() failed; reason: " </span><span style="color: #007700">. </span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">)) . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">socket_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">);<br /><br />echo </span><span style="color: #0000BB">$buf </span><span style="color: #007700">. </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />echo </span><span style="color: #DD0000">"OK.\n\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>
     上面的示例将产生如下内容：
    </p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
&lt;h2&gt;TCP/IP Connection&lt;/h2&gt;
OK.
Attempting to connect to &#039;208.77.188.166&#039; on port &#039;80&#039;...OK.
Sending HTTP HEAD request...OK.
Reading response:

Read 123 bytes from socket_recv(). Closing socket...HTTP/1.1 200 OK
Date: Mon, 14 Sep 2009 08:56:36 GMT
Server: Apache/2.2.3 (Red Hat)
Last-Modified: Tue, 15 Nov 2005 13:24:10 GMT
ETag: &quot;b80f4-1b6-80bfd280&quot;
Accept-Ranges: bytes
Content-Length: 438
Connection: close
Content-Type: text/html; CHARSET=gb2312

OK.
</pre></div>
    </div>
   </div>
  </p>
 </div>

                     
</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="125895""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#125895" class="date">10-Mar-2021 09:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">namespace </span><span class="default">Safe</span><span class="keyword">;<br />
<br />
use </span><span class="default">Safe\Exceptions\SocketsException</span><span class="keyword">;<br />
<br />
</span><span class="comment">/**<br />
&nbsp;* After the socket socket has been created<br />
&nbsp;* using socket_create, bound to a name with<br />
&nbsp;* socket_bind, and told to listen for connections<br />
&nbsp;* with socket_listen, this function will accept<br />
&nbsp;* incoming connections on that socket. Once a successful connection<br />
&nbsp;* is made, a new socket resource is returned, which may be used<br />
&nbsp;* for communication. If there are multiple connections queued on<br />
&nbsp;* the socket, the first will be used. If there are no pending<br />
&nbsp;* connections, socket_accept will block until<br />
&nbsp;* a connection becomes present. If socket<br />
&nbsp;* has been made non-blocking using<br />
&nbsp;* socket_set_blocking or<br />
&nbsp;* socket_set_nonblock, FALSE will be returned.<br />
&nbsp;*<br />
&nbsp;* The socket resource returned by<br />
&nbsp;* socket_accept may not be used to accept new<br />
&nbsp;* connections. The original listening socket<br />
&nbsp;* socket, however, remains open and may be<br />
&nbsp;* reused.<br />
&nbsp;*<br />
&nbsp;* @param resource $socket A valid socket resource created with socket_create.<br />
&nbsp;* @return resource Returns a new socket resource on success. The actual<br />
&nbsp;* error code can be retrieved by calling<br />
&nbsp;* socket_last_error. This error code may be passed to<br />
&nbsp;* socket_strerror to get a textual explanation of the<br />
&nbsp;* error.<br />
&nbsp;* @throws SocketsException<br />
&nbsp;*<br />
&nbsp;*/<br />
</span><span class="keyword">function </span><span class="default">socket_accept</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">error_clear_last</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">\socket_accept</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$result </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw </span><span class="default">SocketsException</span><span class="keyword">::</span><span class="default">createFromPhpError</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">/**<br />
&nbsp;* Create a Socket resource, and bind it to the provided AddrInfo resource.&nbsp; The return<br />
&nbsp;* value of this function may be used with socket_listen.<br />
&nbsp;*<br />
&nbsp;* @param resource $addr Resource created from socket_addrinfo_lookup.<br />
&nbsp;* @return resource Returns a Socket resource on success.<br />
&nbsp;* @throws SocketsException<br />
&nbsp;*<br />
&nbsp;*/<br />
</span><span class="keyword">function </span><span class="default">socket_addrinfo_bind</span><span class="keyword">(</span><span class="default">$addr</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">error_clear_last</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">\socket_addrinfo_bind</span><span class="keyword">(</span><span class="default">$addr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$result </span><span class="keyword">=== </span><span class="default">null</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw </span><span class="default">SocketsException</span><span class="keyword">::</span><span class="default">createFromPhpError</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;<br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123308""></a>
  <div class="note">
   <strong class="user">lexkrstn at gmail dot com</strong>
   <a href="#123308" class="date">05-Nov-2018 06:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It seems like the flags are just passed to the underlying recv() function of your OS, hence there no MSG_DONTWAIT flag on Windows and you should not define it yourself in that case, it just won't work.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121419""></a>
  <div class="note">
   <strong class="user">e-vela at bol dot com dot br</strong>
   <a href="#121419" class="date">23-Jul-2017 07:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Usage example for MSG_PEEK: this function tells if the socket has data available to be read, but preserving it to be read at a future moment.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Workaround for the missing define<br />
</span><span class="keyword">if(!</span><span class="default">defined</span><span class="keyword">(</span><span class="string">'MSG_DONTWAIT'</span><span class="keyword">)) </span><span class="default">define</span><span class="keyword">(</span><span class="string">'MSG_DONTWAIT'</span><span class="keyword">, </span><span class="default">0x40</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Function to check if there is data available in the socket<br />
</span><span class="keyword">function </span><span class="default">SocketHasData</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Based on the following fact:<br />
&nbsp;&nbsp;&nbsp; // $result=0 -&gt; disconnected, $result=false -&gt; no data<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">; </span><span class="comment">// We need a buffer, but we won't use it<br />
<br />
&nbsp;&nbsp;&nbsp; // MSG_PEEK means to preserve data in the queue, so it can<br />
&nbsp;&nbsp;&nbsp; // actually be read afterwards<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">socket_recv</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">, </span><span class="default">MSG_PEEK </span><span class="keyword">| </span><span class="default">MSG_DONTWAIT </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$result </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) return </span><span class="default">false</span><span class="keyword">; </span><span class="comment">// If no data, returns false<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">true</span><span class="keyword">; </span><span class="comment">// Otherwise returns true<br />
</span><span class="keyword">}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="115904""></a>
  <div class="note">
   <strong class="user">cottton at i-stats dot net</strong>
   <a href="#115904" class="date">13-Oct-2014 02:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
socket_recv()<br />
returns FALSE if client returned no data<br />
returns 0 (zero) if client disconnected<br />
<br />
also (asuming case socket_select() "gave" us a "changed" socket):<br />
if <br />
socket_recv() returned FALSE <br />
and no bytes were received <br />
then<br />
client "crashed" (call it disconnected).<br />
<br />
else if<br />
socket_recv() returned 0 (zero) <br />
and no bytes were received <br />
then<br />
client "normaly" disconnected.<br />
<br />
Im pretty sure -- 99.99%.<br />
Example:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">receive</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// !<br />
&nbsp;&nbsp;&nbsp; // on all following cases we assume that<br />
&nbsp;&nbsp;&nbsp; // socket_select() returned the current socket as "changed"<br />
&nbsp;&nbsp;&nbsp; // !<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$timeout </span><span class="keyword">= </span><span class="default">3</span><span class="keyword">; </span><span class="comment">// set your timeout<br />
<br />
&nbsp;&nbsp;&nbsp; /* important */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socket_recv_return_values</span><span class="keyword">[</span><span class="string">'no_data_received'</span><span class="keyword">] = </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socket_recv_return_values</span><span class="keyword">[</span><span class="string">'client_disconnected'</span><span class="keyword">] = </span><span class="default">0</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$start </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$received_data </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$received_bytes </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_nonblock</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_clear_error</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; while(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">$t_out</span><span class="keyword">=((</span><span class="default">time</span><span class="keyword">()-</span><span class="default">$start</span><span class="keyword">) &gt;= </span><span class="default">$timeout</span><span class="keyword">)) === </span><span class="default">false<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">and (</span><span class="default">$read</span><span class="keyword">=@</span><span class="default">socket_recv</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$buf</span><span class="keyword">, </span><span class="default">4096</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">)) &gt;= </span><span class="default">1<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$received_data&nbsp; </span><span class="keyword">= (isset(</span><span class="default">$received_data</span><span class="keyword">)) ? </span><span class="default">$received_data </span><span class="keyword">. </span><span class="default">$buf </span><span class="keyword">: </span><span class="default">$buf</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$received_bytes </span><span class="keyword">= (isset(</span><span class="default">$received_bytes</span><span class="keyword">)) ? </span><span class="default">$received_bytes </span><span class="keyword">+ </span><span class="default">$read </span><span class="keyword">: </span><span class="default">$read</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$last_error </span><span class="keyword">= </span><span class="default">socket_last_error</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_block</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$t_out </span><span class="keyword">=== </span><span class="default">true</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'timeout after ' </span><span class="keyword">. ((!</span><span class="default">$received_bytes</span><span class="keyword">) ? </span><span class="default">0 </span><span class="keyword">: </span><span class="default">$received_bytes</span><span class="keyword">) . </span><span class="string">' bytes'</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="comment">// your eCode here<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; elseif(</span><span class="default">$last_error </span><span class="keyword">!== </span><span class="default">false </span><span class="keyword">and </span><span class="default">$last_error </span><span class="keyword">!== </span><span class="default">0</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">$last_error</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$last_error<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; else{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$read </span><span class="keyword">=== </span><span class="default">$socket_recv_return_values</span><span class="keyword">[</span><span class="string">'no_data_received'</span><span class="keyword">]){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// client returned NO DATA<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // but we were in a loop and could have got some data before:<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$received_bytes </span><span class="keyword">&lt; </span><span class="default">1</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// client is connected but sent NO DATA ?<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // no:<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // in this case the client must be "crashed" because -<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // it is not possible to "send no data" (zero bytes)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // socket_select() now returns this socket as "changed" "forever"<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">throw new </span><span class="default">Exception</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'client crashed'</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="comment">// your eCode here<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// client returned DATA<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">$received_data</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; elseif(</span><span class="default">$read </span><span class="keyword">=== </span><span class="default">$socket_recv_return_values</span><span class="keyword">[</span><span class="string">'client_disconnected'</span><span class="keyword">]){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// client disconnected<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$received_bytes </span><span class="keyword">&lt; </span><span class="default">1</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// client disconnected before/without sending any bytes<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">throw new </span><span class="default">Exception</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'client disconnected'</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="comment">// your eCode here<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// *this value* ^= $socket_recv_return_values['client_disconnected']<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // client disconnected AFTER sending data (we were in a loop!)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // socket_select() will return this socket "forever" as "changed" and -<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // socket_recv() will return *this value* "forever".<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // we will be "back" again "very soon" to see:<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //&nbsp; socket_recv() returns *this value* AND no bytes received<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //&nbsp; which results in disconnect-exception above<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">$received_data</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="115372""></a>
  <div class="note">
   <strong class="user">m_lajos at hotmail dot com</strong>
   <a href="#115372" class="date">14-Jul-2014 03:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Workaround for the missing MSG_DONTWAIT flag according to the bug report page:<br />
<br />
<span class="default">&lt;?php </span><span class="keyword">if(!</span><span class="default">defined</span><span class="keyword">(</span><span class="string">'MSG_DONTWAIT'</span><span class="keyword">)) </span><span class="default">define</span><span class="keyword">(</span><span class="string">'MSG_DONTWAIT'</span><span class="keyword">, </span><span class="default">0x40</span><span class="keyword">); </span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112728""></a>
  <div class="note">
   <strong class="user">ss-130 at yandex dot ru</strong>
   <a href="#112728" class="date">17-Jul-2013 11:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
$er </span><span class="keyword">= </span><span class="default">error_reporting</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">$bytes&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">socket_recv</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">,</span><span class="default">$buffer</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">MSG_WAITALL</span><span class="keyword">);<br />
</span><span class="default">error_reporting</span><span class="keyword">(</span><span class="default">$er</span><span class="keyword">);<br />
<br />
</span><span class="comment">// MEGA BUG HERE<br />
// this statuses are wrong and swapped, closed socket must be with "FALSE"<br />
// but in fact he swap the values:<br />
// <a href="http://php.net/manual/en/function.socket-recv.php" rel="nofollow" target="_blank">http://php.net/manual/en/function.socket-recv.php</a><br />
// <br />
</span><span class="keyword">if(</span><span class="default">$bytes</span><span class="keyword">===</span><span class="default">false</span><span class="keyword">){ </span><span class="comment">// no data available, socket not closed<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">'WS_READ_ERR1: '</span><span class="keyword">.</span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">)).</span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// print when no data available:<br />
&nbsp;&nbsp;&nbsp; // WS_READ_ERR1: Resource temporarily unavailable<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">continue;<br />
}else if(</span><span class="default">$bytes</span><span class="keyword">===</span><span class="default">0</span><span class="keyword">){ </span><span class="comment">// socket closed<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">'WS_READ_ERR2: '</span><span class="keyword">.</span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">)).</span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// print when socket closed:<br />
&nbsp;&nbsp;&nbsp; // WS_READ_ERR2: Success<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$process</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107740""></a>
  <div class="note">
   <strong class="user">davide dot renzi at gmail dot com</strong>
   <a href="#107740" class="date">01-Mar-2012 08:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In PHP version 5.* there is a bug: MSG_DONTWAIT flag is not defined (see https://bugs.php.net/bug.php?id=48326)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56161""></a>
  <div class="note">
   <strong class="user">rathamahata at rathamahata dot net</strong>
   <a href="#56161" class="date">25-Aug-2005 04:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It looks like that mysterious flags are just the recv(2) flags passed to your OS syscall and nothing more...<br />
<br />
ext/sockets/sockets.c:PHP_FUNCTION(socket_recv)<br />
...<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ((retval = recv(php_sock-&gt;bsd_socket, recv_buf, len, flags)) &lt; 1) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; efree(recv_buf);<br />
...<br />
<br />
for linux you can type `man 2 recv' and you will see complete description of thouse flags.<br />
<br />
Sergey S. Kosrtyliov &lt;rathamahata@rathamahata.net&gt;<br />
<a href="http://www.rathamahata.net/" rel="nofollow" target="_blank">http://www.rathamahata.net/</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52582""></a>
  <div class="note">
   
   <a href="#52582" class="date">06-May-2005 04:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
My last post was incorrect. The int flag set to 2 apparently reset the file position pointer so what I was reading was the first record repeatedly. <br />
<br />
My workaroud ended up being the following:<br />
<br />
for($ct=1; $ct&lt;=$numrecs; $ct++) {<br />
&nbsp;&nbsp;&nbsp; $rec = "";<br />
&nbsp;&nbsp;&nbsp; $nr=socket_recv($fp,$rec,76,0);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; //grab the extra bytes.<br />
&nbsp;&nbsp;&nbsp; $terminator = "";<br />
&nbsp;&nbsp;&nbsp; while ($terminator != ".") {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $nr=socket_recv($fp,$terminator,1,0);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; $custarray[]=substr($rec,0,76);&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
}<br />
<br />
Martin K.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52552""></a>
  <div class="note">
   
   <a href="#52552" class="date">05-May-2005 07:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I'm glad that Bastion left the above post about the mysterious int flag. He just helped to fix a problem that I've spent six hours on. Here's my code:<br />
<br />
for($ct=1; $ct&lt;=$numrecs; $ct++) {<br />
&nbsp;&nbsp; &nbsp; $rec = "";<br />
&nbsp;&nbsp; &nbsp; $nr=socket_recv($fp,$rec,77,0);<br />
&nbsp;&nbsp; &nbsp; print "Rec # $ct --&gt;";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; print "$rec";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; print "&lt;br&gt;";<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
<br />
The code is pretty simple, it just loops through all my records and prints them out. All records are 77 bytes and all end with a period. The first 36 records print perfectly then at 37 things go bad. The records start to get offset. The last few characters of the 37th record end up printing on the 38th record. The data on the sending side was perfect, so I knew that the problem was with socked_recv.<br />
<br />
After reading the above post I tried changing the int flag. Changing the flag to 2 worked:<br />
$nr=socket_recv($fp,$rec,77,2);<br />
<br />
Now everything lines up perfectly. I had always left int flag as 0 since it's undocumented. <br />
<br />
Martin K.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47789""></a>
  <div class="note">
   <strong class="user">engine at [NO SPAM] illusiononly dot com</strong>
   <a href="#47789" class="date">30-Nov-2004 04:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To read from socket both on linux and windows OS having&nbsp; flash as a client I use function bellow. $length is the size of&nbsp; a chunk, not the max length to read. It will continue reading until EOL char&nbsp; occures or client disconnects (or in case of error), so it works for bigger packets as well.<br />
<br />
&nbsp;&nbsp; &nbsp; function read($descriptor, $length = 1024) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this-&gt;method = "read";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(!$client){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo("No valid socket descriptor !\n");<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return false;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $read ='';<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(($flag=socket_recv($descriptor, $buf, $length,0))&gt;0){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $asc=ord(substr($buf, -1));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if ($asc==0) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $read.=substr($buf,0,-1);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $read.=$buf;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($flag&lt;0){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //error<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return false;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }elseif ($flag==0){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //Client disconnected<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return&nbsp; false;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return $read;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; }</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47182""></a>
  <div class="note">
   <strong class="user">dgk at tcde dot ru</strong>
   <a href="#47182" class="date">05-Nov-2004 03:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've used socket_select and socket_recv with a while loop and found myself in trouble when remote side closed connection. The code below produced infinite loop and socket_select returned immediately (which lead to high cpu time consumption).<br />
<br />
&lt;?<br />
<br />
socket_set_nonblock($my_socket);<br />
$streams = array($my_socket/*, ... */);<br />
<br />
$lastAccess = time();<br />
while (socket_select($streams, $write = NULL, $except = NULL, SLEEP_TIME_SECONDS, SLEEP_TIME_MILLISECONDS) !== FALSE) {<br />
&nbsp;&nbsp;&nbsp; if (in_array($my_socket, $streams)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (@socket_recv($my_socket, $data, 8192, 0)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo $data;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $lastAccess = time();<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (time()-$lastAccess &gt; LAST_ACCESS_TIMEOUT) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; // ...<br />
&nbsp;&nbsp;&nbsp; $streams = array($my_socket/*, ... */);<br />
}<br />
<br />
?&gt;<br />
<br />
The solution was simple, but quite hard to find because socket_recv is not documented. socket_recv returns FALSE if there is no data and 0 if the socket is widowed (disconnected by remote side). So I had just to check return value of socket_recv. The problem now sounds stupid, but I've spend some time to find it out.<br />
I hope this will save some of somebody's hair ;)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="41278""></a>
  <div class="note">
   <strong class="user">bastiaan at [no-spam] megabass dot nl</strong>
   <a href="#41278" class="date">05-Apr-2004 09:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
in case you want to empty/unset $buffer, but failing to do so, try using 0 as flag.<br />
PHP_NORMAL_READ and PHP_BINARY_READ respectively hold 1 and 2 as value.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
