<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>为套接字设置套接字选项</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.socket-set-nonblock.html">? socket_set_nonblock</a></li>
      <li style="float: right;"><a href="function.socket-setopt.html">socket_setopt ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.sockets.html">Socket 函数</a></li>
    <li>为套接字设置套接字选项</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.socket-set-option" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">socket_set_option</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.3.0, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">socket_set_option</span> &mdash; <span class="dc-title">为套接字设置套接字选项</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.socket-set-option-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>socket_set_option</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type"><a href="class.socket.html" class="type Socket">Socket</a></span> <code class="parameter">$socket</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$level</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$option</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type"><span class="type">array</span>|<span class="type">string</span>|<span class="type">int</span></span> <code class="parameter">$value</code></span><br>): <span class="type">bool</span></div>

  <p class="para rdfs-comment"> 
   <span class="function"><strong>socket_set_option()</strong></span> 函数在 <code class="parameter">socket</code> 
   的指定协议 <code class="parameter">level</code> 上设置由 <code class="parameter">option</code> 
   参数指定的选项，<code class="parameter">value</code> 为指定值。 
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.socket-set-option-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">socket</code></dt>

     <dd>

      <p class="para">
       由 <span class="function"><a href="function.socket-create.html" class="function">socket_create()</a></span> 或 <span class="function"><a href="function.socket-accept.html" class="function">socket_accept()</a></span> 创建的 <span class="classname"><a href="class.socket.html" class="classname">Socket</a></span> 实例。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">level</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">level</code> 参数定义选项所在的协议级别。例如，在 socket 级别设置选项，将使用 <strong><code>SOL_SOCKET</code></strong> 
       作为 <code class="parameter">level</code> 参数。在其它级别，例如 TCP，可以使用该级别定义的协议号来指定级别。协议号可以通过 <span class="function"><a href="function.getprotobyname.html" class="function">getprotobyname()</a></span> 
       找到。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">option</code></dt>

     <dd>

      <p class="para">
       套接字可用选项与 <span class="function"><a href="function.socket-get-option.html" class="function">socket_get_option()</a></span> 函数的选项相同。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">value</code></dt>

     <dd>

      <p class="para">
       选项值。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.socket-set-option-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功时返回 <strong><code>true</code></strong>， 或者在失败时返回 <strong><code>false</code></strong>。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.socket-set-option-changelog">
  <h3 class="title">更新日志</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>版本</th>
      <th>说明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
  <td>8.0.0</td>
  <td>
   现在 <code class="parameter">socket</code> 是 <span class="classname"><a href="class.socket.html" class="classname">Socket</a></span> 实例，
   之前是 <span class="type">resource</span>。
  </td>
 </tr>

    </tbody>
   
  </table>

 </div>


 <div class="refsect1 examples" id="refsect1-function.socket-set-option-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="">
    <p><strong>Example #1 <span class="function"><strong>socket_set_option()</strong></span> 示例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$socket </span><span style="color: #007700">= </span><span style="color: #0000BB">socket_create</span><span style="color: #007700">(</span><span style="color: #0000BB">AF_INET</span><span style="color: #007700">, </span><span style="color: #0000BB">SOCK_STREAM</span><span style="color: #007700">, </span><span style="color: #0000BB">SOL_TCP</span><span style="color: #007700">);<br /><br />if (!</span><span style="color: #0000BB">is_resource</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">)) {<br />    echo </span><span style="color: #DD0000">'Unable to create socket: '</span><span style="color: #007700">. </span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">()) . </span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br />}<br /><br />if (!</span><span style="color: #0000BB">socket_set_option</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">, </span><span style="color: #0000BB">SOL_SOCKET</span><span style="color: #007700">, </span><span style="color: #0000BB">SO_REUSEADDR</span><span style="color: #007700">, </span><span style="color: #0000BB">1</span><span style="color: #007700">)) {<br />    echo </span><span style="color: #DD0000">'Unable to set option on socket: '</span><span style="color: #007700">. </span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">()) . </span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br />}<br /><br />if (!</span><span style="color: #0000BB">socket_bind</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">, </span><span style="color: #DD0000">'127.0.0.1'</span><span style="color: #007700">, </span><span style="color: #0000BB">1223</span><span style="color: #007700">)) {<br />    echo </span><span style="color: #DD0000">'Unable to bind socket: '</span><span style="color: #007700">. </span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">()) . </span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$rval </span><span style="color: #007700">= </span><span style="color: #0000BB">socket_get_option</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">, </span><span style="color: #0000BB">SOL_SOCKET</span><span style="color: #007700">, </span><span style="color: #0000BB">SO_REUSEADDR</span><span style="color: #007700">);<br /><br />if (</span><span style="color: #0000BB">$rval </span><span style="color: #007700">=== </span><span style="color: #0000BB">false</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">'Unable to get socket option: '</span><span style="color: #007700">. </span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">()) . </span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br />} else if (</span><span style="color: #0000BB">$rval </span><span style="color: #007700">!== </span><span style="color: #0000BB">0</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">'SO_REUSEADDR is set on socket !' </span><span style="color: #007700">. </span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.socket-set-option-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.socket-create.html" class="function" rel="rdfs-seeAlso">socket_create()</a> - 创建一个套接字（通讯节点）</span></li>
    <li class="member"><span class="function"><a href="function.socket-bind.html" class="function" rel="rdfs-seeAlso">socket_bind()</a> - 给套接字绑定名字</span></li>
    <li class="member"><span class="function"><a href="function.socket-strerror.html" class="function" rel="rdfs-seeAlso">socket_strerror()</a> - 返回描述套接字错误的字符串</span></li>
    <li class="member"><span class="function"><a href="function.socket-last-error.html" class="function" rel="rdfs-seeAlso">socket_last_error()</a> - 返回套接字上的最后一个错误</span></li>
    <li class="member"><span class="function"><a href="function.socket-get-option.html" class="function" rel="rdfs-seeAlso">socket_get_option()</a> - 获取套接字的套接字选项</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="123992""></a>
  <div class="note">
   <strong class="user">gmail user asmqb7</strong>
   <a href="#123992" class="date">29-Jun-2019 05:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PLEASE NOTE<br />
<br />
PHP 7.3.6, and probably many previous versions, automatically sets SO_REUSEADDR when you use stream_socket_server().<br />
<br />
php_network_bind_socket_to_local_addr() is called at https://github.com/php/php-src/blob/623911f993f39ebbe75abe2771fc89faf6b15b9b/main/streams/xp_socket.c#L675 and defined at https://github.com/php/php-src/blob/61a6a6ec51297506c54f3c6e60ace9b892d0a3e4/main/network.c#L401 and if you take a look you'll see<br />
<br />
#ifdef SO_REUSEADDR<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, (char*)&amp;sockoptval, sizeof(sockoptval));<br />
#endif<br />
<br />
I initially thought I'd need to play with context options to turn this on, but no, the simplest single-arg call with no error checking and just an address, works for me.<br />
<br />
strace your PHP binary to be 100% sure:<br />
<br />
...<br />
setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0<br />
...<br />
<br />
The chances are you ARE using SO_REUSEADDR unless you're using a 100-year old UNIX clone in a month with a Z in it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123753""></a>
  <div class="note">
   <strong class="user">renmengyang567 at gmail dot com</strong>
   <a href="#123753" class="date">07-Apr-2019 10:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
&lt;question&gt;<br />
&nbsp;Why is the size of the buffer 2 times that set by me?<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//Before setting the cache area<br />
</span><span class="default">$sock </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">getprotobyname</span><span class="keyword">(</span><span class="string">'tcp'</span><span class="keyword">));<br />
</span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="string">'127.0.0.1'</span><span class="keyword">,</span><span class="default">5000</span><span class="keyword">);<br />
</span><span class="default">socket_listen</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">$sndbuf </span><span class="keyword">= </span><span class="default">socket_get_option</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">SOL_SOCKET</span><span class="keyword">,</span><span class="default">SO_SNDBUF</span><span class="keyword">);<br />
</span><span class="default">$rcvbuf </span><span class="keyword">= </span><span class="default">socket_get_option</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">SOL_SOCKET</span><span class="keyword">,</span><span class="default">SO_RCVBUF</span><span class="keyword">);<br />
</span><span class="default">printf</span><span class="keyword">(</span><span class="string">"send buffer size(写缓存区大小):%sm \n"</span><span class="keyword">,</span><span class="default">$sndbuf</span><span class="keyword">/</span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">printf</span><span class="keyword">(</span><span class="string">"receive buffer(读缓存区大小)%sm \n"</span><span class="keyword">,</span><span class="default">$rcvbuf</span><span class="keyword">/</span><span class="default">1024</span><span class="keyword">);<br />
<br />
</span><span class="comment">//After setting the cache area<br />
</span><span class="default">$snd_buf </span><span class="keyword">= </span><span class="default">1024</span><span class="keyword">*</span><span class="default">3</span><span class="keyword">;<br />
</span><span class="default">$rcv_buf </span><span class="keyword">= </span><span class="default">1024</span><span class="keyword">*</span><span class="default">3</span><span class="keyword">;<br />
<br />
</span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">SOL_SOCKET</span><span class="keyword">,</span><span class="default">SO_SNDBUF</span><span class="keyword">, </span><span class="default">$snd_buf</span><span class="keyword">);<br />
</span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">SOL_SOCKET</span><span class="keyword">,</span><span class="default">SO_RCVBUF</span><span class="keyword">, </span><span class="default">$rcv_buf</span><span class="keyword">);<br />
</span><span class="default">$sndbuf </span><span class="keyword">= </span><span class="default">socket_get_option</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">SOL_SOCKET</span><span class="keyword">,</span><span class="default">SO_SNDBUF</span><span class="keyword">);<br />
</span><span class="default">$rcvbuf </span><span class="keyword">= </span><span class="default">socket_get_option</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">,</span><span class="default">SOL_SOCKET</span><span class="keyword">,</span><span class="default">SO_RCVBUF</span><span class="keyword">);<br />
<br />
</span><span class="default">printf</span><span class="keyword">(</span><span class="string">"send buffer size(写缓存区大小):%sm \n"</span><span class="keyword">,</span><span class="default">$sndbuf</span><span class="keyword">/</span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">printf</span><span class="keyword">(</span><span class="string">"receive buffer size(读缓存区大小)%sm \n"</span><span class="keyword">,</span><span class="default">$rcvbuf</span><span class="keyword">/</span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107980""></a>
  <div class="note">
   <strong class="user">ckozler at kozler dot net</strong>
   <a href="#107980" class="date">19-Mar-2012 07:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It appears that Winsock does not acknowledge timeout (send and receive) on Windows.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101108""></a>
  <div class="note">
   <strong class="user">DaveRandom</strong>
   <a href="#101108" class="date">26-Nov-2010 04:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Setting the socket timeout microseconds ('usec') does not work under Windows, at least under PHP/5.2.9:<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp; $timeout </span><span class="keyword">= array(</span><span class="string">'sec'</span><span class="keyword">=&gt;</span><span class="default">1</span><span class="keyword">,</span><span class="string">'usec'</span><span class="keyword">=&gt;</span><span class="default">500000</span><span class="keyword">);<br />
&nbsp; </span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">,</span><span class="default">SOL_SOCKET</span><span class="keyword">,</span><span class="default">SO_RCVTIMEO</span><span class="keyword">,</span><span class="default">$timeout</span><span class="keyword">);<br />
&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">,</span><span class="default">SOL_SOCKET</span><span class="keyword">,</span><span class="default">SO_RCVTIMEO</span><span class="keyword">));<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Output on Windows box:<br />
<br />
array(2) {<br />
&nbsp; ["sec"]=&gt;<br />
&nbsp; int(1)<br />
&nbsp; ["usec"]=&gt;<br />
&nbsp; int(0)<br />
}<br />
<br />
Output on Linux box:<br />
<br />
array(2) {<br />
&nbsp; ["sec"]=&gt;<br />
&nbsp; int(1)<br />
&nbsp; ["usec"]=&gt;<br />
&nbsp; int(500000)<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84083""></a>
  <div class="note">
   <strong class="user">aeolianmeson at ifacfchi dot blitzeclipse dot com</strong>
   <a href="#84083" class="date">26-Jun-2008 03:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Lingering will sometimes not work when you're working with non-blocking sockets. Even if the socket is set to linger and you keep tying to close until the socket doesn't return an error and the resource is no longer identifiable as type 'Socket', the socket may STILL close without sending everything.<br />
<br />
Therefore, in the event that you are using non-blocking sockets (which is preferable if you care at all about signaling), you should set the socket as blocking (socket_set_block()) before calling to close it. This will allow everything to flush before it returns.<br />
<br />
Dustin Oprea</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="71904""></a>
  <div class="note">
   <strong class="user">ludvig dot ericson at gmail dot com</strong>
   <a href="#71904" class="date">21-Dec-2006 01:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I would like to comment on the previous note regarding blocking sockets.<br />
There is more to blocking sockets than waiting for data to be received when trying to be read upon, just to make example, a listening blocking socket will wait for a client to try to connect before it returns when you socket_accept() it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52429""></a>
  <div class="note">
   <strong class="user">drenintell</strong>
   <a href="#52429" class="date">30-Apr-2005 05:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To expand a bit more on what "tim at e2-media dot co dot nz" started.<br />
<br />
SO_SNDTIMEO is one of the many constants you can use with socket_set_option.<br />
<br />
See <a href="http://ca.php.net/manual/en/ref.sockets.php for the available Predefind Constants and visit http://man.he.net/man2/setsockopt for the meaning of the ones relevant." rel="nofollow" target="_blank">http://ca.php.net/manual/en/ref.sockets.php for the available Predefind Constants and visit http://man.he.net/man2/setsockopt for the meaning of the ones relevant.</a><br />
<br />
Tim's example might seem at first a bit non-intuitive since he is using the SO_SNDTIMEO constant. Which means, if the socket has to send out data, it must do it within the limit specified - in his case 10 seconds. Usually you won't set a timeout for sending out data. Nevertheless, the example is valid, and there are situations where you need to do so.<br />
<br />
A more intuitive use of socket_set_option would be to set a time out for a blocking socket (a socket that waits for data to be receive when read from). You would do this like so:<br />
<br />
socket_set_option($socket,SOL_SOCKET, SO_RCVTIMEO, array("sec"=&gt;0, "usec"=&gt;100));<br />
<br />
Notice that sec= 0 and usec= 100; Depending on how long you want your program to wait to recieve data, you might want to change these values.<br />
<br />
Regards,<br />
&nbsp; drenintell</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="42438""></a>
  <div class="note">
   <strong class="user">tim at e2-media dot co dot nz</strong>
   <a href="#42438" class="date">16-May-2004 08:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To set a socket timeout value (assuming you've set it blocking) use:<br />
<br />
socket_set_option(<br />
&nbsp; $socket,<br />
&nbsp; SOL_SOCKET,&nbsp; // socket level<br />
&nbsp; SO_SNDTIMEO, // timeout option<br />
&nbsp; array(<br />
&nbsp;&nbsp;&nbsp; "sec"=&gt;10, // Timeout in seconds<br />
&nbsp;&nbsp;&nbsp; "usec"=&gt;0&nbsp; // I assume timeout in microseconds<br />
&nbsp;&nbsp;&nbsp; )<br />
&nbsp; );</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
