<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>启动一个事务</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="class.pdo.html">? PDO</a></li>
      <li style="float: right;"><a href="pdo.commit.html">PDO::commit ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="class.pdo.html">PDO</a></li>
    <li>启动一个事务</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="pdo.begintransaction" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">PDO::beginTransaction</h1>
  <p class="verinfo">(PHP 5 &gt;= 5.1.0, PHP 7, PHP 8, PECL pdo &gt;= 0.1.0)</p><p class="refpurpose"><span class="refname">PDO::beginTransaction</span> &mdash; <span class="dc-title">
   启动一个事务
  </span></p>

 </div>

 <div class="refsect1 description" id="refsect1-pdo.begintransaction-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="methodname"><strong>PDO::beginTransaction</strong></span>(): <span class="type">bool</span></div>

  <p class="para rdfs-comment">
   关闭自动提交模式。自动提交模式被关闭的同时，通过 PDO 对象实例对数据库做出的更改直到调用
   <span class="methodname"><a href="pdo.commit.html" class="methodname">PDO::commit()</a></span> 结束事务才被提交。调用 <span class="methodname"><a href="pdo.rollback.html" class="methodname">PDO::rollBack()</a></span>
   将回滚对数据库做出的更改并将数据库连接返回到自动提交模式。
  </p>
  <p class="para">
   包括 MySQL 在内的一些数据库，当发出一条类似 DROP TABLE 或 CREATE TABLE 这样的 DDL
   语句时，会自动进行一个隐式地事务提交。隐式地提交将阻止你在此事务范围内回滚任何其他更改。
  </p>

 </div>


 <div class="refsect1 parameters" id="refsect1-pdo.begintransaction-parameters">
  <h3 class="title">参数</h3>
  <p class="para">此函数没有参数。</p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-pdo.begintransaction-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功时返回 <strong><code>true</code></strong>， 或者在失败时返回 <strong><code>false</code></strong>。
  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-pdo.begintransaction-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
   如果事务已启动或者驱动不支持事务，则抛出 <span class="classname"><a href="class.pdoexception.html" class="classname">PDOException</a></span>。
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: <span class="simpara"><strong><code>PDO::ATTR_ERRMODE</code></strong> 属性不是 <strong><code>PDO::ERRMODE_EXCEPTION</code></strong> 时会抛出一个异常。</span></p></blockquote>
 </div>


 <div class="refsect1 examples" id="refsect1-pdo.begintransaction-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="example-2080"><p><strong>Example #1 回滚一个事务</strong></p>
    <div class="example-contents"><p>
     下面例子在回滚此更改前开始一个事务并发出两条修改数据库的语句。但在 MySQL 中，DROP TABLE 语句自动提交事务，使得在此事务中的任何更改都不会被回滚。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/* 开始一个事务，关闭自动提交 */<br /></span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">beginTransaction</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">/*  更改数据库架构及数据 */<br /></span><span style="color: #0000BB">$sth </span><span style="color: #007700">= </span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exec</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP TABLE fruit"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$sth </span><span style="color: #007700">= </span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">exec</span><span style="color: #007700">(</span><span style="color: #DD0000">"UPDATE dessert<br />    SET name = 'hamburger'"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*  识别出错误并回滚更改 */<br /></span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">rollBack</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">/* 数据库连接现在返回到自动提交模式 */<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-pdo.begintransaction-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="methodname"><a href="pdo.commit.html" class="methodname" rel="rdfs-seeAlso">PDO::commit()</a> - 提交一个事务</span></li>
    <li class="member"><span class="methodname"><a href="pdo.rollback.html" class="methodname" rel="rdfs-seeAlso">PDO::rollBack()</a> - 回滚事务</span></li>
    <li class="member"><a href="pdo.transactions.html" class="link">事务与自动提交</a></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="126436""></a>
  <div class="note">
   <strong class="user">Sbastien</strong>
   <a href="#126436" class="date">18-Sep-2021 12:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A way to use transaction and prepared statement to speed-up bulk INSERTs :<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">// ...<br />
<br />
</span><span class="default">$insert </span><span class="keyword">= </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">'INSERT INTO table (c1, c2, c3) VALUES (?, ?, ?)'</span><span class="keyword">);<br />
</span><span class="default">$bulk </span><span class="keyword">= </span><span class="default">3_000</span><span class="keyword">; </span><span class="comment">// To adjust according to your data/system<br />
</span><span class="default">$rows </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
<br />
</span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">beginTransaction</span><span class="keyword">();<br />
while (</span><span class="default">$entry </span><span class="keyword">= </span><span class="default">fgetcsv</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$insert</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">(</span><span class="default">$entry</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (++</span><span class="default">$rows </span><span class="keyword">% </span><span class="default">$bulk </span><span class="keyword">=== </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">commit</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">beginTransaction</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
if (</span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">inTransaction</span><span class="keyword">()) { </span><span class="comment">// Remaining rows insertion<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">commit</span><span class="keyword">();<br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120178""></a>
  <div class="note">
   <strong class="user">sasi dot viragelet at gmail dot com</strong>
   <a href="#120178" class="date">17-Nov-2016 09:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When transaction gets your enemy:<br />
<br />
try {<br />
<br />
$pdo-&gt;beginTransaction();<br />
<br />
// ... whatever db actions you have and then:<br />
<br />
$sql_insert = 'INSERT INTO a (a_id, a_name, a_date)<br />
&nbsp; VALUES (:a_id, :a_name CURRENT_TIMESTAMP)';<br />
<br />
&nbsp; $stmt = $pdo-&gt;prepare($sql_insert);<br />
<br />
&nbsp; $stmt-&gt;bindValue(':_id', $id);<br />
&nbsp; $stmt-&gt;bindValue(':a_name', $name);<br />
<br />
&nbsp; $stmt-&gt;execute();<br />
<br />
&nbsp; $pdo-&gt;commit();<br />
<br />
} catch (\PDOException $e) {<br />
<br />
&nbsp; $pdo-&gt;rollBack();<br />
<br />
&nbsp; http_response_code(500);<br />
&nbsp; header("Content-type: text/plain");<br />
&nbsp; echo $e;<br />
&nbsp; exit();<br />
<br />
}<br />
<br />
Notice the sytax error? There's a missing comma that just slips through every gate of surveillance:<br />
<br />
"...UES (:a_id, :a_name CURR..." :: between the to be binded value and current timestamp command. The missing comma will not generate any error no syntax error, no database error. Though this record will never or partially make it. This will just silently fail. The story gets rough if you build your other dependencies on the transactions unmovable foot-stones of trust.<br />
<br />
Just imagine you have some basic records in your transaction that you really wanna ensure ends up correctly in your db. And these records have a foreign constraint relation with another record. (That of course if you'd include in the transaction would throw you a big red error(-for who don't get it: transaction will first attempt to write everything into a temporary place, where it will get checked before everything gets into its permanent place, so constraints cannot be checked for something that don't exist yet.)) So you have a constraint that's based on the trust PDO will throw an error if something gets screwed, so what, you'll just place that insertion after the commit was successful. (Without any doublecheck.)<br />
<br />
What happens you will get some partial records in your database without a relation that just might be important. You will that way be able to build up very sophisticated strange behaviours in your application. So pay attention!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119975""></a>
  <div class="note">
   <strong class="user">cristian at crishk dot com</strong>
   <a href="#119975" class="date">01-Oct-2016 10:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
OK I'm finding a solution for "NESTED" transactions in MySQL, and as you know in the MySQL documentation says that it's not possible to have transactions within transactions. I was trying to use the Database class propossed here in <a href="http://php.net/manual/en/pdo.begintransaction.php but unfortunately that" rel="nofollow" target="_blank">http://php.net/manual/en/pdo.begintransaction.php but unfortunately that</a>'s wrong for many things related to the control flow that I have been solved with the following code (LOOK THE EXAMPLE AT THE END, CarOwner)<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">TransactionController </span><span class="keyword">extends \</span><span class="default">\PDO </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public static </span><span class="default">$warn_rollback_was_thrown </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public static </span><span class="default">$transaction_rollbacked </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">parent </span><span class="keyword">:: </span><span class="default">__construct</span><span class="keyword">( ... </span><span class="default">connection info </span><span class="keyword">... );<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public static </span><span class="default">$nest </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">reset</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$transaction_rollbacked </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$warn_rollback_was_thrown </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$nest </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">beginTransaction</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$nest </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">reset</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">beginTransaction</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$nest</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">commit</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$nest </span><span class="keyword">== </span><span class="default">0 </span><span class="keyword">&amp;&amp;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; !</span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$transaction_rollbacked </span><span class="keyword">&amp;&amp;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; !</span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$warn_rollback_was_thrown</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">parent </span><span class="keyword">:: </span><span class="default">commit</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$nest</span><span class="keyword">--;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">rollback</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$nest </span><span class="keyword">&gt;= </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$nest </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">parent </span><span class="keyword">:: </span><span class="default">rollback</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$transaction_rollbacked </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">TransactionController&nbsp; </span><span class="keyword">:: </span><span class="default">$warn_rollback_was_thrown </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$nest</span><span class="keyword">--;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">transactionFailed</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$warn_rollback_was_thrown </span><span class="keyword">=== </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// to force rollback you can only do it from $nest = 0<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">forceRollback</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">TransactionController </span><span class="keyword">:: </span><span class="default">$nest </span><span class="keyword">=== </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">throws </span><span class="keyword">new </span><span class="default">\PDOException</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119120""></a>
  <div class="note">
   <strong class="user">kesler dot alwin at gmail dot com</strong>
   <a href="#119120" class="date">05-Apr-2016 01:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
please fix in answer #116669:<br />
<br />
&nbsp;&nbsp;&nbsp; $this-&gt;exec('ROLLBACK TO trans'.$this-&gt;transactionCounter + 1);<br />
<br />
with<br />
<br />
&nbsp;&nbsp;&nbsp; $this-&gt;exec('ROLLBACK TO trans'.($this-&gt;transactionCounter + 1));</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116669""></a>
  <div class="note">
   <strong class="user">steve at fancyguy dot com</strong>
   <a href="#116669" class="date">08-Feb-2015 08:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The nested transaction example here is great, but it's missing a key piece of the puzzle.&nbsp; Commits will commit everything, I only wanted commits to actually commit when the outermost commit has been completed.&nbsp; This can be done in InnoDB with savepoints.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">Database </span><span class="keyword">extends </span><span class="default">PDO<br />
</span><span class="keyword">{<br />
<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$transactionCount </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">beginTransaction</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">parent</span><span class="keyword">::</span><span class="default">beginTransaction</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">exec</span><span class="keyword">(</span><span class="string">'SAVEPOINT trans'</span><span class="keyword">.</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter </span><span class="keyword">&gt;= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">commit</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!--</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">parent</span><span class="keyword">::</span><span class="default">commit</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter </span><span class="keyword">&gt;= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">rollback</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (--</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">exec</span><span class="keyword">(</span><span class="string">'ROLLBACK TO trans'</span><span class="keyword">.</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">parent</span><span class="keyword">::</span><span class="default">rollback</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116262""></a>
  <div class="note">
   <strong class="user">Steel Brain</strong>
   <a href="#116262" class="date">03-Dec-2014 12:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The example is misleading, Typically data definition language clauses (DDL) will trigger the database engine to automatically commit. It means that if you drop a table, that query will be executed regardless of the transaction.<br />
Ref-Mysql:<br />
&nbsp;&nbsp;&nbsp; <a href="http://dev.mysql.com/doc/refman/5.0/en/implicit-commit.html" rel="nofollow" target="_blank">http://dev.mysql.com/doc/refman/5.0/en/implicit-commit.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116245""></a>
  <div class="note">
   <strong class="user">eddi13</strong>
   <a href="#116245" class="date">28-Nov-2014 09:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
after TRUNCATE TABLE `table`&nbsp; just as DELETE FROM `table`, so if whole table was deleted, aborts the transaction. And the rollback will not be passible.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114788""></a>
  <div class="note">
   <strong class="user">arth dot inbox at mail dot ru</strong>
   <a href="#114788" class="date">07-Apr-2014 08:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Strange behavior with pdo_firebird driver:<br />
<br />
<span class="default">&lt;?php<br />
$dbh </span><span class="keyword">= new </span><span class="default">PDO </span><span class="keyword">(</span><span class="string">''</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">,array( </span><span class="default">PDO </span><span class="keyword">:: </span><span class="default">ATTR_PERSISTENT</span><span class="keyword">=&gt;</span><span class="default">true</span><span class="keyword">));<br />
</span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">setAttribute</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">ATTR_ERRMODE</span><span class="keyword">,</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">ERRMODE_EXCEPTION </span><span class="keyword">); <br />
</span><span class="default">$dbh </span><span class="keyword">-&gt; </span><span class="default">exec </span><span class="keyword">( </span><span class="string">"select 1;" </span><span class="keyword">); </span><span class="comment">//should be autocommitted<br />
</span><span class="keyword">try<br />
{ <br />
&nbsp;&nbsp; </span><span class="comment">//$dbh-&gt;commit/rollback here fixes the issue;<br />
&nbsp;&nbsp; </span><span class="default">$dbh </span><span class="keyword">-&gt; </span><span class="default">beginTransaction </span><span class="keyword">(); </span><span class="comment">// &lt;- fails "with there is already an active transaction"<br />
&nbsp;&nbsp; </span><span class="default">$dbh </span><span class="keyword">-&gt; </span><span class="default">exec </span><span class="keyword">( </span><span class="string">"select 1;" </span><span class="keyword">); <br />
&nbsp;&nbsp; </span><span class="default">$dbh </span><span class="keyword">-&gt; </span><span class="default">commit </span><span class="keyword">(); <br />
}<br />
catch ( </span><span class="default">Exception $e </span><span class="keyword">)<br />
{ <br />
&nbsp; </span><span class="default">$dbh </span><span class="keyword">-&gt; </span><span class="default">rollBack </span><span class="keyword">(); <br />
&nbsp;} <br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113602""></a>
  <div class="note">
   <strong class="user">mtjo62 at gmail dot com</strong>
   <a href="#113602" class="date">03-Nov-2013 11:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For the PDO driver for the&nbsp; Firebird server, you have to explicitly disable autocommit to initiate the&nbsp; transaction as well as explicitly enable autocommit to commit it.<br />
<br />
$dbh-&gt;setAttribute( PDO::ATTR_AUTOCOMMIT, 0 );<br />
$dbh-&gt;beginTransaction();<br />
<br />
/** Query block */<br />
<br />
$dbh-&gt;commit();<br />
$dbh-&gt;setAttribute( PDO::ATTR_AUTOCOMMIT, 1 );</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109753""></a>
  <div class="note">
   <strong class="user">bitluni</strong>
   <a href="#109753" class="date">16-Aug-2012 09:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can generate problems with nested beginTransaction and commit calls.
<br />
example:
<br />

<br />
beginTransaction()
<br />
do imprortant stuff
<br />
call method
<br />
&nbsp;&nbsp;&nbsp; beginTransaction()
<br />
&nbsp;&nbsp;&nbsp; basic stuff 1
<br />
&nbsp;&nbsp;&nbsp; basic stuff 2
<br />
&nbsp;&nbsp;&nbsp; commit()
<br />
do most important stuff
<br />
commit()
<br />

<br />
Won't work and is dangerous since you could close your transaction too early with the nested commit().
<br />

<br />
There is no need to mess you code and pass like a bool which indicate if transaction is already running. You could just overload the beginTransaction() and commit() in your PDO wrapper like this:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">class </span><span class="default">Database </span><span class="keyword">extends \</span><span class="default">\PDO
<br />
</span><span class="keyword">{
<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$transactionCounter </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">beginTransaction</span><span class="keyword">()
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter</span><span class="keyword">++)
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">parent</span><span class="keyword">::</span><span class="default">beginTransaction</span><span class="keyword">();
<br />
&nbsp;&nbsp; &nbsp; &nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter </span><span class="keyword">&gt;= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">commit</span><span class="keyword">()
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; if(!--</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter</span><span class="keyword">)
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">parent</span><span class="keyword">::</span><span class="default">commit</span><span class="keyword">();
<br />
&nbsp;&nbsp; &nbsp; &nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter </span><span class="keyword">&gt;= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">rollback</span><span class="keyword">()
<br />
&nbsp;&nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter </span><span class="keyword">&gt;= </span><span class="default">0</span><span class="keyword">)
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">parent</span><span class="keyword">::</span><span class="default">rollback</span><span class="keyword">();
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">transactionCounter </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
</span><span class="comment">//...
<br />
</span><span class="keyword">}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98309""></a>
  <div class="note">
   <strong class="user">ludwig dot green at gmail dot com</strong>
   <a href="#98309" class="date">08-Jun-2010 09:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
be aware that you also can not use TRUNCATE TABLE as this statement will trigger a commit just like CREATE TABLE or DROP TABLE<br />
<br />
it is best to only use SELECT, UPDATE and DELETE within a transaction, all other statements may cause commits thus breaking the atomicity of your transactions and their ability to rollback<br />
<br />
obviously you can use DELETE FROM &lt;table&gt; instead of TRUNCATE TABLE but be aware that there are differences between both statements, for example TRUNCATE resets the auto_increment value while DELETE does not.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95353""></a>
  <div class="note">
   <strong class="user">geompse at gmail dot com</strong>
   <a href="#95353" class="date">28-Dec-2009 01:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
With Oracle, any structure statement will do an implicit commit.<br />
<br />
So : ALTER TABLE "my_table" DROP COLUMN "my_column";<br />
Can't be rolled back !<br />
<br />
Hope this will save time for others</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90239""></a>
  <div class="note">
   <strong class="user">rjohnson at intepro dot us</strong>
   <a href="#90239" class="date">11-Apr-2009 02:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are using PDO::SQLITE and need to support a high level of concurrency with locking, try preparing your statements prior to calling beginTransaction() and you may also need to call closeCursor() on SELECT statements to prevent the driver from thinking that there are open transactions.<br />
<br />
Here's an example (Windows, PHP version 5.2.8).&nbsp; We test this by opening 2 browser tabs to this script and running them at the same time.&nbsp; If we put the beginTransaction before the prepare, the second browser tab would hit the catch block and the commit would throw another PDOException indicating that transactions were still open.<br />
<br />
<span class="default">&lt;?php<br />
$conn </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">'sqlite:C:\path\to\file.sqlite'</span><span class="keyword">);<br />
</span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$conn</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">'INSERT INTO my_table(my_id, my_value) VALUES(?, ?)'</span><span class="keyword">);<br />
</span><span class="default">$waiting </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">; </span><span class="comment">// Set a loop condition to test for<br />
</span><span class="keyword">while(</span><span class="default">$waiting</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; try {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$conn</span><span class="keyword">-&gt;</span><span class="default">beginTransaction</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">10</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">bindValue</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">$i</span><span class="keyword">, </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_INT</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">bindValue</span><span class="keyword">(</span><span class="default">2</span><span class="keyword">, </span><span class="string">'TEST'</span><span class="keyword">, </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_STR</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$conn</span><span class="keyword">-&gt;</span><span class="default">commit</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$waiting </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; } catch(</span><span class="default">PDOException $e</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">stripos</span><span class="keyword">(</span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">(), </span><span class="string">'DATABASE IS LOCKED'</span><span class="keyword">) !== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// This should be specific to SQLite, sleep for 0.25 seconds<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // and try again.&nbsp; We do have to commit the open transaction first though<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$conn</span><span class="keyword">-&gt;</span><span class="default">commit</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">250000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$conn</span><span class="keyword">-&gt;</span><span class="default">rollBack</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw </span><span class="default">$e</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85211""></a>
  <div class="note">
   <strong class="user">dbeecher at tekops dot com</strong>
   <a href="#85211" class="date">20-Aug-2008 09:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
// If you need to set an ISOLATION level or LOCK MODE it needs to be done BEFORE you make the BeginTransaction() call...<br />
//<br />
//&nbsp; **note** you should always check result codes on operations and do error handling.&nbsp; This sample code<br />
//&nbsp; assumes all the calls work so that the order of operations is accurate and easy to see<br />
//<br />
//&nbsp; THIS IS using the PECL PDO::INFORMIX module, running on fedora core 6, php 5.2.4<br />
//<br />
//&nbsp; &nbsp; This is the correct way to address an informix -243 error (could not position within table) when there<br />
//&nbsp; &nbsp; is no ISAM error indicating a table corruption.&nbsp; A -243 can happen (if the table/indexes, etc., are ok) <br />
//&nbsp; &nbsp; if a row is locked.&nbsp; The code below sets the LOCK MODE to wait 2 minutes (120 seconds) before<br />
//&nbsp; &nbsp; giving up.&nbsp; In this example you get READ COMMITTED rows, if you don't need read committed<br />
//&nbsp; &nbsp; but just need to get whatever data is there (ignoring locked rows, etc.) instead of<br />
//&nbsp; &nbsp; "SET LOCK MODE TO WAIT 120" you could "SET ISOLATION TO DIRTY READ".<br />
//<br />
//&nbsp; &nbsp; In informix you *must* manage how you do reads because it is very easy to trigger a<br />
//&nbsp; &nbsp; lock table overflow (which downs the instance) if you have lots of rows, are using joins<br />
//&nbsp; &nbsp; and have many updates happening.&nbsp; <br />
//<br />
<br />
// e.g.,<br />
<br />
$sql= "SELECT FIRST 50 * FROM mytable WHERE mystuff=1 ORDER BY myid";&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* define SQL query */<br />
<br />
try&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* create an exception handler */<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp; $dbh = new PDO("informix:host=......");<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; if ($dbh)&nbsp; &nbsp; /* did we connect? */<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $dbh-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $dbh-&gt;query("SET LOCK MODE TO WAIT 120")<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # ----------------<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # open transaction cursor<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # ----------------<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if&nbsp; &nbsp; ( $dbh-&gt;beginTransaction() )&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # explicitly open cursor<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; try&nbsp; &nbsp; /* open exception handler */<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $stmt = $dbh-&gt;prepare($sql, array(PDO::ATTR_CURSOR =&gt; PDO::CURSOR_SCROLL));<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $stmt-&gt;execute();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while ($row = $stmt-&gt;fetch(PDO::FETCH_NUM, PDO::FETCH_ORI_NEXT))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $data = $row[0] . "\t" . $row[1] . "\t" . $row[2] . "\t" . $row[3] . "\t" . $row[4] . "\t" . $row[5] . "\t" . $row[6] . "\t" . $row[7] . "\n" . $row[8] ;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //print $data;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print_r($row);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $stmt = null;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; catch (PDOException $e)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print "Query Failed!\n\n";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print "DBA FAIL:" . $e-&gt;getMessage();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $dbh-&gt;rollback();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # abort any changes (ie. $dbh-&gt;commit()<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $dbh = null;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # close connection<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # we should never get here, it should go to the exception handler<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print "Unable to establish connection...\n\n";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp;&nbsp; }<br />
catch (Exception $e)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp; $dbh-&gt;rollback();<br />
&nbsp;&nbsp;&nbsp; echo "Failed: " . $e-&gt;getMessage();<br />
&nbsp;&nbsp;&nbsp; };</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81022""></a>
  <div class="note">
   <strong class="user">drm at melp dot nl</strong>
   <a href="#81022" class="date">11-Feb-2008 06:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In response to "Anonymous / 20-Dec-2007 03:04"<br />
<br />
You could also extend the PDO class and hold a private flag to check if a transaction is already started.<br />
<br />
class MyPDO extends PDO {<br />
&nbsp;&nbsp; protected $hasActiveTransaction = false;<br />
<br />
&nbsp;&nbsp; function beginTransaction () {<br />
&nbsp;&nbsp; &nbsp;&nbsp; if ( $this-&gt;hasActiveTransaction ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; return false;<br />
&nbsp;&nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;hasActiveTransaction = parent::beginTransaction ();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; return $this-&gt;hasActiveTransaction;<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; function commit () {<br />
&nbsp;&nbsp; &nbsp;&nbsp; parent::commit ();<br />
&nbsp;&nbsp; &nbsp;&nbsp; $this-&gt;hasActiveTransaction = false;<br />
&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; function rollback () {<br />
&nbsp;&nbsp; &nbsp;&nbsp; parent::rollback ();<br />
&nbsp;&nbsp; &nbsp;&nbsp; $this-&gt;hasActiveTransaction = false;<br />
&nbsp;&nbsp; }<br />
<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79942""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#79942" class="date">20-Dec-2007 07:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
beginTransaction will through a PDOException if you execute it while a PDO transaction is already active.&nbsp; Additionally the PDO engine doesn't seem to provide any way of determining if there is a transaction "in flight" so if you might be calling a function from within another function that starts a transaction you'll have to wrap the beginTransaction () call in a try .. catch block.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
