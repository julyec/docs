<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>从已存储的表示中创建 PHP 的值</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.strval.html">? strval</a></li>
      <li style="float: right;"><a href="function.unset.html">unset ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.var.html">变量处理函数</a></li>
    <li>从已存储的表示中创建 PHP 的值</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.unserialize" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">unserialize</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">unserialize</span> &mdash; <span class="dc-title">
   从已存储的表示中创建 PHP 的值
  </span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.unserialize-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>unserialize</strong></span>(<span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>, <span class="methodparam"><span class="type">array</span> <code class="parameter">$options</code><span class="initializer"> = []</span></span>): <span class="type"><a href="language.types.declarations.html#language.types.declarations.mixed" class="type mixed">mixed</a></span></div>

  <p class="simpara">
   <span class="function"><strong>unserialize()</strong></span> 对单一的已序列化的变量进行操作，将其转换回 
   PHP 的值。
  </p>
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="para">
    无论 <code class="literal">allowed_classes</code> 的 <code class="parameter">options</code>
    值如何，都不要将不受信任的用户输入传递给
    <span class="function"><strong>unserialize()</strong></span>。由于对象实例化和自动加载，反序列化可能会导致加载代码并执行，恶意用户可能会利用这一点。如果需要将序列化数据传递给用户，请使用安全、标准的数据交换格式，例如
    JSON（通过 <span class="function"><a href="function.json-decode.html" class="function">json_decode()</a></span> 和 <span class="function"><a href="function.json-encode.html" class="function">json_encode()</a></span>）。
   </p>
   <p class="para">
    如果需要反序列化外部存储的序列化数据，请考虑使用 <span class="function"><a href="function.hash-hmac.html" class="function">hash_hmac()</a></span> 做数据验证。确保数据不会被任何人修改。
   </p>
  </div>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.unserialize-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">data</code></dt>

     <dd>

      <p class="para">
       序列化后的字符串。
      </p>
      <p class="para">
       若被反序列化的变量是一个对象，在成功地重新构造对象之后，PHP 会试图自动调用
       <a href="language.oop5.magic.html#object.unserialize" class="link">__unserialize()</a> 或
       <a href="language.oop5.magic.html#object.wakeup" class="link">__wakeup()</a> 方法（如果存在）。
      </p>
      <p class="para">
       <blockquote class="note"><p><strong class="note">Note</strong>: 
        <strong>unserialize_callback_func 指令</strong><br />
        <p class="para">
         如果在反序列化时需要实例化未定义类，则可以设置回调函数以供调用（以免得到的是不完整的 <span class="type">object</span> 
         "__PHP_Incomplete_Class"）。可通过 <var class="filename">php.ini</var>、<span class="function"><a href="function.ini-set.html" class="function">ini_set()</a></span> 或 <var class="filename">.htaccess</var> 定义 <a href="var.configuration.html#ini.unserialize-callback-func" class="link">unserialize_callback_func</a>。每次实例化未定义类时它都会被调用。若要禁止这个特性，只需置空此设定。
        </p>
       </p></blockquote>
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">options</code></dt>

     <dd>

      <p class="para">
       使用关联数组提供给 <span class="function"><strong>unserialize()</strong></span> 的任何选项。
      </p>
      <table class="doctable table">
       <caption><strong>可用选项</strong></caption>
       
        <thead>
         <tr>
          <th>名称</th>
          <th>类型</th>
          <th>说明</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td><code class="literal">allowed_classes</code></td>
          <td><span class="type"><a href="language.types.declarations.html#language.types.declarations.mixed" class="type mixed">mixed</a></span></td>
          <td>
           <span class="simpara">
            应该接受的类名数组，<strong><code>false</code></strong> 表示不接受任何类，或者 <strong><code>true</code></strong> 表示接受所有类。如果定义此选项且
            <span class="function"><strong>unserialize()</strong></span> 遇到不接受的类的对象，则该对象将会实例化为
            <span class="classname"><strong class="classname">__PHP_Incomplete_Class</strong></span>。
           </span>
           <span class="simpara">
            省略此选项等同于定义为 <strong><code>true</code></strong>：PHP 将会尝试实例化任何类的对象。
           </span>
          </td>
         </tr>

         <tr>
          <td><code class="literal">max_depth</code></td>
          <td><span class="type">int</span></td>
          <td>
           <span class="simpara">
            反序列时允许的最大结构深度，主要为了防止栈溢出。默认深度限制为 <code class="literal">4096</code>，可以通过将
            <code class="literal">max_depth</code> 设置为 <code class="literal">0</code> 来禁用。
           </span>
          </td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.unserialize-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   返回的是转换之后的值，可为 <span class="type">bool</span>、<span class="type">int</span>、<span class="type">float</span>、<span class="type">string</span>、<span class="type">array</span>
   或 <span class="type">object</span>。
  </p>
  <p class="para">
   如果传递的字符串不可反序列化，则返回 <strong><code>false</code></strong>，并产生 <strong><code>E_NOTICE</code></strong>。
  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-function.unserialize-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
   对象可能会在反序列化处理程序中抛出 <span class="classname"><a href="class.throwable.html" class="classname">Throwable</a></span>。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.unserialize-changelog">
  <h3 class="title">更新日志</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>版本</th>
       <th>说明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>7.4.0</td>
       <td>
        新增 <code class="parameter">options</code> 的 <code class="literal">max_depth</code> 元素，设置反序列化时允许的最大结构深度。
       </td>
      </tr>

      <tr>
       <td>7.1.0</td>
       <td>
        <code class="parameter">options</code> 的 <code class="literal">allowed_classes</code> 元素现在是严格类型，即如果给出
        <span class="type">array</span> 或 <span class="type">bool</span> 以外的任何内容，则 <span class="function"><strong>unserialize()</strong></span> 返回
        <strong><code>false</code></strong> 并发出 <strong><code>E_WARNING</code></strong>。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.unserialize-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="">
    <p><strong>Example #1 <span class="function"><strong>unserialize()</strong></span> 例子</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">// 这里，我们使用 unserialize() 装载来自数据库的 $session_data 数组中的会话数据。<br />// 此例是描述 serialize() 的那个例子的补充。<br /><br /></span><span style="color: #0000BB">$conn </span><span style="color: #007700">= </span><span style="color: #0000BB">odbc_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"webdb"</span><span style="color: #007700">, </span><span style="color: #DD0000">"php"</span><span style="color: #007700">, </span><span style="color: #DD0000">"chicken"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$stmt </span><span style="color: #007700">= </span><span style="color: #0000BB">odbc_prepare</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">, </span><span style="color: #DD0000">"SELECT data FROM sessions WHERE id = ?"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$sqldata </span><span style="color: #007700">= array(</span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">'PHP_AUTH_USER'</span><span style="color: #007700">]);<br />if (!</span><span style="color: #0000BB">odbc_execute</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">, </span><span style="color: #0000BB">$sqldata</span><span style="color: #007700">) || !</span><span style="color: #0000BB">odbc_fetch_into</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">, </span><span style="color: #0000BB">$tmp</span><span style="color: #007700">)) {<br />    </span><span style="color: #FF8000">// 如果执行出错或返回错误，则初始化为空数组<br />    </span><span style="color: #0000BB">$session_data </span><span style="color: #007700">= array();<br />} else {<br />    </span><span style="color: #FF8000">// 现在我们需要的是 $tmp[0] 中已序列化的数据。<br />    </span><span style="color: #0000BB">$session_data </span><span style="color: #007700">= </span><span style="color: #0000BB">unserialize</span><span style="color: #007700">(</span><span style="color: #0000BB">$tmp</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]);<br />    if (!</span><span style="color: #0000BB">is_array</span><span style="color: #007700">(</span><span style="color: #0000BB">$session_data</span><span style="color: #007700">)) {<br />        </span><span style="color: #FF8000">// 出错，初始化为空数组<br />        </span><span style="color: #0000BB">$session_data </span><span style="color: #007700">= array();<br />    }<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   <div class="example" id="">
    <p><strong>Example #2 unserialize_callback_func 例子</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$serialized_object</span><span style="color: #007700">=</span><span style="color: #DD0000">'O:1:"a":1:{s:5:"value";s:3:"100";}'</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">ini_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'unserialize_callback_func'</span><span style="color: #007700">, </span><span style="color: #DD0000">'mycallback'</span><span style="color: #007700">); </span><span style="color: #FF8000">// 设置您的回调函数<br /><br /></span><span style="color: #007700">function </span><span style="color: #0000BB">mycallback</span><span style="color: #007700">(</span><span style="color: #0000BB">$classname</span><span style="color: #007700">) <br />{<br />   </span><span style="color: #FF8000">// 只需包含含有类定义的文件<br />   // $classname 指出需要的是哪一个类<br /></span><span style="color: #007700">}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.unserialize-notes">
  <h3 class="title">注释</h3>
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="para">
    如果发生了错误或反序列化了已序列化的 <strong><code>false</code></strong> 值，则会返回 <strong><code>false</code></strong>。可以通过 <code class="parameter">data</code> 和
    <code class="literal">serialize(false)</code> 进行比较，或者捕捉 <strong><code>E_NOTICE</code></strong> 错误来判断这种特殊情况。
   </p>
  </div>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.unserialize-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.json-encode.html" class="function" rel="rdfs-seeAlso">json_encode()</a> - 对变量进行 JSON 编码</span></li>
    <li class="member"><span class="function"><a href="function.json-decode.html" class="function" rel="rdfs-seeAlso">json_decode()</a> - 对 JSON 格式的字符串进行解码</span></li>
    <li class="member"><span class="function"><a href="function.hash-hmac.html" class="function" rel="rdfs-seeAlso">hash_hmac()</a> - 使用 HMAC 方法生成带有密钥的散列值</span></li>
    <li class="member"><span class="function"><a href="function.serialize.html" class="function" rel="rdfs-seeAlso">serialize()</a> - 生成值的可存储表示</span></li>
    <li class="member"><a href="language.oop5.autoload.html" class="link">自动加载类</a></li>
    <li class="member"><a href="var.configuration.html#ini.unserialize-callback-func" class="link">unserialize_callback_func</a></li>
    <li class="member"><a href="var.configuration.html#ini.unserialize-max-depth" class="link">unserialize_max_depth</a></li>
    <li class="member"><a href="language.oop5.magic.html#object.wakeup" class="link">__wakeup()</a></li>
    <li class="member"><a href="language.oop5.magic.html#object.serialize" class="link">__serialize()</a></li>
    <li class="member"><a href="language.oop5.magic.html#object.unserialize" class="link">__unserialize()</a></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="127782""></a>
  <div class="note">
   <strong class="user">OscarZarrus</strong>
   <a href="#127782" class="date">20-Oct-2022 09:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those who are looking for an efficient solution for handling controversial "FALSE", they can use this function which in case of non-unserializable string, instead of a "FALSE", throws an Exception. Vice versa it returns the unserialized variable.
<br />
<span class="default">&lt;?php
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**
<br />
&nbsp;&nbsp; &nbsp; * @param string $serializedString
<br />
&nbsp;&nbsp; &nbsp; * @param array $options
<br />
&nbsp;&nbsp; &nbsp; * @return mixed
<br />
&nbsp;&nbsp; &nbsp; * @throws Exception
<br />
&nbsp;&nbsp; &nbsp; */
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">UnSerialize</span><span class="keyword">(</span><span class="default">string $serializedString</span><span class="keyword">, array </span><span class="default">$options </span><span class="keyword">= []) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$_unserialized </span><span class="keyword">= @</span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$serializedString</span><span class="keyword">, </span><span class="default">$options</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$serializedString </span><span class="keyword">=== </span><span class="default">serialize</span><span class="keyword">(</span><span class="default">false</span><span class="keyword">) || </span><span class="default">$_unserialized </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$_unserialized</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"Non-unserializable string"</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp;&nbsp; }
<br />

<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="125543""></a>
  <div class="note">
   <strong class="user">karsten at dambekalns dot de</strong>
   <a href="#125543" class="date">27-Nov-2020 07:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Keep in mind that the allowed_classes does not use inheritance, i.e. allowing an interface is not possible and sub-classes won't pass the check. See https://3v4l.org/tdHfl</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="124608""></a>
  <div class="note">
   <strong class="user">hadley8899 at gmail dot com</strong>
   <a href="#124608" class="date">13-Jan-2020 01:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For the people who are getting the error <br />
<br />
PHP Notice:&nbsp; unserialize(): Error at offset 191 of 285 bytes in ...<br />
<br />
and are getting the data from a database, Make sure that you have the database set the the correct encoding, I had the database set as latin1_swedish_ci and all of the data looked perfect, Infact when i copied it into a online unserialize it worked fine. I changed the collation to utf8mb4_unicode_ci and all worked fine.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123681""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#123681" class="date">11-Mar-2019 06:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If serialize() is the answer, you're almost certainly asking the wrong question.<br />
<br />
JSON is widely available. The only thing it does not do, is the very thing that makes serialization immensely dangerous. All it takes is a crafty hacker to pass a crafted payload to a supposedly 'secured' serialize call, for a database driver to be overwritten with malicious code, for example.<br />
<br />
Recreate the object. Normally. With actual data, and a source file, not with serialize. To do otherwise is laziness bordering on malice.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121813""></a>
  <div class="note">
   <strong class="user">me+phpnet at unreal4u dot com</strong>
   <a href="#121813" class="date">30-Oct-2017 03:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just some reminder which may save somebody some time regarding the `$options` array: <br />
<br />
Say you want to be on the safe side and not allow any objects to be unserialized... My first thought was doing the following:<br />
<br />
<span class="default">&lt;?php<br />
$lol </span><span class="keyword">= </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />
</span><span class="comment">// This will generate:<br />
// Warning: unserialize() expects parameter 2 to be array, boolean given<br />
</span><span class="default">?&gt;<br />
</span><br />
The correct way of doing this is the following:<br />
<span class="default">&lt;?php<br />
$lol </span><span class="keyword">= </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, [</span><span class="string">'allowed_classes' </span><span class="keyword">=&gt; </span><span class="default">false</span><span class="keyword">]);<br />
</span><span class="default">?&gt;<br />
</span><br />
Hope it helps somebody!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120399""></a>
  <div class="note">
   <strong class="user">bjd</strong>
   <a href="#120399" class="date">02-Jan-2017 12:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Talk on Exploiting PHP7 Unserialize here: https://media.ccc.de/v/33c3-7858-exploiting_php7_unserialize</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119851""></a>
  <div class="note">
   <strong class="user">m.m.j.kronenburg</strong>
   <a href="#119851" class="date">06-Sep-2016 09:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can use the following code to use the php 7 unserialize function in php 5.3 and upwards. This adds the $option argument.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">namespace<br />
{<br />
<br />
</span><span class="comment">/**<br />
&nbsp;* PHP 7 unserialize function for PHP 5.3 upwards.<br />
&nbsp;* Added the $option argument (allowed_classes).<br />
&nbsp;* See php unserialize manual for more detail.<br />
&nbsp;**/<br />
</span><span class="keyword">function </span><span class="default">php7_unserialize</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">, </span><span class="default">$options </span><span class="keyword">= array())<br />
{<br />
&nbsp; if(</span><span class="default">version_compare</span><span class="keyword">(</span><span class="default">PHP_VERSION</span><span class="keyword">, </span><span class="string">'7.0.0'</span><span class="keyword">, </span><span class="string">'&gt;='</span><span class="keyword">))<br />
&nbsp; { return </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">, </span><span class="default">$options</span><span class="keyword">); }<br />
<br />
&nbsp; </span><span class="default">$allowed_classes </span><span class="keyword">= isset(</span><span class="default">$options</span><span class="keyword">[</span><span class="string">'allowed_classes'</span><span class="keyword">]) ? <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$options</span><span class="keyword">[</span><span class="string">'allowed_classes'</span><span class="keyword">] : </span><span class="default">true</span><span class="keyword">;<br />
&nbsp; if(</span><span class="default">is_array</span><span class="keyword">(</span><span class="default">$allowed_classes</span><span class="keyword">) || !</span><span class="default">$allowed_classes</span><span class="keyword">)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="default">preg_replace_callback</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="string">'/(?=^|:)(O|C):\d+:"([^"]*)":(\d+):{/'</span><span class="keyword">, <br />
&nbsp;&nbsp; &nbsp;&nbsp; function(</span><span class="default">$matches</span><span class="keyword">) use (</span><span class="default">$allowed_classes</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">is_array</span><span class="keyword">(</span><span class="default">$allowed_classes</span><span class="keyword">) &amp;&amp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">in_array</span><span class="keyword">(</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">$allowed_classes</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; { return </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">].</span><span class="string">':22:"__PHP_Incomplete_Class":'</span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] + </span><span class="default">1</span><span class="keyword">).<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">':{s:27:"__PHP_Incomplete_Class_Name";'</span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">serialize</span><span class="keyword">(</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; },<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$str<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp; }<br />
&nbsp; unset(</span><span class="default">$allowed_classes</span><span class="keyword">);<br />
&nbsp; return </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">);<br />
}<br />
<br />
} </span><span class="comment">// namespace<br />
<br />
</span><span class="keyword">namespace </span><span class="default">my_name_space<br />
</span><span class="keyword">{<br />
&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; * Use the new php7 unserialize in your namespace without<br />
&nbsp;&nbsp; * renaming all unserialize(...) function calls to <br />
&nbsp;&nbsp; * php7_unserialize(...).<br />
&nbsp;&nbsp; **/<br />
&nbsp; </span><span class="keyword">function </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">, </span><span class="default">$options </span><span class="keyword">= array())<br />
&nbsp; { return </span><span class="default">php7_unserialize</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">, </span><span class="default">$options</span><span class="keyword">); }<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117589""></a>
  <div class="note">
   <strong class="user">chris at pollett dot org</strong>
   <a href="#117589" class="date">02-Jul-2015 03:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When you serialize an object of a class from a particular namespace, the namespace is recorded as part of the serialization. If you decide to change this namespace's name, it can be hard to read in old serialized objects. I.e., suppose you had serialized an object of type foo\A, you change the namespace of your project to goo but otherwise leave the class definition of A unchanged. You would like to be able to unserialize the object as goo\A, instead unserialization will only create a partial object. To fix this in the case where you don't have nested objects in your class definition, you can use the following simple rename function:<br />
/**<br />
&nbsp;* Used to change the namespace of a serialized php object (assumes doesn't<br />
&nbsp;* have nested subobjects)<br />
&nbsp;*<br />
&nbsp;* @param string $class_name new fully qualified name with namespace<br />
&nbsp;* @param string $object_string serialized object<br />
&nbsp;*<br />
&nbsp;* @return string serialized object with new name<br />
&nbsp;*/<br />
function renameSerializedObject($class_name, $object_string)<br />
{<br />
&nbsp;&nbsp;&nbsp; /*&nbsp; number of digits in the length of name of the object needs to be <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; less than 12 digits (probably more like 4) for this to work.<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; $name_length = intval(substr($object_string, 2, 14));<br />
&nbsp;&nbsp;&nbsp; $name_space_info_length = strlen("O:".$name_length.":") +<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $name_length + 2; // 2 for quotes;<br />
&nbsp;&nbsp;&nbsp; $object_string = 'O:' .<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; strlen($class_name) . ':"'. $class_name.'"' .<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; substr($object_string, $name_space_info_length);<br />
&nbsp;&nbsp;&nbsp; return $object_string;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112894""></a>
  <div class="note">
   <strong class="user">ErnestV</strong>
   <a href="#112894" class="date">03-Aug-2013 01:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a note - if the serialized string contains a reference to a class that cannot be instantiated (e.g. being abstract) PHP will immediately die with a fatal error. If the unserialize() statement is preceded with a '@' to avoid cluttering the logs with warns or notices there will be absolutely no clue as to why the script stopped working. Cost me a couple of hours...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112823""></a>
  <div class="note">
   <strong class="user">Ray.Paseur often uses Gmail</strong>
   <a href="#112823" class="date">26-Jul-2013 01:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In the Classes and Objects docs, there is this: In order to be able to unserialize() an object, the class of that object needs to be defined.<br />
<br />
Prior to PHP 5.3, this was not an issue.&nbsp; But after PHP 5.3 an object made by SimpleXML_Load_String() cannot be serialized.&nbsp; An attempt to do so will result in a run-time failure, throwing an exception.&nbsp; If you store such an object in $_SESSION, you will get a post-execution error that says this:<br />
<br />
Fatal error: Uncaught exception 'Exception' with message 'Serialization of 'SimpleXMLElement' is not allowed' in [no active file]:0 Stack trace: #0 {main} thrown in [no active file] on line 0<br />
<br />
The entire contents of the session will be lost.&nbsp; Hope this saves someone some time!<br />
<br />
<span class="default">&lt;?php </span><span class="comment">// RAY_temp_ser.php<br />
</span><span class="default">error_reporting</span><span class="keyword">(</span><span class="default">E_ALL</span><span class="keyword">);<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$_SESSION</span><span class="keyword">);<br />
</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'hello'</span><span class="keyword">] = </span><span class="string">'World'</span><span class="keyword">;<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$_SESSION</span><span class="keyword">);<br />
<br />
</span><span class="comment">// AN XML STRING FOR TEST DATA<br />
</span><span class="default">$xml </span><span class="keyword">= </span><span class="string">'&lt;?xml version="1.0"?&gt;<br />
&lt;families&gt;<br />
&nbsp; &lt;parent&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;child index="1" value="Category 1"&gt;Child One&lt;/child&gt;<br />
&nbsp; &lt;/parent&gt;<br />
&lt;/families&gt;'</span><span class="keyword">;<br />
<br />
</span><span class="comment">// MAKE AN OBJECT (GIVES SimpleXMLElement)<br />
</span><span class="default">$obj </span><span class="keyword">= </span><span class="default">SimpleXML_Load_String</span><span class="keyword">(</span><span class="default">$xml</span><span class="keyword">);<br />
<br />
</span><span class="comment">// STORE THE OBJECT IN THE SESSION<br />
</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'obj'</span><span class="keyword">] = </span><span class="default">$obj</span><span class="keyword">;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107886""></a>
  <div class="note">
   <strong class="user">suman dot jis at gmail dot com</strong>
   <a href="#107886" class="date">13-Mar-2012 09:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was getting unserialize()&nbsp; Error at offset error.<br />
<br />
If you face similar problem&nbsp; then use the following procedure<br />
<br />
$auctionDetails = preg_replace('!s:(\d+):"(.*?)";!se', "'s:'.strlen('$2').':\"$2\";'", $dataArr[$i]['auction_details'] ); <br />
$auctionDetails = unserialize($auctionDetails);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105500""></a>
  <div class="note">
   <strong class="user">walf</strong>
   <a href="#105500" class="date">22-Aug-2011 08:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
a replacement for unserialize that returns whether it worked and populates the unserialized variable by reference:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">funserialize</span><span class="keyword">(</span><span class="default">$serialized</span><span class="keyword">, &amp;</span><span class="default">$into</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; static </span><span class="default">$sfalse</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$sfalse </span><span class="keyword">=== </span><span class="default">null</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sfalse </span><span class="keyword">= </span><span class="default">serialize</span><span class="keyword">(</span><span class="default">false</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$into </span><span class="keyword">= @</span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$serialized</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$into </span><span class="keyword">!== </span><span class="default">false </span><span class="keyword">|| </span><span class="default">rtrim</span><span class="keyword">(</span><span class="default">$serialized</span><span class="keyword">) === </span><span class="default">$sfalse</span><span class="keyword">;</span><span class="comment">//whitespace at end of serialized var is ignored by PHP<br />
</span><span class="keyword">}<br />
<br />
</span><span class="default">$s_foo </span><span class="keyword">= </span><span class="string">'b:0;'</span><span class="keyword">;<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">funserialize</span><span class="keyword">(</span><span class="default">$s_foo</span><span class="keyword">, </span><span class="default">$foo</span><span class="keyword">), </span><span class="default">$foo</span><span class="keyword">);<br />
<br />
</span><span class="default">$s_bar </span><span class="keyword">= </span><span class="string">'bar'</span><span class="keyword">;<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">funserialize</span><span class="keyword">(</span><span class="default">$s_bar</span><span class="keyword">, </span><span class="default">$bar</span><span class="keyword">), </span><span class="default">$bar</span><span class="keyword">);<br />
<br />
</span><span class="default">$s_foo </span><span class="keyword">= </span><span class="string">'a:0:{};'</span><span class="keyword">;<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">funserialize</span><span class="keyword">(</span><span class="default">$s_foo</span><span class="keyword">, </span><span class="default">$foo</span><span class="keyword">), </span><span class="default">$foo</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span>gives:<br />
<br />
bool(true)<br />
bool(false)<br />
<br />
bool(false)<br />
bool(false)<br />
<br />
bool(true)<br />
array(0) {<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105190""></a>
  <div class="note">
   <strong class="user">MBa</strong>
   <a href="#105190" class="date">02-Aug-2011 03:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To check if a string is serialized:<br />
<br />
$blSerialized=(@unserialize($sText)||$sText=='b:0;');</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104479""></a>
  <div class="note">
   <strong class="user">chris at colourlovers dot com</strong>
   <a href="#104479" class="date">16-Jun-2011 05:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Anyone having trouble serializing data with SimpleXMLElement objects stored within it, check this out:<br />
<br />
This will traverse $data looking for any children which are instances of SimpleXMLElement, and will run -&gt;asXML() on them, turning them into a string and making them serializable. Other data will be left alone.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">exportNestedSimpleXML</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">is_scalar</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) === </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">$data </span><span class="keyword">as </span><span class="default">$k </span><span class="keyword">=&gt; </span><span class="default">$v</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$v </span><span class="keyword">instanceof </span><span class="default">SimpleXMLElement</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$v </span><span class="keyword">= </span><span class="default">str_replace</span><span class="keyword">(</span><span class="string">"&amp;#13;"</span><span class="keyword">,</span><span class="string">"\r"</span><span class="keyword">,</span><span class="default">$v</span><span class="keyword">-&gt;</span><span class="default">asXML</span><span class="keyword">());<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$v </span><span class="keyword">= </span><span class="default">exportNestedSimpleXML</span><span class="keyword">(</span><span class="default">$v</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">is_array</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data</span><span class="keyword">[</span><span class="default">$k</span><span class="keyword">] = </span><span class="default">$v</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else if (</span><span class="default">is_object</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data</span><span class="keyword">-&gt;</span><span class="default">$k </span><span class="keyword">= </span><span class="default">$v</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$data</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">$data </span><span class="keyword">= array (<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"baz" </span><span class="keyword">=&gt; array (<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"foo" </span><span class="keyword">=&gt; new </span><span class="default">stdClass</span><span class="keyword">(),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"int" </span><span class="keyword">=&gt; </span><span class="default">123</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"str" </span><span class="keyword">=&gt; </span><span class="string">"asdf"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"bar" </span><span class="keyword">=&gt; new </span><span class="default">SimpleXMLElement</span><span class="keyword">(</span><span class="string">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;foo&gt;bar&lt;/foo&gt;'</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; )<br />
);<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="comment">/*array(1) {<br />
&nbsp; ["baz"]=&gt;<br />
&nbsp; array(4) {<br />
&nbsp;&nbsp;&nbsp; ["foo"]=&gt;<br />
&nbsp;&nbsp;&nbsp; object(stdClass)#3 (0) {<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; ["int"]=&gt;<br />
&nbsp;&nbsp;&nbsp; int(123)<br />
&nbsp;&nbsp;&nbsp; ["str"]=&gt;<br />
&nbsp;&nbsp;&nbsp; string(4) "asdf"<br />
&nbsp;&nbsp;&nbsp; ["bar"]=&gt;<br />
&nbsp;&nbsp;&nbsp; object(SimpleXMLElement)#4 (1) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; [0]=&gt;<br />
&nbsp;&nbsp; &nbsp;&nbsp; string(3) "bar"<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
}*/<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">exportNestedSimpleXML</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">));<br />
</span><span class="comment">/*array(1) {<br />
&nbsp; ["baz"]=&gt;<br />
&nbsp; array(4) {<br />
&nbsp;&nbsp;&nbsp; ["foo"]=&gt;<br />
&nbsp;&nbsp;&nbsp; object(stdClass)#3 (0) {<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; ["int"]=&gt;<br />
&nbsp;&nbsp;&nbsp; int(123)<br />
&nbsp;&nbsp;&nbsp; ["str"]=&gt;<br />
&nbsp;&nbsp;&nbsp; string(4) "asdf"<br />
&nbsp;&nbsp;&nbsp; ["bar"]=&gt;<br />
&nbsp;&nbsp;&nbsp; string(54) "&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />
&lt;foo&gt;bar&lt;/foo&gt;<br />
"<br />
&nbsp; }<br />
}<br />
*/<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96938""></a>
  <div class="note">
   <strong class="user">daniel at fourstaples dot com</strong>
   <a href="#96938" class="date">23-Mar-2010 08:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's a simple function to get the class of a serialized string (that is, the type of object that will be returned if it's unserialized):<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">get_serial_class</span><span class="keyword">(</span><span class="default">$serial</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$types </span><span class="keyword">= array(</span><span class="string">'s' </span><span class="keyword">=&gt; </span><span class="string">'string'</span><span class="keyword">, </span><span class="string">'a' </span><span class="keyword">=&gt; </span><span class="string">'array'</span><span class="keyword">, </span><span class="string">'b' </span><span class="keyword">=&gt; </span><span class="string">'bool'</span><span class="keyword">, </span><span class="string">'i' </span><span class="keyword">=&gt; </span><span class="string">'int'</span><span class="keyword">, </span><span class="string">'d' </span><span class="keyword">=&gt; </span><span class="string">'float'</span><span class="keyword">, </span><span class="string">'N;' </span><span class="keyword">=&gt; </span><span class="string">'NULL'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$parts </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">':'</span><span class="keyword">, </span><span class="default">$serial</span><span class="keyword">, </span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return isset(</span><span class="default">$types</span><span class="keyword">[</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]]) ? </span><span class="default">$types</span><span class="keyword">[</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]] : </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="string">'"'</span><span class="keyword">); <br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
I use this when saving a serialized object to a cookie, to make sure it is the right type when I go to unserialize it.<br />
<br />
The type names are the same format/case as you would see if you did a var_dump().</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96641""></a>
  <div class="note">
   <strong class="user">Fagzal</strong>
   <a href="#96641" class="date">09-Mar-2010 10:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To all who have problem with quoting and slashes when storing serialized data in MySQL: you are probably doing it wrong.<br />
<br />
Use e.g. PDO with placeholders and the blob column type, and it will Just Work.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93451""></a>
  <div class="note">
   <strong class="user">arbie samong</strong>
   <a href="#93451" class="date">10-Sep-2009 07:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
__PHP_Incomplete_Class Object Demystified
<br />

<br />
1. First take note of the output. A simple example:
<br />

<br />
__PHP_Incomplete_Class Object (
<br />
[__PHP_Incomplete_Class_Name] =&gt; SomeObject1
<br />
[obj1property1] =&gt; somevalue1 [obj1property2] =&gt; __PHP_Incomplete_Class Object ( [__PHP_Incomplete_Class_Name] =&gt; SomeObject2 [obj2property1] =&gt; somevalue1 [obj2property2] =&gt; Array (
<br />
['key1'] =&gt; somevalue3, ['key2'] =&gt; somevalue4 ) ) )
<br />

<br />
2. We analyze this and break it down. 
<br />
__PHP_Incomplete_Class Object tells you there is an object that needs to be declared somehow. 
<br />
__PHP_Incomplete_Class_Name simply tells you the expected class name. It is just one of the properties for now.
<br />

<br />
So we have:
<br />
a) an unknown object that has a class name SomeObject1 (first class)
<br />
b) it has 2 properties, namely obj1property1 and obj2property2
<br />
c) obj2property2 is itself an object whose class name is SomeObject2 (the second class)
<br />
d) SomeObject2 has two properties, obj2property1 and obj2property2
<br />
e) obj2property2 is an array that contains two elements
<br />

<br />
3. Now that we have an idea of the structure, we shall create class definitions based from it. We will just create properties for now, methods are not required as a minimum.
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">class </span><span class="default">SomeObject1 </span><span class="keyword">{
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public </span><span class="default">$obj1property1</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public </span><span class="default">$obj1property2</span><span class="keyword">;
<br />
}
<br />
class </span><span class="default">SomeObject2 </span><span class="keyword">{
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public </span><span class="default">$obj2property1</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; public </span><span class="default">$obj2property2</span><span class="keyword">;
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
4. Have that accessible to your script and it will solve the __PHP_Incomplete_Class Object problem as far as the output is concerned. Now you will have:
<br />

<br />
SomeObject1 ( [obj1property1] =&gt; somevalue1 [obj1property2] =&gt; SomeObject2 ( [obj2property1] =&gt; somevalue1 [obj2property2] =&gt; Array ( ['key1'] =&gt; somevalue3, ['key2'] =&gt; somevalue4 ) ) )
<br />

<br />
As you will notice, __PHP_Incomplete_Class Object is gone and replaced by the class name. The property __PHP_Incomplete_Class_Name is also removed.
<br />

<br />
5. As for the array property obj2property2, we can directly access that and just assume that it is an array and loop through it:
<br />

<br />
<span class="default">&lt;?php
<br />

<br />
</span><span class="comment">// this will be SomeObject1 
<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$serialized_data</span><span class="keyword">);
<br />

<br />
</span><span class="comment">// this will be SomeObject2
<br />
</span><span class="default">$data2 </span><span class="keyword">= </span><span class="default">$data</span><span class="keyword">-&gt;</span><span class="default">obj1property2</span><span class="keyword">();
<br />

<br />
foreach(</span><span class="default">$data2</span><span class="keyword">-&gt;</span><span class="default">obj2property2 </span><span class="keyword">as </span><span class="default">$key </span><span class="keyword">=&gt; </span><span class="default">$value</span><span class="keyword">):
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; print </span><span class="default">$key</span><span class="keyword">.</span><span class="string">' : '</span><span class="keyword">. </span><span class="default">$value </span><span class="keyword">.</span><span class="string">'&lt;br&gt;'</span><span class="keyword">; 
<br />
endforeach;
<br />

<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Outputs:
<br />
key1 : somevalue3
<br />
key2 : somevalue4
<br />

<br />
That's it. You can add more methods on the class declarations for the given properties, provided you keep your original output as basis for the data types.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90120""></a>
  <div class="note">
   <strong class="user">w dot laurencine at teknoa dot net</strong>
   <a href="#90120" class="date">07-Apr-2009 05:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When dealing with a string which contain "\r", it seems that the length is not evaluated correctly. The following solves the problem for me :<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// remove the \r caracters from the $unserialized string<br />
</span><span class="default">$unserialized </span><span class="keyword">= </span><span class="default">str_replace</span><span class="keyword">(</span><span class="string">"\r"</span><span class="keyword">,</span><span class="string">""</span><span class="keyword">,</span><span class="default">$unserialized</span><span class="keyword">);<br />
<br />
</span><span class="comment">// and then unserialize()<br />
</span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$unserialized</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85097""></a>
  <div class="note">
   <strong class="user">chris AT cmbuckley DOT co DOT uk</strong>
   <a href="#85097" class="date">14-Aug-2008 06:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As mentioned in the notes, unserialize returns false in the event of an error and for boolean false. Here is the first solution mentioned, without using error handling:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">isSerialized</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; return (</span><span class="default">$str </span><span class="keyword">== </span><span class="default">serialize</span><span class="keyword">(</span><span class="default">false</span><span class="keyword">) || @</span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">) !== </span><span class="default">false</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">isSerialized</span><span class="keyword">(</span><span class="string">'s:6:"foobar";'</span><span class="keyword">)); </span><span class="comment">// bool(true)<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">isSerialized</span><span class="keyword">(</span><span class="string">'foobar'</span><span class="keyword">));&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// bool(false)<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">isSerialized</span><span class="keyword">(</span><span class="string">'b:0;'</span><span class="keyword">));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// bool(true)<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73585""></a>
  <div class="note">
   <strong class="user">BenBE at omorphia dot de</strong>
   <a href="#73585" class="date">02-Mar-2007 06:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When trying to serialize or unserialize recursive arrays or otherwise linked data you might find the undocumented R data type quite useful.<br />
<br />
If you want a array like the one produced with<br />
&lt;?<br />
$a = array();<br />
$a[0] =&amp; $a;<br />
?&gt;<br />
serialized you can store it using a string simular to this one:<br />
&lt;?<br />
$a = unserialize("a:1:{i:0;R:1;}");<br />
?&gt;<br />
<br />
Both sources will make $a hold an array that self-references itself in index 0.<br />
<br />
The argument for R is the index of the created sub-variable of the serialize-string beginning with 1.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="71846""></a>
  <div class="note">
   <strong class="user">double at dumpit dot com</strong>
   <a href="#71846" class="date">19-Dec-2006 05:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This little function will check whether the serialized string is well formed. <br />
<br />
PHP &lt; 6 because i'd heard changes will be made in this php-intern function, <br />
maybe it could be edited easy for it.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">wd_check_serialization</span><span class="keyword">( </span><span class="default">$string</span><span class="keyword">, &amp;</span><span class="default">$errmsg </span><span class="keyword">) <br />
{<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="string">'s'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$array </span><span class="keyword">= </span><span class="string">'a'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$integer </span><span class="keyword">= </span><span class="string">'i'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$any </span><span class="keyword">= </span><span class="string">'[^}]*?'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$count </span><span class="keyword">= </span><span class="string">'\d+'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$content </span><span class="keyword">= </span><span class="string">'"(?:\\\";|.)*?";'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$open_tag </span><span class="keyword">= </span><span class="string">'\{'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$close_tag </span><span class="keyword">= </span><span class="string">'\}'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$parameter </span><span class="keyword">= </span><span class="string">"(</span><span class="default">$str</span><span class="string">|</span><span class="default">$array</span><span class="string">|</span><span class="default">$integer</span><span class="string">|</span><span class="default">$any</span><span class="string">):(</span><span class="default">$count</span><span class="string">)" </span><span class="keyword">. </span><span class="string">"(?:[:](</span><span class="default">$open_tag</span><span class="string">|</span><span class="default">$content</span><span class="string">)|[;])"</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$preg </span><span class="keyword">= </span><span class="string">"/</span><span class="default">$parameter</span><span class="string">|(</span><span class="default">$close_tag</span><span class="string">)/"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if( !</span><span class="default">preg_match_all</span><span class="keyword">( </span><span class="default">$preg</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">, </span><span class="default">$matches </span><span class="keyword">) ) <br />
&nbsp;&nbsp;&nbsp; {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errmsg </span><span class="keyword">= </span><span class="string">'not a serialized string'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$open_arrays </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; foreach( </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] AS </span><span class="default">$key </span><span class="keyword">=&gt; </span><span class="default">$value </span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( !empty( </span><span class="default">$value </span><span class="keyword">) &amp;&amp; ( </span><span class="default">$value </span><span class="keyword">!= </span><span class="default">$array </span><span class="keyword">xor </span><span class="default">$value </span><span class="keyword">!= </span><span class="default">$str </span><span class="keyword">xor </span><span class="default">$value </span><span class="keyword">!= </span><span class="default">$integer </span><span class="keyword">) ) <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errmsg </span><span class="keyword">= </span><span class="string">'undefined datatype'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">$value </span><span class="keyword">== </span><span class="default">$array </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$open_arrays</span><span class="keyword">++;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">][</span><span class="default">$key</span><span class="keyword">] != </span><span class="string">'{' </span><span class="keyword">) <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errmsg </span><span class="keyword">= </span><span class="string">'open tag expected'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">$value </span><span class="keyword">== </span><span class="string">'' </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">4</span><span class="keyword">][</span><span class="default">$key</span><span class="keyword">] != </span><span class="string">'}' </span><span class="keyword">) <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errmsg </span><span class="keyword">= </span><span class="string">'close tag expected'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$open_arrays</span><span class="keyword">--;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">$value </span><span class="keyword">== </span><span class="default">$str </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aVar </span><span class="keyword">= </span><span class="default">ltrim</span><span class="keyword">( </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">][</span><span class="default">$key</span><span class="keyword">], </span><span class="string">'"' </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$aVar </span><span class="keyword">= </span><span class="default">rtrim</span><span class="keyword">( </span><span class="default">$aVar</span><span class="keyword">, </span><span class="string">'";' </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">strlen</span><span class="keyword">( </span><span class="default">$aVar </span><span class="keyword">) != </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">][</span><span class="default">$key</span><span class="keyword">] ) <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errmsg </span><span class="keyword">= </span><span class="string">'stringlen for string not match'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">$value </span><span class="keyword">== </span><span class="default">$integer </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if( !empty( </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">][</span><span class="default">$key</span><span class="keyword">] ) ) <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errmsg </span><span class="keyword">= </span><span class="string">'unexpected data'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if( !</span><span class="default">is_integer</span><span class="keyword">( (int)</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">][</span><span class="default">$key</span><span class="keyword">] ) ) <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errmsg </span><span class="keyword">= </span><span class="string">'integer expected'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; if( </span><span class="default">$open_arrays </span><span class="keyword">!= </span><span class="default">0 </span><span class="keyword">) <br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$errmsg </span><span class="keyword">= </span><span class="string">'wrong setted arrays'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68748""></a>
  <div class="note">
   <strong class="user">Are Pedersen</strong>
   <a href="#68748" class="date">09-Aug-2006 01:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be aware that if useing serialize/unserialize in a serverfarm with both 32bit and 64bit servers you can get unexpected results.<br />
<br />
Ex: if you serialize an integer with value of 2147483648 on a 64bit system and then unserialize it on a 32bit system you will get the value -2147483648 instead. This is because an integer on 32bit cannot be above 2147483647 so it wraps.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="46796""></a>
  <div class="note">
   <strong class="user">Chris Hayes (chris at hypersites dot com)</strong>
   <a href="#46796" class="date">23-Oct-2004 09:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In reply to the earlier post about having to include object definitions *before* using unserialize.&nbsp; There is a workaround for this.<br />
<br />
When an object is serialized, the first bit of the string is actually the name of the class.&nbsp; When an unknown object is unserialized, this is maintained as a property.&nbsp; So if you serialize it again, you get back the exact same string as if you'd serialized the original object.&nbsp; Basically, to cut to the point...<br />
<br />
If you use<br />
<br />
$_SESSION['my_object'] = unserialize(serialize($_SESSION['my_object']))<br />
<br />
then you get back an object of the correct type, even if the session had originally loaded it as an object of type stdClass.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="37008""></a>
  <div class="note">
   <strong class="user">aderyn at nowhere dot tld</strong>
   <a href="#37008" class="date">30-Oct-2003 10:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A quick note:<br />
If you store a serialized object in a session, you have to include the class _before_ you initialize (session_start()) the session.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
