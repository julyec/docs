<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>发送一条 MySQL 查询</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.mysql-ping.html">? mysql_ping</a></li>
      <li style="float: right;"><a href="function.mysql-real-escape-string.html">mysql_real_escape_string ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.mysql.html">MySQL 函数</a></li>
    <li>发送一条 MySQL 查询</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.mysql-query" class="refentry">
   <div class="refnamediv">
    <h1 class="refname">mysql_query</h1>
    <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">mysql_query</span> &mdash; <span class="dc-title">发送一条 MySQL 查询</span></p>

   </div>
   
 <div id="function.mysql-query-refsynopsisdiv">
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="para">本扩展自 PHP 5.5.0
起已废弃，并在自 PHP 7.0.0 开始被移除。应使用 <a href="book.mysqli.html" class="link">MySQLi</a>
或 <a href="ref.pdo-mysql.html" class="link">PDO_MySQL</a> 扩展来替换之。参见 <a href="mysqlinfo.api.choosing.html" class="link">MySQL：选择 API</a> 
指南来获取更多信息。用以替代本函数的有：</p>
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="mysqli.query.html" class="function">mysqli_query()</a></span></li>
    <li class="member"><span class="methodname"><a href="pdo.query.html" class="methodname">PDO::query()</a></span></li>
   </ul>
  </div>
 </div>
   
 <div class="refsect1 description" id="refsect1-function.mysql-query-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>mysql_query</strong></span>(<span class="methodparam"><span class="type">string</span> <code class="parameter">$query</code></span>, <span class="methodparam"><span class="type">resource</span> <code class="parameter">$link_identifier</code><span class="initializer"> = NULL</span></span>): <span class="type"><a href="language.types.declarations.html#language.types.declarations.mixed" class="type mixed">mixed</a></span></div>

    <p class="para rdfs-comment">
     <span class="function"><strong>mysql_query()</strong></span>
     向与指定的 <code class="parameter">link_identifier</code> 关联的服务器中的当前活动数据库发送一条查询（不支持多条查询）。
    </p>
   </div>

   
    <div class="refsect1 parameters" id="refsect1-function.mysql-query-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">query</code></dt>

     <dd>

      <p class="para">
       SQL 查询语句
      </p>
      <p class="para">
       查询字符串不应以分号结束。
       查询中被嵌入的数据应该<a href="function.mysql-real-escape-string.html" class="link">正确地转义</a>。
      </p>
     </dd>

    
    <dt>

<code class="parameter">link_identifier</code></dt>
<dd>
<p class="para">MySQL
连接。如不指定连接标识，则使用由 <span class="function"><a href="function.mysql-connect.html" class="function">mysql_connect()</a></span>
最近打开的连接。如果没有找到该连接，会尝试不带参数调用
<span class="function"><a href="function.mysql-connect.html" class="function">mysql_connect()</a></span>
来创建。如没有找到连接或无法建立连接，则会生成
<strong><code>E_WARNING</code></strong> 级别的错误。</p></dd>


   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.mysql-query-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   <span class="function"><strong>mysql_query()</strong></span> 仅对
     SELECT，SHOW，DESCRIBE, EXPLAIN 和其他语句
     语句返回一个 <span class="type">resource</span>，如果查询出现错误则返回 <strong><code>false</code></strong>。
  </p>
  <p class="para">
   对于其它类型的 SQL
     语句，比如INSERT, UPDATE, DELETE, DROP 之类， <span class="function"><strong>mysql_query()</strong></span>
     在执行成功时返回 <strong><code>true</code></strong>，出错时返回 <strong><code>false</code></strong>。
  </p>
  <p class="para">
   返回的结果资源应该传递给 <span class="function"><a href="function.mysql-fetch-array.html" class="function">mysql_fetch_array()</a></span> 和其他函数来处理结果表,取出返回的数据。
  </p>
  <p class="para">
   假定查询成功，可以调用
     <span class="function"><a href="function.mysql-num-rows.html" class="function">mysql_num_rows()</a></span>
     来查看对应于 SELECT
     语句返回了多少行，或者调用
     <span class="function"><a href="function.mysql-affected-rows.html" class="function">mysql_affected_rows()</a></span>
     来查看对应于
     DELETE，INSERT，REPLACE 或 UPDATE
     语句影响到了多少行。
  </p>
  <p class="para">
   如果没有权限访问查询语句中引用的表时，<span class="function"><strong>mysql_query()</strong></span>
     也会返回 <strong><code>false</code></strong>。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.mysql-query-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="example-3582">
    <p><strong>Example #1 无效的查询</strong></p>
    <div class="example-contents"><p>
     以下查询语法上有错，因此
     <span class="function"><strong>mysql_query()</strong></span>
     失败并返回 <strong><code>false</code></strong>。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$result </span><span style="color: #007700">= </span><span style="color: #0000BB">mysql_query</span><span style="color: #007700">(</span><span style="color: #DD0000">'SELECT * WHERE 1=1'</span><span style="color: #007700">);<br />if (!</span><span style="color: #0000BB">$result</span><span style="color: #007700">) {<br />    die(</span><span style="color: #DD0000">'Invalid query: ' </span><span style="color: #007700">. </span><span style="color: #0000BB">mysql_error</span><span style="color: #007700">());<br />}<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   <div class="example" id="example-3584">
    <p><strong>Example #2 有效的查询</strong></p>
    <div class="example-contents"><p>
     以下查询语法正确，所以 <span class="function"><strong>mysql_query()</strong></span>
     返回了一个 <span class="type">resource</span>。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">// 这应该由用户提供,下面是一个示例<br /></span><span style="color: #0000BB">$firstname </span><span style="color: #007700">= </span><span style="color: #DD0000">'fred'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$lastname  </span><span style="color: #007700">= </span><span style="color: #DD0000">'fox'</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">// 构造查询<br />// 这是执行 SQL 最好的方式<br />// 更多例子参见 mysql_real_escape_string()<br /></span><span style="color: #0000BB">$query </span><span style="color: #007700">= </span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT firstname, lastname, address, age FROM friends <br />    WHERE firstname='%s' AND lastname='%s'"</span><span style="color: #007700">,<br />    </span><span style="color: #0000BB">mysql_real_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$firstname</span><span style="color: #007700">),<br />    </span><span style="color: #0000BB">mysql_real_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$lastname</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">// 执行查询<br /></span><span style="color: #0000BB">$result </span><span style="color: #007700">= </span><span style="color: #0000BB">mysql_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">// 检查结果<br />// 下面显示了实际发送给 MySQL 的查询，以及出现的错误。这对调试很有帮助。<br /></span><span style="color: #007700">if (!</span><span style="color: #0000BB">$result</span><span style="color: #007700">) {<br />    </span><span style="color: #0000BB">$message  </span><span style="color: #007700">= </span><span style="color: #DD0000">'Invalid query: ' </span><span style="color: #007700">. </span><span style="color: #0000BB">mysql_error</span><span style="color: #007700">() . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />    </span><span style="color: #0000BB">$message </span><span style="color: #007700">.= </span><span style="color: #DD0000">'Whole query: ' </span><span style="color: #007700">. </span><span style="color: #0000BB">$query</span><span style="color: #007700">;<br />    die(</span><span style="color: #0000BB">$message</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">// 结果的使用<br />// 尝试 print $result 并不会取出结果资源中的信息<br />// 所以必须至少使用其中一个 mysql 结果函数<br />// 参见 mysql_result(), mysql_fetch_array(), mysql_fetch_row() 等。<br /></span><span style="color: #007700">while (</span><span style="color: #0000BB">$row </span><span style="color: #007700">= </span><span style="color: #0000BB">mysql_fetch_assoc</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">)) {<br />    echo </span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'firstname'</span><span style="color: #007700">];<br />    echo </span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'lastname'</span><span style="color: #007700">];<br />    echo </span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'address'</span><span style="color: #007700">];<br />    echo </span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'age'</span><span style="color: #007700">];<br />}<br /><br /></span><span style="color: #FF8000">// 释放关联结果集的资源<br />// 在脚本结束的时候会自动进行<br /></span><span style="color: #0000BB">mysql_free_result</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.mysql-query-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.mysql-connect.html" class="function" rel="rdfs-seeAlso">mysql_connect()</a> - 打开一个到 MySQL 服务器的连接</span></li>
    <li class="member"><span class="function"><a href="function.mysql-error.html" class="function" rel="rdfs-seeAlso">mysql_error()</a> - 返回上一个 MySQL 操作中的错误信息的文本</span></li>
    <li class="member"><span class="function"><a href="function.mysql-real-escape-string.html" class="function" rel="rdfs-seeAlso">mysql_real_escape_string()</a> - 将字符串中的特殊字符进行转义，以在 SQL 语句中使用</span></li>
    <li class="member"><span class="function"><a href="function.mysql-result.html" class="function" rel="rdfs-seeAlso">mysql_result()</a> - 取得结果数据</span></li>
    <li class="member"><span class="function"><a href="function.mysql-fetch-assoc.html" class="function" rel="rdfs-seeAlso">mysql_fetch_assoc()</a> - 从结果集中取得一行作为关联数组</span></li>
    <li class="member"><span class="function"><a href="function.mysql-unbuffered-query.html" class="function" rel="rdfs-seeAlso">mysql_unbuffered_query()</a> - 向 MySQL 发送一条 SQL 查询，并不获取和缓存结果的行</span></li>
   </ul>
  </p>
 </div>

   
  </div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="122783""></a>
  <div class="note">
   <strong class="user">fbraz3 at gmail dot com</strong>
   <a href="#122783" class="date">30-May-2018 07:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This project implements a wrapper to mysql functions in PHP7.0+<br />
<br />
https://github.com/OOPS-ORG-PHP/mysql-extension-wrapper<br />
<br />
tested and working fine =)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108160""></a>
  <div class="note">
   <strong class="user">mwwaygoo at hotmail dot com</strong>
   <a href="#108160" class="date">03-Apr-2012 02:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I much prefer to use the same syntax for single INSERT, REPLACE and UPDATE queries as it is easier to read and keeps my code shorter (no seperate building of insert and update values)<br />
<br />
INSERT INTO table SET x='1', y=3<br />
UPDATE table SET x='2' WHERE y=3<br />
<br />
So if your using a function to build your query, you will only ever need to code the "field=value, field2=value2" part for any query.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101488""></a>
  <div class="note">
   <strong class="user">ddlshack [at] gmail.dot.com</strong>
   <a href="#101488" class="date">20-Dec-2010 09:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Use this to neatly insert data into a mysql table:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">mysql_insert</span><span class="keyword">(</span><span class="default">$table</span><span class="keyword">, </span><span class="default">$inserts</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$values </span><span class="keyword">= </span><span class="default">array_map</span><span class="keyword">(</span><span class="string">'mysql_real_escape_string'</span><span class="keyword">, </span><span class="default">array_values</span><span class="keyword">(</span><span class="default">$inserts</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$keys </span><span class="keyword">= </span><span class="default">array_keys</span><span class="keyword">(</span><span class="default">$inserts</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">'INSERT INTO `'</span><span class="keyword">.</span><span class="default">$table</span><span class="keyword">.</span><span class="string">'` (`'</span><span class="keyword">.</span><span class="default">implode</span><span class="keyword">(</span><span class="string">'`,`'</span><span class="keyword">, </span><span class="default">$keys</span><span class="keyword">).</span><span class="string">'`) VALUES (\''</span><span class="keyword">.</span><span class="default">implode</span><span class="keyword">(</span><span class="string">'\',\''</span><span class="keyword">, </span><span class="default">$values</span><span class="keyword">).</span><span class="string">'\')'</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
For example:<br />
<br />
<span class="default">&lt;?php<br />
<br />
mysql_insert</span><span class="keyword">(</span><span class="string">'cars'</span><span class="keyword">, array(<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">'make' </span><span class="keyword">=&gt; </span><span class="string">'Aston Martin'</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">'model' </span><span class="keyword">=&gt; </span><span class="string">'DB9'</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">'year' </span><span class="keyword">=&gt; </span><span class="string">'2009'</span><span class="keyword">,<br />
));<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93774""></a>
  <div class="note">
   <strong class="user">Richie (at) RichieBartlett.com</strong>
   <a href="#93774" class="date">28-Sep-2009 04:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those of you whom spent hours bashing your brains against the keyboard wondering why your non-English characters are output as question marks... Try the following:
<br />

<br />
<span class="default">&lt;?php
<br />

<br />
$db </span><span class="keyword">= </span><span class="default">mysql_connect</span><span class="keyword">(</span><span class="string">'YOUR_DB_ADDRESS'</span><span class="keyword">,</span><span class="string">'YOUR_DB_USER'</span><span class="keyword">,</span><span class="string">'YOUR_DB_PASS'</span><span class="keyword">) or die(</span><span class="string">"Database error"</span><span class="keyword">);
<br />
</span><span class="default">mysql_select_db</span><span class="keyword">(</span><span class="string">'YOUR_DB'</span><span class="keyword">, </span><span class="default">$db</span><span class="keyword">);
<br />

<br />
</span><span class="comment">//SOLUTION::&nbsp; add this comment before your 1st query -- force multiLanuage support
<br />
</span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"set names 'utf8'"</span><span class="keyword">);
<br />

<br />
</span><span class="default">$query </span><span class="keyword">= </span><span class="string">"select * from YOUR_DB_TABLE"</span><span class="keyword">;
<br />
</span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">);
<br />

<br />
</span><span class="comment">//-THE_REST_IS_UP_TO_YOU-
<br />

<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Simply run the query "set names 'utf8' " against the MySQL DB and your output should appear correct.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91791""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#91791" class="date">25-Jun-2009 08:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When processing a RENAME TABLE query, PHP apparently always returns false, no matter if the query was successfully processed or not.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88602""></a>
  <div class="note">
   <strong class="user">ialsoagree</strong>
   <a href="#88602" class="date">30-Jan-2009 08:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When you run a select statement and receive a response, the data types of your response will be a string regardless of the data type of the column.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Query to select an int column<br />
</span><span class="default">$query </span><span class="keyword">= </span><span class="string">'SELECT user_id FROM users WHERE user_id = 1'</span><span class="keyword">;<br />
</span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">);<br />
</span><span class="default">$array </span><span class="keyword">= </span><span class="default">mysql_fetch_assoc</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Echoes: string<br />
</span><span class="keyword">echo </span><span class="default">gettype</span><span class="keyword">(</span><span class="default">$array</span><span class="keyword">[</span><span class="string">'user_id'</span><span class="keyword">]);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85807""></a>
  <div class="note">
   <strong class="user">Mr. Tim</strong>
   <a href="#85807" class="date">18-Sep-2008 11:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It should be noted that mysql_query can generate an E_WARNING (not documented).&nbsp; The warning that I hit was when the db user did not have permission to execute a UDF. <br />
<br />
Expected behavior would be like an Invalid SQL statement, where there is no E_WARNING generated by mysql_query.<br />
<br />
Warning: mysql_query() [function.mysql-query]: Unable to save result set in filename.php<br />
<br />
The mysql_errno is 1370 and the mysql_error is:<br />
<br />
execute command denied to user 'username'@'%' for routine 'database_name.MyUDF'</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83884""></a>
  <div class="note">
   <strong class="user">fernandoleal at loytek dot com</strong>
   <a href="#83884" class="date">16-Jun-2008 03:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Dunno if is it a bug but when you are working with replications servers and work with multiple databases queries if you don't select the database it will only insert,update,delete into the master and bypass the slave, I think it its because it doesn't insert the sql on the binary log so the work around its to just call mysql_select_db <br />
MYSQL : 5.0.51a-log<br />
PHP: 5.2.6<br />
Example:<br />
<span class="default">&lt;?php<br />
</span><span class="comment">#Inserts only to master<br />
</span><span class="default">$link</span><span class="keyword">=</span><span class="default">mysql_connect</span><span class="keyword">(</span><span class="string">'host'</span><span class="keyword">,</span><span class="string">'user'</span><span class="keyword">,</span><span class="string">'pass'</span><span class="keyword">);<br />
</span><span class="default">$sql </span><span class="keyword">=</span><span class="string">"INSERT INTO mysql.host (host) VALUES ('localhost');"<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">,</span><span class="default">$link</span><span class="keyword">));<br />
<br />
</span><span class="comment">#The Working Way Master - Slave<br />
</span><span class="default">$link2</span><span class="keyword">=</span><span class="default">mysql_connect</span><span class="keyword">(</span><span class="string">'host'</span><span class="keyword">,</span><span class="string">'user'</span><span class="keyword">,</span><span class="string">'pass'</span><span class="keyword">);<br />
</span><span class="default">$select_db </span><span class="keyword">= </span><span class="default">mysql_select_db</span><span class="keyword">(</span><span class="string">'mysql'</span><span class="keyword">, </span><span class="default">$link2</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">,</span><span class="default">$link2</span><span class="keyword">));&nbsp;&nbsp; <br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82429""></a>
  <div class="note">
   <strong class="user">rogier</strong>
   <a href="#82429" class="date">10-Apr-2008 06:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For all you programmers out there getting the 'Command out of synch' errors when executing a stored procedure call:<br />
<br />
There are known bugs related to this issue, and the best workaround for avoiding this error seems to be switching to mysqli.<br />
<br />
Still, I needed mysql to also handle these calls correctly.<br />
The error is normally related to wrong function call sequences, though the bug report at&nbsp; <a href="http://bugs.php.net/bug.php?id=39727 shows otherwise." rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=39727 shows otherwise.</a><br />
<br />
For me, after commenting out hundreds of lines and several introspection calls to parse the procedure information (using information_schema and 'SHOW' extensions), I still got the same error.<br />
The first result is returned, because I initiated my connection using the MYSQL_MULTI_RESULTS value of 131072 (forget this and you will never get any output, but an error message stating mysql cannot return results in this context)<br />
<br />
After testing with this code (sproc2 simply calls 'SELECT * FROM sometable'), I found the error must be in the mysql library/extension. Somehow, mysql does not handle multiple resultsets correctly, or is at least missing some functionality related to handling multiple results.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//...<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rs </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">'CALL sproc2(500)'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; while ((</span><span class="default">$row</span><span class="keyword">=</span><span class="default">mysql_fetch_assoc</span><span class="keyword">(</span><span class="default">$rs</span><span class="keyword">))!==</span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mysql_free_result</span><span class="keyword">(</span><span class="default">$rs</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rs </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">'CALL sproc2(500)'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; print </span><span class="default">mysql_error</span><span class="keyword">(); </span><span class="comment">//the notorious 'command out of synch' message :(<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">while ((</span><span class="default">$row</span><span class="keyword">=</span><span class="default">mysql_fetch_assoc</span><span class="keyword">(</span><span class="default">$rs</span><span class="keyword">))!==</span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mysql_free_result</span><span class="keyword">(</span><span class="default">$rs</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
After spending hours debugging my code (the full library is already over the MB), the only solution seemed to be to CLOSE the connection after the first call, and reopening it before the second. <br />
<br />
So if you ever make a uniform database accessing interface and implement stored procedures/prepared statements (or classes for it), this could be a solution if you really wish to enable stored procedures.<br />
<br />
Still, be aware that this is really a serious flaw in your design (and IMHO, the mysql extension)<br />
<br />
Also see the documentation for mysqli on mysqli_query, which seems to be working fine.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79255""></a>
  <div class="note">
   <strong class="user">masteracc0 at aol dot com</strong>
   <a href="#79255" class="date">17-Nov-2007 10:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Keep in mind when dealing with PHP &amp; MySQL that sending a null-terminated string to a MySQL query can be misleading if you use echo($sql) in PHP because the null terminator may not be visible.<br />
<br />
For example (this assumes connection is already made),<br />
$string1 = "mystring\0";<br />
$string2 = "mystring";<br />
<br />
$query1 = "SELECT * FROM table WHERE mystring='".$string1."'"<br />
$query2 = "SELECT * FROM table WHERE mystring='".$string2."'"<br />
&nbsp;<br />
$result1 = mysql_query($query1);<br />
<br />
$result2 = mysql_query($query2);<br />
<br />
//$result1 IS NOT EQUAL TO $result2 but will not provide an error<br />
<br />
//but printing these queries to the screen will provide the same result<br />
echo($result1);<br />
echo($result2);<br />
<br />
Not knowing this could lead to some mind-numbing troubleshooting when dealing with any strings with a null terminator.&nbsp; So now you know! :)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76991""></a>
  <div class="note">
   <strong class="user">halion at gmail dot com</strong>
   <a href="#76991" class="date">09-Aug-2007 02:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
mysql_query doesnt support multiple queries, a way round this is to use innodb and transactions<br />
<br />
this db class/function will accept an array of arrays of querys, it will auto check every line for affected rows in db, if one is 0 it will rollback and return false, else it will commit and return true, the call to the function is simple and is easy to read etc<br />
----------<br />
<br />
class MySQLDB<br />
{<br />
&nbsp;&nbsp; private $connection;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // The MySQL database connection<br />
<br />
&nbsp;&nbsp; /* Class constructor */<br />
&nbsp;&nbsp; function MySQLDB(){<br />
&nbsp;&nbsp; &nbsp;&nbsp; /* Make connection to database */<br />
&nbsp;&nbsp; &nbsp;&nbsp; $this-&gt;connection = mysql_connect(DB_SERVER, DB_USER, DB_PASS) or die(mysql_error());<br />
&nbsp;&nbsp; &nbsp;&nbsp; mysql_select_db(DB_NAME, $this-&gt;connection) or die(mysql_error());<br />
&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; /* Transactions functions */<br />
<br />
&nbsp;&nbsp; function begin(){<br />
&nbsp;&nbsp; &nbsp;&nbsp; $null = mysql_query("START TRANSACTION", $this-&gt;connection);<br />
&nbsp;&nbsp; &nbsp;&nbsp; return mysql_query("BEGIN", $this-&gt;connection);<br />
&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; function commit(){<br />
&nbsp;&nbsp; &nbsp;&nbsp; return mysql_query("COMMIT", $this-&gt;connection);<br />
&nbsp;&nbsp; }<br />
&nbsp;&nbsp; <br />
&nbsp;&nbsp; function rollback(){<br />
&nbsp;&nbsp; &nbsp;&nbsp; return mysql_query("ROLLBACK", $this-&gt;connection);<br />
&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; function transaction($q_array){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; $retval = 1;<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; $this-&gt;begin();<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; foreach($q_array as $qa){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $result = mysql_query($qa['query'], $this-&gt;connection);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(mysql_affected_rows() == 0){ $retval = 0; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; if($retval == 0){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;rollback();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; return false;<br />
&nbsp;&nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;commit();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; return true;<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; }<br />
<br />
};<br />
<br />
/* Create database connection object */<br />
$database = new MySQLDB;<br />
<br />
// then from anywhere else simply put the transaction queries in an array or arrays like this:<br />
<br />
&nbsp;&nbsp; function function(){<br />
&nbsp;&nbsp; &nbsp;&nbsp; global $database;<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; $q = array ( <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; array("query" =&gt; "UPDATE table WHERE something = 'something'"),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; array("query" =&gt; "UPDATE table WHERE something_else = 'something_else'"),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; array("query" =&gt; "DELETE FROM table WHERE something_else2 = 'something_else2'"),<br />
&nbsp;&nbsp; &nbsp;&nbsp; );<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; $database-&gt;transaction($q);<br />
<br />
&nbsp;&nbsp; }</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76848""></a>
  <div class="note">
   <strong class="user">jack dot whoami at gmail dot com</strong>
   <a href="#76848" class="date">01-Aug-2007 06:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Simulating an atomic operation for application locks using mysql.<br />
<br />
$link = mysql_connect('localhost', 'user', 'pass');<br />
if (!$link) {<br />
&nbsp;&nbsp;&nbsp; die('Not connected : ' . mysql_error());<br />
}<br />
<br />
// make foo the current db<br />
$db_selected = mysql_select_db('foo', $link);<br />
if (!$db_selected) {<br />
&nbsp;&nbsp;&nbsp; die ('Can\'t use foo : ' . mysql_error());<br />
}<br />
<br />
$q = "update `table` set `LOCK`='F' where `ID`='1'";<br />
$lock = mysql_affected_rows();<br />
<br />
If we assume<br />
&nbsp;&nbsp; &nbsp; NOT LOCKED = "" (empty string)<br />
&nbsp;&nbsp; &nbsp; LOCKED = 'F'<br />
<br />
then if the column LOCK had a value other than F (normally should be an empty string) the update statement sets it to F and set the affected rows to 1. Which mean than we got the lock.<br />
If affected rows return 0 then the value of that column was already F and somebody else has the lock.<br />
<br />
The secret lies in the following statement taken from the mysql manual:<br />
"If you set a column to the value it currently has, MySQL notices this and does not update it."<br />
<br />
Of course all this is possible if the all application processes agree on the locking algorithm.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="70132""></a>
  <div class="note">
   <strong class="user">veyita_angi at hotmail dot com</strong>
   <a href="#70132" class="date">04-Oct-2006 09:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
this could be a nice way to print values from 2 tables with a foreign key. i have not yet tested correctly but it should work fine.<br />
<br />
$buscar = mysql_query("SELECT k.*, e.Clasificacion FROM cat_plan_k k, cat_equipo e WHERE Tipo='$tipo' AND k.ID_Eq=a.ID_Eq"); <br />
&nbsp;&nbsp;&nbsp; while ($row=mysql_fetch_array($buscar))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $nombre = "e.Clasificacion"; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $row[$nombre] = $Clasific; echo $row[$nombre].'convertido en '.$Clasific;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; mysql_free_result($buscar);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69365""></a>
  <div class="note">
   <strong class="user">cc+php at c2se dot com</strong>
   <a href="#69365" class="date">02-Sep-2006 05:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's a parameterised query function for MySQL similar to pg_query_params, I've been using something similar for a while now and while there is a slight drop in speed, it's far better than making a mistake escaping the parameters of your query and allowing an SQL injection attack on your server.<br />
<br />
<span class="default">&lt;?php&nbsp;&nbsp; </span><span class="comment"># Parameterised query implementation for MySQL (similar PostgreSQL's PHP function pg_query_params)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Example: mysql_query_params( "SELECT * FROM my_table WHERE col1=$1 AND col2=$2", array( 42, "It's ok" ) );<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if( !</span><span class="default">function_exists</span><span class="keyword">( </span><span class="string">'mysql_query_params' </span><span class="keyword">) ) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">mysql_query_params__callback</span><span class="keyword">( </span><span class="default">$at </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$mysql_query_params__parameters</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$mysql_query_params__parameters</span><span class="keyword">[ </span><span class="default">$at</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]-</span><span class="default">1 </span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">mysql_query_params</span><span class="keyword">( </span><span class="default">$query</span><span class="keyword">, </span><span class="default">$parameters</span><span class="keyword">=array(), </span><span class="default">$database</span><span class="keyword">=</span><span class="default">false </span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Escape parameters as required &amp; build parameters for callback function<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">global </span><span class="default">$mysql_query_params__parameters</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; foreach( </span><span class="default">$parameters </span><span class="keyword">as </span><span class="default">$k</span><span class="keyword">=&gt;</span><span class="default">$v </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$parameters</span><span class="keyword">[</span><span class="default">$k</span><span class="keyword">] = ( </span><span class="default">is_int</span><span class="keyword">( </span><span class="default">$v </span><span class="keyword">) ? </span><span class="default">$v </span><span class="keyword">: ( </span><span class="default">NULL</span><span class="keyword">===</span><span class="default">$v </span><span class="keyword">? </span><span class="string">'NULL' </span><span class="keyword">: </span><span class="string">"'"</span><span class="keyword">.</span><span class="default">mysql_real_escape_string</span><span class="keyword">( </span><span class="default">$v </span><span class="keyword">).</span><span class="string">"'" </span><span class="keyword">) );<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mysql_query_params__parameters </span><span class="keyword">= </span><span class="default">$parameters</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Call using mysql_query<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if( </span><span class="default">false</span><span class="keyword">===</span><span class="default">$database </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysql_query</span><span class="keyword">( </span><span class="default">preg_replace_callback</span><span class="keyword">( </span><span class="string">'/\$([0-9]+)/'</span><span class="keyword">, </span><span class="string">'mysql_query_params__callback'</span><span class="keyword">, </span><span class="default">$query </span><span class="keyword">) );<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else&nbsp; &nbsp; return </span><span class="default">mysql_query</span><span class="keyword">( </span><span class="default">preg_replace_callback</span><span class="keyword">( </span><span class="string">'/\$([0-9]+)/'</span><span class="keyword">, </span><span class="string">'mysql_query_params__callback'</span><span class="keyword">, </span><span class="default">$query </span><span class="keyword">), </span><span class="default">$database </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="67943""></a>
  <div class="note">
   <strong class="user">rob desbois</strong>
   <a href="#67943" class="date">07-Jul-2006 02:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that the 'source' command used in the mysql client program is *not* a feature of the server but of the client.<br />
This means that you cannot do<br />
&nbsp;&nbsp; mysql_query('source myfile.sql');<br />
You will get a syntax error. Use LOAD DATA INFILE as an alternative.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62247""></a>
  <div class="note">
   
   <a href="#62247" class="date">22-Feb-2006 11:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If, like me, you come from perl, you may not like having to use sprintf to 'simulate' placeholders that the DBI package from perl provides. I have created the following wrapper function for mysql_query() that allows you to use '?' characters to substitute values in your DB queries. Note that this is not how DBI in perl handles placeholders, but it's pretty similar.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// mysql_query() wrapper. takes two arguments. first<br />
&nbsp;&nbsp;&nbsp; // is the query with '?' placeholders in it. second argument<br />
&nbsp;&nbsp;&nbsp; // is an array containing the values to substitute in place<br />
&nbsp;&nbsp;&nbsp; // of the placeholders (in order, of course).<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">mysql_prepare </span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">, </span><span class="default">$phs </span><span class="keyword">= array()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">$phs </span><span class="keyword">as </span><span class="default">$ph</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ph </span><span class="keyword">= </span><span class="string">"'" </span><span class="keyword">. </span><span class="default">mysql_real_escape_string</span><span class="keyword">(</span><span class="default">$ph</span><span class="keyword">) . </span><span class="string">"'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$query </span><span class="keyword">= </span><span class="default">substr_replace</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$query</span><span class="keyword">, </span><span class="default">$ph</span><span class="keyword">, </span><span class="default">strpos</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">, </span><span class="string">'?'</span><span class="keyword">), </span><span class="default">1<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// sample usage<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">list(</span><span class="default">$user</span><span class="keyword">, </span><span class="default">$passwd</span><span class="keyword">) = array(</span><span class="string">'myuser'</span><span class="keyword">, </span><span class="string">'mypass'</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sth </span><span class="keyword">= </span><span class="default">mysql_prepare</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'select userid from users where userid=? and passwd=?'</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="default">$user</span><span class="keyword">, </span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$passwd</span><span class="keyword">))<br />
&nbsp;&nbsp;&nbsp; );<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$row </span><span class="keyword">= </span><span class="default">mysql_fetch_row</span><span class="keyword">(</span><span class="default">$sth</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// successfull username &amp; password authentication<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$row </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"logging in as '</span><span class="keyword">{</span><span class="default">$row</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]}</span><span class="string">'!\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// oops, wrong userid or passwd<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Invalid username and password combination.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57377""></a>
  <div class="note">
   <strong class="user">php at arcannon dot com</strong>
   <a href="#57377" class="date">01-Oct-2005 03:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I believe there is a typo in celtic at raven-blue dot com version with:<br />
<br />
if (($sql != "") &amp;&amp; (substr($tsl, 0, 2) != "--") &amp;&amp; (substr($tsl, 0, 1) != "#")) {<br />
<br />
I think you really ment: <br />
<br />
if (($tsl != "") &amp;&amp; (substr($tsl, 0, 2) != "--") &amp;&amp; (substr($tsl, 0, 1) != "#")) {<br />
<br />
I changed the $sql to $tsl</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55811""></a>
  <div class="note">
   <strong class="user">ix at nivelzero dot ro</strong>
   <a href="#55811" class="date">14-Aug-2005 03:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
here's a script for parsing a *.sql file (tested only on dumps created with phpMyAdmin) which is short and simple (why do people say "here's a short and simple script" and it has a 100 lines?). the script skips comments and allows ; to be present within the querys<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">function </span><span class="default">parse_mysql_dump</span><span class="keyword">(</span><span class="default">$url</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$file_content </span><span class="keyword">= </span><span class="default">file</span><span class="keyword">(</span><span class="default">$url</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$query </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; foreach(</span><span class="default">$file_content </span><span class="keyword">as </span><span class="default">$sql_line</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp;&nbsp; if(</span><span class="default">trim</span><span class="keyword">(</span><span class="default">$sql_line</span><span class="keyword">) != </span><span class="string">"" </span><span class="keyword">&amp;&amp; </span><span class="default">strpos</span><span class="keyword">(</span><span class="default">$sql_line</span><span class="keyword">, </span><span class="string">"--"</span><span class="keyword">) === </span><span class="default">false</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$query </span><span class="keyword">.= </span><span class="default">$sql_line</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">"/;[\040]*\$/"</span><span class="keyword">, </span><span class="default">$sql_line</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">)or die(</span><span class="default">mysql_error</span><span class="keyword">());<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$query </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52427""></a>
  <div class="note">
   <strong class="user">wjyong at sh163 dot net</strong>
   <a href="#52427" class="date">30-Apr-2005 04:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The following query is not valid as expected:<br />
<span class="default">&lt;?php<br />
$username </span><span class="keyword">= </span><span class="string">'dicteworld'</span><span class="keyword">;<br />
</span><span class="default">$username</span><span class="keyword">{</span><span class="default">4</span><span class="keyword">} = </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="default">$sql </span><span class="keyword">= </span><span class="string">"SELECT * FROM `user` WHERE `User` = '</span><span class="default">$username</span><span class="string">'"</span><span class="keyword">;<br />
print(</span><span class="default">$sql</span><span class="keyword">); </span><span class="comment">// Result: SELECT * FROM `user` WHERE `User` = 'dictworld'<br />
</span><span class="default">$res </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">);<br />
</span><span class="default">$row </span><span class="keyword">= </span><span class="default">mysql_fetch_array</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">);<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">);</span><span class="comment">// Result: still return Array(), supposed that the user 'dictworld' exists.<br />
</span><span class="default">?&gt;<br />
</span>Pay more attention that null string '' is equivalent to '\0',therefore SQL statement above is equivalent to SELECT * FROM `user` WHERE `User` = 'dict\0world',though printing string is right.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49375""></a>
  <div class="note">
   <strong class="user">jon at websandbox dot net</strong>
   <a href="#49375" class="date">25-Jan-2005 05:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I think it's important to note (for newbies, like me especially) that an empty result is not the same as an error:<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/* 'bar' is an empty table in the db */<br />
</span><span class="default">$rs </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"SELECT `foo` FROM `bar`"</span><span class="keyword">)<br />
if(</span><span class="default">$rs</span><span class="keyword">) {<br />
&nbsp; echo </span><span class="default">mysql_num_rows</span><span class="keyword">(</span><span class="default">$rs</span><span class="keyword">); </span><span class="comment">//outputs: 0<br />
</span><span class="keyword">}<br />
<br />
</span><span class="comment">/* malformed query /*<br />
$rs = mysql_query("SELECT `foo` FRO `bar`");<br />
if($rs) {<br />
&nbsp; echo "This will never be echoed";<br />
}<br />
?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="37870""></a>
  <div class="note">
   <strong class="user">Predrag Supurovic</strong>
   <a href="#37870" class="date">30-Nov-2003 04:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you need to execute sevaral SQL commands in a row (usually called batcg SQL) using PHP you canot use mysql_query() since it can execute single command only.<br />
<br />
Here is simple but effective function that can run batch SQL commands. Take cere, if string contains semicolon (;) anywhere except as command delimiter (within string expression for example) function will not work.<br />
<br />
function mysql_exec_batch ($p_query, $p_transaction_safe = true) {<br />
&nbsp; if ($p_transaction_safe) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; $p_query = 'START TRANSACTION;' . $p_query . '; COMMIT;';<br />
&nbsp;&nbsp;&nbsp; };<br />
&nbsp; $query_split = preg_split ("/[;]+/", $p_query);<br />
&nbsp; foreach ($query_split as $command_line) {<br />
&nbsp;&nbsp;&nbsp; $command_line = trim($command_line);<br />
&nbsp;&nbsp;&nbsp; if ($command_line != '') {<br />
&nbsp;&nbsp; &nbsp;&nbsp; $query_result = mysql_query($command_line);<br />
&nbsp;&nbsp; &nbsp;&nbsp; if ($query_result == 0) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp;&nbsp; };<br />
&nbsp;&nbsp;&nbsp; };<br />
&nbsp; };<br />
&nbsp; return $query_result;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31707""></a>
  <div class="note">
   <strong class="user">chris at hotmail dot com</strong>
   <a href="#31707" class="date">30-Apr-2003 06:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Windows programmers, keep in mind that although table names in Windows queries are not case sensitive, many *NIX versions of Mysql require the correct table name case (perhaps others as well). So you're better off using the right case from the beginning, in case you ever decide to go with a *NIX server.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31381""></a>
  <div class="note">
   <strong class="user">davidc at edeca dot net</strong>
   <a href="#31381" class="date">19-Apr-2003 12:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Regarding the idea for returning all possible values of an enum field, the mySQL manual says that "SHOW COLUMNS FROM table LIKE column" should be used to do this.<br />
<br />
The function below (presumes db connection) will return an array of the possible values of an enum.<br />
<br />
function GetEnumValues($Table,$Column)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp; $dbSQL = "SHOW COLUMNS FROM ".$Table." LIKE '".$Column."'";<br />
&nbsp;&nbsp;&nbsp; $dbQuery = mysql_query($dbSQL);<br />
<br />
&nbsp;&nbsp;&nbsp; $dbRow = mysql_fetch_assoc($dbQuery);<br />
&nbsp;&nbsp;&nbsp; $EnumValues = $dbRow["Type"];<br />
<br />
&nbsp;&nbsp;&nbsp; $EnumValues = substr($EnumValues, 6, strlen($EnumValues)-8); <br />
&nbsp;&nbsp;&nbsp; $EnumValues = str_replace("','",",",$EnumValues);<br />
<br />
&nbsp;&nbsp;&nbsp; return explode(",",$EnumValues);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
Cavaets:<br />
<br />
1) If the LIKE matches more than one column you get the enum from the first, so be careful with the $Column argument<br />
2) You can't have ',' as part of one of the enums (I guess mySQL would escape this, but I haven't tried)<br />
3) If the field isn't an enum you'll get garbage back!<br />
<br />
This is just a quick example to show how to do it, some tidying up needs to be done (ie checking if the field is actually an enum) before it is perfect.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31078""></a>
  <div class="note">
   
   <a href="#31078" class="date">09-Apr-2003 12:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Until this function prohibits them, watch out for SQL comments (--) in your input.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="30783""></a>
  <div class="note">
   <strong class="user">allen a brooker gb net</strong>
   <a href="#30783" class="date">28-Mar-2003 05:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
One way to reduce the dangers of queries like the dlete command above that dletes the whole DB is to use limits wherever possible. <br />
<br />
EG. If you have a routine that is only deisnged to delete 1 record, add 'LIMIT 1' to the end of the command. This way you'll only lose one record if someone does something stupid.<br />
<br />
You should also check all input, especially if it is sent using GET. ie. make sure that $_GET['id'] is not NULL or == "", is a number that is positive, not 0 (generally, I know this doesn't apply to some table types, but it applies to the default) and is within the valid range for that field.<br />
<br />
Just don't trust ANY data that is sent to your script.<br />
<br />
HTH<br />
Allen</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="2984""></a>
  <div class="note">
   <strong class="user">nikhil-php at nols dot com</strong>
   <a href="#2984" class="date">02-Jan-2000 12:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When trying to INSERT or UPDATE and trying to put a large amount of text or data (blob) into a mysql table you might run into problems.
<br />

<br />
In mysql.err you might see:
<br />
Packet too large (73904)
<br />

<br />
To fix you just have to start up mysql with the option -O max_allowed_packet=maxsize 
<br />

<br />
You would just replace maxsize with the max size you want to insert, the default is 65536</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
