<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>Perform a regular expression search and replace using callbacks</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.preg-quote.html">? preg_quote</a></li>
      <li style="float: right;"><a href="function.preg-replace-callback.html">preg_replace_callback ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.pcre.html">PCRE 函数</a></li>
    <li>Perform a regular expression search and replace using callbacks</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.preg-replace-callback-array" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">preg_replace_callback_array</h1>
  <p class="verinfo">(PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">preg_replace_callback_array</span> &mdash; <span class="dc-title">Perform a regular expression search and replace using callbacks</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.preg-replace-callback-array-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>preg_replace_callback_array</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">array</span> <code class="parameter">$pattern</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type"><span class="type">string</span>|<span class="type">array</span></span> <code class="parameter">$subject</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$limit</code><span class="initializer"> = -1</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter reference">&$count</code><span class="initializer"> = <strong><code>null</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code><span class="initializer"> = 0</span></span><br>): <span class="type"><span class="type">string</span>|<span class="type">array</span>|<span class="type">null</span></span></div>

  <p class="para rdfs-comment">
   The behavior of this function is similar to
   <span class="function"><a href="function.preg-replace-callback.html" class="function">preg_replace_callback()</a></span>, except that callbacks are
   executed on a per-pattern basis.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.preg-replace-callback-array-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">pattern</code></dt>

     <dd>

      <p class="para">
       An associative array mapping patterns (keys) to <span class="type"><a href="language.types.callable.html" class="type callable">callable</a></span>s (values).
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">subject</code></dt>

     <dd>

      <p class="para">
       The string or an array with strings to search and replace.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">limit</code></dt>

     <dd>

      <p class="para">
       The maximum possible replacements for each pattern in each
       <code class="parameter">subject</code> string. Defaults to
       <code class="literal">-1</code> (no limit).
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">count</code></dt>

     <dd>

      <p class="para">
       If specified, this variable will be filled with the number of
       replacements done.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">flags</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">flags</code> can be a combination of the
       <strong><code>PREG_OFFSET_CAPTURE</code></strong> and
       <strong><code>PREG_UNMATCHED_AS_NULL</code></strong> flags, which influence the
       format of the matches array.
       See the description in <span class="function"><a href="function.preg-match.html" class="function">preg_match()</a></span> for more details.
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.preg-replace-callback-array-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   <span class="function"><strong>preg_replace_callback_array()</strong></span> returns an array if the
   <code class="parameter">subject</code> parameter is an array, or a string
   otherwise. On errors the return value is <strong><code>null</code></strong>
  </p>
  <p class="para">
   If matches are found, the new subject will be returned, otherwise
   <code class="parameter">subject</code> will be returned unchanged. 
  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-function.preg-replace-callback-array-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
如果传递的正则表达式无法正常解析，会发出 <strong><code>E_WARNING</code></strong>。 
</p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.preg-replace-callback-array-changelog">
  <h3 class="title">更新日志</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>版本</th>
       <th>说明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>7.4.0</td>
       <td>
        The <code class="parameter">flags</code> parameter was added.
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.preg-replace-callback-array-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="">
    <p><strong>Example #1 <span class="function"><strong>preg_replace_callback_array()</strong></span> example</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$subject </span><span style="color: #007700">= </span><span style="color: #DD0000">'Aaaaaa Bbb'</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">preg_replace_callback_array</span><span style="color: #007700">(<br />    [<br />        </span><span style="color: #DD0000">'~[a]+~i' </span><span style="color: #007700">=&gt; function (</span><span style="color: #0000BB">$match</span><span style="color: #007700">) {<br />            echo </span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$match</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]), </span><span style="color: #DD0000">' matches for "a" found'</span><span style="color: #007700">, </span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br />        },<br />        </span><span style="color: #DD0000">'~[b]+~i' </span><span style="color: #007700">=&gt; function (</span><span style="color: #0000BB">$match</span><span style="color: #007700">) {<br />            echo </span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$match</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]), </span><span style="color: #DD0000">' matches for "b" found'</span><span style="color: #007700">, </span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br />        }<br />    ],<br />    </span><span style="color: #0000BB">$subject<br /></span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上示例会输出：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
6 matches for &quot;a&quot; found
3 matches for &quot;b&quot; found
</pre></div>
    </div>
   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.preg-replace-callback-array-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><a href="pcre.pattern.html" class="link">PCRE Patterns</a></li>
    <li class="member"><span class="function"><a href="function.preg-replace-callback.html" class="function" rel="rdfs-seeAlso">preg_replace_callback()</a> - 执行一个正则表达式搜索并且使用一个回调进行替换</span></li>
    <li class="member"><span class="function"><a href="function.preg-quote.html" class="function" rel="rdfs-seeAlso">preg_quote()</a> - 转义正则表达式字符</span></li>
    <li class="member"><span class="function"><a href="function.preg-replace.html" class="function" rel="rdfs-seeAlso">preg_replace()</a> - 执行一个正则表达式的搜索和替换</span></li>
    <li class="member"><span class="function"><a href="function.preg-last-error.html" class="function" rel="rdfs-seeAlso">preg_last_error()</a> - 返回最后一个PCRE正则执行产生的错误代码</span></li>
    <li class="member"><a href="functions.anonymous.html" class="link">Anonymous functions</a></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="122311""></a>
  <div class="note">
   <strong class="user">Sz.</strong>
   <a href="#122311" class="date">25-Jan-2018 05:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Based on some tests, I found these important traits of the function. (These would<br />
be nice to see documented as part of its spec, e.g. for confirmation. Without that,<br />
this is just experimental curiosity. Still better than guesswork, though! ;) )<br />
<br />
1. Changes cascade over a subject across callbacks, i.e. a change made to a<br />
&nbsp;&nbsp; subject by a callback will be seen by the next callback, if its pattern matches<br />
&nbsp;&nbsp; the changed subject.<br />
&nbsp;&nbsp; (But a change made by a previous call of the *same* callback (on any subject)<br />
&nbsp;&nbsp; will not be seen by that callback again.)<br />
<br />
2. The pattern + callback pairs will be applied in the order of their appearance<br />
&nbsp;&nbsp; in $patterns_and_callbacks.<br />
<br />
3. The callback can't be null (or '') for a quick shortcut for empty replacements.<br />
<br />
4. Overall, the algorithm starts iterating over $patterns_and_callbacks, and then<br />
&nbsp;&nbsp; feeds each $subject to the current callback, repeatedly for every single match<br />
&nbsp;&nbsp; of its pattern on the current subject (unlike "preg_match_all", that is, which<br />
&nbsp;&nbsp; can do the same in one go, returning the accumulated results in an array).<br />
<br />
&nbsp;&nbsp; This basically means that the "crown jewel", an even more efficient function:<br />
&nbsp;&nbsp; "preg_replace_all_callback_array" is still missing from the collection.<br />
<br />
&nbsp;&nbsp; (Of course, that would better fit a new design of the regex API, where one<br />
&nbsp;&nbsp; API could flexibly handle various different modes via some $flags = [] array.)<br />
<br />
5. (This last one is not specific to this function, but inherent to regexes, OTOH,<br />
&nbsp;&nbsp; it's probably more relevant here than anywhere else in PHP's regex support.)<br />
<br />
&nbsp;&nbsp; Even apparently simple cases can generate a crazy (and difficult-to-predict)<br />
&nbsp;&nbsp; number of matches, and therefore callback invokations, so remember the set<br />
&nbsp;&nbsp; $limit, where affordable. But, of course, try to sharpen your patterns first!<br />
<br />
&nbsp;&nbsp; E.g. use ^...$ anchoring to avoid unintended extra calls on matching substrings<br />
&nbsp;&nbsp; of a subject, (I.e. '/.*/', without anchoring, would match twice: once for the<br />
&nbsp;&nbsp; whole subject, and then for a trailing empty substring -- but I'm not quite sure<br />
&nbsp;&nbsp; this should actually be correct behavior, though.)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118563""></a>
  <div class="note">
   <strong class="user">jfcherng at NOSPAM dot gmail dot com</strong>
   <a href="#118563" class="date">29-Dec-2015 06:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's a possible alternative in older PHP.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">// if (!function_exists('preg_replace_callback_array')) {<br />
<br />
</span><span class="keyword">function </span><span class="default">preg_replace_callback_array </span><span class="keyword">(array </span><span class="default">$patterns_and_callbacks</span><span class="keyword">, </span><span class="default">$subject</span><span class="keyword">, </span><span class="default">$limit</span><span class="keyword">=-</span><span class="default">1</span><span class="keyword">, &amp;</span><span class="default">$count</span><span class="keyword">=</span><span class="default">NULL</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$count </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$patterns_and_callbacks </span><span class="keyword">as </span><span class="default">$pattern </span><span class="keyword">=&gt; &amp;</span><span class="default">$callback</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$subject </span><span class="keyword">= </span><span class="default">preg_replace_callback</span><span class="keyword">(</span><span class="default">$pattern</span><span class="keyword">, </span><span class="default">$callback</span><span class="keyword">, </span><span class="default">$subject</span><span class="keyword">, </span><span class="default">$limit</span><span class="keyword">, </span><span class="default">$partial_count</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$count </span><span class="keyword">+= </span><span class="default">$partial_count</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">preg_last_error</span><span class="keyword">() == </span><span class="default">PREG_NO_ERROR </span><span class="keyword">? </span><span class="default">$subject </span><span class="keyword">: </span><span class="default">NULL</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">// }<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118455""></a>
  <div class="note">
   <strong class="user">drevilkuko at gmail dot com</strong>
   <a href="#118455" class="date">09-Dec-2015 12:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
finally!!!<br />
<br />
before (&lt;=php5.6):<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $htmlString </span><span class="keyword">= </span><span class="default">preg_replace_callback</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'/(href="?)(\S+)("?)/i'</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; function (&amp;</span><span class="default">$matches</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] . </span><span class="default">urldecode</span><span class="keyword">(</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]) . </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; },<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$htmlString<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$htmlString </span><span class="keyword">= </span><span class="default">preg_replace_callback</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'/(href="?\S+)(%24)(\S+)?"?/i'</span><span class="keyword">, </span><span class="comment">// %24 = $<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">function (&amp;</span><span class="default">$matches</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">urldecode</span><span class="keyword">(</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] . </span><span class="string">'$' </span><span class="keyword">. </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; },<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$htmlString<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
php7<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $htmlString </span><span class="keyword">= </span><span class="default">preg_replace_callback_array</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; [<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'/(href="?)(\S+)("?)/i' </span><span class="keyword">=&gt; function (&amp;</span><span class="default">$matches</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] . </span><span class="default">urldecode</span><span class="keyword">(</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]) . </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; },<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'/(href="?\S+)(%24)(\S+)?"?/i' </span><span class="keyword">=&gt; function (&amp;</span><span class="default">$matches</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">urldecode</span><span class="keyword">(</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] . </span><span class="string">'$' </span><span class="keyword">. </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ],<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$htmlString<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
