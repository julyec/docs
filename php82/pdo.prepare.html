<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>预处理要执行的语句，并返回语句对象</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="pdo.lastinsertid.html">? PDO::lastInsertId</a></li>
      <li style="float: right;"><a href="pdo.query.html">PDO::query ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="class.pdo.html">PDO</a></li>
    <li>预处理要执行的语句，并返回语句对象</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="pdo.prepare" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">PDO::prepare</h1>
  <p class="verinfo">(PHP 5 &gt;= 5.1.0, PHP 7, PHP 8, PHP 8,PECL pdo &gt;= 0.1.0)</p><p class="refpurpose"><span class="refname">PDO::prepare</span> &mdash; <span class="dc-title">
    预处理要执行的语句，并返回语句对象
  </span></p>

 </div>
 <div class="refsect1 description" id="refsect1-pdo.prepare-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="methodname"><strong>PDO::prepare</strong></span>(<span class="methodparam"><span class="type">string</span> <code class="parameter">$query</code></span>, <span class="methodparam"><span class="type">array</span> <code class="parameter">$options</code><span class="initializer"> = []</span></span>): <span class="type"><span class="type"><a href="class.pdostatement.html" class="type PDOStatement">PDOStatement</a></span>|<span class="type"><span class="type false">false</span></span></span></div>


  <p class="para rdfs-comment">
   为 <span class="methodname"><a href="pdostatement.execute.html" class="methodname">PDOStatement::execute()</a></span> 方法预处理待执行的 SQL 语句。
   语句模板可以包含零个或多个参数占位标记，格式是命名（:name）或问号（?）的形式，当它执行时将用真实数据取代。
   
   在同一个语句模板里，命名形式和问号形式不能同时使用；只能选择其中一种参数形式。
   请用参数形式绑定用户输入的数据，不要直接字符串拼接到查询里。
  </p>
  <p class="para">
   调用 <span class="methodname"><a href="pdostatement.execute.html" class="methodname">PDOStatement::execute()</a></span> 时，每一个值的参数占位标记，名称必须唯一。
   除非启用模拟（emulation）模式，同一个语句里无法使用重名的参数。
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
     参数占位符仅能字面上展示完整的数据。不能是字面的一部分，不能是关键词，不能是标识符，不能是其他任意的范围。
     举例说明：不能把多个值绑到单个参数里，然后在 SQL 语句里用 IN() 查询。
   </p>
  </p></blockquote>
  <p class="para">
    如果用不同参数，通过 <span class="methodname"><strong>PDO::prepare()</strong></span> 和 <span class="methodname"><a href="pdostatement.execute.html" class="methodname">PDOStatement::execute()</a></span>
   多次调用同一个 SQL 语句，将提升应用的性能 &mdash;&mdash; 驱动可以让客户端/服务器缓存查询和元信息。
   同时，调用 <span class="methodname"><strong>PDO::prepare()</strong></span> 和
   <span class="methodname"><a href="pdostatement.execute.html" class="methodname">PDOStatement::execute()</a></span> 还能阻止 SQL 注入攻击，不需要给参数手动加引号与转义。
  </p>
  <p class="para">
    如果内置驱动不支持参数，PDO 将模拟出参数的功能；如果驱动仅仅支持其中一种风格（命名参数和问号参数两种），也会自动重写到另外一种风格。
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <span class="simpara">
    The parser used for emulated prepared statements and for
    rewriting named or question mark style parameters supports the non standard
    backslash escapes for single- and double quotes. That means that terminating
    quotes immediately preceeded by a backslash are not recognized as such, which
    may result in wrong detection of parameters causing the prepared statement to
    fail when it is executed. A work-around is to not use emulated prepares for
    such SQL queries, and to avoid rewriting of parameters by using a parameter style
    which is natively supported by the driver.
   </span>
  </p></blockquote>
  <p class="para">
    自 PHP 7.4.0 起，可以通过两个问号来转义问号。这意味着 <code class="literal">??</code> 在发送查询到数据库时会转换成 <code class="literal">?</code>。
  </p>
 </div>

 <div class="refsect1 parameters" id="refsect1-pdo.prepare-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">query</code></dt>

     <dd>

      <p class="para">
        必须是对目标数据库服务器有效的 SQL 语句模板。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">options</code></dt>

     <dd>

      <p class="para">
        数组包含一个或多个 key=&gt;value 键值对，为返回的 PDOStatement 对象设置属性。
       常见用法是：设置 <code class="literal">PDO::ATTR_CURSOR</code> 为 <code class="literal">PDO::CURSOR_SCROLL</code>，将得到可滚动的光标。
       某些驱动有驱动级的选项，在 prepare 时就设置。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-pdo.prepare-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   如果数据库服务器已经成功预处理语句，<span class="methodname"><strong>PDO::prepare()</strong></span> 返回 <span class="classname"><a href="class.pdostatement.html" class="classname">PDOStatement</a></span> 对象。
   如果数据库服务器无法预处理语句，<span class="methodname"><strong>PDO::prepare()</strong></span> 返回 <strong><code>false</code></strong> 或抛出
   <span class="classname"><a href="class.pdoexception.html" class="classname">PDOException</a></span> (取决于 <a href="pdo.error-handling.html" class="link">错误处理</a>)。
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    模拟模式下的预处理语句不会和数据库服务器交互，所以 <span class="methodname"><strong>PDO::prepare()</strong></span> 不会检查语句。
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 errors" id="refsect1-pdo.prepare-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
如果属性 <strong><code>PDO::ATTR_ERRMODE</code></strong> 设置为 <strong><code>PDO::ERRMODE_WARNING</code></strong>，则发出级别为 <strong><code>E_WARNING</code></strong> 的错误。
</p>
<p class="para">
如果属性 <strong><code>PDO::ATTR_ERRMODE</code></strong> 设置为 <strong><code>PDO::ERRMODE_EXCEPTION</code></strong>，则抛出 <span class="classname"><a href="class.pdoexception.html" class="classname">PDOException</a></span>。
</p>
 </div>


 <div class="refsect1 examples" id="refsect1-pdo.prepare-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="example-2102"><p><strong>Example #1 命名参数形式的 SQL 语句模板</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/* 传入数组的值，并执行已预处理的语句 */<br /></span><span style="color: #0000BB">$sql </span><span style="color: #007700">= </span><span style="color: #DD0000">'SELECT name, colour, calories<br />    FROM fruit<br />    WHERE calories &lt; :calories AND colour = :colour'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$sth </span><span style="color: #007700">= </span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">, [</span><span style="color: #0000BB">PDO</span><span style="color: #007700">::</span><span style="color: #0000BB">ATTR_CURSOR </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">PDO</span><span style="color: #007700">::</span><span style="color: #0000BB">CURSOR_FWDONLY</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">([</span><span style="color: #DD0000">'calories' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">150</span><span style="color: #007700">, </span><span style="color: #DD0000">'colour' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'red'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">$red </span><span style="color: #007700">= </span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetchAll</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">/* Array keys can be prefixed with colons ":" too (optional) */<br /></span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">([</span><span style="color: #DD0000">':calories' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">175</span><span style="color: #007700">, </span><span style="color: #DD0000">':colour' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'yellow'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">$yellow </span><span style="color: #007700">= </span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetchAll</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
   <div class="example" id="example-2104">
    <p><strong>Example #2 问号形式的 SQL 语句模板</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/* 传入数组的值，并执行已预处理的语句 */<br /></span><span style="color: #0000BB">$sth </span><span style="color: #007700">= </span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">'SELECT name, colour, calories<br />    FROM fruit<br />    WHERE calories &lt; ? AND colour = ?'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">([</span><span style="color: #0000BB">150</span><span style="color: #007700">, </span><span style="color: #DD0000">'red'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">$red </span><span style="color: #007700">= </span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetchAll</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">([</span><span style="color: #0000BB">175</span><span style="color: #007700">, </span><span style="color: #DD0000">'yellow'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">$yellow </span><span style="color: #007700">= </span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetchAll</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
   <div class="example" id="example-2106">
    <p><strong>Example #3 问号转义的 SQL 语句模板</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/* note: this is only valid on PostgreSQL databases */<br /></span><span style="color: #0000BB">$sth </span><span style="color: #007700">= </span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">'SELECT * FROM issues WHERE tag::jsonb ?? ?'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">([</span><span style="color: #DD0000">'feature'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">$featureIssues </span><span style="color: #007700">= </span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetchAll</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">([</span><span style="color: #DD0000">'performance'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">$performanceIssues </span><span style="color: #007700">= </span><span style="color: #0000BB">$sth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetchAll</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-pdo.prepare-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="methodname"><a href="pdo.exec.html" class="methodname" rel="rdfs-seeAlso">PDO::exec()</a> - 执行 SQL 语句，并返回受影响的行数</span></li>
    <li class="member"><span class="methodname"><a href="pdo.query.html" class="methodname" rel="rdfs-seeAlso">PDO::query()</a> - 预处理并执行没有占位符的 SQL 语句</span></li>
    <li class="member"><span class="methodname"><a href="pdostatement.execute.html" class="methodname" rel="rdfs-seeAlso">PDOStatement::execute()</a> - 执行预处理语句</span></li>
   </ul>
  </p>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="128138""></a>
  <div class="note">
   <strong class="user">theking2 at king dot ma</strong>
   <a href="#128138" class="date">21-Jan-2023 01:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There are restrictions on the placeholder string. In the following code the first execute fails with a SQLSTATE[HY093]. It is not clear exactly what characters are allowed.<br />
<br />
<span class="default">&lt;?php </span><span class="keyword">declare(</span><span class="default">strict_types</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">);<br />
<br />
</span><span class="default">$db </span><span class="keyword">= new </span><span class="default">\PDO</span><span class="keyword">(</span><span class="string">"mysql:hostname=localhost;dbname=minidwh"</span><span class="keyword">, </span><span class="string">"minidwh"</span><span class="keyword">, </span><span class="string">"Meisterstueck!"</span><span class="keyword">);<br />
</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"SET NAMES 'utf8mb4'"</span><span class="keyword">);<br />
<br />
</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"DROP TABLE IF EXISTS `????ü?`"</span><span class="keyword">);<br />
</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"CREATE TABLE `????ü?` ( `id` INT NOT NULL AUTO_INCREMENT, PRIMARY KEY (`id`) ) ENGINE = ARIA;"</span><span class="keyword">);<br />
</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"ALTER TABLE `????ü?` ADD COLUMN `????ü?` TEXT NULL"</span><span class="keyword">);<br />
try {<br />
&nbsp; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"INSERT INTO `????ü?` (`????ü?`) VALUES (:????ü?)"</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">([</span><span class="string">':????ü?' </span><span class="keyword">=&gt; </span><span class="string">'test1'</span><span class="keyword">]);<br />
} catch (</span><span class="default">\PDOException $e</span><span class="keyword">) {<br />
&nbsp; echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">'&lt;BR&gt;'</span><span class="keyword">;<br />
}<br />
<br />
try {<br />
&nbsp; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"INSERT INTO `????ü?` (`????ü?`) VALUES (?)"</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">([</span><span class="string">'test2'</span><span class="keyword">]);<br />
} catch (</span><span class="default">\PDOException $e</span><span class="keyword">) {<br />
&nbsp; echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">'&lt;BR&gt;'</span><span class="keyword">;<br />
}<br />
<br />
try {<br />
&nbsp; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"INSERT INTO `????ü?` (`????ü?`) VALUES (:column)"</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">([</span><span class="string">':column' </span><span class="keyword">=&gt; </span><span class="string">'test3'</span><span class="keyword">]);<br />
} catch (</span><span class="default">\PDOException $e</span><span class="keyword">) {<br />
&nbsp; echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">'&lt;BR&gt;'</span><span class="keyword">;<br />
}<br />
<br />
try {<br />
&nbsp; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"INSERT INTO `????ü?` (`????ü?`) VALUES (:column)"</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">bindValue</span><span class="keyword">(</span><span class="string">':column'</span><span class="keyword">, </span><span class="string">'test4'</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
} catch (</span><span class="default">\PDOException $e</span><span class="keyword">) {<br />
&nbsp; echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">'&lt;BR&gt;'</span><span class="keyword">;<br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121992""></a>
  <div class="note">
   <strong class="user">omidbahrami1990 at gmail dot com</strong>
   <a href="#121992" class="date">06-Dec-2017 10:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This Is A Secure Way To Sign in With pdo::prepare<br />
--------------------------------------------------------<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">secured_signin</span><span class="keyword">(</span><span class="default">$username</span><span class="keyword">,</span><span class="default">$password</span><span class="keyword">)<br />
{&nbsp; &nbsp; <br />
try <br />
{<br />
</span><span class="default">$connection </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">"mysql:host=</span><span class="default">$dbhost</span><span class="string">;dbname=</span><span class="default">$dbname</span><span class="string">"</span><span class="keyword">, </span><span class="default">$dbusername</span><span class="keyword">, </span><span class="default">$dbpassword</span><span class="keyword">);<br />
</span><span class="default">$connection</span><span class="keyword">-&gt;</span><span class="default">setAttribute</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">ATTR_ERRMODE</span><span class="keyword">, </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">ERRMODE_EXCEPTION</span><span class="keyword">);<br />
<br />
</span><span class="default">$prepared </span><span class="keyword">= </span><span class="default">$connection</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"SELECT COUNT(`username`) FROM `users` WHERE `username` = :bp_username AND `password` = :bp_password ; "</span><span class="keyword">);<br />
</span><span class="default">$prepared</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">':bp_username'</span><span class="keyword">, </span><span class="default">$username</span><span class="keyword">);<br />
</span><span class="default">$prepared</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">':bp_password'</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; <br />
</span><span class="default">$prepared</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
if (</span><span class="default">$prepared</span><span class="keyword">-&gt;</span><span class="default">fetchColumn</span><span class="keyword">() == </span><span class="default">1</span><span class="keyword">)<br />
</span><span class="default">$result</span><span class="keyword">=</span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
else <br />
</span><span class="default">$result</span><span class="keyword">=</span><span class="default">false</span><span class="keyword">;<br />
}<br />
<br />
catch(</span><span class="default">PDOException $x</span><span class="keyword">) { die(</span><span class="string">"Secured"</span><span class="keyword">); }<br />
<br />
</span><span class="default">$prepared </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
</span><span class="default">$connection </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
<br />
return </span><span class="default">$result</span><span class="keyword">;&nbsp; &nbsp; <br />
}<br />
</span><span class="comment">/*<br />
$dbhost ---&gt; DataBase IP Address<br />
$dbusername ---&gt; DataBase Username<br />
$dbpassword ---&gt; DataBase Password<br />
$dbname ---&gt; DataBase Name<br />
*/<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121379""></a>
  <div class="note">
   <strong class="user">machitgarha at outlook dot com</strong>
   <a href="#121379" class="date">14-Jul-2017 06:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hello everyone.<br />
<br />
I want to note that it doesn't matter where you are using a variable inside the query directly, that is not secure against SQL injections (unless performing a long security operation).<br />
<br />
The following example is insecure against SQL injections:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$statement </span><span class="keyword">= </span><span class="default">$databaseConnection</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"SELECT * FROM `</span><span class="default">$_POST</span><span class="keyword">[</span><span class="string">'table']` WHERE </span><span class="default">$_POST</span><span class="keyword">[</span><span class="string">'search_for']=:search"</span><span class="keyword">);<br />
</span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">":search"</span><span class="keyword">, </span><span class="default">$search</span><span class="keyword">);<br />
</span><span class="default">$search </span><span class="keyword">= </span><span class="default">18</span><span class="keyword">; </span><span class="comment">// For example<br />
</span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
If an attacker pass '1;-- ' as input named 'search_for', he is not a very bad attacker; because he didn't delete your data! In the above example, an attacker can do anything with connected database (unless you have restricted the connected user). Unfortunately, as Simon Le Pine mentioned, you cannot use prepared statements as other parts of a query; just can be used to search in indexes.<br />
<br />
Hope this helps from loosing some data.<br />
Sorry for my a bit weak English!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120969""></a>
  <div class="note">
   <strong class="user">Mark Simon</strong>
   <a href="#120969" class="date">11-Apr-2017 11:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Many students are tempted to add single quotes around string place holders in the SQL statement, since that's what they normally do around strings in SQL and PHP.<br />
<br />
I have to explain:<br />
<br />
Quotes are not part of the string &mdash; they are used to construct a string in the coding language. If you are creating a string literal in SQL or PHP, then it must indeed be quoted. If the string has already been created, and is being passed on, then additional quotes would be wrong at best, and mis-interpreted at worst.<br />
<br />
In prepared place holders, think of place holders as variables, which, whether they are strings or other values, are always written without quotes.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116859""></a>
  <div class="note">
   <strong class="user">chatelain dot cedric dot pro at gmail dot com</strong>
   <a href="#116859" class="date">11-Mar-2015 11:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
you can't use CREATE DATABASE with prepared statement.<br />
<br />
$sql = $conn-&gt;prepare("DROP DATABASE IF EXISTS :dbname ;", <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array(PDO::ATTR_CURSOR =&gt; PDO::CURSOR_FWDONLY));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $sql-&gt;execute(array(':dbname' =&gt; $dbname));<br />
<br />
This will not work.<br />
Anyone has an explanation ?</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116220""></a>
  <div class="note">
   <strong class="user">jesse dot chisholm at gmail dot com</strong>
   <a href="#116220" class="date">24-Nov-2014 04:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
@Simon Le Pine<br />
<br />
Be aware that:<br />
<br />
$search = "user";<br />
$sth = db-&gt;prepare("SELECT * FROM users WHERE $search=:email");<br />
<br />
and<br />
<br />
$search = "email";<br />
$sth = db-&gt;prepare("SELECT * FROM users WHERE $search=:email");<br />
<br />
will produce two totally different prepared statements.<br />
<br />
Doing this _will not work_:<br />
<br />
$search = "user";<br />
$sth = db-&gt;prepare("SELECT * FROM users WHERE $search=:email");<br />
$sth-&gt;execute(array(email=&gt;"yada"));<br />
$search = "email";<br />
$sth-&gt;execute(array(email=&gt;"yada@ya.da"));</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114616""></a>
  <div class="note">
   <strong class="user">bg at enativ dot com</strong>
   <a href="#114616" class="date">12-Mar-2014 03:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you run queries in a loop, don't include $pdo-&gt;prepare() inside the loop, it will save you some resources (and time).<br />
<br />
prepare statement inside loop:<br />
for($i=0; $i&lt;1000; $i++) {<br />
&nbsp;&nbsp;&nbsp; $rs = $pdo-&gt;prepare("SELECT `id` FROM `admins` WHERE `groupID` = :groupID AND `id` &lt;&gt; :id");<br />
&nbsp;&nbsp;&nbsp; $rs-&gt;execute([':groupID' =&gt; $group, ':id' =&gt; $id]);<br />
}<br />
<br />
// took 0.066626071929932 microseconds<br />
<br />
prepare statement outside loop:<br />
$rs = $pdo-&gt;prepare("SELECT `id` FROM `admins` WHERE `groupID` = :groupID AND `id` &lt;&gt; :id");<br />
for($i=0; $i&lt;1000; $i++) {<br />
&nbsp;&nbsp;&nbsp; $rs-&gt;execute([':groupID' =&gt; $group, ':id' =&gt; $id]);<br />
}<br />
<br />
// took 0.064448118209839 microseconds<br />
<br />
for 1,000 (simple) queries it took 0.002 microseconds less.<br />
not much, but it worth mention.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114251""></a>
  <div class="note">
   <strong class="user">pbakhuis</strong>
   <a href="#114251" class="date">29-Jan-2014 03:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Noteworthy in my opinion is that if you prepare a statement but do not bind a value to the markers it will insert null by default. e.g.<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/** @var PDO $db */<br />
</span><span class="default">$prep </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">'INSERT INTO item(title, link) VALUES(:title, :link)'</span><span class="keyword">);<br />
</span><span class="default">$prep</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span>Will attempt to insert null, null into the item table.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112626""></a>
  <div class="note">
   <strong class="user">php dot chaska at xoxy dot net</strong>
   <a href="#112626" class="date">05-Jul-2013 08:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that for Postgres, even though Postgres does support prepared statements, PHP's PDO driver NEVER sends the prepared statement to the Postgres server in advance of the call to PDO::execute().&nbsp; <br />
<br />
Therefore, PDO::prepare() will never throw an error for things like faulty SQL syntax.&nbsp; <br />
<br />
It also means the server will not parse and plan the SQL until the first time PDO::execute() is called, which may or may not adversely affect your optimization plans.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112277""></a>
  <div class="note">
   <strong class="user">Hayley Watson</strong>
   <a href="#112277" class="date">27-May-2013 01:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It is possible to prepare in advance several statements against a single connection. As long as that connection remains open the statements can be executed and fetched from as often as you like in any order; their "prepare-execute-fetch" steps can be interleaved in whichever way is best.<br />
<br />
So if you're likely to be using several statements often (perhaps within a loop of transactions), you may like to consider preparing all the statements you'll be using up front.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111977""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#111977" class="date">18-Apr-2013 05:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To those wondering why adding quotes to around a placeholder is wrong, and why you can't use placeholders for table or column names:<br />
<br />
There is a common misconception about how the placeholders in prepared statements work: they are not simply substituted in as (escaped) strings, and the resulting SQL executed. Instead, a DBMS asked to "prepare" a statement comes up with a complete query plan for how it would execute that query, including which tables and indexes it would use, which will be the same regardless of how you fill in the placeholders.<br />
<br />
The plan for "SELECT name FROM my_table WHERE id = :value" will be the same whatever you substitute for ":value", but the seemingly similar "SELECT name FROM :table WHERE id = :value" cannot be planned, because the DBMS has no idea what table you're actually going to select from.<br />
<br />
Even when using "emulated prepares", PDO cannot let you use placeholders anywhere, because it would have to work out what you meant: does "Select :foo From some_table" mean ":foo" is going to be a column reference, or a literal string?<br />
<br />
When your query is using a dynamic column reference, you should be explicitly white-listing the columns you know to exist on the table, e.g. using a switch statement with an exception thrown in the default: clause.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111798""></a>
  <div class="note">
   <strong class="user">Kjetil H</strong>
   <a href="#111798" class="date">28-Mar-2013 09:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note that the correct internal method signature is:<br />
<span class="default">&lt;?php </span><span class="keyword">public function </span><span class="default">prepare </span><span class="keyword">(</span><span class="default">$statement</span><span class="keyword">, </span><span class="default">$driver_options </span><span class="keyword">= array()) </span><span class="default">?&gt;</span> <br />
<br />
and NOT:<br />
<span class="default">&lt;?php </span><span class="keyword">public function </span><span class="default">prepare </span><span class="keyword">(</span><span class="default">$statement</span><span class="keyword">, array </span><span class="default">$driver_options </span><span class="keyword">= array()) </span><span class="default">?&gt;</span>.<br />
<br />
Redeclaring the method using the latter method signature throws a Stricts Standards error.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111458""></a>
  <div class="note">
   <strong class="user">Simon Le Pine</strong>
   <a href="#111458" class="date">21-Feb-2013 05:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hi All,<br />
<br />
First time posting to php.net, a little nervous.<br />
<br />
After a bunch of searching I've learned 2 things about prepared statements:<br />
1.) It fails if you enclose in a single quote (')<br />
This fails: "SELECT * FROM users WHERE email=':email'"<br />
This works: "SELECT * FROM users WHERE email=:email"<br />
2.) You cannot search with a prepared statement<br />
This fails: "SELECT * FROM users WHERE :search=:email"<br />
This succeeds: "SELECT * FROM users WHERE $search=:email"<br />
<br />
In my case I allow the user to enter their username or email, determine which they've entered and set $search to "username" or "email". As this value is not entered by the user there is no potential for SQL injection and thus safe to use as I have done.<br />
<br />
Hope that saves someone else from a lot of searching.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108481""></a>
  <div class="note">
   <strong class="user">orrd101 at gmail dot com</strong>
   <a href="#108481" class="date">30-Apr-2012 12:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Don't just automatically use prepare() for all of your queries.<br />
<br />
If you are only submitting one query, using PDO::query() with PDO::quote() is much faster (about 3x faster in my test results with MySQL).&nbsp; A prepared query is only faster if you are submitting thousands of identical queries at once (with different data).<br />
<br />
If you Google for performance comparisons you will find that this is generally consistently the case, or you can write some code and do your own comparison for your particular configuration and query scenario. But generally PDO::query() will always be faster except when submitting a large number of identical queries.&nbsp; Prepared queries do have the advantage of escaping the data for you, so you have to be sure to use quote() when using query().</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107811""></a>
  <div class="note">
   <strong class="user">public at grik dot net</strong>
   <a href="#107811" class="date">07-Mar-2012 12:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
With PDO_MYSQL you need to remember about the PDO::ATTR_EMULATE_PREPARES option.<br />
<br />
The default value is TRUE, like<br />
$dbh-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES,true); <br />
<br />
This means that no prepared statement is created with $dbh-&gt;prepare() call. With exec() call PDO replaces the placeholders with values itself and sends MySQL a generic query string.<br />
<br />
The first consequence is that the call&nbsp; $dbh-&gt;prepare('garbage');<br />
reports no error. You will get an SQL error during the $dbh-&gt;exec() call.<br />
The second one is the SQL injection risk in special cases, like using a placeholder for the table name.<br />
<br />
The reason for emulation is a poor performance of MySQL with prepared statements. Emulation works significantly faster.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99697""></a>
  <div class="note">
   <strong class="user">pascal dot buguet at laposte dot net</strong>
   <a href="#99697" class="date">31-Aug-2010 05:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PDO::CURSOR_SCROLL is ok with MSS.<br />
You must install SQL Server Driver for PHP 2.0 CTP2 : SQLSRV20.EXE<br />
and&nbsp; the native client "Microsoft SQL Server 2008 R2 Native Client" : sqlncli.msi.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96544""></a>
  <div class="note">
   <strong class="user">Robin</strong>
   <a href="#96544" class="date">04-Mar-2010 05:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Use prepared statements to ensure integrity of binary data during storage and retrieval. Escaping/quoting by f.e. sqlite_escape_string() or PDO::quote() is NOT suited for binary data - only for strings of text.<br />
<br />
A simple test verifies perfect storage and retrieval with prepared statements:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$num_values </span><span class="keyword">= </span><span class="default">10000</span><span class="keyword">;<br />
<br />
</span><span class="default">$db </span><span class="keyword">= new </span><span class="default">pdo</span><span class="keyword">( </span><span class="string">'sqlite::memory:' </span><span class="keyword">);<br />
<br />
</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">exec</span><span class="keyword">( </span><span class="string">'CREATE TABLE data (binary BLOB(512));' </span><span class="keyword">);<br />
<br />
</span><span class="comment">// generate plenty of troublesome, binary data<br />
</span><span class="keyword">for( </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$num_values</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++ )<br />
{<br />
&nbsp;&nbsp;&nbsp; for( </span><span class="default">$val </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">, </span><span class="default">$c </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$c </span><span class="keyword">&lt; </span><span class="default">512</span><span class="keyword">/</span><span class="default">16</span><span class="keyword">; </span><span class="default">$c</span><span class="keyword">++ )<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val </span><span class="keyword">.= </span><span class="default">md5</span><span class="keyword">( </span><span class="default">mt_rand</span><span class="keyword">(), </span><span class="default">true </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; @</span><span class="default">$binary</span><span class="keyword">[] = </span><span class="default">$val</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">// insert each value by prepared statement<br />
</span><span class="keyword">for( </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$num_values</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++ )<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">( </span><span class="string">'INSERT INTO data VALUES (?);' </span><span class="keyword">)-&gt;</span><span class="default">execute</span><span class="keyword">( array(</span><span class="default">$binary</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]) );<br />
<br />
</span><span class="comment">// fetch the entire row<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">( </span><span class="string">'SELECT binary FROM data;' </span><span class="keyword">)-&gt;</span><span class="default">fetchAll</span><span class="keyword">( </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">FETCH_COLUMN </span><span class="keyword">);<br />
<br />
</span><span class="comment">// compare with original array, noting any mismatch<br />
</span><span class="keyword">for( </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$num_values</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++ )<br />
&nbsp;&nbsp;&nbsp; if( </span><span class="default">$data</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] != </span><span class="default">$binary</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] ) echo </span><span class="string">"[</span><span class="default">$i</span><span class="string">] mismatch\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">$db </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="94354""></a>
  <div class="note">
   <strong class="user">sgirard at rossprint dot com</strong>
   <a href="#94354" class="date">29-Oct-2009 03:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Maybe everyone else already knows this but...<br />
<br />
If you have a routine that prepares/executes many insert or update statements for a sqlite db then you may want to make use of the pdo transactions. <br />
<br />
On some old hardware my query set went from 12 seconds to 1/3-1/2 second. <br />
<br />
-sean</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93469""></a>
  <div class="note">
   <strong class="user">richard at codevanilla.com</strong>
   <a href="#93469" class="date">11-Sep-2009 04:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
beware
<br />
PDO will emulate prepared statements/bound parameters for drivers that do not natively support them, and can also rewrite named or question mark style parameter markers to something more appropriate, if the driver supports one style but not the other.
<br />

<br />
This includes mySQL it seems so
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">try{ 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sth1 </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">db1</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="default">$t1</span><span class="keyword">, array(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">ATTR_CURSOR </span><span class="keyword">=&gt; </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">CURSOR_FWDONLY</span><span class="keyword">));
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; catch(</span><span class="default">PDOException $e</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">pack</span><span class="keyword">(</span><span class="string">'dbError'</span><span class="keyword">, </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">());
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
does not and so will not throw the exception if your SQL is wrong.
<br />

<br />
You will need to check that $sth1 is not null.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91078""></a>
  <div class="note">
   <strong class="user">daniel dot egeberg at gmail dot com</strong>
   <a href="#91078" class="date">24-May-2009 01:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can also pass an array of values to PDOStatement::execute(). This is also secured against SQL injection. You don't necessarily have to use bindParam() or bindValue().</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90209""></a>
  <div class="note">
   <strong class="user">admin at wdfa dot co dot uk</strong>
   <a href="#90209" class="date">09-Apr-2009 09:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note on the SQL injection properties of prepared statements.<br />
<br />
Prepared statements only project you from SQL injection IF you use the bindParam or bindValue option.<br />
<br />
For example if you have a table called users with two fields, username and email and someone updates their username you might run<br />
<br />
UPDATE `users` SET `user`='$var'<br />
<br />
where $var would be the user submitted text. <br />
<br />
Now if you did <br />
<span class="default">&lt;?php<br />
$a</span><span class="keyword">=new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">"mysql:host=localhost;dbname=database;"</span><span class="keyword">,</span><span class="string">"root"</span><span class="keyword">,</span><span class="string">""</span><span class="keyword">);<br />
</span><span class="default">$b</span><span class="keyword">=</span><span class="default">$a</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"UPDATE `users` SET user='</span><span class="default">$var</span><span class="string">'"</span><span class="keyword">);<br />
</span><span class="default">$b</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
and the user had entered&nbsp; User', email='test for a test the injection would occur and the email would be updated to test as well as the user being updated to User.<br />
<br />
Using bindParam as follows<br />
&nbsp;<span class="default">&lt;?php<br />
$var</span><span class="keyword">=</span><span class="string">"User', email='test"</span><span class="keyword">;<br />
</span><span class="default">$a</span><span class="keyword">=new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">"mysql:host=localhost;dbname=database;"</span><span class="keyword">,</span><span class="string">"root"</span><span class="keyword">,</span><span class="string">""</span><span class="keyword">);<br />
</span><span class="default">$b</span><span class="keyword">=</span><span class="default">$a</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"UPDATE `users` SET user=:var"</span><span class="keyword">);<br />
</span><span class="default">$b</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">":var"</span><span class="keyword">,</span><span class="default">$var</span><span class="keyword">);<br />
</span><span class="default">$b</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
The sql would be escaped and update the username to User', email='test'</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83281""></a>
  <div class="note">
   <strong class="user">ak_9jsz</strong>
   <a href="#83281" class="date">18-May-2008 10:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Using cursors doesn't work with SQLite 3.5.9. I get an error message when it gets to the execute() method.<br />
<br />
Some of you might be saying "duh!" but i was surprised to see TRIGGER support in SQLite, so i had to try. :)<br />
<br />
I wanted to use Absolute referencing on a Scrollable cursor and i only wanted one column of data. So i used this instead of a cursor.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$dbo </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">'sqlite:tdb'</span><span class="keyword">);<br />
</span><span class="default">$sql </span><span class="keyword">= </span><span class="string">'SELECT F1, F2 FROM tblA WHERE F1 &lt;&gt; "A";'</span><span class="keyword">;<br />
</span><span class="default">$res </span><span class="keyword">= </span><span class="default">$dbo</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
</span><span class="default">$res</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
</span><span class="default">$resColumn </span><span class="keyword">= </span><span class="default">$res</span><span class="keyword">-&gt;</span><span class="default">fetchAll</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">FETCH_COLUMN</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
<br />
for(</span><span class="default">$r</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$r</span><span class="keyword">&lt;=</span><span class="default">3</span><span class="keyword">;</span><span class="default">$r</span><span class="keyword">++)<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">'Row '</span><span class="keyword">. </span><span class="default">$r </span><span class="keyword">. </span><span class="string">' returned: ' </span><span class="keyword">. </span><span class="default">$resColumn</span><span class="keyword">[</span><span class="default">$r</span><span class="keyword">] . </span><span class="string">"\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">$dbo </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
</span><span class="default">$res </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74362""></a>
  <div class="note">
   <strong class="user">www.onphp5.com</strong>
   <a href="#74362" class="date">07-Apr-2007 06:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note that the statement regarding driver_options is misleading:<br />
<br />
"This array holds one or more key=&gt;value pairs to set attribute values for the PDOStatement object that this method returns. You would most commonly use this to set the PDO::ATTR_CURSOR value to PDO::CURSOR_SCROLL to request a scrollable cursor. Some drivers have driver specific options that may be set at prepare-time"<br />
<br />
From this you might think that scrollable cursors work for all databases, but they don't! Check out this bug report:<br />
<a href="http://bugs.php.net/bug.php?id=34625" rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=34625</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73421""></a>
  <div class="note">
   <strong class="user">johniskew</strong>
   <a href="#73421" class="date">22-Feb-2007 08:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you need to create variable sql statements in a prepare statement...for example you may need to construct a sql query with zero, one, two, etc numbers of arguments...here is a way to do it without a lot of if/else statements needed to glue the sql together:<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">matchCriteria</span><span class="keyword">(</span><span class="default">$field1</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">,</span><span class="default">$field2</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">,</span><span class="default">$field3</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$db</span><span class="keyword">=</span><span class="default">DB</span><span class="keyword">::</span><span class="default">conn</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql</span><span class="keyword">=array();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$paramArray</span><span class="keyword">=array();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!empty(</span><span class="default">$field1</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql</span><span class="keyword">[]=</span><span class="string">'field1=?'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$paramArray</span><span class="keyword">[]=</span><span class="default">$field1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!empty(</span><span class="default">$field2</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql</span><span class="keyword">[]=</span><span class="string">'field2=?'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$paramArray</span><span class="keyword">[]=</span><span class="default">$field2</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!empty(</span><span class="default">$field3</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql</span><span class="keyword">[]=</span><span class="string">'field3=?'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$paramArray</span><span class="keyword">[]=</span><span class="default">$field3</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$rs</span><span class="keyword">=</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">'SELECT * FROM mytable'</span><span class="keyword">.(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$paramArray</span><span class="keyword">)&gt;</span><span class="default">0 </span><span class="keyword">? </span><span class="string">' WHERE '</span><span class="keyword">.</span><span class="default">join</span><span class="keyword">(</span><span class="string">' AND '</span><span class="keyword">,</span><span class="default">$sql</span><span class="keyword">) : </span><span class="string">''</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result</span><span class="keyword">=</span><span class="default">$rs</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">(</span><span class="default">$paramArray</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$result</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$rs</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69335""></a>
  <div class="note">
   <strong class="user">william dot clarke at gmail dot com</strong>
   <a href="#69335" class="date">31-Aug-2006 03:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Surely if you want to use prepared statements that way you should use the syntax in the second example:<br />
<br />
eg. <br />
<br />
instead of:<br />
select id,name from demo_de where name LIKE :name OR name=:name <br />
<br />
use:<br />
select id,name from demo_de where name LIKE ? OR name=?<br />
<br />
I believe you are supposed to either use distinct named parameters (name, name1) OR anonymous parameters (?s)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69291""></a>
  <div class="note">
   <strong class="user">roth at egotec dot com</strong>
   <a href="#69291" class="date">30-Aug-2006 01:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Attention using MySQL and prepared statements.<br />
Using a placeholder multiple times inside a statement doesn't work. PDO just translates the first occurance und leaves the second one as is.<br />
<br />
select id,name from demo_de where name LIKE :name OR name=:name<br />
<br />
You have to use<br />
<br />
select id,name from demo_de where name LIKE :name OR name=:name2<br />
<br />
and bind name two times. I don't know if other databases (for example Oracle or MSSQL) support multiple occurances. If that's the fact, then the PDO behaviour for MySQL should be changed.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
