<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>将 PNG 图像输出到浏览器或文件</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.imagepalettetotruecolor.html">? imagepalettetotruecolor</a></li>
      <li style="float: right;"><a href="function.imagepolygon.html">imagepolygon ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.image.html">GD 和图像处理 函数</a></li>
    <li>将 PNG 图像输出到浏览器或文件</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.imagepng" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">imagepng</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">imagepng</span> &mdash; <span class="dc-title">将 PNG 图像输出到浏览器或文件</span></p>

 </div>
 <div class="refsect1 description" id="refsect1-function.imagepng-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>imagepng</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type"><a href="class.gdimage.html" class="type GdImage">GdImage</a></span> <code class="parameter">$image</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type"><span class="type">resource</span>|<span class="type">string</span>|<span class="type">null</span></span> <code class="parameter">$file</code><span class="initializer"> = <strong><code>null</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$quality</code><span class="initializer"> = -1</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$filters</code><span class="initializer"> = -1</span></span><br>): <span class="type">bool</span></div>

  <p class="para rdfs-comment">
   从指定 <code class="parameter">image</code> 输出或保存 <abbr title="Portable Network Graphics">PNG</abbr> 图像。
  </p>
 </div>

 <div class="refsect1 parameters" id="refsect1-function.imagepng-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    <dt>

<code class="parameter">image</code></dt>
<dd>
<p class="para">由图象创建函数(例如<span class="function"><a href="function.imagecreatetruecolor.html" class="function">imagecreatetruecolor()</a></span>)返回的 
<span class="classname"><a href="class.gdimage.html" class="classname">GdImage</a></span> 对象。</p></dd>

    
     <dt>
<code class="parameter">file</code></dt>

     <dd>

      <p class="para">文件保存的路径或者已打开的流资源（此方法返回后自动关闭该流资源），如果未设置或为 <strong><code>null</code></strong>，将会直接输出原始图象流。</p>
      <blockquote class="note"><p><strong class="note">Note</strong>: 
       <p class="para">
        如果未使用 <code class="parameter">quality</code> 和 <code class="parameter">filters</code> 参数，则 <strong><code>null</code></strong> 无效。
       </p>
      </p></blockquote>
     </dd>

    
    
     <dt>
<code class="parameter">quality</code></dt>

     <dd>

      <p class="para">
       压缩级别：从 0（不压缩）到 9。
       默认值（<code class="literal">-1</code>）使用 zlib 压缩默认值。
       有关详细信息，请参阅 <a href="http://www.zlib.net/manual.html" class="link external" title="Link : http://www.zlib.net/manual.html">&raquo;&nbsp;zlib 手册</a>。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">filters</code></dt>

     <dd>

      <p class="para">
       允许减小 PNG 文件的大小。它是位掩码字段，可以设置为任意 <code class="literal">PNG_FILTER_XXX</code> 常量的组合。<strong><code>PNG_NO_FILTER</code></strong>
       或 <strong><code>PNG_ALL_FILTERS</code></strong> 也可分别用于禁用或激活所有过滤器。
       默认值（<code class="literal">-1</code>）禁用过滤。
      </p>
      <div class="caution"><strong class="caution">Caution</strong>
       <p class="simpara">
        系统 libgd 忽略 <code class="parameter">filters</code> 参数。
       </p>
      </div>
     </dd>

    
   </dl>

  </p>
 </div>

 <div class="refsect1 returnvalues" id="refsect1-function.imagepng-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   成功时返回 <strong><code>true</code></strong>， 或者在失败时返回 <strong><code>false</code></strong>。
  </p>
  <div class="caution"><strong class="caution">Caution</strong><p class="simpara">如果 libgd 输出图像失败，函数会返回 <strong><code>true</code></strong>。</p></div>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.imagepng-changelog">
  <h3 class="title">更新日志</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>版本</th>
      <th>说明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
 <td>8.0.0</td>
 <td>
  <code class="parameter">image</code> 现在需要 <span class="classname"><a href="class.gdimage.html" class="classname">GdImage</a></span> 实例；之前需要有效的 <code class="literal">gd</code> <span class="type">resource</span>。
 </td>
</tr>

    </tbody>
   
  </table>

 </div>


 <div class="refsect1 examples" id="refsect1-function.imagepng-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$im </span><span style="color: #007700">= </span><span style="color: #0000BB">imagecreatefrompng</span><span style="color: #007700">(</span><span style="color: #DD0000">"test.png"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">header</span><span style="color: #007700">(</span><span style="color: #DD0000">'Content-Type: image/png'</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">imagepng</span><span style="color: #007700">(</span><span style="color: #0000BB">$im</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">imagedestroy</span><span style="color: #007700">(</span><span style="color: #0000BB">$im</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>

 <div class="refsect1 seealso" id="refsect1-function.imagepng-seealso">
  <h3 class="title">参见</h3>
  <ul class="simplelist">
   <li class="member"><span class="function"><a href="function.imagegif.html" class="function" rel="rdfs-seeAlso">imagegif()</a> - 输出图象到浏览器或文件。</span></li>
   <li class="member"><span class="function"><a href="function.imagewbmp.html" class="function" rel="rdfs-seeAlso">imagewbmp()</a> - 输出图象到浏览器或文件。</span></li>
   <li class="member"><span class="function"><a href="function.imagejpeg.html" class="function" rel="rdfs-seeAlso">imagejpeg()</a> - 输出图象到浏览器或文件。</span></li>
   <li class="member"><span class="function"><a href="function.imagetypes.html" class="function" rel="rdfs-seeAlso">imagetypes()</a> - 返回 PHP 内置支持的图像类型</span></li>
   <li class="member"><span class="function"><a href="function.imagesavealpha.html" class="function" rel="rdfs-seeAlso">imagesavealpha()</a> - 保存图像时是否保留完整的 alpha 通道信息</span></li>
  </ul>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="128421""></a>
  <div class="note">
   <strong class="user">Messerli at messerli dot net</strong>
   <a href="#128421" class="date">22-Apr-2023 03:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
// Send the Image as Base64 Data directly to the browser.<br />
// No File on the Server! No Hacker Problem. <br />
<br />
&nbsp; ob_start();<br />
&nbsp; imagepng($img);<br />
&nbsp; $ImageData=ob_get_contents();<br />
&nbsp; ob_end_clean();<br />
&nbsp; echo '&lt;img src="data:image/jpg;base64,'.base64_encode($ImageData).'"&gt;';</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120610""></a>
  <div class="note">
   <strong class="user">klaus at hax dot at</strong>
   <a href="#120610" class="date">07-Feb-2017 05:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
apparently something changed from php 5.5 to 5.6.<br />
<br />
I used to call ImagePng($image, '');<br />
apparently this doesn't work anymore in 5.6 as it returns: imagepng(): Filename cannot be empty<br />
<br />
ImagePng($image, NULL); <br />
<br />
seems to work fine though.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117819""></a>
  <div class="note">
   <strong class="user">Chris F</strong>
   <a href="#117819" class="date">14-Aug-2015 04:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was curious about the relationship between quality, processing time and resulting image size, so I created this little benchmark to test it (The image used was originally RGB_24bits_palette_R85.png, found on wikipedia). Results are at the bottom.<br />
<span class="default">&lt;?php<br />
$sizes </span><span class="keyword">= [</span><span class="string">'32'</span><span class="keyword">, </span><span class="string">'64'</span><span class="keyword">, </span><span class="string">'128'</span><span class="keyword">, </span><span class="string">'256'</span><span class="keyword">, </span><span class="string">'512'</span><span class="keyword">, </span><span class="string">'1024'</span><span class="keyword">, </span><span class="string">'2048'</span><span class="keyword">];<br />
<br />
foreach (</span><span class="default">$sizes </span><span class="keyword">as </span><span class="default">$size</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"\nSize: </span><span class="keyword">{</span><span class="default">$size</span><span class="keyword">}</span><span class="string">x</span><span class="keyword">{</span><span class="default">$size</span><span class="keyword">}</span><span class="string">px:\n"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreatefrompng</span><span class="keyword">(</span><span class="string">"images/test</span><span class="keyword">{</span><span class="default">$size</span><span class="keyword">}</span><span class="string">.png"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$quality </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$quality </span><span class="keyword">&lt; </span><span class="default">10</span><span class="keyword">; </span><span class="default">$quality</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ob_start</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$start </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">$quality</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$elapsed </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">) - </span><span class="default">$start</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$blob </span><span class="keyword">= </span><span class="default">ob_get_contents</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ob_end_clean</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$blobSize </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$blob</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"quality: </span><span class="default">$quality</span><span class="string">, size: </span><span class="default">$blobSize</span><span class="string">, elapsed: </span><span class="default">$elapsed</span><span class="string">\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">// Results (some omitted for brevity):<br />
<br />
// Size: 32x32px:<br />
// quality: 0, size: 3172, elapsed: 0.00013399124145508<br />
// quality: 1, size: 266, elapsed: 9.4890594482422E-5<br />
// quality: 2, size: 264, elapsed: 7.7009201049805E-5<br />
// quality: 3, size: 223, elapsed: 7.4863433837891E-5<br />
// quality: 4, size: 225, elapsed: 8.5830688476562E-5<br />
// quality: 5, size: 209, elapsed: 8.5115432739258E-5<br />
// quality: 6, size: 208, elapsed: 9.608268737793E-5<br />
// quality: 7, size: 205, elapsed: 0.0001060962677002<br />
// quality: 8, size: 186, elapsed: 0.00015091896057129<br />
// quality: 9, size: 181, elapsed: 0.00022006034851074<br />
<br />
// Size: 128x128px:<br />
// quality: 0, size: 49425, elapsed: 0.0010969638824463<br />
// quality: 1, size: 976, elapsed: 0.00091886520385742<br />
// quality: 2, size: 938, elapsed: 0.00088310241699219<br />
// quality: 3, size: 925, elapsed: 0.00087594985961914<br />
// quality: 4, size: 608, elapsed: 0.0009760856628418<br />
// quality: 5, size: 607, elapsed: 0.00098395347595215<br />
// quality: 6, size: 601, elapsed: 0.0010099411010742<br />
// quality: 7, size: 602, elapsed: 0.001086950302124<br />
// quality: 8, size: 521, elapsed: 0.001910924911499<br />
// quality: 9, size: 491, elapsed: 0.0029060840606689<br />
<br />
// Size: 512x512px:<br />
// quality: 0, size: 788279, elapsed: 0.012928009033203<br />
// quality: 1, size: 12467, elapsed: 0.013065099716187<br />
// quality: 2, size: 11885, elapsed: 0.013008117675781<br />
// quality: 3, size: 11190, elapsed: 0.013030052185059<br />
// quality: 4, size: 7311, elapsed: 0.016619920730591<br />
// quality: 5, size: 6994, elapsed: 0.016351222991943<br />
// quality: 6, size: 6475, elapsed: 0.016234159469604<br />
// quality: 7, size: 6432, elapsed: 0.016525983810425<br />
// quality: 8, size: 6094, elapsed: 0.022937774658203<br />
// quality: 9, size: 5649, elapsed: 0.065664052963257<br />
<br />
// Size: 2048x2048px:<br />
// quality: 0, size: 12605375, elapsed: 0.20983290672302<br />
// quality: 1, size: 451735, elapsed: 0.19678711891174<br />
// quality: 2, size: 409375, elapsed: 0.19415307044983<br />
// quality: 3, size: 366404, elapsed: 0.20460414886475<br />
// quality: 4, size: 312538, elapsed: 0.22785305976868<br />
// quality: 5, size: 281671, elapsed: 0.23320484161377<br />
// quality: 6, size: 244248, elapsed: 0.28935289382935<br />
// quality: 7, size: 238310, elapsed: 0.33481192588806<br />
// quality: 8, size: 217038, elapsed: 0.71698379516602<br />
// quality: 9, size: 208881, elapsed: 1.858146905899<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113515""></a>
  <div class="note">
   <strong class="user">php dot net at phor dot net</strong>
   <a href="#113515" class="date">23-Oct-2013 01:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are outputting a PNG directly in response to a client request it is important to check your web server configuration.<br />
<br />
Some clients may request your images with a &lt;a href="<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html" rel="nofollow" target="_blank">http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html</a>"&gt;accept header&lt;/a&gt; of image/*. Default configurations of Apache and possibly other servers will by default NOT allow your script to run in response to this request.<br />
<br />
Apache is specifically discussed at <a href="http://stackoverflow.com/q/19169337 but other server have been documented to have issue too." rel="nofollow" target="_blank">http://stackoverflow.com/q/19169337 but other server have been documented to have issue too.</a><br />
<br />
In other words, when testing your application don't just use the web browser, consider a phone's browser and networking libraries which could send different headers.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108032""></a>
  <div class="note">
   <strong class="user">geompse at gmail dot com</strong>
   <a href="#108032" class="date">23-Mar-2012 11:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be careful when using a variable for the file name.<br />
PHP behavior with $filename differs when switching to PHP5.4 : PHP5.3 will use $filename='' the same way as $filename=NULL (e.g. no warning)<br />
<span class="default">&lt;?php<br />
$im </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">,</span><span class="default">10</span><span class="keyword">);<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">,</span><span class="string">''</span><span class="keyword">,</span><span class="default">9</span><span class="keyword">); </span><span class="comment"># Warning: imagepng(): Filename cannot be empty<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">,</span><span class="default">NULL</span><span class="keyword">,</span><span class="default">9</span><span class="keyword">); </span><span class="comment"># works as expected<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="106093""></a>
  <div class="note">
   <strong class="user">matteosistisette at gmail dot com</strong>
   <a href="#106093" class="date">09-Oct-2011 12:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The name "quality" for the compression parameter is quite misleading, as png compression is always lossless. The trade off is between speed and filesize, it cannot affect quality.<br />
<br />
Here's something I found at stackoverflow; I haven't checked it, but if it is correct it should definitely included in the documentation:<br />
<br />
---<br />
from php source (gd.h):<br />
<br />
/* 2.0.12: Compression level: 0-9 or -1, where 0 is NO COMPRESSION at all,<br />
* 1 is FASTEST but produces larger files, 9 provides the best<br />
* compression (smallest files) but takes a long time to compress, and<br />
* -1 selects the default compiled into the zlib library.<br />
*/<br />
Conclusion: Based on the Zlib manual (<a href="http://www.zlib.net/manual.html" rel="nofollow" target="_blank">http://www.zlib.net/manual.html</a>) the default compression level is set to 6.<br />
---<br />
<br />
Regarding suggestions to rescale the 0-99 quality range of jpeg into the 0-9 range of png, note that for jpeg 99 is minimum compression (maximum quality) while for png 9 is maximum compression (quality doesn't change).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104913""></a>
  <div class="note">
   <strong class="user">Zane, MegaLab.it</strong>
   <a href="#104913" class="date">14-Jul-2011 11:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
My script was unable to complete: Fatal error: Allowed memory size of XX bytes exhausted (tried to allocate XX+n bytes).<br />
<br />
I found out that PHP handles images in uncompressed format: my input image was 8768x4282@32 bit =&gt; ~150 MB per single in-memory copy.<br />
<br />
As a solution, you can either check the dimensions and reject anything too big or, as I did, use ini_set('memory_limit','1024M'); on the page start (if your server has enough on board memory).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103787""></a>
  <div class="note">
   <strong class="user">boukeversteegh at gmail dot com</strong>
   <a href="#103787" class="date">03-May-2011 02:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you care about speed, you probably already cache your generated images to a file. In that case, DON'T use "createimagefrompng" and "imagepng" to output the image. Use fpassthru instead. It is literally hundreds of times faster.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; header</span><span class="keyword">(</span><span class="string">"Content-Type: image/png"</span><span class="keyword">);<br />
&nbsp; <br />
&nbsp; </span><span class="comment"># Generate cachefile for image, if it doesn't exist<br />
&nbsp; </span><span class="keyword">if( !</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$cachefile</span><span class="keyword">) ) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$im </span><span class="keyword">= </span><span class="default">generateimage</span><span class="keyword">();&nbsp; &nbsp;&nbsp; </span><span class="comment"># some code generates an image resource<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">$cachefile</span><span class="keyword">); </span><span class="comment"># store the image to cachefile<br />
<br />
&nbsp;&nbsp;&nbsp; # don't output it like this:<br />
&nbsp;&nbsp;&nbsp; /* imagepng($im);*/<br />
&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">);<br />
&nbsp; }<br />
<br />
&nbsp; </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$cachefile</span><span class="keyword">, </span><span class="string">'rb'</span><span class="keyword">); </span><span class="comment"># stream the image directly from the cachefile<br />
&nbsp; </span><span class="default">fpassthru</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp; exit;<br />
</span><span class="default">?&gt;<br />
</span><br />
I've tested it with a 5120x5120 (1.2Mb) image, that was cached on the harddisk. Using imagepng, the transfer took 12 seconds. Using fpassthru, it took only 32ms!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102944""></a>
  <div class="note">
   <strong class="user">codam</strong>
   <a href="#102944" class="date">15-Mar-2011 10:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Creating a transparent image filled with tranparent color only
<br />

<br />
I had some hard times putting up this one:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="comment">// Set the image
<br />
</span><span class="default">$img </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">100</span><span class="keyword">,</span><span class="default">100</span><span class="keyword">);
<br />
</span><span class="default">imagesavealpha</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);
<br />

<br />
</span><span class="comment">// Fill the image with transparent color
<br />
</span><span class="default">$color </span><span class="keyword">= </span><span class="default">imagecolorallocatealpha</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">,</span><span class="default">0x00</span><span class="keyword">,</span><span class="default">0x00</span><span class="keyword">,</span><span class="default">0x00</span><span class="keyword">,</span><span class="default">127</span><span class="keyword">);
<br />
</span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$color</span><span class="keyword">);
<br />

<br />
</span><span class="comment">// Save the image to file.png
<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="string">"file.png"</span><span class="keyword">);
<br />

<br />
</span><span class="comment">// Destroy image
<br />
</span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100577""></a>
  <div class="note">
   <strong class="user">mhorne69 at gmail dot com</strong>
   <a href="#100577" class="date">24-Oct-2010 07:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you're generating an image dynamically based on post data and don't want to save it to the server, sending it to be displayed can cause problems as when the person tries to save it, the browser will request it again from the server (causing any post data to be lost and probably a corrupted png).
<br />

<br />
The easiest way to get around this is to force it to download using the content disposition header, for example:
<br />

<br />
<span class="default">&lt;?php
<br />
header</span><span class="keyword">(</span><span class="string">'Content-Disposition: Attachment;filename=image.png'</span><span class="keyword">);
<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">'Content-type: image/png'</span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99733""></a>
  <div class="note">
   <strong class="user">anonymous</strong>
   <a href="#99733" class="date">01-Sep-2010 12:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you need to call imagepng() multiple times (for example, when you want to send it to the browser, but also to a disk cache), write your image to a file first, THEN call readfile() on it.<br />
<br />
PHP internally works with a temporary file when sending the image to the browser, so you'll gain nothing by calling imagepng() twice.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97032""></a>
  <div class="note">
   <strong class="user">wietse89 at gmail dot com</strong>
   <a href="#97032" class="date">29-Mar-2010 06:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When you allow multiple output formats, (jpg/png) but want to use the 1-100 quality scale (like jpg), you will have to format the number:<br />
<br />
<span class="default">&lt;?php<br />
$pngQuality </span><span class="keyword">= (</span><span class="default">$quality </span><span class="keyword">- </span><span class="default">100</span><span class="keyword">) / </span><span class="default">11.111111</span><span class="keyword">;<br />
</span><span class="default">$pngQuality </span><span class="keyword">= </span><span class="default">round</span><span class="keyword">(</span><span class="default">abs</span><span class="keyword">(</span><span class="default">$pngQuality</span><span class="keyword">));<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$resource</span><span class="keyword">, </span><span class="default">$path</span><span class="keyword">, </span><span class="default">$pngQuality</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96303""></a>
  <div class="note">
   <strong class="user">r.lomas at infonie.fr</strong>
   <a href="#96303" class="date">19-Feb-2010 07:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I just lost about 4 hours on a really stupid problem. My images on the local server were somehow broken and therefore did not display in the browsers. After much looking around and testing, including re-installing apache on my computer a couple of times, I traced the problem to an included file. <br />
No the problem was not a whitespace, but the UTF BOM encoding character at the begining of one of my inluded files...<br />
So beware of your included files!<br />
Make sure they are not encoded in UTF or otherwise in UTF without BOM.<br />
Hope it save someone's time.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90760""></a>
  <div class="note">
   <strong class="user">thalis kalfigopoulos</strong>
   <a href="#90760" class="date">08-May-2009 04:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I ran across the following WRT sessions and image creation.<br />
<br />
In main.php:<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">(...</span><span class="default">session in progress</span><span class="keyword">...)<br />
&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'text'</span><span class="keyword">]=</span><span class="string">'some text...'</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$imgSrc</span><span class="keyword">=</span><span class="string">'<a href="http://foo.com/createImage.php?sid=" rel="nofollow" target="_blank">http://foo.com/createImage.php?sid=</a>'</span><span class="keyword">.</span><span class="default">session_id</span><span class="keyword">();<br />
&nbsp; echo(</span><span class="string">'&lt;img src="'</span><span class="keyword">.</span><span class="default">$imgSrc</span><span class="keyword">.</span><span class="string">'"/&gt;'</span><span class="keyword">);<br />
&nbsp; unset(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'text'</span><span class="keyword">]);<br />
...<br />
</span><span class="default">?&gt;<br />
</span><br />
In createImage.php:<br />
<span class="default">&lt;?php<br />
&nbsp; header</span><span class="keyword">(</span><span class="string">'image/png'</span><span class="keyword">);<br />
&nbsp; </span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$_REQUEST</span><span class="keyword">[</span><span class="string">'sid'</span><span class="keyword">]);<br />
&nbsp; </span><span class="default">session_start</span><span class="keyword">();<br />
&nbsp; </span><span class="default">$img</span><span class="keyword">=</span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">200</span><span class="keyword">, </span><span class="default">30</span><span class="keyword">);&nbsp; <br />
&nbsp; </span><span class="default">$text_color</span><span class="keyword">=</span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">200</span><span class="keyword">, </span><span class="default">200</span><span class="keyword">, </span><span class="default">200</span><span class="keyword">);<br />
&nbsp; </span><span class="default">imagestring</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">5</span><span class="keyword">, </span><span class="default">5</span><span class="keyword">, </span><span class="default">5</span><span class="keyword">,&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'text'</span><span class="keyword">], </span><span class="default">$text_color</span><span class="keyword">);<br />
&nbsp; </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">);<br />
&nbsp; </span><span class="default">imagedestroy</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Problem: main.php execution ends before createImage.php writing the text to image, thus the unset($_SESSION['text']) destroys the text and you end up with empty image.<br />
Solution: move call to unset() as last statement of createImage.php</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89609""></a>
  <div class="note">
   <strong class="user">matt at mattbostock dot com</strong>
   <a href="#89609" class="date">16-Mar-2009 12:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To change the background of a 24-bit PNG for graceful degradation in IE6, the PNG file needs a bKGD chunk:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// insert a BKGD chunk into the PNG file for graceful image degradation in IE6<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bgColor </span><span class="keyword">= array(</span><span class="default">250</span><span class="keyword">, </span><span class="default">250</span><span class="keyword">, </span><span class="default">250</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pngData </span><span class="keyword">= </span><span class="default">bin2hex</span><span class="keyword">(</span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$idatMarker </span><span class="keyword">= </span><span class="string">'200049444154'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bkgdMarker </span><span class="keyword">= </span><span class="string">'624b4744'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bkgdChunk </span><span class="keyword">= </span><span class="string">'0006' </span><span class="keyword">. </span><span class="default">$bkgdMarker</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$bgColor </span><span class="keyword">as </span><span class="default">$bit</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bkgdChunkData </span><span class="keyword">.= </span><span class="string">'00' </span><span class="keyword">. </span><span class="default">dechex</span><span class="keyword">(</span><span class="default">$bit</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bkgdChunk </span><span class="keyword">.= </span><span class="default">$bkgdChunkData</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bkgdChunk </span><span class="keyword">.= </span><span class="default">dechex</span><span class="keyword">(</span><span class="default">crc32</span><span class="keyword">(</span><span class="default">pack</span><span class="keyword">(</span><span class="string">'H*'</span><span class="keyword">, </span><span class="default">$bkgdMarker </span><span class="keyword">. </span><span class="default">$bkgdChunkData</span><span class="keyword">))) . </span><span class="string">'0000'</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$parsed </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="default">$idatMarker</span><span class="keyword">, </span><span class="default">$pngData</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">); </span><span class="comment">// split file by first 'IDAT' chunk&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pngData </span><span class="keyword">= </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'H*'</span><span class="keyword">, </span><span class="default">$parsed</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] . </span><span class="default">$bkgdChunk </span><span class="keyword">. </span><span class="default">$idatMarker </span><span class="keyword">. </span><span class="default">$parsed</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$cachedFilename</span><span class="keyword">, </span><span class="default">$pngData</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="86735""></a>
  <div class="note">
   <strong class="user">eetu11 at suomi24 dot fi</strong>
   <a href="#86735" class="date">01-Nov-2008 07:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php <br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// aid of the highlighted Alliance <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$marked_aid </span><span class="keyword">= </span><span class="default">2403</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Preferences <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mysqlhost </span><span class="keyword">= </span><span class="string">'localhost'</span><span class="keyword">; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mysqluser </span><span class="keyword">= </span><span class="string">'user'</span><span class="keyword">; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mysqlpass </span><span class="keyword">= </span><span class="string">'password'</span><span class="keyword">; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mysqldb </span><span class="keyword">= </span><span class="string">'database'</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Create database connection and select database <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$db </span><span class="keyword">= @</span><span class="default">mysql_connect</span><span class="keyword">(</span><span class="default">$mysqlhost</span><span class="keyword">, </span><span class="default">$mysqluser</span><span class="keyword">, </span><span class="default">$mysqlpass</span><span class="keyword">) OR die(</span><span class="string">'Can not connect to DB-Server!'</span><span class="keyword">); <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$db_select </span><span class="keyword">= @</span><span class="default">mysql_select_db</span><span class="keyword">(</span><span class="default">$mysqldb</span><span class="keyword">) OR die(</span><span class="string">'Can not select DB!'</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Create image: Map goes from -400 to 400 <br />
&nbsp;&nbsp;&nbsp; // -&gt; sums up tp 2*400+1 (+1 due to the 0 in the center) <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreate</span><span class="keyword">(</span><span class="default">801</span><span class="keyword">, </span><span class="default">801</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Choose the colors of background, normal village and highlighted alliance <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$color_background </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">); <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$color_normal </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">200</span><span class="keyword">, </span><span class="default">200</span><span class="keyword">, </span><span class="default">200</span><span class="keyword">); <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$color_marked </span><span class="keyword">= </span><span class="default">imagecolorallocate</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">); <br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Fill images background with chosen color <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagefill</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$color_background</span><span class="keyword">); <br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Select ALL villages from the DB and order by ascending ID <br />
&nbsp;&nbsp;&nbsp; // (Fields are numbered from top left to bottom right) <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$query </span><span class="keyword">= </span><span class="string">'SELECT x, y, aid FROM x_world ORDER BY id ASC'</span><span class="keyword">; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= @</span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">) OR die(</span><span class="string">'Can not select villages from table x_world!'</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Check whether there any villages at all <br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">mysql_num_rows</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">)) { <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Select first village <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$row </span><span class="keyword">= @</span><span class="default">mysql_fetch_assoc</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// These variables save the location on which we are currently drawing <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x_pointer </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$y_pointer </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Outer loop for the Y-coordinates <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">for(</span><span class="default">$y</span><span class="keyword">=</span><span class="default">400</span><span class="keyword">; </span><span class="default">$y </span><span class="keyword">&gt;= -</span><span class="default">400</span><span class="keyword">; </span><span class="default">$y</span><span class="keyword">--) { <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Inner loop for the X-coordinates <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">for (</span><span class="default">$x</span><span class="keyword">=-</span><span class="default">400</span><span class="keyword">; </span><span class="default">$x </span><span class="keyword">&lt;= </span><span class="default">400</span><span class="keyword">; </span><span class="default">$x</span><span class="keyword">++) { <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Once we reached the coordinates matching the current record selected from the DB: <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'x'</span><span class="keyword">] == </span><span class="default">$x </span><span class="keyword">AND </span><span class="default">$row</span><span class="keyword">[</span><span class="string">'y'</span><span class="keyword">] == </span><span class="default">$y</span><span class="keyword">) { <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Selecting the village color depending on the aid <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'aid'</span><span class="keyword">] == </span><span class="default">$marked_aid</span><span class="keyword">) { <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$color </span><span class="keyword">= </span><span class="default">$color_marked</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else { <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$color </span><span class="keyword">= </span><span class="default">$color_normal</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Drawing the village with the selected color <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagefilledrectangle</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$x_pointer</span><span class="keyword">, </span><span class="default">$y_pointer</span><span class="keyword">, (</span><span class="default">$x_pointer </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">), (</span><span class="default">$y_pointer </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">), </span><span class="default">$color</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Select next record <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$row </span><span class="keyword">= @</span><span class="default">mysql_fetch_assoc</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Increase pointer for X-coordinate <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x_pointer</span><span class="keyword">++; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Increase pointer for Y-coordinate <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$y_pointer</span><span class="keyword">++; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// We reached the end of a line and have to set the X-pointer to 0 again <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x_pointer </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; } <br />
&nbsp;&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Select the HTTP-Header for the selected filetype <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Type: image/png"</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Generate image and print it <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">); <br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85748""></a>
  <div class="note">
   <strong class="user">luxian.m [at] gmail [dot] com</strong>
   <a href="#85748" class="date">16-Sep-2008 01:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to open a png image with alpha blending, you need to do something like this:<br />
<br />
<span class="default">&lt;?php<br />
$file </span><span class="keyword">= </span><span class="string">'semitransparent.png'</span><span class="keyword">; </span><span class="comment">// path to png image<br />
</span><span class="default">$img </span><span class="keyword">= </span><span class="default">imagecreatefrompng</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">); </span><span class="comment">// open image<br />
</span><span class="default">imagealphablending</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">); </span><span class="comment">// setting alpha blending on<br />
</span><span class="default">imagesavealpha</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">); </span><span class="comment">// save alphablending setting (important)<br />
</span><span class="default">?&gt;<br />
</span><br />
I spent almost a day to find out why alpha blending doesn't work. I hope this is usefull to others too :)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82612""></a>
  <div class="note">
   <strong class="user">vicrry at yahoo dot com</strong>
   <a href="#82612" class="date">18-Apr-2008 04:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
@ phpman at texmedia dot de:<br />
<br />
The compression range in PNG is in range 0-9, i think if you specified a compression level higher than 9, it'll be completely "compressed", or suppressed in the other words.<br />
<br />
The compression level is originally for JPEG, which is in range 0 - 100, I think it'll work fine if you divide it by ten before passing to imagepng(). ;)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79150""></a>
  <div class="note">
   <strong class="user">Jeff Sauro</strong>
   <a href="#79150" class="date">13-Nov-2007 03:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
My webserver, running 5.14 didn't like the header that was generated using imagepng(). It works find on my local test server and on 4.x from another host. <br />
<br />
The generated image displays in the browser (IE, firefox) but when saved to a file or inserted into an RTF file, the image was corrupted. As a test, when attempting to right-click to save as, the image format was not recognized. <br />
<br />
The only work-around appears to be adding the additional paramaters. <br />
<br />
So instead of just <br />
imagepng($image); //DIDNT WORK--CORUPT IMAGE<br />
<br />
This worked<br />
imagepng($image,NULL,0,NULL);<br />
<br />
and saving to disk, this worked:<br />
imagepng($image,$file_location,0,NULL);<br />
<br />
Jeff</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="78787""></a>
  <div class="note">
   <strong class="user">phpman at texmedia dot de</strong>
   <a href="#78787" class="date">27-Oct-2007 02:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When changeing the PHP version from 4 to 5 I found out, that PHP5 handles imagepng() more restrictive than in PHP4. I'd used <br />
<br />
imagepng($image,'',90);<br />
<br />
to reduce the image quality whithout saving the image as a file. The quality parameter is not supported at all, I used imagejpg before and simply changed the function to imagepng whithout taking care of the existing parameters. It did not matter and there was no error in PHP4. But in PHP5, the image will not be shown anymore. So you have to remove it to have the standard:<br />
<br />
imagepng($image);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="72237""></a>
  <div class="note">
   <strong class="user">alex at gateway-productions dot com</strong>
   <a href="#72237" class="date">08-Jan-2007 03:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
barts code below does not work at least with gd 2<br />
<br />
Only returns a blank image with alpha not the source resized<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $im = ImageCreateFromPNG($sourcefile);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $im_dest = imagecreatetruecolor ($forcedwidth, $forcedheight);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagealphablending($im_dest, false);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagecopyresampled($im_dest, $im, 0, 0, 0, 0, $wm_width, $wm_height, $forcedwidth, $forcedheight);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagesavealpha($im_dest, true);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagepng($im_dest, $destfile);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; imagedestroy($img_dest);<br />
<br />
ps you also forgot image destroy and you had a random var in imagepng undefined in your post</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="64061""></a>
  <div class="note">
   <strong class="user">bart at resolume dot com</strong>
   <a href="#64061" class="date">06-Apr-2006 08:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to resize a png-24 image and preserve the alpha channel you need to set imagealphablending($im_dest, false) on the destination image just after creating it with imagecreatetruecolor() and do a imagesavealpha($im_dest, true) on it before saving it:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$im </span><span class="keyword">= </span><span class="default">ImageCreateFromPNG</span><span class="keyword">(</span><span class="string">'redfade.png'</span><span class="keyword">);<br />
<br />
</span><span class="default">$im_dest </span><span class="keyword">= </span><span class="default">imagecreatetruecolor </span><span class="keyword">(</span><span class="default">500</span><span class="keyword">, </span><span class="default">300</span><span class="keyword">);<br />
</span><span class="default">imagealphablending</span><span class="keyword">(</span><span class="default">$im_dest</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />
<br />
</span><span class="default">imagecopyresampled</span><span class="keyword">(</span><span class="default">$im_dest</span><span class="keyword">, </span><span class="default">$im</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">300</span><span class="keyword">, </span><span class="default">300</span><span class="keyword">, </span><span class="default">500</span><span class="keyword">, </span><span class="default">300</span><span class="keyword">);<br />
<br />
</span><span class="default">imagesavealpha</span><span class="keyword">(</span><span class="default">$im_dest</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$im_re</span><span class="keyword">, </span><span class="string">'small_redfade.png'</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60128""></a>
  <div class="note">
   <strong class="user">adrenalin at NOSPAM dot myrealbox dot com</strong>
   <a href="#60128" class="date">27-Dec-2005 07:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Trying to resize a png 256 colors image and save it in 256 colors with a correct color palette ? (if you'll save a 256 color image in truecolor palette the result image will have a big size).<br />
I spent some hours trying various function to get a good quality 256 color png image, but because of color palette the result image quality was awful.<br />
But thank to the comment of zmorris at zsculpt dot com from imagetruecolortopalette function page, i figured out how to get a properly image!<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">resize_png</span><span class="keyword">(</span><span class="default">$src</span><span class="keyword">,</span><span class="default">$dst</span><span class="keyword">,</span><span class="default">$dstw</span><span class="keyword">,</span><span class="default">$dsth</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; list(</span><span class="default">$width</span><span class="keyword">, </span><span class="default">$height</span><span class="keyword">, </span><span class="default">$type</span><span class="keyword">, </span><span class="default">$attr</span><span class="keyword">) = </span><span class="default">getimagesize</span><span class="keyword">(</span><span class="default">$src</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$im </span><span class="keyword">= </span><span class="default">imagecreatefrompng</span><span class="keyword">(</span><span class="default">$src</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tim </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$dstw</span><span class="keyword">,</span><span class="default">$dsth</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagecopyresampled</span><span class="keyword">(</span><span class="default">$tim</span><span class="keyword">,</span><span class="default">$im</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$dstw</span><span class="keyword">,</span><span class="default">$dsth</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tim </span><span class="keyword">= </span><span class="default">ImageTrueColorToPalette2</span><span class="keyword">(</span><span class="default">$tim</span><span class="keyword">,</span><span class="default">false</span><span class="keyword">,</span><span class="default">255</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$tim</span><span class="keyword">,</span><span class="default">$dst</span><span class="keyword">);<br />
}<br />
</span><span class="comment">//zmorris at zsculpt dot com function, a bit completed<br />
</span><span class="keyword">function </span><span class="default">ImageTrueColorToPalette2</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">, </span><span class="default">$dither</span><span class="keyword">, </span><span class="default">$ncolors</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$width </span><span class="keyword">= </span><span class="default">imagesx</span><span class="keyword">( </span><span class="default">$image </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$height </span><span class="keyword">= </span><span class="default">imagesy</span><span class="keyword">( </span><span class="default">$image </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$colors_handle </span><span class="keyword">= </span><span class="default">ImageCreateTrueColor</span><span class="keyword">( </span><span class="default">$width</span><span class="keyword">, </span><span class="default">$height </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ImageCopyMerge</span><span class="keyword">( </span><span class="default">$colors_handle</span><span class="keyword">, </span><span class="default">$image</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$width</span><span class="keyword">, </span><span class="default">$height</span><span class="keyword">, </span><span class="default">100 </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ImageTrueColorToPalette</span><span class="keyword">( </span><span class="default">$image</span><span class="keyword">, </span><span class="default">$dither</span><span class="keyword">, </span><span class="default">$ncolors </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ImageColorMatch</span><span class="keyword">( </span><span class="default">$colors_handle</span><span class="keyword">, </span><span class="default">$image </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ImageDestroy</span><span class="keyword">(</span><span class="default">$colors_handle</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$image</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Good luck,<br />
Namolovan Nicolae, Moldova</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60068""></a>
  <div class="note">
   <strong class="user">awalton at gmail dot com</strong>
   <a href="#60068" class="date">24-Dec-2005 01:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PNG images (as any image) can be stored in a MySQL blob field, but if you want to do this, you'll want to serialize the image stream into a better form. I would recommend base64_encode() and base64_decode(). (Just fopen() the file, fread() the contents in, base64_encode() the string, and fire off your SQL query (use addslashes()/stripslashes() to be more secure)). <br />
<br />
This has been posted an innumerable amount of times throughout the site, but it's still terrible that a lot of users simply don't understand this and use it to its full potential. <br />
<br />
I would also recommend that if you are doing images this way, to keep an image cache folder somewhere that PHP can access (possibly even somewhere off your webroot?). That way if your website is swamped with traffic it won't kill the SQL server.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54432""></a>
  <div class="note">
   <strong class="user">vladson at pc-labs dot info</strong>
   <a href="#54432" class="date">04-Jul-2005 08:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To send 'Content-Length' header (like in static pictures case) i use "Output handler" like this...<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//&nbsp; &nbsp; Output handler<br />
</span><span class="keyword">function </span><span class="default">output_handler</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">'Content-type: image/png'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">'Content-Length: ' </span><span class="keyword">. </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$img</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$img</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">//&nbsp; &nbsp; Image output<br />
</span><span class="default">ob_start</span><span class="keyword">(</span><span class="string">"output_handler"</span><span class="keyword">);<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">);<br />
</span><span class="default">ob_end_flush</span><span class="keyword">();<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="53021""></a>
  <div class="note">
   <strong class="user">neburk0rk at gmail dot com</strong>
   <a href="#53021" class="date">20-May-2005 11:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is my way to store PNG-images in a MySQL database... You cannot directly store the PNG-image in a variable, and then parse it in the database, cos if you try to define it to a variable, it'll still just output it...<br />
In my method i use three functions<br />
&nbsp;to "capture" the output and store it in a variable; ob_start (to start the output buffering),&nbsp; &nbsp; ob_get_contents&nbsp; (to capture the output),&nbsp; &nbsp; and&nbsp; ob_end_clean (to erase the cache, and end the output buffering)<br />
<br />
<span class="default">&lt;?php<br />
$imagefile </span><span class="keyword">= </span><span class="string">"changethistogourimage.gif"</span><span class="keyword">;<br />
<br />
</span><span class="default">$image </span><span class="keyword">= </span><span class="default">imagecreatefromgif</span><span class="keyword">(</span><span class="default">$imagefile</span><span class="keyword">);<br />
</span><span class="default">ob_start</span><span class="keyword">();<br />
</span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
</span><span class="default">$imagevariable </span><span class="keyword">= </span><span class="default">ob_get_contents</span><span class="keyword">();<br />
</span><span class="default">ob_end_clean</span><span class="keyword">();<br />
<br />
</span><span class="comment">/*<br />
HERE YOU CAN MESS WITH THE $imagevariable AS YOU LIKE<br />
*/<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52520""></a>
  <div class="note">
   <strong class="user">php at no dot spam dot prosa dot net</strong>
   <a href="#52520" class="date">04-May-2005 07:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You could use the function imagecreatefrompng <br />
<br />
(I assume that you already know how to get the text from the url.)<br />
<br />
The only thing left to do is put that text on the image using the correct colors for you.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$im </span><span class="keyword">= @</span><span class="default">imagecreatefrompng</span><span class="keyword">(</span><span class="default">$imgname</span><span class="keyword">); <br />
<br />
</span><span class="default">$text_color </span><span class="keyword">= </span><span class="default">imagecolorallocate </span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">$Red</span><span class="keyword">,</span><span class="default">$Green</span><span class="keyword">,</span><span class="default">$Blue</span><span class="keyword">);<br />
<br />
</span><span class="default">imagestring </span><span class="keyword">(</span><span class="default">$im</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">,&nbsp; </span><span class="default">5</span><span class="keyword">, </span><span class="default">15</span><span class="keyword">,&nbsp; </span><span class="default">$SomeTextFromURL</span><span class="keyword">, </span><span class="default">$text_color</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Regards,<br />
Peter Berkhout.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49278""></a>
  <div class="note">
   <strong class="user">dws at mrao dot cam dot ac dot uk</strong>
   <a href="#49278" class="date">22-Jan-2005 02:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Presumably it returns true on success and false on failure, although the documentation doesn't actually say so.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="45027""></a>
  <div class="note">
   <strong class="user">pm at dontspamme dot pietmarcus dot com</strong>
   <a href="#45027" class="date">23-Aug-2004 01:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
in reply to: cbrasho at yahoo dot com<br />
<br />
if you use Apache as a webserver, you could do the following:<br />
<br />
You could set up a 'img' directory in your webspace.<br />
In that directory there will be two files: a .htaccess file and a img.php file<br />
the .htaccess file contains the following code:<br />
ErrorDocument 404 /img/img.php<br />
<br />
the img.php file looks something like this:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; $file </span><span class="keyword">= </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REDIRECT_URL'</span><span class="keyword">];<br />
<br />
&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">'select img_blob from images where filename=\\'' . $file . '</span><span class="keyword">\\</span><span class="string">');<br />
&nbsp; list($blob) = mysql_fetch_row($result);<br />
<br />
&nbsp; header('</span><span class="default">HTTP</span><span class="keyword">/</span><span class="default">1.0 200 Ok</span><span class="string">');<br />
&nbsp; header("Content-type: image/jpeg");<br />
&nbsp; <br />
&nbsp; print $blob; # or whatever works, I don'</span><span class="default">t </span><span class="keyword">use </span><span class="default">this<br />
?&gt;<br />
</span><br />
if you use a url for your image like <a href="http://test.com/img/image1.jpeg, which doesn" rel="nofollow" target="_blank">http://test.com/img/image1.jpeg, which doesn</a>'t exist, normally you would get a 404-page. in this case, the 404 is being handled by img.php, which brings up the required image...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="44820""></a>
  <div class="note">
   <strong class="user">cbrasho at yahoo dot com</strong>
   <a href="#44820" class="date">17-Aug-2004 07:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Having your pictures stored in a database sounds great but brings you a lot of trouble.<br />
Storing images in a DB you will have a script show.php that will appear in &lt;img&gt; tags: &lt;img src='show.php?img_id=$some_id'&gt;<br />
But if you want to have REGISTER GLOBALS = OFF, you are in trouble and there is no way (at leas as far as i know) to solve the problem but to put te img from the DB in a file and put the coresponding file name in the &lt;img&gt; tag. But this brings another problem: simultaneous accesses to the page. So you will have to find a way to give unique names to the picture files for each simultaneous access to the page. The solution might be using sessions. This is how you end up having a very compleh PHP script for a very simple problem. So, the basic ideea is " do not store your pictures in a blob unless you know exactly what you are doing".</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31308""></a>
  <div class="note">
   <strong class="user">mail at stefanbechtold dot de</strong>
   <a href="#31308" class="date">16-Apr-2003 06:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
to all the ones, who like having their users fill their profil with an image without destroying a fixed design the following should be a great way to handle this problem.<br />
<br />
this file opens a picture from $imagepath and returns it as a valid picture to embed in: &lt;img src="file.php?image=123.jpg[?maxX=200&amp;maxY=150]"&gt; (in [] = optional)<br />
<br />
but this file does more than this. it also adds black borders to files that are smaller than the max. size, so adding borders to the left and right where a image is too high :-)<br />
<br />
if there is a need for a copyright note this script will also help you. you can put in a various text to $copyright. the text length should be in relationship to $maxX and $maxY.<br />
<br />
Well there are other features of the script, just try'em out and have fun with it :-)<br />
<br />
bye <br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment"># standard height &amp; weight if not given<br />
</span><span class="keyword">if(!isset(</span><span class="default">$maxX</span><span class="keyword">)) </span><span class="default">$maxX </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;<br />
if(!isset(</span><span class="default">$maxY</span><span class="keyword">)) </span><span class="default">$maxY </span><span class="keyword">= </span><span class="default">75</span><span class="keyword">;<br />
<br />
</span><span class="comment"># colour- &amp; textvalues<br />
</span><span class="default">$picBG </span><span class="keyword">= </span><span class="string">"0,0,0"</span><span class="keyword">; </span><span class="comment"># RGB-value !<br />
</span><span class="default">$picFG </span><span class="keyword">= </span><span class="string">"104,104,104"</span><span class="keyword">; </span><span class="comment"># RGB-value !<br />
</span><span class="default">$copyright </span><span class="keyword">= </span><span class="string">"stefan bechtold"</span><span class="keyword">; <br />
</span><span class="default">$font </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
<br />
</span><span class="comment"># minimal &amp; maximum zoom<br />
</span><span class="default">$minZoom </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="comment"># per cent related on orginal (!=0)<br />
</span><span class="default">$maxZoom </span><span class="keyword">= </span><span class="default">200</span><span class="keyword">; </span><span class="comment"># per cent related on orginal (!=0)<br />
<br />
# paths<br />
</span><span class="default">$imgpath </span><span class="keyword">= </span><span class="string">"userimages/"</span><span class="keyword">; </span><span class="comment"># ending with "/" !<br />
</span><span class="default">$nopicurl </span><span class="keyword">= </span><span class="string">"../images/nopic.jpg"</span><span class="keyword">; </span><span class="comment"># starting in $imagepath!!!<br />
</span><span class="default">$nofileurl </span><span class="keyword">= </span><span class="string">"../images/nofile.jpg"</span><span class="keyword">; </span><span class="comment"># starting in $imagepath!!!<br />
<br />
</span><span class="keyword">if(!isset(</span><span class="default">$image</span><span class="keyword">) || empty(</span><span class="default">$image</span><span class="keyword">))<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$imageurl </span><span class="keyword">= </span><span class="default">$imgpath </span><span class="keyword">. </span><span class="default">$nopicurl</span><span class="keyword">;<br />
elseif(! </span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$imgpath </span><span class="keyword">. </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">)))<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$imageurl </span><span class="keyword">= </span><span class="default">$imgpath </span><span class="keyword">. </span><span class="default">$nofileurl</span><span class="keyword">;<br />
else<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$imageurl </span><span class="keyword">= </span><span class="default">$imgpath </span><span class="keyword">. </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br />
<br />
</span><span class="comment"># reading image<br />
</span><span class="default">$image </span><span class="keyword">= </span><span class="default">getImageSize</span><span class="keyword">(</span><span class="default">$imageurl</span><span class="keyword">, </span><span class="default">$info</span><span class="keyword">); </span><span class="comment"># $info, only to handle problems with earlier php versions...<br />
</span><span class="keyword">switch(</span><span class="default">$image</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; case </span><span class="default">1</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment"># GIF image<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$timg </span><span class="keyword">= </span><span class="default">imageCreateFromGIF</span><span class="keyword">(</span><span class="default">$imageurl</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp; case </span><span class="default">2</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment"># JPEG image<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$timg </span><span class="keyword">= </span><span class="default">imageCreateFromJPEG</span><span class="keyword">(</span><span class="default">$imageurl</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp; case </span><span class="default">3</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment"># PNG image<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$timg </span><span class="keyword">= </span><span class="default">imageCreateFromPNG</span><span class="keyword">(</span><span class="default">$imageurl</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
}<br />
<br />
</span><span class="comment"># reading image sizes<br />
</span><span class="default">$imgX </span><span class="keyword">= </span><span class="default">$image</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">];<br />
</span><span class="default">$imgY </span><span class="keyword">= </span><span class="default">$image</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">];<br />
<br />
</span><span class="comment"># calculation zoom factor <br />
</span><span class="default">$_X </span><span class="keyword">= </span><span class="default">$imgX</span><span class="keyword">/</span><span class="default">$maxX </span><span class="keyword">* </span><span class="default">100</span><span class="keyword">;<br />
</span><span class="default">$_Y </span><span class="keyword">= </span><span class="default">$imgY</span><span class="keyword">/</span><span class="default">$maxY </span><span class="keyword">* </span><span class="default">100</span><span class="keyword">;<br />
<br />
</span><span class="comment"># selecting correct zoom factor, so that the image always keeps in the given format<br />
# no matter if it is more higher than wider or the other way around<br />
</span><span class="keyword">if((</span><span class="default">100</span><span class="keyword">-</span><span class="default">$_X</span><span class="keyword">) &lt; (</span><span class="default">100</span><span class="keyword">-</span><span class="default">$_Y</span><span class="keyword">)) </span><span class="default">$_K </span><span class="keyword">= </span><span class="default">$_X</span><span class="keyword">;<br />
else </span><span class="default">$_K </span><span class="keyword">= </span><span class="default">$_Y</span><span class="keyword">;<br />
<br />
</span><span class="comment"># zoom check to the original<br />
</span><span class="keyword">if(</span><span class="default">$_K </span><span class="keyword">&gt; </span><span class="default">10000</span><span class="keyword">/</span><span class="default">$minZoom</span><span class="keyword">) </span><span class="default">$_K </span><span class="keyword">= </span><span class="default">10000</span><span class="keyword">/</span><span class="default">$minZoom</span><span class="keyword">;<br />
if(</span><span class="default">$_K </span><span class="keyword">&lt; </span><span class="default">10000</span><span class="keyword">/</span><span class="default">$maxZoom</span><span class="keyword">) </span><span class="default">$_K </span><span class="keyword">= </span><span class="default">10000</span><span class="keyword">/</span><span class="default">$maxZoom</span><span class="keyword">;<br />
<br />
</span><span class="comment"># calculate new image sizes<br />
</span><span class="default">$newX </span><span class="keyword">= </span><span class="default">$imgX</span><span class="keyword">/</span><span class="default">$_K </span><span class="keyword">* </span><span class="default">100</span><span class="keyword">;<br />
</span><span class="default">$newY </span><span class="keyword">= </span><span class="default">$imgY</span><span class="keyword">/</span><span class="default">$_K </span><span class="keyword">* </span><span class="default">100</span><span class="keyword">;<br />
<br />
</span><span class="comment"># set start positoin of the image<br />
# always centered <br />
</span><span class="default">$posX </span><span class="keyword">= (</span><span class="default">$maxX</span><span class="keyword">-</span><span class="default">$newX</span><span class="keyword">) / </span><span class="default">2</span><span class="keyword">;<br />
</span><span class="default">$posY </span><span class="keyword">= (</span><span class="default">$maxY</span><span class="keyword">-</span><span class="default">$newY</span><span class="keyword">) / </span><span class="default">2</span><span class="keyword">;<br />
<br />
</span><span class="comment"># creating new image with given sizes<br />
</span><span class="default">$imgh </span><span class="keyword">= </span><span class="default">imageCreateTrueColor</span><span class="keyword">(</span><span class="default">$maxX</span><span class="keyword">, </span><span class="default">$maxY</span><span class="keyword">);<br />
<br />
</span><span class="comment"># setting colours<br />
</span><span class="default">$cols </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">","</span><span class="keyword">, </span><span class="default">$picBG</span><span class="keyword">);<br />
</span><span class="default">$bgcol </span><span class="keyword">= </span><span class="default">imageColorallocate</span><span class="keyword">(</span><span class="default">$imgh</span><span class="keyword">, </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$cols</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]), </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$cols</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]), </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$cols</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]));<br />
</span><span class="default">$cols </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">","</span><span class="keyword">, </span><span class="default">$picFG</span><span class="keyword">);<br />
</span><span class="default">$fgcol </span><span class="keyword">= </span><span class="default">imageColorallocate</span><span class="keyword">(</span><span class="default">$imgh</span><span class="keyword">, </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$cols</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]), </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$cols</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]), </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$cols</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]));<br />
<br />
</span><span class="comment"># fill background<br />
</span><span class="default">imageFill</span><span class="keyword">(</span><span class="default">$imgh</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$bgcol</span><span class="keyword">);<br />
<br />
</span><span class="comment"># create small copy of the image<br />
</span><span class="default">imageCopyResampled</span><span class="keyword">(</span><span class="default">$imgh</span><span class="keyword">, </span><span class="default">$timg</span><span class="keyword">, </span><span class="default">$posX</span><span class="keyword">, </span><span class="default">$posY</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$newX</span><span class="keyword">, </span><span class="default">$newY</span><span class="keyword">, </span><span class="default">$image</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$image</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
<br />
</span><span class="comment"># writing copyright note<br />
</span><span class="default">imageStringUp</span><span class="keyword">(</span><span class="default">$imgh</span><span class="keyword">, </span><span class="default">$font</span><span class="keyword">, </span><span class="default">$maxX</span><span class="keyword">-</span><span class="default">9</span><span class="keyword">, </span><span class="default">$maxY</span><span class="keyword">-</span><span class="default">3</span><span class="keyword">, </span><span class="default">$copyright</span><span class="keyword">, </span><span class="default">$fgcol</span><span class="keyword">);<br />
<br />
</span><span class="comment"># output<br />
</span><span class="keyword">switch(</span><span class="default">$image</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; case </span><span class="default">1</span><span class="keyword">:<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># GIF image<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-type: image/gif"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imageGIF</span><span class="keyword">(</span><span class="default">$imgh</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; case </span><span class="default">2</span><span class="keyword">:<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># JPEG image<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-type: image/jpeg"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imageJPEG</span><span class="keyword">(</span><span class="default">$imgh</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; case </span><span class="default">3</span><span class="keyword">:<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># PNG image<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-type: image/png"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">imagePNG</span><span class="keyword">(</span><span class="default">$imgh</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment"># cleaning cache<br />
</span><span class="default">imageDestroy</span><span class="keyword">(</span><span class="default">$timg</span><span class="keyword">);<br />
</span><span class="default">imageDestroy</span><span class="keyword">(</span><span class="default">$imgh</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="28775""></a>
  <div class="note">
   
   <a href="#28775" class="date">23-Jan-2003 10:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
"Tip: As with anything that outputs its result directly to the browser, you can use the output-control functions (<a href="http://www.php.net/manual/en/ref.outcontrol.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/ref.outcontrol.php</a>) to capture the output of this function, and save it in a string (for example)."<br />
<br />
ob_start();<br />
imagepng($image);<br />
$image_data = ob_get_contents();<br />
ob_end_clean();<br />
<br />
And now you can save $image_data to a database, for example, instead of first writing it to file and then reading the data from it. Just don't forget to use mysql_escape_string...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="28667""></a>
  <div class="note">
   <strong class="user">johnbeech at mkv25.net</strong>
   <a href="#28667" class="date">20-Jan-2003 04:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PNG files are already compressed. They use a lossless compression algorithm. If you are using HighColour images, the compression only does so much. For low colour images (16 or 256) the compression is much better.<br />
<br />
It is pointless trying to compress the images further before sending to a browser.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="23739""></a>
  <div class="note">
   <strong class="user">bgd1977 at hotmail dot com</strong>
   <a href="#23739" class="date">26-Jul-2002 06:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have experienced segfaults and bus errors with the following configuration: FreeBSD4.4, Apache 1.3.26, PHP 4.2.2, GD-1.8.4, PDFlib 4.0.1. The apache process crashed when calling the imagepng function, but it didn't crash when calling the imagejpg function, or imagecreatefrompng...<br />
<br />
&nbsp;Some wasted hours (lots) later, in which I have tried to recompile gd, libpng, php, libjpeg, what-not, I have found the following advices:<br />
<a href="http://bugs.php.net/bug.php?id=16841" rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=16841</a><br />
<br />
&nbsp;So the problem was not with the png library, but rather with the PDFlib. Even though all the threads led to a png-problem... so I have simply upgraded to PDFlib 4.0.3 (w/o any special configure arguments; --with-libpng didn't work anyways), recompiled PHP, and now everything works (imagepng, pdf creation, etc.).<br />
<br />
&nbsp;Hope this helps,<br />
&nbsp;bogdan</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="19130""></a>
  <div class="note">
   <strong class="user">ruelle at xtof dot com</strong>
   <a href="#19130" class="date">17-Feb-2002 06:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Better than a chmod 777 to any '/dir/pic.png' you should :<br />
- test if dir is writable (is_writable func.)<br />
- use chmod 700 (more secure because let only the webserver ID have access)<br />
<br />
In any case you should program a (crontab) script to change the owner ID of any images created.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
