<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>转义字符串以供查询</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.pg-escape-literal.html">? pg_escape_literal</a></li>
      <li style="float: right;"><a href="function.pg-execute.html">pg_execute ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.pgsql.html">PostgreSQL 函数</a></li>
    <li>转义字符串以供查询</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.pg-escape-string" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">pg_escape_string</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.2.0, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">pg_escape_string</span> &mdash; <span class="dc-title">
   转义字符串以供查询
  </span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.pg-escape-string-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>pg_escape_string</strong></span>(<span class="methodparam"><span class="type"><a href="class.pgsql-connection.html" class="type PgSql\Connection">PgSql\Connection</a></span> <code class="parameter">$connection</code><span class="initializer"> = ?</span></span>, <span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>): <span class="type">string</span></div>

  <p class="para rdfs-comment">
   <span class="function"><strong>pg_escape_string()</strong></span> 转义用于查询数据库的字符串。它返回不带引号的 PostgreSQL 格式的转义字符串。<span class="function"><a href="function.pg-escape-literal.html" class="function">pg_escape_literal()</a></span>
   是为 PostgreSQL 转义 SQL 参数的首选方法。<span class="function"><a href="function.addslashes.html" class="function">addslashes()</a></span> 不得与 PostgreSQL 一起使用。如果列的类型是 bytea，则必须改用
   <span class="function"><a href="function.pg-escape-bytea.html" class="function">pg_escape_bytea()</a></span>。<span class="function"><a href="function.pg-escape-identifier.html" class="function">pg_escape_identifier()</a></span> 必须用于转义标识符（例如表名、字段名）
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    本函数需要 PostgreSQL 7.2 及其更高版本。
    </p>
  </p></blockquote>
 </div>


<div class="refsect1 parameters" id="refsect1-function.pg-escape-string-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">connection</code></dt>

     <dd>

      <p class="para">An <span class="classname"><a href="class.pgsql-connection.html" class="classname">PgSql\Connection</a></span> instance.
When <code class="parameter">connection</code> is unspecified, the default connection is used.
The default connection is the last connection made by <span class="function"><a href="function.pg-connect.html" class="function">pg_connect()</a></span>
or <span class="function"><a href="function.pg-pconnect.html" class="function">pg_pconnect()</a></span>.
<div class="warning"><strong class="warning">Warning</strong><p class="simpara">As of PHP 8.1.0, using the default connection is deprecated.</p></div></p>
     </dd>

    
    
     <dt>
<code class="parameter">data</code></dt>

     <dd>

      <p class="para">
       包含要转义的 <span class="type">string</span>。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.pg-escape-string-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   包含转义数据的 <span class="type">string</span>。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.pg-escape-string-changelog">
  <h3 class="title">更新日志</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>版本</th>
      <th>说明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
 <td>8.1.0</td>
 <td>
  现在 <code class="parameter">connection</code> 参数接受 <span class="classname"><a href="class.pgsql-connection.html" class="classname">PgSql\Connection</a></span>
  实例，之前接受 <a href="language.types.resource.html" class="link">资源(resource)</a>。
 </td>
</tr>

    </tbody>
   
  </table>

 </div>


 <div class="refsect1 examples" id="refsect1-function.pg-escape-string-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="example-3850">
    <p><strong>Example #1 <span class="function"><strong>pg_escape_string()</strong></span> 示例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php <br />  </span><span style="color: #FF8000">// 连接到数据库<br />  </span><span style="color: #0000BB">$dbconn </span><span style="color: #007700">= </span><span style="color: #0000BB">pg_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">'dbname=foo'</span><span style="color: #007700">);<br />  <br />  </span><span style="color: #FF8000">// 读入文本文件（包含撇号和反斜线）<br />  </span><span style="color: #0000BB">$data </span><span style="color: #007700">= </span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">'letter.txt'</span><span style="color: #007700">);<br />  <br />  </span><span style="color: #FF8000">// 转义文本数据<br />  </span><span style="color: #0000BB">$escaped </span><span style="color: #007700">= </span><span style="color: #0000BB">pg_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br />  <br />  </span><span style="color: #FF8000">// 将其插入数据库<br />  </span><span style="color: #0000BB">pg_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT INTO correspondence (name, data) VALUES ('My letter', '</span><span style="color: #007700">{</span><span style="color: #0000BB">$escaped</span><span style="color: #007700">}</span><span style="color: #DD0000">')"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>

 
 <div class="refsect1 seealso" id="refsect1-function.pg-escape-string-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.pg-escape-bytea.html" class="function" rel="rdfs-seeAlso">pg_escape_bytea()</a> - 转义字符串以插入到 bytea 字段</span></li>
   </ul>
  </p>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="122019""></a>
  <div class="note">
   <strong class="user">efjiolvwejlojfwel at mailinator dot com</strong>
   <a href="#122019" class="date">14-Dec-2017 01:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please, as a service to the Internet, add a note advising developers to use prepared statements and placeholders, and deprecate this function and its friends (but not pg_escape_identifier).<br />
There is no valid reason to mix data and SQL into a single string before sending it to the RDBMS, and thus create the potential for SQL injection vulnerabilities. Hence, there is no need to escape data. Hence, there is no need for this function. It's confusing to offer developers functionality that they don't need and shouldn't use.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121746""></a>
  <div class="note">
   <strong class="user">arunintellirise at gmail dot com</strong>
   <a href="#121746" class="date">10-Oct-2017 06:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PostgreSQL is a powerful and an open source object relational database having more than 15 years of active development and a proven architecture with an emphasis on extensibility and standards compliance. PostgreSQL primary functions are to store data securely and return that data in response to requests from other software applications that has earned it a strong reputation for reliability, data integrity and correctness which runs on all major operating system including Linux, UNIX and Windows. PostgreSQL is a cross platform which is open source and its source code is available free of charge that is not controlled by any corporation or other private entity. PostgreSQL also supports storage of binary large objects including picture, sound or video along with handles workloads ranging from small single machine applications to large internet facing applications with lots of concurrent users-. PostgreSQL is highly scalable in the sheer quantity of data which support international character sets and multibyte character encodings.<br />
if you know more aboutthis note then please visit on our website.<br />
https://www.codesroom.com/blog/postgresql</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="114478""></a>
  <div class="note">
   <strong class="user">ringerc at ringerc dot id dot au</strong>
   <a href="#114478" class="date">25-Feb-2014 07:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You should prefer to use pg_query_params, i.e. use parameterized queries, rather than using pg_escape_string. Or use the newer PDO interface with its parameterized query support.<br />
<br />
If you must substitute values directly, e.g. in DDL commands that don't support execution as parameterized queries, do so with pg_escape_literal:<br />
<br />
<a href="http://au1.php.net/manual/en/function.pg-escape-literal.php" rel="nofollow" target="_blank">http://au1.php.net/manual/en/function.pg-escape-literal.php</a><br />
<br />
Identifiers can't be used as query parameters. Always use pg_escape_identifier for these if they're substituted dynamically:<br />
<br />
<a href="http://au1.php.net/manual/en/function.pg-escape-identifier.php" rel="nofollow" target="_blank">http://au1.php.net/manual/en/function.pg-escape-identifier.php</a><br />
<br />
You should not need to change text encodings when using this function. Make sure your connection's client_encoding is set to the text encoding used by PHP, and the PostgreSQL client driver will take care of text encodings for you. No explicit utf-8 conversions should be necessary with a correctly set&nbsp; client_encoding.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105290""></a>
  <div class="note">
   <strong class="user">strata_ranger at hotmail dot com</strong>
   <a href="#105290" class="date">07-Aug-2011 08:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This may seem obvious, but remember that pg_escape_string escapes values for use as string literals in an SQL query -- if you need to escape arbitrary strings for use as SQL identifiers (column names, etc.), there doesn't seem to be a PHP function for that so you'll have to do that escaping yourself.&nbsp; (PostgreSQL has an in-database function, quote_ident(), that does this.)<br />
<br />
This can be an issue if your database contains mixed-case (or otherwise unusual) column names and you have a class interface managing your database/query interactions (for connecting to different types of databases).&nbsp; If you don't double-quote your column names then postgreSQL will match them case-insensitively, but will label the results in all-lowercase (which differs from MySQL).<br />
<br />
For example:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Plain column identifier<br />
</span><span class="default">$res </span><span class="keyword">= </span><span class="default">pg_query</span><span class="keyword">(</span><span class="string">"Select columnName from table"</span><span class="keyword">);<br />
</span><span class="default">$row </span><span class="keyword">= </span><span class="default">pg_fetch_assoc</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">);<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'columnName'</span><span class="keyword">]); </span><span class="comment">// Doesn't work (throws E_NOTICE)<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'columnname'</span><span class="keyword">]); </span><span class="comment">// Works<br />
<br />
// Escaped column identifier<br />
</span><span class="default">$res </span><span class="keyword">= </span><span class="default">pg_query</span><span class="keyword">(</span><span class="string">"Select \"columnName\" from table"</span><span class="keyword">);<br />
</span><span class="default">$row </span><span class="keyword">= </span><span class="default">pg_fetch_assoc</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">);<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'columnName'</span><span class="keyword">]); </span><span class="comment">// Works<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'columnname'</span><span class="keyword">]); </span><span class="comment">// Doesn't<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104690""></a>
  <div class="note">
   <strong class="user">ppp</strong>
   <a href="#104690" class="date">30-Jun-2011 12:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
pg_escape_string() won't cast array arguments to the "Array" string like php usually does; it returns NULL instead. The following statements all evaluate to true:<br />
<br />
<span class="default">&lt;?php<br />
$a </span><span class="keyword">= array(</span><span class="string">'foo'</span><span class="keyword">, </span><span class="string">'bar'</span><span class="keyword">);<br />
<br />
</span><span class="string">"</span><span class="default">$a</span><span class="string">" </span><span class="keyword">== </span><span class="string">'Array'</span><span class="keyword">;<br />
(string)</span><span class="default">$a </span><span class="keyword">== </span><span class="string">'Array'</span><span class="keyword">;<br />
</span><span class="default">$a </span><span class="keyword">. </span><span class="string">'' </span><span class="keyword">== </span><span class="string">'Array'</span><span class="keyword">;<br />
<br />
</span><span class="default">is_null</span><span class="keyword">(</span><span class="default">pg_escape_string</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">));<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99023""></a>
  <div class="note">
   <strong class="user">strata_ranger at hotmail dot com</strong>
   <a href="#99023" class="date">22-Jul-2010 10:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Forthose curious, the exact escaping performed on the string may vary slightly depending on your database configuration.<br />
<br />
For example, if your database's standard_conforming_strings variable is OFF, backslashes are treated as a special character and pg_escape_string() will ensure they are properly escaped.&nbsp; If this variable is ON, backslashes will be treated as ordinary characters, and pg_escape_string() will leave them as-is.&nbsp; In either case, the behavior matches the configuration of the database connection.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80975""></a>
  <div class="note">
   <strong class="user">Nathan Bruer</strong>
   <a href="#80975" class="date">08-Feb-2008 01:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If your database is a UTF-8 database, you will run into problems trying to add some data into your database...
<br />

<br />
for securty issues and/or compatability you may need to use the: utf_encode() (<a href="http://php.net/utf8-encode" rel="nofollow" target="_blank">http://php.net/utf8-encode</a>) function.
<br />

<br />
for example:
<br />
<span class="default">&lt;?php
<br />
$my_data </span><span class="keyword">= </span><span class="default">pg_escape_string</span><span class="keyword">(</span><span class="default">utf8_encode</span><span class="keyword">(</span><span class="default">$_POST</span><span class="keyword">[</span><span class="string">'my_data'</span><span class="keyword">]));
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77426""></a>
  <div class="note">
   <strong class="user">Gautam Khanna</strong>
   <a href="#77426" class="date">29-Aug-2007 07:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Security methods which you use depend on the specific purpose. For those who dont know, take a look at the following built-in PHP functions:<br />
<br />
strip_tags()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to remove HTML characters<br />
(also see htmlspecialchars)<br />
<br />
escapeshellarg()&nbsp; &nbsp; &nbsp; to escape shell commands etc<br />
escapeshellcmd()<br />
<br />
mysql_real_escape_string()&nbsp; &nbsp;&nbsp; to escape mySQL commands.<br />
<br />
Enjoy!<br />
<br />
web dot expert dot panel at gmail dot com</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="66827""></a>
  <div class="note">
   <strong class="user">johniskew2 at yahoo dot com</strong>
   <a href="#66827" class="date">30-May-2006 09:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those who escape their single quotes with a backslash (ie \') instead of two single quotes in a row (ie '') there has recently been a SERIOUS sql injection vulnerability that can be employed taking advantage of your chosen escaping method.&nbsp; More info here: <a href="http://www.postgresql.org/docs/techdocs.50" rel="nofollow" target="_blank">http://www.postgresql.org/docs/techdocs.50</a><br />
Even after the postgre update, you may still be limited to what you can do with your queries if you still insist on backslash escaping. It's a lesson to always use the PHP functions to do proper escaping instead of adhoc addslashes or magic quotes escaping.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="66750""></a>
  <div class="note">
   <strong class="user">meng</strong>
   <a href="#66750" class="date">27-May-2006 04:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Since php 5.1 the new function pg_query_params() was introduced. With this function you can use bind variables and don't have to escape strings. If you can use it, do so. If unsure why, check the changelog for Postgres 8.0.8.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="65130""></a>
  <div class="note">
   <strong class="user">otix</strong>
   <a href="#65130" class="date">24-Apr-2006 03:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Creating a double-tick is just fine. It works the same as the backslash-tick syntax. From the PostgreSQL docs:<br />
<br />
The fact that string constants are bound by single quotes presents an obvious semantic problem, however, in that if the sequence itself contains a single quote, the literal bounds of the constant are made ambiguous. To escape (make literal) a single quote within the string, you may type two adjacent single quotes. The parser will interpret the two adjacent single quotes within the string constant as a single, literal single quote. PostgreSQL will also allow single quotes to be embedded by using a C-style backslash.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
