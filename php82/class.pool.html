<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>Pool 类</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="collectable.isgarbage.html">? Collectable::isGarbage</a></li>
      <li style="float: right;"><a href="pool.collect.html">Pool::collect ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="book.pthreads.html">pthreads</a></li>
    <li>Pool 类</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="class.pool" class="reference">

 <h1 class="title">Pool 类</h1>
 

 <div class="partintro"><p class="verinfo">(PECL pthreads &gt;= 2.0.0)</p>


  <div class="section" id="pool.intro">
   <h2 class="title">简介</h2>
   <p class="para">
    Pool 对象是多个 Worker 对象的容器，同时也是它们的控制器。
   </p>
   <p class="para">
    线程池是对 Worker 功能的高层抽象，包括按照 pthreads 需要的方式来管理应用的功能。
   </p>
  </div>


  <div class="section" id="pool.synopsis">
   <h2 class="title">类摘要</h2>


   <div class="classsynopsis">
    <span class="ooclass"><strong class="classname"></strong></span>


    <div class="classsynopsisinfo">
     <span class="ooclass">
      <span class="modifier">class</span> <strong class="classname">Pool</strong>
     </span>
     {</div>

    <div class="classsynopsisinfo classsynopsisinfo_comment">/* 属性 */</div>
    <div class="fieldsynopsis">
     <span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.size">$<var class="varname">size</var></a></var>;</div>

    <div class="fieldsynopsis"><span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.class">$<var class="varname">class</var></a></var>;</div>

    <div class="fieldsynopsis"><span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.workers">$<var class="varname">workers</var></a></var>;</div>

    <div class="fieldsynopsis"><span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.ctor">$<var class="varname">ctor</var></a></var>;</div>

    <div class="fieldsynopsis"><span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.last">$<var class="varname">last</var></a></var>;</div>


    <div class="classsynopsisinfo classsynopsisinfo_comment">/* 方法 */</div>
    <div class="constructorsynopsis dc-description">
   <span class="modifier">public</span> <span class="methodname"><a href="pool.construct.html" class="methodname">__construct</a></span>(<span class="methodparam"><span class="type">int</span> <code class="parameter">$size</code></span>, <span class="methodparam"><span class="type">string</span> <code class="parameter">$class</code><span class="initializer"> = ?</span></span>, <span class="methodparam"><span class="type">array</span> <code class="parameter">$ctor</code><span class="initializer"> = ?</span></span>)</div>

    <div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="pool.collect.html" class="methodname">collect</a></span>(<span class="methodparam"><span class="type"><a href="language.types.callable.html" class="type Callable">Callable</a></span> <code class="parameter">$collector</code><span class="initializer"> = ?</span></span>): <span class="type">int</span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span><span class="methodname"><a href="pool.resize.html" class="methodname">resize</a></span>(<span class="methodparam"><span class="type">int</span> <code class="parameter">$size</code></span>): <span class="type"><span class="type void">void</span></span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span><span class="methodname"><a href="pool.shutdown.html" class="methodname">shutdown</a></span>(): <span class="type"><span class="type void">void</span></span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="pool.submit.html" class="methodname">submit</a></span>(<span class="methodparam"><span class="type"><a href="class.threaded.html" class="type Threaded">Threaded</a></span> <code class="parameter">$task</code></span>): <span class="type">int</span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="pool.submitTo.html" class="methodname">submitTo</a></span>(<span class="methodparam"><span class="type">int</span> <code class="parameter">$worker</code></span>, <span class="methodparam"><span class="type"><a href="class.threaded.html" class="type Threaded">Threaded</a></span> <code class="parameter">$task</code></span>): <span class="type">int</span></div>

   }</div>


  </div>


  <div class="section" id="pool.props">
   <h2 class="title">属性</h2>
   <dl>
    
     <dt id="pool.props.size"><var class="varname">size</var></dt>

     <dd>

      <p class="para">Pool 对象可容纳的 Worker 对象的最大数量</p>
     </dd>

    
    
     <dt id="pool.props.class"><var class="varname">class</var></dt>

     <dd>

      <p class="para">Worker 的类</p>
     </dd>

    
    
     <dt id="pool.props.workers"><var class="varname">workers</var></dt>

     <dd>

      <p class="para">指向 Worker 对象的引用</p>
     </dd>

    
    
     <dt id="pool.props.ctor"><var class="varname">ctor</var></dt>

     <dd>

      <p class="para">构造新的 Worker 对象时所需的参数</p>
     </dd>

    
    
     <dt id="pool.props.last"><var class="varname">last</var></dt>

     <dd>

      <p class="para">最后使用的 Worker 对象在池中的位置偏移量</p>
     </dd>

    
   </dl>

  </div>



 </div>

 
























































<h2>Table of Contents</h2><ul class="chunklist chunklist_reference"><li><a href="pool.collect.html">Pool::collect</a> &mdash; 回收已完成任务的引用</li><li><a href="pool.construct.html">Pool::__construct</a> &mdash; 创建新的 Worker 对象池</li><li><a href="pool.resize.html">Pool::resize</a> &mdash; 改变 Pool 对象的可容纳 Worker 对象的数量</li><li><a href="pool.shutdown.html">Pool::shutdown</a> &mdash; 停止所有的 Worker 对象</li><li><a href="pool.submit.html">Pool::submit</a> &mdash; 提交对象以执行</li><li><a href="pool.submitTo.html">Pool::submitTo</a> &mdash; 提交一个任务到特定的 Worker 以执行</li></ul>
</div>
<div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="125633""></a>
  <div class="note">
   <strong class="user">meadowsjared at gmail dot com</strong>
   <a href="#125633" class="date">29-Dec-2020 05:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In this example, it shows how to use a pool to get an array of results, using pThreads v3.2.1 and php 7.3.23<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">TestWork </span><span class="keyword">extends </span><span class="default">Threaded </span><span class="keyword">{<br />
</span><span class="comment">//updated version that works with pThreads v3.2.1 and php 7.3.23<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">protected </span><span class="default">$complete</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//$pData is the data sent to your worker thread to do it's job.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$pData</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//transfer all the variables to local variables<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">complete </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">testData </span><span class="keyword">= </span><span class="default">$pData</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//This is where all of your work will be done.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">run</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">2000000</span><span class="keyword">); </span><span class="comment">//sleep 2 seconds to simulate a large job<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">complete </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">isDone</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">complete</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
class </span><span class="default">ExamplePool </span><span class="keyword">extends </span><span class="default">Pool </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$data </span><span class="keyword">= array(); </span><span class="comment">// used to return data after we're done<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$numTasks </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">// counter used to know when we're done<br />
&nbsp;&nbsp;&nbsp; /**<br />
&nbsp;&nbsp; &nbsp; * override the submit function from the parent<br />
&nbsp;&nbsp; &nbsp; * to keep track of our jobs<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">submit</span><span class="keyword">(</span><span class="default">Threaded $task</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">numTasks</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">parent</span><span class="keyword">::</span><span class="default">submit</span><span class="keyword">(</span><span class="default">$task</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * used to wait until all workers are done<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">process</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Run this loop as long as we have<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // jobs in the pool<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">) &lt; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">numTasks</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">collect</span><span class="keyword">(function (</span><span class="default">TestWork $task</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// If a task was marked as done, collect its results<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$task</span><span class="keyword">-&gt;</span><span class="default">isDone</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmpObj </span><span class="keyword">= new </span><span class="default">stdclass</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmpObj</span><span class="keyword">-&gt;</span><span class="default">complete </span><span class="keyword">= </span><span class="default">$task</span><span class="keyword">-&gt;</span><span class="default">complete</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//this is how you get your completed data back out [accessed by $pool-&gt;process()]<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">[] = </span><span class="default">$tmpObj</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$task</span><span class="keyword">-&gt;</span><span class="default">isDone</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; });<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// All jobs are done<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // we can shutdown the pool<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">shutdown</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">$pool </span><span class="keyword">= new </span><span class="default">ExamplePool</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">);<br />
</span><span class="default">$testData </span><span class="keyword">= </span><span class="string">'asdf'</span><span class="keyword">;<br />
for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">5</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">submit</span><span class="keyword">(new </span><span class="default">TestWork</span><span class="keyword">(</span><span class="default">$testData</span><span class="keyword">));<br />
}<br />
</span><span class="default">$retArr </span><span class="keyword">= </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">process</span><span class="keyword">(); </span><span class="comment">//get all of the results<br />
</span><span class="keyword">echo </span><span class="string">'&lt;pre&gt;'</span><span class="keyword">;<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$retArr</span><span class="keyword">); </span><span class="comment">//return the array of results (and maybe errors)<br />
</span><span class="keyword">echo </span><span class="string">'&lt;/pre&gt;'</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118996""></a>
  <div class="note">
   <strong class="user">meadowsjared at gmail dot com</strong>
   <a href="#118996" class="date">14-Mar-2016 07:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note, when using the collect function, it's important that you extend the pool class so you can keep checking for finished threads until they're all done.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">TestWork </span><span class="keyword">extends </span><span class="default">Threaded </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$complete</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//$pData is the data sent to your worker thread to do it's job.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$pData</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//transfer all the variables to local variables<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">complete </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">testData </span><span class="keyword">= </span><span class="default">$pData</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//This is where all of your work will be done.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">run</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">2000000</span><span class="keyword">); </span><span class="comment">//sleep 2 seconds to simulate a large job<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">complete </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">isGarbage</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">complete</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
class </span><span class="default">ExamplePool </span><span class="keyword">extends </span><span class="default">Pool<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$data </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">process</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Run this loop as long as we have<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // jobs in the pool<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">work</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">collect</span><span class="keyword">(function (</span><span class="default">TestWork $task</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// If a task was marked as done<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // collect its results<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$task</span><span class="keyword">-&gt;</span><span class="default">isGarbage</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmpObj </span><span class="keyword">= new </span><span class="default">stdclass</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmpObj</span><span class="keyword">-&gt;</span><span class="default">complete </span><span class="keyword">= </span><span class="default">$task</span><span class="keyword">-&gt;</span><span class="default">complete</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//this is how you get your completed data back out [accessed by $pool-&gt;process()]<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">[] = </span><span class="default">$tmpObj</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$task</span><span class="keyword">-&gt;</span><span class="default">isGarbage</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; });<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// All jobs are done<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // we can shutdown the pool<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">shutdown</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">$pool </span><span class="keyword">= new </span><span class="default">ExamplePool</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">);<br />
</span><span class="default">$testData </span><span class="keyword">= </span><span class="string">'asdf'</span><span class="keyword">;<br />
for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">5</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">submit</span><span class="keyword">(new </span><span class="default">TestWork</span><span class="keyword">(</span><span class="default">$testData</span><span class="keyword">));<br />
}<br />
</span><span class="default">$retArr </span><span class="keyword">= </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">process</span><span class="keyword">(); </span><span class="comment">//get all of the results<br />
</span><span class="keyword">echo </span><span class="string">'&lt;pre&gt;'</span><span class="keyword">;<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$retArr</span><span class="keyword">); </span><span class="comment">//return the array of results (and maybe errors)<br />
</span><span class="keyword">echo </span><span class="string">'&lt;/pre&gt;'</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116980""></a>
  <div class="note">
   <strong class="user">olavk</strong>
   <a href="#116980" class="date">30-Mar-2015 01:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Simple example with Collectable (basically Thread meant for Pool) and Pool<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">job </span><span class="keyword">extends </span><span class="default">Collectable </span><span class="keyword">{<br />
&nbsp; public </span><span class="default">$val</span><span class="keyword">;<br />
<br />
&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// init some properties<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">val </span><span class="keyword">= </span><span class="default">$val</span><span class="keyword">;<br />
&nbsp; }<br />
&nbsp; public function </span><span class="default">run</span><span class="keyword">(){<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// do some work<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">val </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">val </span><span class="keyword">. </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">'<a href="http://www.example.com/" rel="nofollow" target="_blank">http://www.example.com/</a>'</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">setGarbage</span><span class="keyword">();<br />
&nbsp; }<br />
}<br />
<br />
</span><span class="comment">// At most 3 threads will work at once<br />
</span><span class="default">$p </span><span class="keyword">= new </span><span class="default">Pool</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">);<br />
<br />
</span><span class="default">$tasks </span><span class="keyword">= array(<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'0'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'1'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'2'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'3'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'4'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'5'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'6'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'7'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'8'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'9'</span><span class="keyword">),<br />
&nbsp; new </span><span class="default">job</span><span class="keyword">(</span><span class="string">'10'</span><span class="keyword">),<br />
);<br />
</span><span class="comment">// Add tasks to pool queue<br />
</span><span class="keyword">foreach (</span><span class="default">$tasks </span><span class="keyword">as </span><span class="default">$task</span><span class="keyword">) {<br />
&nbsp; </span><span class="default">$p</span><span class="keyword">-&gt;</span><span class="default">submit</span><span class="keyword">(</span><span class="default">$task</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">// shutdown will wait for current queue to be completed<br />
</span><span class="default">$p</span><span class="keyword">-&gt;</span><span class="default">shutdown</span><span class="keyword">();<br />
</span><span class="comment">// garbage collection check / read results<br />
</span><span class="default">$p</span><span class="keyword">-&gt;</span><span class="default">collect</span><span class="keyword">(function(</span><span class="default">$checkingTask</span><span class="keyword">){<br />
&nbsp; echo </span><span class="default">$checkingTask</span><span class="keyword">-&gt;</span><span class="default">val</span><span class="keyword">;<br />
&nbsp; return </span><span class="default">$checkingTask</span><span class="keyword">-&gt;</span><span class="default">isGarbage</span><span class="keyword">();<br />
});<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="115118""></a>
  <div class="note">
   <strong class="user">fajan</strong>
   <a href="#115118" class="date">28-May-2014 01:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Example class to demonstrate usage of Pool/Worker mechanism, also to show a few tricks &amp; hints ;)<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">Config </span><span class="keyword">extends </span><span class="default">Threaded</span><span class="keyword">{&nbsp; &nbsp; </span><span class="comment">// shared global object<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">protected </span><span class="default">$val</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">, </span><span class="default">$val2</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; protected function </span><span class="default">inc</span><span class="keyword">(){++</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">val</span><span class="keyword">;}&nbsp; &nbsp; </span><span class="comment">// protected synchronizes by-object<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">inc2</span><span class="keyword">(){++</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">val2</span><span class="keyword">;}&nbsp; &nbsp; </span><span class="comment">// no synchronization<br />
</span><span class="keyword">}<br />
class </span><span class="default">WorkerClass </span><span class="keyword">extends </span><span class="default">Worker</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; protected static </span><span class="default">$worker_id_next </span><span class="keyword">= -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$worker_id</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$config</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$config</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">worker_id </span><span class="keyword">= ++static::</span><span class="default">$worker_id_next</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">// static members are not avalable in thread but are in 'main thread'<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">config </span><span class="keyword">= </span><span class="default">$config</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">run</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$config</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">config</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">// NOTE: setting by reference WON'T work<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">global </span><span class="default">$worker_id</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$worker_id </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">worker_id</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"working context </span><span class="keyword">{</span><span class="default">$worker_id</span><span class="keyword">}</span><span class="string"> is created!\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//$this-&gt;say_config();&nbsp; &nbsp; // globally synchronized function.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp;&nbsp; protected function </span><span class="default">say_config</span><span class="keyword">(){&nbsp; &nbsp; </span><span class="comment">// 'protected' is synchronized by-object so WON'T work between multiple instances<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">global </span><span class="default">$config</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// you can use the shared $config object as synchronization source.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">synchronized</span><span class="keyword">(function() use (&amp;</span><span class="default">$config</span><span class="keyword">){&nbsp; &nbsp; </span><span class="comment">// NOTE: you can use Closures here, but if you attach a Closure to a Threaded object it will be destroyed as can't be serialized<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$config</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; });<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
class </span><span class="default">Task </span><span class="keyword">extends </span><span class="default">Stackable</span><span class="keyword">{&nbsp; &nbsp; </span><span class="comment">// Stackable still exists, it's just somehow dissappeared from docs (probably by mistake). See older version's docs for more details.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">protected </span><span class="default">$set</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$set</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">set </span><span class="keyword">= </span><span class="default">$set</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">run</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$worker_id</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"task is running in </span><span class="keyword">{</span><span class="default">$worker_id</span><span class="keyword">}</span><span class="string">!\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">mt_rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">,</span><span class="default">100</span><span class="keyword">)*</span><span class="default">100</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">getConfig</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val </span><span class="keyword">= </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">arr</span><span class="keyword">-&gt;</span><span class="default">shift</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">arr</span><span class="keyword">[] = </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">set</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0 </span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">1000</span><span class="keyword">; ++</span><span class="default">$i</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">inc</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">inc2</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">getConfig</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$config</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">// WorkerClass set this on thread's scope, can be reused by Tasks for additional asynch data source. (ie: connection pool or taskqueue to demultiplexer)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">$config</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">$config </span><span class="keyword">= new </span><span class="default">Config</span><span class="keyword">;<br />
</span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">arr </span><span class="keyword">= new </span><span class="default">\Threaded</span><span class="keyword">();<br />
</span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">arr</span><span class="keyword">-&gt;</span><span class="default">merge</span><span class="keyword">(array(</span><span class="default">1</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">3</span><span class="keyword">,</span><span class="default">4</span><span class="keyword">,</span><span class="default">5</span><span class="keyword">,</span><span class="default">6</span><span class="keyword">));<br />
class </span><span class="default">PoolClass </span><span class="keyword">extends </span><span class="default">Pool</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">worker_list</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">workers </span><span class="keyword">!== </span><span class="default">null</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">array_keys</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">workers</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">$pool </span><span class="keyword">= new </span><span class="default">PoolClass</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">, </span><span class="string">'WorkerClass'</span><span class="keyword">, [</span><span class="default">$config</span><span class="keyword">] );<br />
</span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">worker_list</span><span class="keyword">();<br />
</span><span class="comment">//$pool-&gt;submitTo(0,new Task(-10));&nbsp; &nbsp; // submitTo DOES NOT try to create worker<br />
<br />
</span><span class="default">$spammed_id </span><span class="keyword">= -</span><span class="default">1</span><span class="keyword">;<br />
for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt;= </span><span class="default">100</span><span class="keyword">; ++</span><span class="default">$i</span><span class="keyword">){&nbsp; &nbsp; </span><span class="comment">// add some jobs<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$spammed_id </span><span class="keyword">== -</span><span class="default">1 </span><span class="keyword">&amp;&amp; (</span><span class="default">$x </span><span class="keyword">= </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">worker_list</span><span class="keyword">())!= </span><span class="default">null </span><span class="keyword">&amp;&amp; @</span><span class="default">$x</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$spammed_id </span><span class="keyword">= </span><span class="default">$x</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"spamming worker </span><span class="keyword">{</span><span class="default">$spammed_id</span><span class="keyword">}</span><span class="string"> with lots of tasks from now on\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$spammed_id </span><span class="keyword">!= -</span><span class="default">1 </span><span class="keyword">&amp;&amp; (</span><span class="default">$i </span><span class="keyword">% </span><span class="default">5</span><span class="keyword">) == </span><span class="default">0</span><span class="keyword">)&nbsp; &nbsp; </span><span class="comment">// every 5th job is routed to one worker, so it has 20% of the total jobs (with 3 workers it should do ~33%, not it has (33+20)%, so only delegate to worker if you plan to do balancing as well... )<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">submitTo</span><span class="keyword">(</span><span class="default">$spammed_id</span><span class="keyword">,new </span><span class="default">Task</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">*</span><span class="default">$i</span><span class="keyword">));&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">submit</span><span class="keyword">(new </span><span class="default">Task</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">*</span><span class="default">$i</span><span class="keyword">));<br />
}<br />
</span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">shutdown</span><span class="keyword">();<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$config</span><span class="keyword">); </span><span class="comment">// "val" is exactly 100000, "val2" is probably a bit less<br />
// also: if you disable the spammer, you'll that the order of the "arr" is random.<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
