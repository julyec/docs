<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>清除文件状态缓存</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.chown.html">? chown</a></li>
      <li style="float: right;"><a href="function.copy.html">copy ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.filesystem.html">文件系统函数</a></li>
    <li>清除文件状态缓存</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.clearstatcache" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">clearstatcache</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">clearstatcache</span> &mdash; <span class="dc-title">清除文件状态缓存</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.clearstatcache-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>clearstatcache</strong></span>(<span class="methodparam"><span class="type">bool</span> <code class="parameter">$clear_realpath_cache</code><span class="initializer"> = <strong><code>false</code></strong></span></span>, <span class="methodparam"><span class="type">string</span> <code class="parameter">$filename</code><span class="initializer"> = &quot;&quot;</span></span>): <span class="type"><span class="type void">void</span></span></div>

  <p class="para rdfs-comment">
   当使用 <span class="function"><a href="function.stat.html" class="function">stat()</a></span>，<span class="function"><a href="function.lstat.html" class="function">lstat()</a></span>
   或者任何列在受影响函数表（见下面）中的函数时，PHP
   将缓存这些函数的返回信息以提供更快的性能。然而在某些情况下，你可能想清除被缓存的信息。例如如果在一个脚本中多次检查同一个文件，而该文件在此脚本执行期间有被删除或修改的危险时，你需要清除文件状态缓存。这种情况下，可以用
   <span class="function"><strong>clearstatcache()</strong></span> 函数来清除被
   PHP 缓存的该文件信息。
  </p>
  <p class="para">
   必须注意的是，对于不存在的文件，PHP 并不会缓存其信息。所以如果调用
   <span class="function"><a href="function.file-exists.html" class="function">file_exists()</a></span> 来检查不存在的文件，在该文件没有被创建之前，它都会返回
   <strong><code>false</code></strong>。如果该文件被创建了，就算以后被删除，它都会返回 <strong><code>true</code></strong>
   函数 <span class="function"><a href="function.unlink.html" class="function">unlink()</a></span> 会自动清除该缓存.
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    本函数缓存特定文件名的信息，因此只在对同一个文件名进行多次操作并且需要该文件信息不被缓存时才需要调用
    <span class="function"><strong>clearstatcache()</strong></span>。
   </p>
  </p></blockquote>
  <p class="para">
   受影响的函数包括
   <span class="function"><a href="function.stat.html" class="function">stat()</a></span>，
   <span class="function"><a href="function.lstat.html" class="function">lstat()</a></span>，
   <span class="function"><a href="function.file-exists.html" class="function">file_exists()</a></span>，
   <span class="function"><a href="function.is-writable.html" class="function">is_writable()</a></span>，
   <span class="function"><a href="function.is-readable.html" class="function">is_readable()</a></span>，
   <span class="function"><a href="function.is-executable.html" class="function">is_executable()</a></span>，
   <span class="function"><a href="function.is-file.html" class="function">is_file()</a></span>，
   <span class="function"><a href="function.is-dir.html" class="function">is_dir()</a></span>，
   <span class="function"><a href="function.is-link.html" class="function">is_link()</a></span>，
   <span class="function"><a href="function.filectime.html" class="function">filectime()</a></span>，
   <span class="function"><a href="function.fileatime.html" class="function">fileatime()</a></span>，
   <span class="function"><a href="function.filemtime.html" class="function">filemtime()</a></span>，
   <span class="function"><a href="function.fileinode.html" class="function">fileinode()</a></span>，
   <span class="function"><a href="function.filegroup.html" class="function">filegroup()</a></span>，
   <span class="function"><a href="function.fileowner.html" class="function">fileowner()</a></span>，
   <span class="function"><a href="function.filesize.html" class="function">filesize()</a></span>，
   <span class="function"><a href="function.filetype.html" class="function">filetype()</a></span>
   和 <span class="function"><a href="function.fileperms.html" class="function">fileperms()</a></span>。
  </p>
 </div>

 
 <div class="refsect1 parameters" id="refsect1-function.clearstatcache-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">clear_realpath_cache</code></dt>

     <dd>

      <p class="para">
       是否<em class="emphasis">也</em>清除真实路径缓存
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">filename</code></dt>

     <dd>

      <p class="para">
       仅清除指定文件名的真实路径缓存; 只在
       <code class="parameter">clear_realpath_cache</code> 为 <strong><code>true</code></strong> 
       时启用。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.clearstatcache-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   没有返回值。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.clearstatcache-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="example-4400">
    <p><strong>Example #1 <span class="function"><strong>clearstatcache()</strong></span> 例子</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$file </span><span style="color: #007700">= </span><span style="color: #DD0000">'output_log.txt'</span><span style="color: #007700">;<br /><br />function </span><span style="color: #0000BB">get_owner</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">)<br />{<br />    </span><span style="color: #0000BB">$stat </span><span style="color: #007700">= </span><span style="color: #0000BB">stat</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">$user </span><span style="color: #007700">= </span><span style="color: #0000BB">posix_getpwuid</span><span style="color: #007700">(</span><span style="color: #0000BB">$stat</span><span style="color: #007700">[</span><span style="color: #DD0000">'uid'</span><span style="color: #007700">]);<br />    return </span><span style="color: #0000BB">$user</span><span style="color: #007700">[</span><span style="color: #DD0000">'name'</span><span style="color: #007700">];<br />}<br /><br /></span><span style="color: #0000BB">$format </span><span style="color: #007700">= </span><span style="color: #DD0000">"UID @ %s: %s\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #0000BB">$format</span><span style="color: #007700">, </span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">'r'</span><span style="color: #007700">), </span><span style="color: #0000BB">get_owner</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">chown</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">, </span><span style="color: #DD0000">'ross'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #0000BB">$format</span><span style="color: #007700">, </span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">'r'</span><span style="color: #007700">), </span><span style="color: #0000BB">get_owner</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">clearstatcache</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #0000BB">$format</span><span style="color: #007700">, </span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">'r'</span><span style="color: #007700">), </span><span style="color: #0000BB">get_owner</span><span style="color: #007700">(</span><span style="color: #0000BB">$file</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>以上示例的输出类似于：</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
UID @ Sun, 12 Oct 2008 20:48:28 +0100: root
UID @ Sun, 12 Oct 2008 20:48:28 +0100: root
UID @ Sun, 12 Oct 2008 20:48:28 +0100: ross
</pre></div>
    </div>
   </div>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="125163""></a>
  <div class="note">
   <strong class="user">vechenjivot  at  gmail dot com</strong>
   <a href="#125163" class="date">03-Jul-2020 06:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Not documented, but seems like clearstatcache() is clearing the cache only for the process it is being called from. I have 2 PHP scripts running simultaneously, and the first one does call clearstatcache(), but still the second one deadlocks, unless I call clearstatcache() in it too:<br />
<br />
script1:<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; touch</span><span class="keyword">(</span><span class="string">'system.lock'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; ...<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="string">'system.lock'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">clearstatcache</span><span class="keyword">(); </span><span class="comment">// should be done by unlink?<br />
</span><span class="default">?&gt;<br />
</span><br />
script2:<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">while (</span><span class="default">is_file</span><span class="keyword">(</span><span class="string">'system.lock'</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">clearstatcache</span><span class="keyword">(); </span><span class="comment">// without this, script 2 will deadlock forever!<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
</span><span class="default">?&gt;<br />
</span><br />
I also found this page, which leads to the same conclusion:<br />
https://stackoverflow.com/questions/9251237/clearstatcache-include-path-sessions</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="124497""></a>
  <div class="note">
   <strong class="user">msaladna at apisnetworks dot com</strong>
   <a href="#124497" class="date">10-Dec-2019 11:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
clearstatcache() does not canonicalize the path. clearstatcache(true, "/a/b/c") is different from clearstatcache(true, "/a/b//c").</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123451""></a>
  <div class="note">
   <strong class="user">Gabriel</strong>
   <a href="#123451" class="date">18-Dec-2018 04:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Definition of $filename parameter let's you think that it expects the filename only but it works if you give the path + filename also.<br />
<br />
It should be more clear about this.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="123405""></a>
  <div class="note">
   <strong class="user">David Spector</strong>
   <a href="#123405" class="date">07-Dec-2018 01:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that this function affects only file metadata. However, all the PHP file system functions do their own caching of actual file contents as well. You can use the "realpath_cache_size = 0" directive in PHP.ini to disable the content caching if you like. The default content caching timeout is 120 seconds.<br />
<br />
Content caching is not a good idea during development work and for certain kinds of applications, since your code may read in old data from a file whose contents you have just changed.<br />
<br />
Note: This is separate from the caching typically done by browsers for all GET requests (the majority of Web accesses) unless the HTTP headers override it. It is also separate from optional Apache server caching.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116554""></a>
  <div class="note">
   <strong class="user">bj at wjblack dot com</strong>
   <a href="#116554" class="date">22-Jan-2015 02:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just to make this more obvious (and so search engines find this easier):<br />
<br />
If you do fileops of any kind outside of PHP (say via a system() call), you probably want to clear the stat cache before doing any further tests on the file/dir/whatever.&nbsp; For example:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// is_dir() forces a stat call, so the cache is populated<br />
</span><span class="keyword">if( </span><span class="default">is_dir</span><span class="keyword">(</span><span class="default">$foo</span><span class="keyword">) ) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">system</span><span class="keyword">(</span><span class="string">"rm -rf " </span><span class="keyword">. </span><span class="default">escapeshellarg</span><span class="keyword">(</span><span class="default">$foo</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; if( </span><span class="default">is_dir</span><span class="keyword">(</span><span class="default">$foo</span><span class="keyword">) ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// ...will still be true, even if the rm succeeded, because it's just<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // reading from cache, not re-running the stat()<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Pop a clearstatcache() after the system call and all is good (modulo a bit of a performance hit from having a cleared stat cache :-( ).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105888""></a>
  <div class="note">
   <strong class="user">matt_m at me dot com</strong>
   <a href="#105888" class="date">23-Sep-2011 03:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
unlink() does not clear the cache if you are performing file_exists() on a remote file like:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">if (</span><span class="default">file_exists</span><span class="keyword">(</span><span class="string">"<a href="ftp://ftp.example.com/somefile" rel="nofollow" target="_blank">ftp://ftp.example.com/somefile</a>"</span><span class="keyword">))
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
In this case, even after you unlink() successfully, you must call clearstatcache().
<br />

<br />
<span class="default">&lt;?php
<br />
unlink</span><span class="keyword">(</span><span class="string">"<a href="ftp://ftp.example.com/somefile" rel="nofollow" target="_blank">ftp://ftp.example.com/somefile</a>"</span><span class="keyword">);
<br />
</span><span class="default">clearstatcache</span><span class="keyword">();
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
file_exists() then properly returns false.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96621""></a>
  <div class="note">
   <strong class="user">markandrewslade at gmail dot com</strong>
   <a href="#96621" class="date">08-Mar-2010 11:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On Linux, a forked process inherits a copy of the parent's cache, but after forking the two caches do not impact each other.&nbsp; The snippet below demonstrates this by creating a child and confirming outdated (cached) information, then clearing the cache, and getting new information.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">report</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">, </span><span class="default">$prefix </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">) { </span><span class="default">printf</span><span class="keyword">(</span><span class="string">'%sDoes %s exist?&nbsp; PHP says "%s"'</span><span class="keyword">. </span><span class="default">PHP_EOL</span><span class="keyword">, </span><span class="default">$prefix</span><span class="keyword">, </span><span class="default">$directory</span><span class="keyword">, </span><span class="default">is_dir</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">) ? </span><span class="string">'yes' </span><span class="keyword">: </span><span class="string">'no'</span><span class="keyword">); }<br />
</span><span class="default">$target </span><span class="keyword">= </span><span class="string">'./delete-me-before-running-statcache'</span><span class="keyword">;<br />
<br />
if (</span><span class="default">is_dir</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">"Delete </span><span class="default">$target</span><span class="string"> before running.\n"</span><span class="keyword">);<br />
}<br />
<br />
echo </span><span class="string">"Creating </span><span class="default">$target</span><span class="string">.\n"</span><span class="keyword">;<br />
</span><span class="default">mkdir</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">) || die(</span><span class="string">"Unable to create </span><span class="default">$target</span><span class="string">.\n"</span><span class="keyword">);<br />
</span><span class="default">report</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">); </span><span class="comment">// is_dir($target) is now cached as true<br />
<br />
</span><span class="keyword">echo </span><span class="string">"Unlinking </span><span class="default">$target</span><span class="string">.\n"</span><span class="keyword">;<br />
</span><span class="default">rmdir</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">) || die(</span><span class="string">"Unable to unlink </span><span class="default">$target</span><span class="string">.\n"</span><span class="keyword">);<br />
<br />
</span><span class="comment">// This will say "yes", which is old (inaccurate) information.<br />
</span><span class="default">report</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">);<br />
<br />
if ((</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">()) === -</span><span class="default">1</span><span class="keyword">) { die(</span><span class="string">"Failed to pcntl_fork.\n"</span><span class="keyword">); }<br />
elseif (</span><span class="default">$pid </span><span class="keyword">=== </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// child<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">report</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">, </span><span class="string">'&lt;&lt;child&gt;&gt; '</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"&lt;&lt;child&gt;&gt; Clearing stat cache.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">clearstatcache</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">report</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">, </span><span class="string">'&lt;&lt;child&gt;&gt; '</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// parent<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">2</span><span class="keyword">); </span><span class="comment">// move this to the child block to reverse the test.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">report</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">, </span><span class="string">'&lt;&lt;&lt;parent&gt;&gt; '</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">clearstatcache</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">report</span><span class="keyword">(</span><span class="default">$target</span><span class="keyword">, </span><span class="string">'&lt;&lt;&lt;parent&gt;&gt; '</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
