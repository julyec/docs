<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=UTF-8">
  <title>Connect to an LDAP server</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.ldap-compare.html">? ldap_compare</a></li>
      <li style="float: right;"><a href="function.ldap-control-paged-result-response.html">ldap_control_paged_result_response ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.ldap.html">LDAP 函数</a></li>
    <li>Connect to an LDAP server</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.ldap-connect" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">ldap_connect</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">ldap_connect</span> &mdash; <span class="dc-title">Connect to an LDAP server</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.ldap-connect-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>ldap_connect</strong></span>(<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">string</span><span class="type"></span></span> <code class="parameter">$uri</code><span class="initializer"> = <strong><code>null</code></strong></span></span>): <span class="type"><span class="type"><a href="class.ldap-connection.html" class="type LDAP\Connection">LDAP\Connection</a></span>|<span class="type"><span class="type false">false</span></span></span></div>

  <div class="warning"><strong class="warning">Warning</strong>
   <p class="simpara">
    The <em class="emphasis">following</em> signature is still supported for backwards
    compatibility (except for using named parameters), but is considered deprecated and should not be used anymore!
   </p>
  </div>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>ldap_connect</strong></span>(<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">string</span><span class="type"></span></span> <code class="parameter">$host</code><span class="initializer"> = <strong><code>null</code></strong></span></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter">$port</code><span class="initializer"> = 389</span></span>): <span class="type"><span class="type"><a href="class.ldap-connection.html" class="type LDAP\Connection">LDAP\Connection</a></span>|<span class="type"><span class="type false">false</span></span></span></div>

  <p class="para rdfs-comment">
   Creates an <span class="classname"><a href="class.ldap-connection.html" class="classname">LDAP\Connection</a></span> connection and checks whether the given
   <code class="parameter">uri</code> is plausible.
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <span class="simpara">
    This function does <em class="emphasis">not</em> open a connection.
    It checks whether the given parameters are plausible and can be used
    to open a connection as soon as one is needed.
   </span>
  </p></blockquote>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.ldap-connect-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">uri</code></dt>

     <dd>

      <p class="para">
       A full LDAP URI of the form <code class="literal">ldap://hostname:port</code>
       or <code class="literal">ldaps://hostname:port</code> for SSL encryption.
      </p>
      <p class="para">
       You can also provide multiple LDAP-URIs separated by a space as one string
      </p>
      <p class="para">
       Note that <code class="literal">hostname:port</code> is not a supported LDAP URI as the schema is missing.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">host</code></dt>

     <dd>

      <p class="para">
       The hostname to connect to.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">port</code></dt>

     <dd>

      <p class="para">
       The port to connect to.
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.ldap-connect-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   Returns an <span class="classname"><a href="class.ldap-connection.html" class="classname">LDAP\Connection</a></span> instance when the provided LDAP URI
   seems plausible. It&#039;s a syntactic check of the provided parameter but the server(s) will not
   be contacted! If the syntactic check fails it returns <strong><code>false</code></strong>.
   <span class="function"><strong>ldap_connect()</strong></span> will otherwise
   return a <span class="classname"><a href="class.ldap-connection.html" class="classname">LDAP\Connection</a></span> instance as it does not actually connect but just
   initializes the connecting parameters.  The actual connect happens with
   the next calls to ldap_* functions, usually with
   <span class="function"><a href="function.ldap-bind.html" class="function">ldap_bind()</a></span>.
  </p>
  <p class="para">
   If no argument is specified then the <span class="classname"><a href="class.ldap-connection.html" class="classname">LDAP\Connection</a></span> instance of the already
   opened connection will be returned.
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.ldap-connect-changelog">
  <h3 class="title">更新日志</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>版本</th>
      <th>说明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>8.1.0</td>
      <td>
       Returns an <span class="classname"><a href="class.ldap-connection.html" class="classname">LDAP\Connection</a></span> instance now;
       previously, a <a href="language.types.resource.html" class="link">资源(resource)</a> was returned.
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>


 <div class="refsect1 examples" id="refsect1-function.ldap-connect-examples">
  <h3 class="title">示例</h3>
  <p class="para">
   <div class="example" id="">
    <p><strong>Example #1 Example of connecting to LDAP server.</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">// LDAP variables<br /></span><span style="color: #0000BB">$ldapuri </span><span style="color: #007700">= </span><span style="color: #DD0000">"ldap://ldap.example.com:389"</span><span style="color: #007700">;  </span><span style="color: #FF8000">// your ldap-uri<br /><br />// Connecting to LDAP<br /></span><span style="color: #0000BB">$ldapconn </span><span style="color: #007700">= </span><span style="color: #0000BB">ldap_connect</span><span style="color: #007700">(</span><span style="color: #0000BB">$ldapuri</span><span style="color: #007700">)<br />          or die(</span><span style="color: #DD0000">"That LDAP-URI was not parseable"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
   <div class="example" id="">
    <p><strong>Example #2 Example of connecting securely to LDAP server.</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">// make sure your host is the correct one<br />// that you issued your secure certificate to<br /></span><span style="color: #0000BB">$ldaphost </span><span style="color: #007700">= </span><span style="color: #DD0000">"ldaps://ldap.example.com/"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">// Connecting to LDAP<br /></span><span style="color: #0000BB">$ldapconn </span><span style="color: #007700">= </span><span style="color: #0000BB">ldap_connect</span><span style="color: #007700">(</span><span style="color: #0000BB">$ldaphost</span><span style="color: #007700">)<br />          or die(</span><span style="color: #DD0000">"That LDAP-URI was not parseable"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.ldap-connect-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.ldap-bind.html" class="function" rel="rdfs-seeAlso">ldap_bind()</a> - 绑定 LDAP 目录</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="124788""></a>
  <div class="note">
   <strong class="user">nateshull at gmail dot com</strong>
   <a href="#124788" class="date">03-Mar-2020 07:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Implementing LDAPS on a WISP stack - Win, IIS, SQL, PHP<br />
PHP 7.0.19:<br />
<br />
Had some issues with some of the instructions and I needed LDAPS for an upcoming Active Directory update that removes insecure LDAP connections. <br />
<br />
Enable modules for ldap and openssl in php.ini<br />
<br />
Also ensure the extensions are in the ext folder<br />
<br />
Verify the modules are loaded: phpinfo()<br />
<br />
Notes:<br />
The ldap or openssl config file is not needed if the environment variables are set in the code. Also the ca path does not like double quotations around the path. <br />
<br />
*** code sample:<br />
<br />
&nbsp;<span class="default">&lt;?php<br />
$ldapuser </span><span class="keyword">= </span><span class="string">"domain\\user"</span><span class="keyword">;<br />
</span><span class="default">$ldappass </span><span class="keyword">= </span><span class="string">"Passsword"</span><span class="keyword">;<br />
</span><span class="default">$ldapserver </span><span class="keyword">= </span><span class="string">"ldaps://server.domain.com"</span><span class="keyword">;<br />
<br />
</span><span class="comment">//options are require, never, allow<br />
//require is most secure, the others could allow for man in the middle attacks<br />
</span><span class="default">putenv</span><span class="keyword">(</span><span class="string">'LDAPTLS_REQCERT=require'</span><span class="keyword">);<br />
<br />
</span><span class="comment">//tell ldap where the root ca certificate is<br />
//note that the space is allowed in the path without escape or quotes<br />
//I have not tested the permissions, but I would assume the service should have read. <br />
</span><span class="default">putenv</span><span class="keyword">(</span><span class="string">'LDAPTLS_CACERT=C:\\Program Files\\php\\certs\\rootca.pem'</span><span class="keyword">);<br />
<br />
</span><span class="comment">//test to ensure the certificate is able to be read and path is right.<br />
</span><span class="keyword">echo </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"LDAPTLS_CACERT=C:\\Program Files\\php\\certs\\rootca.pem"</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Set debugging<br />
</span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">NULL</span><span class="keyword">, </span><span class="default">LDAP_OPT_DEBUG_LEVEL</span><span class="keyword">, </span><span class="default">7</span><span class="keyword">);<br />
<br />
</span><span class="comment">// connect to ldap server<br />
</span><span class="default">$ldapconn </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$ldapserver</span><span class="keyword">) or die (</span><span class="string">"Couldn't connect"</span><span class="keyword">); <br />
<br />
</span><span class="comment">// binding to ldap server<br />
</span><span class="default">$ldapbind </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
</span><span class="default">$ldapbind </span><span class="keyword">= </span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ldapconn</span><span class="keyword">, </span><span class="default">$ldapuser</span><span class="keyword">, </span><span class="default">$ldappass</span><span class="keyword">);<br />
<br />
</span><span class="comment">//easy view of success or failure<br />
</span><span class="keyword">if (</span><span class="default">$ldapbind</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; print(</span><span class="string">"\n logged in! \n\n"</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp;&nbsp; print(</span><span class="string">"\n log on failure \n\n"</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120383""></a>
  <div class="note">
   <strong class="user">titanrat at bk dot ru</strong>
   <a href="#120383" class="date">28-Dec-2016 12:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I found some difference between php7.0 and php5.5 on this function<br />
<br />
Php5 ldap_connect ('host', 0) try to connect default port - host:389<br />
Php7 ldap_connect ('host', 0) try to connect host:0 and crashes.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="118363""></a>
  <div class="note">
   <strong class="user">antoine dot php dot net at bonnefoy dot eu</strong>
   <a href="#118363" class="date">23-Nov-2015 10:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hello,<br />
<br />
Little corrections to nemanja&nbsp; post. <br />
- There was a warning if connection is denied by firewall (adding @ before fsockopen)<br />
- fclose parameter was incorrect. <br />
<br />
With this approach, you get a real nice failover functionality, take for an example a company with a dozen of DC-a distributed along distant places, this way your PHP program will always have high availability if at least one DC is active at present.<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">serviceping</span><span class="keyword">(</span><span class="default">$_host</span><span class="keyword">, </span><span class="default">$_port </span><span class="keyword">= </span><span class="default">389</span><span class="keyword">, </span><span class="default">$_timeout </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$op </span><span class="keyword">= @</span><span class="default">fsockopen</span><span class="keyword">(</span><span class="default">$_host</span><span class="keyword">, </span><span class="default">$_port</span><span class="keyword">, </span><span class="default">$errno</span><span class="keyword">, </span><span class="default">$errstr</span><span class="keyword">, </span><span class="default">$_timeout</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (!</span><span class="default">$op</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"KO!"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; } </span><span class="comment">//DC is N/A<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$op</span><span class="keyword">); </span><span class="comment">//explicitly close open socket connection<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">1</span><span class="keyword">; </span><span class="comment">//DC is up &amp; running, we can safely connect with ldap_connect<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
}<br />
<br />
function </span><span class="default">ldap_connect_failover</span><span class="keyword">(</span><span class="default">$_domain</span><span class="keyword">) {<br />
</span><span class="comment">// ##### STATIC DC LIST, if your DNS round robin is not setup<br />
//$dclist = array('10.111.222.111', '10.111.222.100', '10.111.222.200');<br />
// ##### DYNAMIC DC LIST, reverse DNS lookup sorted by round-robin result<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dclist </span><span class="keyword">= </span><span class="default">gethostbynamel</span><span class="keyword">(</span><span class="default">$_domain</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$dclist </span><span class="keyword">as </span><span class="default">$dc</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">serviceping</span><span class="keyword">(</span><span class="default">$dc</span><span class="keyword">) == </span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dc </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="comment">//after this loop, either there will be at least one DC which is available at present, or $dc would return bool false while the next line stops program from further execution<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (!</span><span class="default">$dc</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; } </span><span class="comment">//user being notified<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$dc</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117685""></a>
  <div class="note">
   <strong class="user">Nixahnung</strong>
   <a href="#117685" class="date">22-Jul-2015 03:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have spent a lot of time to make an LDAPS connection to a MS AD Global Catalog port 3269<br />
<br />
My five Cents:<br />
<br />
ldap_connect("ldaps://example.com", 3269)<br />
=&gt; Connection to 636.... :(, DC only<br />
<br />
ldap_connect("ldaps://example.com:3269")<br />
=&gt; Connection to 3269.... :), GC as expected<br />
<br />
May it helps...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117611""></a>
  <div class="note">
   <strong class="user">lee at lareck70 dot net</strong>
   <a href="#117611" class="date">08-Jul-2015 06:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To use LDAPS on Windows whitout "c:\openldap\sysconf\ldap.conf":<br />
Generate a file like ldap.conf, name it "ldaprc".<br />
For PHP script running on command line put the file to the script.<br />
For PHP script running on webserver put the file in home directory of PHP.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="117296""></a>
  <div class="note">
   <strong class="user">mwilmes at avc dot edu</strong>
   <a href="#117296" class="date">18-May-2015 05:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I support a LAMP stack with PHP-FPM on CentOS 7 that needs to connect to Active Directory over SSL.&nbsp; We have a root certificate for the domain.&nbsp; I was able to set this up in five steps.<br />
<br />
1. Get the domain's root SSL certificate in base64. (Must be an Enterprise Administrator - talk with your admin if you are not one.)<br />
Run mmc.exe<br />
File -&gt; Add/Remove Snap-in<br />
Select Certification Authority, then the server that generates certificates for your domain.<br />
Expand the tree until you find the entry for the root certificate, then right click-&gt;Properties.<br />
Click the "View Certificate" button, The "Details" tab, then the "Copy to File..." button.<br />
Use the wizard to export the root certificate to your computer. Ensure you use the Base-64 format.<br />
<br />
2. Copy the root cert to the Linux server.&nbsp; You can open the certificate in notepad and copy and paste the contents.<br />
<br />
3. Convert the certificate to pem format.&nbsp; Substitute the names of files as needed.<br />
openssl x509 -in &lt;copied certificate file&gt; -out /etc/openldap/certs/&lt;cert&gt;.pem<br />
<br />
4. Add a line in ldap.conf to use new root cert.<br />
vi /etc/openldap/ldap.conf<br />
TLS_CACERT&nbsp; &nbsp; &nbsp; /etc/openldap/certs/&lt;cert&gt;.pem<br />
<br />
5.Restart the PHP service.<br />
systemctl restart php-fpm.service</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116853""></a>
  <div class="note">
   <strong class="user">harrison at glsan dot com</strong>
   <a href="#116853" class="date">10-Mar-2015 06:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To override the ssl ca file can be done by setting an environmental variable within php.<br />
<br />
I found using saving the ca certificate (and intermediate ca's) to a file called ca.pem and then adding <br />
<br />
putenv('LDAPTLS_CACERT=./ca.pem'); <br />
<br />
before ldap_connect works for me.&nbsp;&nbsp; <br />
Code example:<br />
<span class="default">&lt;?php<br />
putenv</span><span class="keyword">(</span><span class="string">'LDAPTLS_CACERT=./ca.pem'</span><span class="keyword">);<br />
</span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">NULL</span><span class="keyword">, </span><span class="default">LDAP_OPT_DEBUG_LEVEL</span><span class="keyword">, </span><span class="default">7</span><span class="keyword">);<br />
</span><span class="default">$l </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="string">"ldaps://ldap/"</span><span class="keyword">);<br />
</span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$l</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);<br />
</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$l</span><span class="keyword">, </span><span class="string">"cn=apache,dc=example"</span><span class="keyword">, </span><span class="string">"xxxxxxx"</span><span class="keyword">);<br />
echo(</span><span class="default">ldap_error</span><span class="keyword">(</span><span class="default">$l</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">);<br />
</span><span class="default">$s </span><span class="keyword">= </span><span class="default">ldap_search</span><span class="keyword">(</span><span class="default">$l</span><span class="keyword">, </span><span class="string">"dc=example"</span><span class="keyword">, </span><span class="string">"uid=test"</span><span class="keyword">);<br />
echo(</span><span class="default">ldap_count_entries</span><span class="keyword">(</span><span class="default">$l</span><span class="keyword">, </span><span class="default">$s</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span>in the file&nbsp; ca.pem in the same directory we have our ca's:<br />
-----BEGIN CERTIFICATE-----<br />
&lt;cert here&gt;<br />
-----END CERTIFICATE-----</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116524""></a>
  <div class="note">
   <strong class="user">TheThinkingMan</strong>
   <a href="#116524" class="date">18-Jan-2015 10:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have spent hours and hours trying to get an LDAPS connection happening with my local AD LDS instance (running on Windows 8.1 64bit).<br />
<br />
I tried certificate after certificate. OpenSSL, Thawte and Self-signed - all with no success.<br />
<br />
I ended up deleting all of my certificates and created a Self-signed certificate using IIS 7 (running on Windows 8.1).<br />
<br />
I then downloaded the Softerra LDAP browser and it was able to connect to my AD LDS instance via SSL with no problems.<br />
<br />
Sure if it could PHP could.<br />
<br />
I used the following code to connect: <br />
<span class="default">&lt;?php<br />
$ldap_server </span><span class="keyword">= </span><span class="string">"ldaps://delllappy:636"</span><span class="keyword">;<br />
</span><span class="default">$ldap_conn </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$ldap_server</span><span class="keyword">)&nbsp; or die(</span><span class="string">"Failed to connect to LDAP server."</span><span class="keyword">); <br />
</span><span class="default">?&gt;<br />
</span>I added the following above the ldap_connect:<br />
<span class="default">&lt;?php<br />
putenv</span><span class="keyword">(</span><span class="string">'LDAPTLS_REQCERT=allow'</span><span class="keyword">);<br />
</span><span class="default">putenv</span><span class="keyword">(</span><span class="string">"LDAPCONF=C:\OpenLDAP\sysconf\ldap.conf"</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
That did nothing.<br />
<br />
The ldap_bind command I used was:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if (!</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ldap_conn</span><span class="keyword">, </span><span class="default">$ldap_user</span><span class="keyword">, </span><span class="default">$ldap_pass</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"error"</span><span class="keyword">;<br />
}else{<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"success"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span>BTW: I added a heap of debug in the code too - which is referenced elsewhere - so I didn't add it in here.<br />
<br />
The error that I kept on getting was:<br />
Error Binding to LDAP: error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed<br />
<br />
I then ran ProcMon (Process Monitor from Microsoft).<br />
<br />
I monitored when I restarted my web server (Z-WAMP). At that point there was no attempt to read ldap.conf.<br />
<br />
I then loaded up my web page with my test.php file. <br />
<br />
At that point I noticed that it was ldap.conf that was being read but openldap.conf.<br />
<br />
Of course as my file was called ldap.conf, openldap.conf failed. I renamed my ldap.conf to openldap.conf and everything worked.<br />
<br />
On Z-WAMP running OpenLDAP don't used ldap.conf, use openldap.conf.<br />
<br />
The openldap.conf file was placed in C:\openldap\sysconf\.<br />
<br />
As the PUTENV values did not do anything, I removed them.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="115662""></a>
  <div class="note">
   <strong class="user">nemanja at prolux-universal dot com</strong>
   <a href="#115662" class="date">04-Sep-2014 11:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you don't want your PHP program to wait XXX seconds before giving up in a case when one of your corporate DC have failed, and since ldap_connect() does not have a mechanism to timeout on a user specified time, this is my workaround which shows excellent practical results.<br />
<br />
===========================================================<br />
function serviceping($host, $port=389, $timeout=1)<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $op = fsockopen($host, $port, $errno, $errstr, $timeout);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!$op) return 0; //DC is N/A<br />
&nbsp;&nbsp;&nbsp; else {<br />
&nbsp;&nbsp;&nbsp; fclose($opanak); //explicitly close open socket connection<br />
&nbsp;&nbsp;&nbsp; return 1; //DC is up &amp; running, we can safely connect with ldap_connect<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
// ##### STATIC DC LIST, if your DNS round robin is not setup<br />
//$dclist = array('10.111.222.111', '10.111.222.100', '10.111.222.200');<br />
<br />
// ##### DYNAMIC DC LIST, reverse DNS lookup sorted by round-robin result<br />
$dclist = gethostbynamel('domain.name');<br />
<br />
foreach ($dclist as $k =&gt; $dc) if (serviceping($dc) == true) break; else $dc = 0;<br />
//after this loop, either there will be at least one DC which is available at present, or $dc would return bool false while the next line stops program from further execution<br />
<br />
if (!$dc) exit("NO DOMAIN CONTROLLERS AVAILABLE AT PRESENT, PLEASE TRY AGAIN LATER!"); //user being notified<br />
<br />
//now, ldap_connect would certainly connect succesfully to DC tested previously and no timeout will occur<br />
$ldapconn = ldap_connect($dc) or die("DC N/A, PLEASE TRY AGAIN LATER.");<br />
===========================================================<br />
<br />
Also with this approach, you get a real nice failover functionality, take for an example a company with a dozen of DC-a distributed along distant places, this way your PHP program will always have high availability if at least one DC is active at present.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109829""></a>
  <div class="note">
   <strong class="user">ac dot russell at live dot com</strong>
   <a href="#109829" class="date">24-Aug-2012 06:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In order to connect to an ldap server via ssl I needed to use a certificate. For this to work the ldap admin sent me a .der file which I put into /etc/openldap/cacerts. 
<br />
&nbsp;&nbsp;&nbsp; cp ldap-server.der /etc/openldap/cacerts
<br />
That directory must be chmod 755. Then the following entries had to be in /etc/openldap/ldap.conf 
<br />

<br />
&nbsp;&nbsp;&nbsp; # Make the connection vulnerable to MITM-Attacks 
<br />
&nbsp;&nbsp;&nbsp; # by not checking any certificates
<br />
&nbsp;&nbsp;&nbsp; # For a better solution see https://andreas.heigl.org/2020/01/31/handle-self-signed-certificates-with-phps-ldap-extension/
<br />
&nbsp;&nbsp;&nbsp; TLS_REQCERT&nbsp;&nbsp; never&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; TLS_CACERTDIR /etc/openldap/cacerts
<br />
"TLS_REQCERT never" should only be required if there is a self-signed certificate in the certificate chain.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103372""></a>
  <div class="note">
   <strong class="user">verikono</strong>
   <a href="#103372" class="date">11-Apr-2011 01:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PHP:LDAP does not support persistent connections.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96660""></a>
  <div class="note">
   <strong class="user">miki at qex dot cz</strong>
   <a href="#96660" class="date">10-Mar-2010 04:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I had terrible problems with "Unable to bind to server: Invalid credentials" error - everything seemed to be OK (login/pwd used in other apps).
<br />
Solved by adding domain to login (instead "username" I used "username@example.com").</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93317""></a>
  <div class="note">
   <strong class="user">mharting at micahtek dot com</strong>
   <a href="#93317" class="date">02-Sep-2009 01:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
An addition to trying to setup failover. After doing the ldap_connect, do the ldap_bind.&nbsp; If ldap_bind fails, use the command ldap_errno to get the error number.&nbsp; If the error number is 81, that represents the server is down.&nbsp; That is the only time we do a failover to our backup ldap server.<br />
<br />
Another thing to consider is the error could be 49, then do<br />
ldap_get_option($this-&gt;ds,LDAP_OPT_ERROR_NUMBER,$optErrorNumber);. This will return extended data and if the data code in that is 532 or 773, the bind failure will be caused by the password being expired and requiring a password update before the bind will succeed.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90303""></a>
  <div class="note">
   <strong class="user">csnyder at fcny dot org</strong>
   <a href="#90303" class="date">15-Apr-2009 09:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It bears repeating (and the examples should probably be updated) that ldap_connect() doesn't actually test the connection to the specified ldap server. This is important if you're trying to build failover into your ldap-based authentication routine.
<br />

<br />
The only way to test the connection is to actually call ldap_bind( $ds, $username, $password ). But if that fails, is it because you have the wrong username/password or is it because the connection is down? As far as I can see there isn't any way to tell.
<br />

<br />
It seems that if ldap_bind() fails against your primary server, you have no choice but to try ldap_bind() with the same credentials against the backup. And yet, if your organization limits failed login attempts, a single bad password counts as two failed login attempts. Not good.
<br />

<br />
One possible workaround is to try an anonymous bind first:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="comment">// connect to primary
<br />
</span><span class="default">$ds </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">( </span><span class="string">'ldap://10.0.0.7/' </span><span class="keyword">);
<br />
</span><span class="comment">// note: $ds is always a resource even if primary is down
<br />

<br />
// try anonymous login to test connection
<br />
</span><span class="default">$anon </span><span class="keyword">= @</span><span class="default">ldap_bind</span><span class="keyword">( </span><span class="default">$ds </span><span class="keyword">);
<br />
if ( !</span><span class="default">$anon </span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// test failed, connect to failover host
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ds </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">( </span><span class="string">'ldap://10.0.0.8/' </span><span class="keyword">);
<br />
}
<br />
else {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// test passed, unbind anonymous and reconnect to primary
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ldap_unbind</span><span class="keyword">( </span><span class="default">$ds </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ds </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">( </span><span class="string">'ldap://10.0.0.7/' </span><span class="keyword">);
<br />
}
<br />

<br />
</span><span class="comment">// now try a real login
<br />
</span><span class="default">$login </span><span class="keyword">= @</span><span class="default">ldap_bind</span><span class="keyword">( </span><span class="default">$ds</span><span class="keyword">, </span><span class="default">$username</span><span class="keyword">, </span><span class="default">$password </span><span class="keyword">);
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Note that this workaround relies on anonymous login being enabled, which may not always be the case. It's a little sad that there is no other way to test the connection. Hopefully this can be remedied in some future implementation of ldap_connect().</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88508""></a>
  <div class="note">
   <strong class="user">peter dot burden at gmail dot com</strong>
   <a href="#88508" class="date">27-Jan-2009 04:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The host name parameter can be a space separated list of host names. This means that the LDAP code will talk to a backup server if the main server is not operational. There will be a delay while the code times out trying to talk to the main server but things will still work. This is particularly useful with a typical Microsoft Active Directory setup of primary and backup domain controllers.<br />
<span class="default">&lt;?php<br />
$ldaphost </span><span class="keyword">= </span><span class="string">"192.168.0.100 192.168.0.101"</span><span class="keyword">;<br />
</span><span class="default">$ldapconn </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$ldaphost</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82918""></a>
  <div class="note">
   <strong class="user">geigers at binghamton dot edu</strong>
   <a href="#82918" class="date">01-May-2008 01:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you have oci8 and are trying to use openldap for ldap you *may* run into a problem.&nbsp; I have an Oracle database that I connect to from apache.&nbsp; Oracle also has ldap libs which were taking precedence over the openldap libs.&nbsp; This would cause a seg fault when calling ldap_connect with a uri style connect string; e.g. ldap_connect("ldaps://myldapserver.host");<br />
<br />
After using gdb to debug a core dump and a lot of googling I found that the solution was to add an env-var to apachectl startup.<br />
<br />
I am using Apache 2.2.8 with PHP 5.2.5 on RHEL.&nbsp; I added:<br />
<br />
LD_PRELOAD=/path/to/libldap.so<br />
export LD_PRELOAD<br />
<br />
in /usr/sbin/envvars which is read when apachectl starts.&nbsp; You can read more on this here: <a href="http://www.mail-archive.com/php-bugs@lists.php.net/msg02201.html" rel="nofollow" target="_blank">http://www.mail-archive.com/php-bugs@lists.php.net/msg02201.html</a><br />
<br />
Scott Geiger</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81427""></a>
  <div class="note">
   <strong class="user">bleathem at gmail dot com</strong>
   <a href="#81427" class="date">27-Feb-2008 02:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Everyone is posting about getting ldaps:// working in a WAMP/AD stack, I had a tough time finding how to get it going in RHEL 5.1 (w/ all stock rpms).&nbsp; Good old strace did the trick and helped me find the problem...<br />
<br />
Turns out php was looking for the CA file in /etc/pki/CA, and I didn't have the correct permissions on the folder.&nbsp; chmod'ing it to 755 solved my "Can't contact LDAP server" message.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75571""></a>
  <div class="note">
   <strong class="user">andreas dot a dot sandberg at gmail dot com</strong>
   <a href="#75571" class="date">05-Jun-2007 05:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be careful when using ldap_connect with the sun client libraries that come bundled with solaris.&nbsp;&nbsp; When specifyng the host with the ldap protocol, my connection failed and it took me a good day to trouble shoot.&nbsp; ie. ldap_connect("ldap://somwhere.com");&nbsp; Just remove the 'ldap://' and specify the host.&nbsp;&nbsp; This was on Solaris 10 sparc.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74941""></a>
  <div class="note">
   <strong class="user">vandervoord at planet dot nl</strong>
   <a href="#74941" class="date">05-May-2007 06:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The previous note concerning searching the whole AD tree works fully. Though you must be sure that the server you're authenticating/searching is a Global Catalog server. If not, connecting and binding will fail. Usually there is at least one Global Catalog server in your domain, so if the connect fails try another server it will work. The reason it works is that the Global Catalog server searches the whole domain as where the domain catalog only searches a given OU, offcourse this opposes a security threat as well :)...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73691""></a>
  <div class="note">
   <strong class="user">allie  at  lsu  dot  edu</strong>
   <a href="#73691" class="date">06-Mar-2007 02:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I sure do wish there was some way I could get this information out to all programmers in the world about binding and searching MS AD.&nbsp; This is the second time I was bit by the "I need to search the entire tree" problem.<br />
<br />
For php (and apache auth_ldap ) you need to specify port 3268 when you want to search the entire tree.&nbsp; Otherwise it will spit out the partial results error.<br />
<br />
ldap_connect($server,3268);<br />
<br />
I'm just fortunate enough to have won this same battle with apache searching the whole directory.&nbsp; When I noticed our php application failing auth's for users, I was immediately able to fix the problem by adding this port specification (and the ldap_set_option($ldapserver, LDAP_OPT_REFERRALS, 0)&nbsp; option).<br />
<br />
I really hope this helps someone else before they pull all their hair out.&nbsp; I know I miss mine.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69807""></a>
  <div class="note">
   <strong class="user">elsint at yahoo dot com</strong>
   <a href="#69807" class="date">21-Sep-2006 01:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be careful about the certificate's permission if you are using Windows.<br />
<br />
Set certificates' permissions for everyone to Read and Read&amp;Execute or you may get binding errors because of this.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58473""></a>
  <div class="note">
   <strong class="user">baroque at citromail dot hu</strong>
   <a href="#58473" class="date">05-Nov-2005 01:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This code sample shows how to connect and bind to eDirectory in PHP using LDAP for Netware.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$server</span><span class="keyword">=</span><span class="string">'137.65.138.159'</span><span class="keyword">;<br />
</span><span class="default">$admin</span><span class="keyword">=</span><span class="string">'cn=admin,o=novell'</span><span class="keyword">;<br />
</span><span class="default">$passwd</span><span class="keyword">=</span><span class="string">'novell'</span><span class="keyword">;<br />
<br />
</span><span class="default">$ds</span><span class="keyword">=</span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$server</span><span class="keyword">);&nbsp; </span><span class="comment">// assuming the LDAP server is on this host<br />
<br />
</span><span class="keyword">if (</span><span class="default">$ds</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// bind with appropriate dn to give update access<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$r</span><span class="keyword">=</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">$admin</span><span class="keyword">, </span><span class="default">$passwd</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if(!</span><span class="default">$r</span><span class="keyword">) die(</span><span class="string">"ldap_bind failed&lt;br&gt;"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"ldap_bind success"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ldap_close</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Unable to connect to LDAP server"</span><span class="keyword">; <br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54082""></a>
  <div class="note">
   <strong class="user">Srivathsa M</strong>
   <a href="#54082" class="date">23-Jun-2005 03:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Using LDAP over SSL on NetWare:<br />
<br />
1. Copy the server certificates to sys:/php5/cert directory. This location is configurable in php.ini file.<br />
<br />
2. Use "ldaps://" prefix for host name argument or a value of 636 for port number argument in ldap_connect call.<br />
<br />
For more details, visit, NetWare specific PHP documentation at <a href="http://developer.novell.com/ndk/doc/php/index.html" rel="nofollow" target="_blank">http://developer.novell.com/ndk/doc/php/index.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52253""></a>
  <div class="note">
   <strong class="user">nigelf at esp dot co dot uk</strong>
   <a href="#52253" class="date">26-Apr-2005 03:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As mentioned above, openLDAP will always return a resource, even if the server name isn't valid.&nbsp; <br />
<br />
If you then bind with errors suppressed (@ldap_bind) and it fails, it's not obvious what caused the failure (ie: connection or credentials).&nbsp; As the bind doesn't return a resource you can't get the last error from ldap_error etc. either.<br />
<br />
If you display just a message about login failure to the user they may get frustrated re-typing a valid username/password when it's the connection that's at fault.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="46054""></a>
  <div class="note">
   <strong class="user">blizzards at libero dot it</strong>
   <a href="#46054" class="date">28-Sep-2004 03:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To complete questions about how to connect to a LDAP ACTIVE DIRECTORY 2000/2003 server with SASL on port 636, you can refer to prevous notes, and the following directives:<br />
<br />
A)Create CA certificates from AD;<br />
B)Export in .pem (DER) format;<br />
C)Install OPENSSL,CYRUS SASL,OPENLDAP,KERBEROS 5;<br />
D)Copy exported AD ca cert into openssl certs dir on your unix system;<br />
E)Reash with c_reash command;<br />
F)Get a kerberos ticket form AD for your user;<br />
G)Compile PHP with SSL and LDAP support;<br />
H)Test with ldapsearch -D &lt;binddn&gt; -W -H ldaps://ad.secure.com:636 -x<br />
<br />
If all works right, create your php script.<br />
<br />
Note: For writing parameters to AD you need to renew ticket each 10 hours or less (AD default lifetime ticket), for reading pourpose you can maintain expired ticket.<br />
When querying a windows 2000/2003 AD you MUST use only SASL and not TLS (non supported).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36156""></a>
  <div class="note">
   <strong class="user">Andrew (a.whyte at cqu.edu.au)</strong>
   <a href="#36156" class="date">29-Sep-2003 12:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To be able to make modifications to Active Directory via the LDAP connector you must bind to the LDAP service over SSL. Otherwise Active Directory provides a mostly readonly connection. You cannot add objects or modify certain properties without LDAPS, e.g. passwords can only be changed using LDAPS connections to Active Directory.
<br />

<br />
Therefore, for those wishing to securely connect to Active Directory, from a Unix host using PHP+OpenLDAP+OpenSSL I spent some time getting this going myself, and came across a few gotcha's. Hope this proves fruitfull for others like me when you couldn't find answers out there.
<br />

<br />
Make sure you compile OpenLDAP with OpenSSL support, and that you compile PHP with OpenLDAP and OpenSSL.
<br />

<br />
This provides PHP with what it needs to make use of ldaps:// connections.
<br />

<br />
Configure OpenSSL:
<br />

<br />
Extract your Root CA certificate from Active Directory, this is achived through the use of Certificate Services, a startard component of Windows 2000 Server, but may not be installed by default, (The usual Add/Remove Software method will work here). I extracted this in Base64 not DER format.
<br />

<br />
Place the extracted CAcert into the certs folder for openssl. (e.g. /usr/local/ssl/certs) and setup the hashed symlinks. This is easily done by simply running:
<br />

<br />
&nbsp; /usr/local/ssl/bin/c_rehash
<br />

<br />
Once this is done you can test it is worked by running:
<br />

<br />
&nbsp; /usr/local/ssl/bin/openssl verify -verbose -CApath /usr/local/ssl/certs /tmp/exported_cacert.pem
<br />

<br />
(Should return: OK).
<br />

<br />
Configure OpenLDAP:
<br />

<br />
Add the following to your ldap.conf file.
<br />
(found as /usr/local/openldap/etc/openldap/ldap.conf)
<br />

<br />
&nbsp; #--begin--
<br />

<br />
&nbsp; # Instruct client to NOT request a server's cert. 
<br />
&nbsp; #
<br />
&nbsp; # WARNING: This will open up the server vor Man-in-the-middle 
<br />
&nbsp; # attacs and should *not* be used on production systems or outside
<br />
&nbsp; # of test-scenarios!
<br />
&nbsp; #
<br />
&nbsp; # If you use this setting you will not need any other settings as
<br />
&nbsp; # no certificate is requested and therefore will not be validated
<br />
&nbsp; #
<br />
&nbsp; # For a proper solution check out https://andreas.heigl.org/2020/01/31/handle-self-signed-certificates-with-phps-ldap-extension/
<br />
&nbsp; TLS_REQCERT never
<br />

<br />
&nbsp; # Define location of CA Cert
<br />
&nbsp; TLS_CACERT /usr/local/ssl/certs/AD_CA_CERT.pem
<br />
&nbsp; TLS_CACERTDIR /usr/local/ssl/certs
<br />

<br />
&nbsp; #--end--
<br />

<br />
You also need to place those same settings in a file within the Apache Web user homedir called .ldaprc
<br />

<br />
&nbsp; e.g.:
<br />
&nbsp; 
<br />
&nbsp; cp /usr/local/openldap/etc/openldap/ldap.conf ~www/.ldaprc )
<br />

<br />
You can then test that you're able to establish a LDAPS connection to Active Directory from the OpenLDAP command tools:
<br />

<br />
&nbsp; /usr/local/openldap/bin/ldapsearch -H "ldaps://adserver.ad.com"
<br />

<br />
This should return some output in extended LDIF format and will indicate no matching objects, but it proves the connection works.
<br />

<br />
The name of the server you're connecting to is important. If they server name you specify in the "ldaps://" URI does not match the name of the server in it's certificate, it will complain like so:
<br />

<br />
&nbsp; ldap_bind: Can't contact LDAP server (81)
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; additional info: TLS: hostname does not match CN in peer certificate
<br />

<br />
Once you've gotten the ldapsearch tool working correctly PHP should work also.
<br />

<br />
One important gotcha however is that the Web user must be able to locate it's HOME folder. You must check that Apache is providing a HOME variable set to the Web users home directory, so that php can locate the .ldaprc file and the settings contained within. This may well be different between Unix variants but it is such a simple and stupid thing if you miss it and it causes you grief. Simply use a SetEnv directive in Apache's httpd.conf:
<br />

<br />
&nbsp; SetEnv HOME /usr/local/www
<br />

<br />
With all that done, you can now code up a simple connect function:
<br />

<br />
&nbsp; function connect_AD()
<br />
&nbsp; {
<br />
&nbsp;&nbsp;&nbsp; $ldap_server = "ldaps://adserver.ad.com" ;
<br />
&nbsp;&nbsp;&nbsp; $ldap_user&nbsp;&nbsp; = "CN=web service account,OU=Service Accounts,DC=ad,DC=com" ;
<br />
&nbsp;&nbsp;&nbsp; $ldap_pass&nbsp;&nbsp; = "password" ;
<br />

<br />
&nbsp;&nbsp;&nbsp; $ad = ldap_connect($ldap_server) ;
<br />
&nbsp;&nbsp;&nbsp; ldap_set_option($ad, LDAP_OPT_PROTOCOL_VERSION, 3) ;
<br />
&nbsp;&nbsp;&nbsp; $bound = ldap_bind($ad, $ldap_user, $ldap_pass);
<br />

<br />
&nbsp;&nbsp;&nbsp; return $ad ;
<br />
&nbsp; }
<br />

<br />
Optionally you can avoid the URI style server string and use something like ldap_connect("adserver.ad.com", 636) ;&nbsp; But work fine with Active Directory servers.
<br />

<br />
Hope this proves usefull.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="23654""></a>
  <div class="note">
   <strong class="user">avel at noc uoa gr</strong>
   <a href="#23654" class="date">24-Jul-2002 07:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that hostname can be a space-separated list of LDAP host names. This is very useful for failover; if the first ldap host is down, ldap_connect will ask the second LDAP host. Of course, you _must_ have LDAP replicates before doing this. :) Read the LDAP API documentation for more information.
<br />

<br />
This can also be useful, apart from failover, for LDAP load balancing. Just use a random generator function that will return a different space-separated list every time. This is because the first host in the list is always tried first.
<br />

<br />
Be careful when doing LDAP writes; be sure to always connect to your master host when you are about to modify the database, so that the replicates will get the changes as expected.
<br />

<br />
Alexandros Vellis</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="20984""></a>
  <div class="note">
   
   <a href="#20984" class="date">24-Apr-2002 09:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A resource ID is always returned when using URLs for the host parameter<br />
even if the host does not exist.<br />
<br />
"When using an URI to describe the connection, the (open)ldap library<br />
only parses the url and checks if it's valid, _no connection_ is<br />
established in that case."<br />
-mfischer@php.net<br />
<a href="http://bugs.php.net/bug.php?id=15637" rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=15637</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
